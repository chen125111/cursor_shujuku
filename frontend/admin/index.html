<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åå°ç®¡ç†ç³»ç»Ÿ - æ°”ä½“æ··åˆç‰©æ•°æ®ç®¡ç†</title>
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500&family=Inter:wght@400;500;600;700&family=Noto+Sans+SC:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-dark: #0f1419;
            --bg-card: #1a1f2e;
            --bg-sidebar: #151922;
            --bg-input: #0d1117;
            --border: #2d3748;
            --text: #e2e8f0;
            --text-dim: #718096;
            --accent: #4299e1;
            --accent-hover: #63b3ed;
            --success: #48bb78;
            --warning: #ecc94b;
            --danger: #f56565;
            --purple: #9f7aea;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', 'Noto Sans SC', sans-serif;
            background: var(--bg-dark);
            color: var(--text);
            min-height: 100vh;
        }

        /* Login Page */
        .login-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #0f1419 0%, #1a1f2e 50%, #0f1419 100%);
        }

        .login-box {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 40px;
            width: 400px;
            box-shadow: 0 25px 50px rgba(0,0,0,0.5);
        }

        .login-logo {
            text-align: center;
            margin-bottom: 30px;
        }

        .login-logo .icon {
            width: 64px;
            height: 64px;
            background: linear-gradient(135deg, var(--accent), var(--purple));
            border-radius: 16px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            margin-bottom: 16px;
        }

        .login-logo h1 {
            font-size: 24px;
            font-weight: 700;
        }

        .login-logo p {
            color: var(--text-dim);
            font-size: 14px;
            margin-top: 8px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 8px;
            color: var(--text-dim);
        }

        .form-group input {
            width: 100%;
            padding: 14px 16px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 10px;
            color: var(--text);
            font-size: 15px;
            transition: all 0.2s;
        }

        .form-group input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.2);
        }

        .login-btn {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, var(--accent), var(--purple));
            border: none;
            border-radius: 10px;
            color: white;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(66, 153, 225, 0.3);
        }

        .login-error {
            background: rgba(245, 101, 101, 0.1);
            border: 1px solid var(--danger);
            color: var(--danger);
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
            display: none;
        }

        /* Dashboard Layout */
        .dashboard {
            display: none;
            min-height: 100vh;
        }

        .dashboard.active {
            display: flex;
        }

        /* Sidebar */
        .sidebar {
            width: 260px;
            background: var(--bg-sidebar);
            border-right: 1px solid var(--border);
            padding: 20px 0;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
        }

        .sidebar-logo {
            padding: 0 20px 20px;
            border-bottom: 1px solid var(--border);
            margin-bottom: 20px;
        }

        .sidebar-logo h2 {
            font-size: 18px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .sidebar-logo span {
            font-size: 12px;
            background: var(--accent);
            padding: 2px 8px;
            border-radius: 4px;
        }

        .nav-section {
            padding: 0 12px;
            margin-bottom: 20px;
        }

        .nav-section-title {
            font-size: 11px;
            font-weight: 600;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 1px;
            padding: 0 12px;
            margin-bottom: 10px;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            color: var(--text-dim);
            text-decoration: none;
            border-radius: 10px;
            transition: all 0.2s;
            cursor: pointer;
            font-size: 14px;
        }

        .nav-item:hover {
            background: rgba(66, 153, 225, 0.1);
            color: var(--text);
        }

        .nav-item.active {
            background: linear-gradient(135deg, rgba(66, 153, 225, 0.2), rgba(159, 122, 234, 0.2));
            color: var(--accent);
        }

        .nav-item .icon {
            font-size: 18px;
        }

        .nav-item .badge {
            margin-left: auto;
            background: var(--danger);
            color: white;
            font-size: 11px;
            padding: 2px 8px;
            border-radius: 10px;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            margin-left: 260px;
            padding: 30px;
            background: var(--bg-dark);
        }

        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .page-header h1 {
            font-size: 28px;
            font-weight: 700;
        }

        .page-header p {
            color: var(--text-dim);
            margin-top: 5px;
        }

        .header-actions {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px 16px;
            background: var(--bg-card);
            border-radius: 10px;
            cursor: pointer;
        }

        .user-avatar {
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, var(--accent), var(--purple));
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: var(--accent);
            color: white;
        }

        .btn-primary:hover {
            background: var(--accent-hover);
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-secondary {
            background: var(--bg-card);
            color: var(--text);
            border: 1px solid var(--border);
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 24px;
            position: relative;
            overflow: hidden;
        }

        .stat-card.clickable {
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .stat-card.clickable:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 20px rgba(66, 153, 225, 0.15);
        }

        .stat-card::after {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 100px;
            height: 100px;
            background: radial-gradient(circle, rgba(66, 153, 225, 0.1) 0%, transparent 70%);
        }

        .stat-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            margin-bottom: 16px;
        }

        .stat-icon.blue { background: rgba(66, 153, 225, 0.2); }
        .stat-icon.green { background: rgba(72, 187, 120, 0.2); }
        .stat-icon.yellow { background: rgba(236, 201, 75, 0.2); }
        .stat-icon.purple { background: rgba(159, 122, 234, 0.2); }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
            font-family: 'Fira Code', monospace;
        }

        .stat-label {
            color: var(--text-dim);
            font-size: 14px;
            margin-top: 4px;
        }

        .stat-change {
            font-size: 13px;
            margin-top: 8px;
        }

        .stat-change.up { color: var(--success); }
        .stat-change.down { color: var(--danger); }

        /* Cards */
        .card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            margin-bottom: 20px;
        }

        .card-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .card-header h3 {
            font-size: 16px;
            font-weight: 600;
        }

        .card-header .badge {
            background: rgba(66, 153, 225, 0.15);
            color: var(--accent);
            font-size: 11px;
            padding: 4px 10px;
            border-radius: 999px;
            border: 1px solid var(--border);
        }

        .card-body {
            padding: 24px;
        }

        /* Visualization */
        .viz-controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 16px;
        }

        .viz-control {
            padding: 12px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 12px;
        }

        .viz-control label {
            display: block;
            font-size: 12px;
            font-weight: 500;
            margin-bottom: 8px;
            color: var(--text-dim);
        }

        .viz-control input,
        .viz-control select {
            width: 100%;
            padding: 10px 12px;
            background: #0b0f14;
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text);
            font-size: 13px;
        }

        .viz-control input:focus,
        .viz-control select:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.15);
        }

        .viz-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 20px;
        }

        .chart-wrap {
            width: 100%;
            height: 340px;
        }

        .chart-wrap.large {
            height: 420px;
        }

        /* Table */
        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table th {
            text-align: left;
            padding: 14px 16px;
            font-size: 12px;
            font-weight: 600;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            background: var(--bg-input);
        }

        .data-table td {
            padding: 14px 16px;
            font-size: 14px;
            border-bottom: 1px solid var(--border);
            font-family: 'Fira Code', monospace;
        }

        .data-table tr:hover {
            background: rgba(66, 153, 225, 0.05);
        }

        .data-table tr.highlight-row {
            background: rgba(66, 153, 225, 0.12);
            box-shadow: inset 0 0 0 1px rgba(66, 153, 225, 0.35);
        }

        .data-table tr.highlight-row td:first-child::after {
            content: 'å®šä½';
            margin-left: 8px;
            padding: 2px 6px;
            font-size: 11px;
            color: #1a202c;
            background: #63b3ed;
            border-radius: 999px;
        }

        /* System Info */
        .info-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
        }

        .info-item {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid var(--border);
        }

        .info-item:last-child {
            border-bottom: none;
        }

        .info-label {
            color: var(--text-dim);
        }

        .info-value {
            font-family: 'Fira Code', monospace;
            font-weight: 500;
        }

        /* Activity Log */
        .activity-item {
            display: flex;
            align-items: flex-start;
            gap: 16px;
            padding: 16px 0;
            border-bottom: 1px solid var(--border);
        }

        .activity-item:last-child {
            border-bottom: none;
        }

        .activity-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            flex-shrink: 0;
        }

        .activity-icon.create { background: rgba(72, 187, 120, 0.2); }
        .activity-icon.update { background: rgba(66, 153, 225, 0.2); }
        .activity-icon.delete { background: rgba(245, 101, 101, 0.2); }
        .activity-icon.export { background: rgba(236, 201, 75, 0.2); }

        .activity-content h4 {
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 4px;
        }

        .activity-content p {
            font-size: 13px;
            color: var(--text-dim);
        }

        .activity-time {
            margin-left: auto;
            font-size: 12px;
            color: var(--text-dim);
            white-space: nowrap;
        }

        /* Progress Bar */
        .progress-bar {
            height: 8px;
            background: var(--bg-input);
            border-radius: 4px;
            overflow: hidden;
            margin-top: 8px;
        }

        .progress-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        .progress-fill.blue { background: var(--accent); }
        .progress-fill.green { background: var(--success); }

        /* Database Actions */
        .db-actions {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .action-card {
            flex: 1;
            min-width: 200px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .action-card:hover {
            border-color: var(--accent);
            transform: translateY(-2px);
        }

        .action-card .icon {
            font-size: 32px;
            margin-bottom: 12px;
        }

        .action-card h4 {
            font-size: 15px;
            margin-bottom: 4px;
        }

        .action-card p {
            font-size: 13px;
            color: var(--text-dim);
        }

        /* Page Sections */
        .page-section {
            display: none;
        }

        .page-section.active {
            display: block;
        }

        /* Responsive */
        @media (max-width: 1200px) {
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .sidebar {
                display: none;
            }
            .main-content {
                margin-left: 0;
            }
            .stats-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Login Page -->
    <div class="login-container" id="loginPage">
        <div class="login-box">
            <div class="login-logo">
                <div class="icon">ğŸ”</div>
                <h1>åå°ç®¡ç†ç³»ç»Ÿ</h1>
                <p>æ°”ä½“æ··åˆç‰©æ•°æ®ç®¡ç†å¹³å°</p>
            </div>
            <div class="login-error" id="loginError">ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯</div>
            <form id="loginForm">
                <div class="form-group">
                    <label>ç®¡ç†å‘˜è´¦å·</label>
                    <input type="text" id="username" placeholder="è¯·è¾“å…¥è´¦å·">
                </div>
                <div class="form-group">
                    <label>å¯†ç </label>
                    <input type="password" id="password" placeholder="è¯·è¾“å…¥å¯†ç ">
                </div>
                <button type="submit" class="login-btn">ç™» å½•</button>
            </form>
            <p style="text-align: center; margin-top: 20px; color: var(--text-dim); font-size: 13px;">
                ç®¡ç†å‘˜è´¦å·ç”±ç¯å¢ƒå˜é‡ ADMIN_USERNAME / ADMIN_PASSWORD é…ç½®
            </p>
        </div>
    </div>

    <!-- Dashboard -->
    <div class="dashboard" id="dashboard">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-logo">
                <h2>âš—ï¸ ç®¡ç†åå° <span>v4.0</span></h2>
            </div>
            
            <nav class="nav-section">
                <div class="nav-section-title">æ¦‚è§ˆ</div>
                <a class="nav-item active" data-page="overview">
                    <span class="icon">ğŸ“Š</span> ç³»ç»Ÿæ¦‚è§ˆ
                </a>
                <a class="nav-item" data-page="database">
                    <span class="icon">ğŸ—ƒï¸</span> æ•°æ®åº“ç®¡ç†
                </a>
                <a class="nav-item" data-page="backup">
                    <span class="icon">ğŸ’¾</span> è‡ªåŠ¨å¤‡ä»½
                </a>
            </nav>
            
            <nav class="nav-section">
                <div class="nav-section-title">æ•°æ®ç®¡ç†</div>
                <a class="nav-item" data-page="records">
                    <span class="icon">ğŸ“‹</span> æ•°æ®è®°å½•
                    <span class="badge" id="recordCount">0</span>
                </a>
                <a class="nav-item" data-page="visualization">
                    <span class="icon">ğŸ“ˆ</span> é«˜çº§å¯è§†åŒ–
                </a>
                <a class="nav-item" data-page="review">
                    <span class="icon">âœ…</span> æ•°æ®å®¡æ ¸
                    <span class="badge" id="reviewCount" style="background: var(--warning);">0</span>
                </a>
                <a class="nav-item" data-page="import">
                    <span class="icon">ğŸ“¤</span> å¯¼å…¥å¯¼å‡º
                </a>
                <a class="nav-item" data-page="history">
                    <span class="icon">ğŸ“œ</span> æ•°æ®å†å²
                </a>
            </nav>
            
            <nav class="nav-section">
                <div class="nav-section-title">å®‰å…¨ä¸­å¿ƒ</div>
                <a class="nav-item" data-page="users">
                    <span class="icon">ğŸ‘¥</span> ç”¨æˆ·ç®¡ç†
                </a>
                <a class="nav-item" data-page="totp">
                    <span class="icon">ğŸ”</span> ä¸¤æ­¥éªŒè¯
                </a>
                <a class="nav-item" data-page="sessions">
                    <span class="icon">ğŸ“±</span> ä¼šè¯ç®¡ç†
                </a>
                <a class="nav-item" data-page="logs">
                    <span class="icon">ğŸ“</span> ç™»å½•æ—¥å¿—
                </a>
                <a class="nav-item" data-page="settings">
                    <span class="icon">âš™ï¸</span> ç³»ç»Ÿè®¾ç½®
                </a>
                <a class="nav-item" onclick="logout()">
                    <span class="icon">ğŸšª</span> é€€å‡ºç™»å½•
                </a>
            </nav>
            
            <nav class="nav-section" style="margin-top: auto;">
                <a class="nav-item" href="/" target="_blank" id="frontHomeLink">
                    <span class="icon">ğŸŒ</span> å‰å°é¦–é¡µ
                </a>
                <a class="nav-item" href="/docs" target="_blank" id="apiDocsLink">
                    <span class="icon">ğŸ“š</span> APIæ–‡æ¡£
                </a>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <div class="page-header">
                <div>
                    <h1 id="pageTitle">ç³»ç»Ÿæ¦‚è§ˆ</h1>
                    <p id="pageDesc">æŸ¥çœ‹ç³»ç»Ÿè¿è¡ŒçŠ¶æ€å’Œæ•°æ®ç»Ÿè®¡</p>
                </div>
                <div class="header-actions">
                    <button class="btn btn-secondary" onclick="refreshData()">ğŸ”„ åˆ·æ–°</button>
                    <div class="user-info">
                        <div class="user-avatar">A</div>
                        <div>
                            <div style="font-weight: 600; font-size: 14px;">Admin</div>
                            <div style="font-size: 12px; color: var(--text-dim);">ç®¡ç†å‘˜</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Overview Page -->
            <div class="page-section active" id="page-overview">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon blue">ğŸ“Š</div>
                        <div class="stat-value" id="statTotal">0</div>
                        <div class="stat-label">æ€»è®°å½•æ•°</div>
                        <div class="stat-change up">æ•°æ®å®Œæ•´</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon green">ğŸŒ¡ï¸</div>
                        <div class="stat-value" id="statTempRange">-</div>
                        <div class="stat-label">æ¸©åº¦èŒƒå›´ (K)</div>
                        <div class="stat-change">æ•°æ®åˆ†å¸ƒå‡åŒ€</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon yellow">ğŸ’¨</div>
                        <div class="stat-value" id="statPressureRange">-</div>
                        <div class="stat-label">å‹åŠ›èŒƒå›´ (MPa)</div>
                        <div class="stat-change">è¦†ç›–å®Œæ•´</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon purple">ğŸ’¾</div>
                        <div class="stat-value" id="statDbSize">-</div>
                        <div class="stat-label">æ•°æ®åº“å¤§å°</div>
                        <div class="stat-change up">è¿è¡Œæ­£å¸¸</div>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 20px;">
                    <div class="card">
                        <div class="card-header">
                            <h3>ğŸ“ˆ æœ€è¿‘æ•°æ®è®°å½•</h3>
                            <button class="btn btn-secondary" onclick="showPage('records')">æŸ¥çœ‹å…¨éƒ¨</button>
                        </div>
                        <div class="card-body" style="padding: 0;">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>æ¸©åº¦ (K)</th>
                                        <th>å‹åŠ› (MPa)</th>
                                        <th>CHâ‚„</th>
                                        <th>åˆ›å»ºæ—¶é—´</th>
                                    </tr>
                                </thead>
                                <tbody id="recentRecords"></tbody>
                            </table>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h3>â„¹ï¸ ç³»ç»Ÿä¿¡æ¯</h3>
                        </div>
                        <div class="card-body">
                            <div class="info-item">
                                <span class="info-label">ç³»ç»Ÿç‰ˆæœ¬</span>
                                <span class="info-value">v3.0.0</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">åç«¯æ¡†æ¶</span>
                                <span class="info-value">FastAPI</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">å‰ç«¯æ¡†æ¶</span>
                                <span class="info-value">Vue 3</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">æ•°æ®åº“</span>
                                <span class="info-value">SQLite</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">APIçŠ¶æ€</span>
                                <span class="info-value" style="color: var(--success);">â— æ­£å¸¸</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">æœåŠ¡å™¨æ—¶é—´</span>
                                <span class="info-value" id="serverTime">-</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Database Page -->
            <div class="page-section" id="page-database">
                <div class="card">
                    <div class="card-header">
                        <h3>ğŸ—ƒï¸ æ•°æ®åº“æ“ä½œ</h3>
                    </div>
                    <div class="card-body">
                        <div class="db-actions">
                            <div class="action-card" onclick="backupDatabase()">
                                <div class="icon">ğŸ’¾</div>
                                <h4>å¤‡ä»½æ•°æ®åº“</h4>
                                <p>å¯¼å‡ºå®Œæ•´æ•°æ®åº“å¤‡ä»½æ–‡ä»¶</p>
                            </div>
                            <div class="action-card" onclick="exportAllData()">
                                <div class="icon">ğŸ“¥</div>
                                <h4>å¯¼å‡ºæ‰€æœ‰æ•°æ®</h4>
                                <p>å¯¼å‡ºä¸º Excel æ ¼å¼</p>
                            </div>
                            <div class="action-card" onclick="optimizeDatabase()">
                                <div class="icon">âš¡</div>
                                <h4>ä¼˜åŒ–æ•°æ®åº“</h4>
                                <p>æ¸…ç†ç¢ç‰‡ï¼Œæå‡æ€§èƒ½</p>
                            </div>
                            <div class="action-card" onclick="showClearConfirm()">
                                <div class="icon">ğŸ—‘ï¸</div>
                                <h4>æ¸…ç©ºæ•°æ®</h4>
                                <p>åˆ é™¤æ‰€æœ‰è®°å½•ï¼ˆå±é™©æ“ä½œï¼‰</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3>ğŸ“Š æ•°æ®åº“çŠ¶æ€</h3>
                    </div>
                    <div class="card-body">
                        <div class="info-grid">
                            <div>
                                <div class="info-item">
                                    <span class="info-label">æ•°æ®è¡¨</span>
                                    <span class="info-value">gas_mixture</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">æ€»è®°å½•æ•°</span>
                                    <span class="info-value" id="dbRecordCount">0</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">æ•°æ®åº“æ–‡ä»¶</span>
                                    <span class="info-value">gas_data.db</span>
                                </div>
                            </div>
                            <div>
                                <div class="info-item">
                                    <span class="info-label">å­—æ®µæ•°é‡</span>
                                    <span class="info-value">12 ä¸ªå­—æ®µ</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">ç´¢å¼•</span>
                                    <span class="info-value">ä¸»é”®ç´¢å¼•</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">æœ€åæ›´æ–°</span>
                                    <span class="info-value" id="lastUpdate">-</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Records Page -->
            <div class="page-section" id="page-records">
                <div class="card">
                    <div class="card-header">
                        <h3>ğŸ“‹ å…¨éƒ¨æ•°æ®è®°å½•</h3>
                        <div style="display: flex; gap: 10px;">
                            <button class="btn btn-primary" onclick="window.open('/')">å‰å¾€å‰å°ç®¡ç†</button>
                        </div>
                    </div>
                    <div class="card-body" style="padding: 0;">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>æ¸©åº¦ (K)</th>
                                    <th>CHâ‚„</th>
                                    <th>Câ‚‚Hâ‚†</th>
                                    <th>Câ‚ƒHâ‚ˆ</th>
                                    <th>COâ‚‚</th>
                                    <th>Nâ‚‚</th>
                                    <th>Hâ‚‚S</th>
                                    <th>i-Câ‚„Hâ‚â‚€</th>
                                    <th>å‹åŠ› (MPa)</th>
                                </tr>
                            </thead>
                            <tbody id="allRecords"></tbody>
                        </table>
                    </div>
                </div>
                <div style="text-align: center; padding: 20px;">
                    <button class="btn btn-secondary" id="loadMoreBtn" onclick="loadMoreRecords()">åŠ è½½æ›´å¤š</button>
                </div>
            </div>

            <!-- Visualization Page -->
            <div class="page-section" id="page-visualization">
                <div class="card">
                    <div class="card-header">
                        <h3>ğŸ›ï¸ å¯è§†åŒ–å‚æ•°</h3>
                        <button class="btn btn-secondary" onclick="loadVisualization()">åˆ·æ–°å›¾è¡¨</button>
                    </div>
                    <div class="card-body">
                        <div class="viz-controls">
                            <div class="viz-control">
                                <label>æ•£ç‚¹å›¾è¯´æ˜</label>
                                <div style="color: var(--text-dim); font-size: 13px; line-height: 1.6;">
                                    ç‚¹ä½è¡¨ç¤ºæ¸©åº¦-å‹åŠ›åˆ†å¸ƒï¼Œé¢œè‰²æŒ‰å‹åŠ›é«˜ä½æ¸å˜ã€‚
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3>ğŸ”µ æ¸©åº¦-å‹åŠ›æ•£ç‚¹å›¾</h3>
                        <span class="badge">å‹åŠ›ç€è‰²</span>
                    </div>
                    <div class="card-body">
                        <div class="chart-wrap large" id="scatterChart"></div>
                    </div>
                </div>
            </div>

            <!-- Import/Export Page -->
            <div class="page-section" id="page-import">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div class="card">
                        <div class="card-header">
                            <h3>ğŸ“¤ æ•°æ®å¯¼å…¥</h3>
                        </div>
                        <div class="card-body">
                            <p style="color: var(--text-dim); margin-bottom: 20px;">æ”¯æŒ CSV å’Œ Excel æ–‡ä»¶æ ¼å¼</p>
                            <input type="file" id="importFile" accept=".csv,.xlsx,.xls" style="display: none;" onchange="handleImport(event)">
                            <input type="file" id="importPreviewFile" accept=".csv,.xlsx,.xls" style="display: none;" onchange="handleImportPreview(event)">
                            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                                <button class="btn btn-primary" onclick="document.getElementById('importFile').click()">
                                ğŸ“ é€‰æ‹©æ–‡ä»¶å¯¼å…¥
                                </button>
                                <button class="btn btn-secondary" onclick="document.getElementById('importPreviewFile').click()">
                                    ğŸ” æ ¡éªŒé¢„è§ˆ
                                </button>
                            </div>
                            <div style="display: flex; gap: 10px; margin-top: 12px; flex-wrap: wrap;">
                                <button class="btn btn-secondary" onclick="downloadCSVTemplate()">â¬‡ï¸ CSV æ¨¡æ¿</button>
                                <button class="btn btn-secondary" onclick="downloadExcelTemplate()">â¬‡ï¸ Excel æ¨¡æ¿</button>
                            </div>
                            <div id="importPreviewResult" style="margin-top: 16px;"></div>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <h3>ğŸ“¥ æ•°æ®å¯¼å‡º</h3>
                        </div>
                        <div class="card-body">
                            <p style="color: var(--text-dim); margin-bottom: 20px;">å¯¼å‡ºæ‰€æœ‰æ•°æ®è®°å½•</p>
                            <button class="btn btn-secondary" onclick="exportCSV()" style="margin-right: 10px;">
                                ğŸ“„ å¯¼å‡º CSV
                            </button>
                            <button class="btn btn-primary" onclick="exportExcel()">
                                ğŸ“Š å¯¼å‡º Excel
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Logs Page -->
            <div class="page-section" id="page-logs">
                <div class="card">
                    <div class="card-header">
                        <h3>ğŸ“ æ“ä½œæ—¥å¿—</h3>
                        <button class="btn btn-secondary" onclick="clearLogs()">æ¸…ç©ºæ—¥å¿—</button>
                    </div>
                    <div class="card-body">
                        <div id="activityLogs">
                            <div class="activity-item">
                                <div class="activity-icon update">ğŸ‘¤</div>
                                <div class="activity-content">
                                    <h4>ç®¡ç†å‘˜ç™»å½•</h4>
                                    <p>ç®¡ç†å‘˜ admin ç™»å½•ç³»ç»Ÿ</p>
                                </div>
                                <div class="activity-time">åˆšåˆš</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Settings Page -->
            <div class="page-section" id="page-settings">
                <div class="card">
                    <div class="card-header">
                        <h3>âš™ï¸ ç³»ç»Ÿè®¾ç½®</h3>
                    </div>
                    <div class="card-body">
                        <div class="form-group">
                            <label>ç³»ç»Ÿåç§°</label>
                            <input type="text" value="æ°”ä½“æ··åˆç‰©æ•°æ®ç®¡ç†ç³»ç»Ÿ" style="max-width: 400px;">
                        </div>
                        <div class="form-group">
                            <label>æ¯é¡µæ˜¾ç¤ºæ¡æ•°</label>
                            <input type="number" value="15" style="max-width: 200px;">
                        </div>
                        <div class="form-group">
                            <label>API åŸºç¡€åœ°å€</label>
                            <input type="text" value="/api" readonly style="max-width: 400px;">
                        </div>
                        <button class="btn btn-primary" onclick="showToast('è®¾ç½®å·²ä¿å­˜')">ğŸ’¾ ä¿å­˜è®¾ç½®</button>
                    </div>
                </div>
            </div>

            <!-- Backup Page -->
            <div class="page-section" id="page-backup">
                <div class="stats-grid" style="grid-template-columns: repeat(3, 1fr);">
                    <div class="stat-card">
                        <div class="stat-icon green">ğŸ’¾</div>
                        <div class="stat-value" id="backupCount">0</div>
                        <div class="stat-label">å¤‡ä»½æ–‡ä»¶æ•°</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon blue">ğŸ“Š</div>
                        <div class="stat-value" id="backupTotalSize">0 KB</div>
                        <div class="stat-label">æ€»å¤‡ä»½å¤§å°</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon purple">â±ï¸</div>
                        <div class="stat-value" id="backupInterval">6h</div>
                        <div class="stat-label">å¤‡ä»½é—´éš”</div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3>ğŸ’¾ å¤‡ä»½æ“ä½œ</h3>
                        <button class="btn btn-primary" id="backupCreateButton" onclick="createBackup()">â• ç«‹å³å¤‡ä»½</button>
                    </div>
                    <div class="card-body">
                        <p style="color: var(--text-dim); margin-bottom: 20px;">
                            ç³»ç»Ÿä¼šè‡ªåŠ¨æ¯ 6 å°æ—¶å¤‡ä»½ä¸€æ¬¡æ•°æ®åº“ï¼Œæœ€å¤šä¿ç•™ 10 ä¸ªå¤‡ä»½æ–‡ä»¶ã€‚
                        </p>
                        <div id="backupStatus" style="padding: 16px; background: var(--bg-input); border-radius: 10px; margin-bottom: 20px;">
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <span style="color: var(--success); font-size: 20px;">â—</span>
                                <span>è‡ªåŠ¨å¤‡ä»½å·²å¯ç”¨</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3>ğŸ“‹ å¤‡ä»½æ–‡ä»¶åˆ—è¡¨</h3>
                        <button class="btn btn-secondary" onclick="loadBackups()">ğŸ”„ åˆ·æ–°</button>
                    </div>
                    <div class="card-body" style="padding: 0;">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>æ–‡ä»¶å</th>
                                    <th>ç±»å‹</th>
                                    <th>å¤§å°</th>
                                    <th>åˆ›å»ºæ—¶é—´</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="backupList"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Users Page -->
            <div class="page-section" id="page-users">
                <div class="card">
                    <div class="card-header">
                        <h3>ğŸ‘¥ ç”¨æˆ·ç®¡ç†</h3>
                        <button class="btn btn-primary" onclick="showCreateUserModal()">â• æ·»åŠ ç”¨æˆ·</button>
                    </div>
                    <div class="card-body" style="padding: 0;">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>ç”¨æˆ·å</th>
                                    <th>è§’è‰²</th>
                                    <th>åˆ›å»ºæ—¶é—´</th>
                                    <th>çŠ¶æ€</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="userList">
                                <tr>
                                    <td>admin</td>
                                    <td><span style="background: var(--accent); padding: 4px 12px; border-radius: 20px; font-size: 12px;">ç®¡ç†å‘˜</span></td>
                                    <td>2024-01-01</td>
                                    <td><span style="color: var(--success);">â— åœ¨çº¿</span></td>
                                    <td>-</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3>ğŸ” ä¿®æ”¹å¯†ç </h3>
                    </div>
                    <div class="card-body">
                        <div class="form-group">
                            <label>å½“å‰å¯†ç </label>
                            <input type="password" id="oldPassword" placeholder="è¯·è¾“å…¥å½“å‰å¯†ç " style="max-width: 400px;">
                        </div>
                        <div class="form-group">
                            <label>æ–°å¯†ç </label>
                            <input type="password" id="newPassword" placeholder="è¯·è¾“å…¥æ–°å¯†ç " style="max-width: 400px;">
                        </div>
                        <div class="form-group">
                            <label>ç¡®è®¤æ–°å¯†ç </label>
                            <input type="password" id="confirmPassword" placeholder="å†æ¬¡è¾“å…¥æ–°å¯†ç " style="max-width: 400px;">
                        </div>
                        <button class="btn btn-primary" onclick="changePassword()">ğŸ”‘ ä¿®æ”¹å¯†ç </button>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3>ğŸ”’ å®‰å…¨ä¿¡æ¯</h3>
                    </div>
                    <div class="card-body">
                        <div class="info-item">
                            <span class="info-label">è®¤è¯æ–¹å¼</span>
                            <span class="info-value">JWT Token</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">å¯†ç åŠ å¯†</span>
                            <span class="info-value">PBKDF2-SHA256</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Token æœ‰æ•ˆæœŸ</span>
                            <span class="info-value">24 å°æ—¶</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">å½“å‰ä¼šè¯</span>
                            <span class="info-value" style="color: var(--success);">â— æœ‰æ•ˆ</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- TOTP Page -->
            <div class="page-section" id="page-totp">
                <div class="card">
                    <div class="card-header">
                        <h3>ğŸ” ä¸¤æ­¥éªŒè¯è®¾ç½®</h3>
                    </div>
                    <div class="card-body">
                        <div id="totpStatus">
                            <p style="color: var(--text-dim); margin-bottom: 20px;">
                                ä¸¤æ­¥éªŒè¯ä¸ºæ‚¨çš„è´¦æˆ·æä¾›é¢å¤–çš„å®‰å…¨ä¿æŠ¤ã€‚å¯ç”¨åï¼Œç™»å½•æ—¶éœ€è¦è¾“å…¥éªŒè¯å™¨Appç”Ÿæˆçš„åŠ¨æ€éªŒè¯ç ã€‚
                            </p>
                            <div id="totpNotEnabled" style="display: none;">
                                <button class="btn btn-primary" onclick="setupTOTP()">ğŸ” è®¾ç½®ä¸¤æ­¥éªŒè¯</button>
                            </div>
                            <div id="totpEnabled" style="display: none;">
                                <div style="padding: 16px; background: rgba(72, 187, 120, 0.1); border: 1px solid var(--success); border-radius: 10px; margin-bottom: 20px;">
                                    <span style="color: var(--success);">âœ“ ä¸¤æ­¥éªŒè¯å·²å¯ç”¨</span>
                                </div>
                                <button class="btn btn-danger" onclick="disableTOTP()">ç¦ç”¨ä¸¤æ­¥éªŒè¯</button>
                                <button class="btn btn-secondary" onclick="regenerateBackupCodes()" style="margin-left: 10px;">é‡æ–°ç”Ÿæˆå¤‡ç”¨ç </button>
                            </div>
                        </div>
                        <div id="totpSetup" style="display: none; margin-top: 20px;">
                            <h4 style="margin-bottom: 15px;">è®¾ç½®ä¸¤æ­¥éªŒè¯</h4>
                            <p style="color: var(--text-dim); margin-bottom: 15px;">è¯·ä½¿ç”¨éªŒè¯å™¨Appï¼ˆå¦‚ Google Authenticatorï¼‰æ‰«æä¸‹æ–¹äºŒç»´ç æˆ–æ‰‹åŠ¨è¾“å…¥å¯†é’¥ï¼š</p>
                            <div style="background: var(--bg-input); padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                                <p style="font-family: 'Fira Code', monospace; word-break: break-all;" id="totpSecret"></p>
                            </div>
                            <div class="form-group">
                                <label>è¾“å…¥éªŒè¯ç ç¡®è®¤</label>
                                <input type="text" id="totpCode" placeholder="6ä½æ•°å­—éªŒè¯ç " style="max-width: 200px;">
                            </div>
                            <button class="btn btn-primary" onclick="enableTOTP()">âœ“ ç¡®è®¤å¯ç”¨</button>
                            <button class="btn btn-secondary" onclick="cancelTOTPSetup()">å–æ¶ˆ</button>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3>ğŸ“‹ å¯†ç ç­–ç•¥</h3>
                    </div>
                    <div class="card-body">
                        <div class="info-item">
                            <span class="info-label">æœ€å°é•¿åº¦</span>
                            <span class="info-value">8 ä½</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">å¿…é¡»åŒ…å«å¤§å†™å­—æ¯</span>
                            <span class="info-value" style="color: var(--success);">âœ“ æ˜¯</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">å¿…é¡»åŒ…å«å°å†™å­—æ¯</span>
                            <span class="info-value" style="color: var(--success);">âœ“ æ˜¯</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">å¿…é¡»åŒ…å«æ•°å­—</span>
                            <span class="info-value" style="color: var(--success);">âœ“ æ˜¯</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">å¿…é¡»åŒ…å«ç‰¹æ®Šå­—ç¬¦</span>
                            <span class="info-value" style="color: var(--text-dim);">âœ— å¦</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sessions Page -->
            <div class="page-section" id="page-sessions">
                <div class="card">
                    <div class="card-header">
                        <h3>ğŸ“± æ´»è·ƒä¼šè¯</h3>
                        <button class="btn btn-danger" onclick="revokeAllSessions()">æ’¤é”€æ‰€æœ‰å…¶ä»–ä¼šè¯</button>
                    </div>
                    <div class="card-body" style="padding: 0;">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>IP åœ°å€</th>
                                    <th>è®¾å¤‡/æµè§ˆå™¨</th>
                                    <th>ç™»å½•æ—¶é—´</th>
                                    <th>æœ€åæ´»è·ƒ</th>
                                    <th>çŠ¶æ€</th>
                                </tr>
                            </thead>
                            <tbody id="sessionList"></tbody>
                        </table>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3>ğŸ›¡ï¸ API é™æµçŠ¶æ€</h3>
                    </div>
                    <div class="card-body">
                        <div class="info-item">
                            <span class="info-label">å½“å‰ IP</span>
                            <span class="info-value" id="currentIP">-</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">è¯·æ±‚æ¬¡æ•°ï¼ˆ1åˆ†é’Ÿå†…ï¼‰</span>
                            <span class="info-value" id="requestCount">-</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">é™åˆ¶</span>
                            <span class="info-value">60 æ¬¡/åˆ†é’Ÿ</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">çŠ¶æ€</span>
                            <span class="info-value" id="rateLimitStatus" style="color: var(--success);">â— æ­£å¸¸</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Review Page -->
            <div class="page-section" id="page-review">
                <div class="stats-grid" style="grid-template-columns: repeat(4, 1fr);">
                    <div class="stat-card clickable" id="pendingGroupsCard">
                        <div class="stat-icon yellow">â³</div>
                        <div class="stat-value" id="pendingGroups">0</div>
                        <div class="stat-label">å¾…å®¡æ ¸ç»„æ•°</div>
                    </div>
                    <div class="stat-card clickable" id="pendingRecordsCard">
                        <div class="stat-icon blue">ğŸ“Š</div>
                        <div class="stat-value" id="pendingRecords">0</div>
                        <div class="stat-label">å¾…å®¡æ ¸è®°å½•</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon green">âœ“</div>
                        <div class="stat-value" id="approvedRecords">0</div>
                        <div class="stat-label">å·²é€šè¿‡</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon" style="background: rgba(245,101,101,0.2);">âœ—</div>
                        <div class="stat-value" id="rejectedRecords">0</div>
                        <div class="stat-label">å·²æ‹’ç»</div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3>ğŸ” æ•°æ®ç­›é€‰</h3>
                        <div style="display: flex; gap: 10px;">
                            <button class="btn btn-primary" onclick="scanDuplicates()">æ‰«æé‡å¤æ•°æ®</button>
                            <button class="btn btn-danger" onclick="moveDuplicatesToReview()">ç§»åˆ°å¾…å®¡æ ¸åŒº</button>
                        </div>
                    </div>
                    <div class="card-body">
                        <p style="color: var(--text-dim);">
                            ç‚¹å‡»"æ‰«æé‡å¤æ•°æ®"æŸ¥æ‰¾åŒç»„åˆ†ã€åŒæ¸©åº¦ä¸‹æœ‰å¤šä¸ªä¸åŒå‹åŠ›å€¼çš„æ•°æ®ã€‚<br>
                            ç¡®è®¤åç‚¹å‡»"ç§»åˆ°å¾…å®¡æ ¸åŒº"å°†è¿™äº›æ•°æ®ç§»å‡ºæ­£å¼æ•°æ®åº“ï¼Œç­‰å¾…äººå·¥å®¡æ ¸ã€‚
                        </p>
                        <div id="duplicateResults" style="margin-top: 20px;"></div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3>âœ… å¾…å®¡æ ¸æ•°æ®</h3>
                        <button class="btn btn-secondary" onclick="loadPendingGroups()">ğŸ”„ åˆ·æ–°</button>
                    </div>
                    <div class="card-body">
                        <div id="pendingBatchActions" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                            <div style="display: flex; align-items: center; gap: 12px; font-size: 13px;">
                                <label style="display: flex; align-items: center; gap: 6px;">
                                    <input type="checkbox" id="pendingSelectAll" onchange="toggleSelectAllPending(this.checked)" style="accent-color: var(--accent);">
                                    æœ¬é¡µå…¨é€‰
                                </label>
                                <span style="color: var(--text-dim);">å·²é€‰ <span id="pendingSelectedCount">0</span> ç»„</span>
                            </div>
                            <div style="display: flex; gap: 8px;">
                                <button class="btn btn-primary" onclick="batchApproveGroups()">æ‰¹é‡é€šè¿‡</button>
                                <button class="btn btn-danger" onclick="batchRejectGroups()">æ‰¹é‡æ‹’ç»</button>
                            </div>
                        </div>
                        <div id="pendingFilters" style="display: flex; flex-wrap: wrap; gap: 10px; align-items: center; margin-bottom: 12px;">
                            <input type="text" id="pendingFilterGroupId" placeholder="ç»„ID" style="max-width: 160px;">
                            <input type="number" id="pendingTempMin" placeholder="æ¸©åº¦ â‰¥" style="max-width: 120px;">
                            <input type="number" id="pendingTempMax" placeholder="æ¸©åº¦ â‰¤" style="max-width: 120px;">
                            <button class="btn btn-primary" onclick="applyPendingFilters()">ç­›é€‰</button>
                            <button class="btn btn-secondary" onclick="clearPendingFilters()">æ¸…ç©º</button>
                        </div>
                        <div id="pendingGroupsContainer">
                            <p style="color: var(--text-dim); text-align: center;">ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®åŠ è½½å¾…å®¡æ ¸æ•°æ®</p>
                        </div>
                        <div id="pendingGroupsPagination" style="display: flex; justify-content: space-between; align-items: center; margin-top: 16px;"></div>
                    </div>
                </div>
            </div>

            <!-- History Page -->
            <div class="page-section" id="page-history">
                <div class="card">
                    <div class="card-header">
                        <h3>ğŸ“œ æ•°æ®ä¿®æ”¹å†å²</h3>
                        <button class="btn btn-secondary" onclick="loadHistory()">ğŸ”„ åˆ·æ–°</button>
                    </div>
                    <div class="card-body">
                        <div style="display: flex; flex-wrap: wrap; gap: 10px; align-items: center;">
                            <input type="number" id="historyRecordId" placeholder="è®°å½•ID" style="max-width: 140px;">
                            <select id="historyAction" style="max-width: 140px;">
                                <option value="">å…¨éƒ¨æ“ä½œ</option>
                                <option value="CREATE">CREATE</option>
                                <option value="UPDATE">UPDATE</option>
                                <option value="DELETE">DELETE</option>
                            </select>
                            <input type="text" id="historyUsername" placeholder="æ“ä½œè€…" style="max-width: 160px;">
                            <button class="btn btn-primary" onclick="loadHistory()">ç­›é€‰</button>
                            <button class="btn btn-secondary" onclick="exportHistoryCsv()">å¯¼å‡º CSV</button>
                        </div>
                    </div>
                    <div class="card-body" style="padding: 0;">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>è®°å½•ID</th>
                                    <th>æ“ä½œ</th>
                                    <th>å­—æ®µ</th>
                                    <th>æ—§å€¼</th>
                                    <th>æ–°å€¼</th>
                                    <th>æ“ä½œè€…</th>
                                    <th>æ—¶é—´</th>
                                </tr>
                            </thead>
                            <tbody id="historyList"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Logs Page (Login Logs) -->
            <div class="page-section" id="page-logs">
                <div class="card">
                    <div class="card-header">
                        <h3>ğŸ“ ç™»å½•æ—¥å¿—</h3>
                        <button class="btn btn-secondary" onclick="loadLoginLogs()">ğŸ”„ åˆ·æ–°</button>
                    </div>
                    <div class="card-body" style="padding: 0;">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>ç”¨æˆ·å</th>
                                    <th>IP åœ°å€</th>
                                    <th>çŠ¶æ€</th>
                                    <th>å¤±è´¥åŸå› </th>
                                    <th>æ—¶é—´</th>
                                </tr>
                            </thead>
                            <tbody id="loginLogList"></tbody>
                        </table>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3>ğŸ” å®¡è®¡æ—¥å¿—</h3>
                        <button class="btn btn-secondary" onclick="loadAuditLogs()">ğŸ”„ åˆ·æ–°</button>
                    </div>
                    <div class="card-body">
                        <div style="display: flex; flex-wrap: wrap; gap: 10px; align-items: center;">
                            <input type="text" id="auditUsername" placeholder="ç”¨æˆ·å" style="max-width: 160px;">
                            <input type="text" id="auditAction" placeholder="æ“ä½œç±»å‹" style="max-width: 160px;">
                            <button class="btn btn-primary" onclick="loadAuditLogs()">ç­›é€‰</button>
                            <button class="btn btn-secondary" onclick="exportAuditCsv()">å¯¼å‡º CSV</button>
                        </div>
                    </div>
                    <div class="card-body" style="padding: 0;">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>ç”¨æˆ·</th>
                                    <th>æ“ä½œ</th>
                                    <th>èµ„æº</th>
                                    <th>èµ„æºID</th>
                                    <th>IP</th>
                                    <th>æ—¶é—´</th>
                                </tr>
                            </thead>
                            <tbody id="auditLogList"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
    <script>
        // å…¨å±€å˜é‡
        let currentPage = 1;
        const perPage = 20;
        let pendingPage = 1;
        const pendingPerPage = 20;
        let pendingGroupIds = [];
        let pendingSelection = new Set();
        let lastImportPreview = null;
        const BASE_PATH = window.location.pathname.indexOf('/thermodynamic') === 0 ? '/thermodynamic' : '';
        const API_BASE = `${BASE_PATH}/api`;
        let authToken = localStorage.getItem('authToken');
        let scatterChart = null;
        let visualizationReady = false;
        let pendingRecordId = null;
        let highlightTimer = null;


        // è·å–å¸¦è®¤è¯çš„è¯·æ±‚å¤´
        function getAuthHeaders() {
            return {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${authToken}`
            };
        }

        function getAuthHeaderOnly() {
            return {
                'Authorization': `Bearer ${authToken}`
            };
        }

        const frontHomeLink = document.getElementById('frontHomeLink');
        if (frontHomeLink) frontHomeLink.setAttribute('href', `${BASE_PATH}/`);
        const apiDocsLink = document.getElementById('apiDocsLink');
        if (apiDocsLink) apiDocsLink.setAttribute('href', `${BASE_PATH}/docs`);

        // ç™»å½•å¤„ç†
        document.getElementById('loginForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            try {
                const res = await fetch(`${API_BASE}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                const data = await res.json();

                if (data.success) {
                    authToken = data.data.access_token;
                    localStorage.setItem('authToken', authToken);
                    document.getElementById('loginPage').style.display = 'none';
                    document.getElementById('dashboard').classList.add('active');
                    loadDashboardData();
                    addLog('ğŸ‘¤', 'ç®¡ç†å‘˜ç™»å½•', `ç®¡ç†å‘˜ ${username} ç™»å½•ç³»ç»Ÿ`, 'update');
                } else {
                    document.getElementById('loginError').style.display = 'block';
                    document.getElementById('loginError').textContent = data.detail || 'ç™»å½•å¤±è´¥';
                }
            } catch (error) {
                document.getElementById('loginError').style.display = 'block';
                document.getElementById('loginError').textContent = 'ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•';
            }
        });

        // éªŒè¯ Token æœ‰æ•ˆæ€§
        async function validateToken() {
            if (!authToken) return false;
            try {
                const res = await fetch(`${API_BASE}/auth/me`, {
                    headers: getAuthHeaders()
                });
                return res.ok;
            } catch (error) {
                return false;
            }
        }

        // æ£€æŸ¥ç™»å½•çŠ¶æ€
        (async function() {
            if (authToken && await validateToken()) {
                document.getElementById('loginPage').style.display = 'none';
                document.getElementById('dashboard').classList.add('active');
                loadDashboardData();
            } else {
                localStorage.removeItem('authToken');
                authToken = null;
            }
        })();

        // é€€å‡ºç™»å½•
        function logout() {
            localStorage.removeItem('authToken');
            authToken = null;
            location.reload();
        }

        // å¯¼èˆªåˆ‡æ¢
        document.querySelectorAll('.nav-item[data-page]').forEach(item => {
            item.addEventListener('click', function() {
                const page = this.dataset.page;
                showPage(page);
            });
        });

        function showPage(page) {
            // æ›´æ–°å¯¼èˆªçŠ¶æ€
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            const navItem = document.querySelector(`.nav-item[data-page="${page}"]`);
            if (navItem) navItem.classList.add('active');

            // åˆ‡æ¢é¡µé¢
            document.querySelectorAll('.page-section').forEach(p => p.classList.remove('active'));
            document.getElementById(`page-${page}`).classList.add('active');

            // æ›´æ–°æ ‡é¢˜
                const titles = {
                    'overview': ['ç³»ç»Ÿæ¦‚è§ˆ', 'æŸ¥çœ‹ç³»ç»Ÿè¿è¡ŒçŠ¶æ€å’Œæ•°æ®ç»Ÿè®¡'],
                    'database': ['æ•°æ®åº“ç®¡ç†', 'ç®¡ç†å’Œç»´æŠ¤æ•°æ®åº“'],
                    'backup': ['è‡ªåŠ¨å¤‡ä»½', 'ç®¡ç†æ•°æ®åº“å¤‡ä»½'],
                    'records': ['æ•°æ®è®°å½•', 'æŸ¥çœ‹æ‰€æœ‰æ•°æ®è®°å½•'],
                    'visualization': ['é«˜çº§å¯è§†åŒ–', 'æ¢ç´¢æ•°æ®åˆ†å¸ƒä¸è¶‹åŠ¿'],
                    'review': ['æ•°æ®å®¡æ ¸', 'å®¡æ ¸åŒç»„åˆ†åŒæ¸©åº¦ä¸‹çš„å¤šå‹åŠ›å€¼æ•°æ®'],
                    'import': ['å¯¼å…¥å¯¼å‡º', 'æ‰¹é‡å¯¼å…¥å’Œå¯¼å‡ºæ•°æ®'],
                    'history': ['æ•°æ®å†å²', 'æŸ¥çœ‹æ•°æ®ä¿®æ”¹è®°å½•'],
                    'users': ['ç”¨æˆ·ç®¡ç†', 'ç®¡ç†ç³»ç»Ÿç”¨æˆ·å’Œæƒé™'],
                'totp': ['ä¸¤æ­¥éªŒè¯', 'è®¾ç½®è´¦æˆ·ä¸¤æ­¥éªŒè¯'],
                'sessions': ['ä¼šè¯ç®¡ç†', 'ç®¡ç†ç™»å½•ä¼šè¯'],
                'logs': ['ç™»å½•æ—¥å¿—', 'æŸ¥çœ‹ç™»å½•è®°å½•'],
                'settings': ['ç³»ç»Ÿè®¾ç½®', 'é…ç½®ç³»ç»Ÿå‚æ•°']
            };
            const title = titles[page] ? titles[page][0] : page;
            const desc = titles[page] ? titles[page][1] : '';
            document.getElementById('pageTitle').textContent = title;
            document.getElementById('pageDesc').textContent = desc;

            // åŠ è½½é¡µé¢æ•°æ®
            if (page === 'records') loadAllRecords();
            if (page === 'visualization') loadVisualization();
            if (page === 'backup') loadBackups();
            if (page === 'users') loadUsers();
            if (page === 'totp') loadTOTPStatus();
            if (page === 'sessions') loadSessions();
            if (page === 'history') loadHistory();
            if (page === 'logs') {
                loadLoginLogs();
                loadAuditLogs();
            }
            if (page === 'review') loadReviewStats();
        }

        async function jumpToPendingReview() {
            const reviewPage = document.getElementById('page-review');
            if (!reviewPage.classList.contains('active')) {
                showPage('review');
            }
            await loadPendingGroups();
            const target = document.getElementById('pendingGroupsContainer');
            if (target) {
                target.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }

        const pendingGroupsCard = document.getElementById('pendingGroupsCard');
        if (pendingGroupsCard) pendingGroupsCard.addEventListener('click', jumpToPendingReview);
        const pendingRecordsCard = document.getElementById('pendingRecordsCard');
        if (pendingRecordsCard) pendingRecordsCard.addEventListener('click', jumpToPendingReview);

        // åŠ è½½ä»ªè¡¨æ¿æ•°æ®
        async function loadDashboardData() {
            try {
                // è·å–ç»Ÿè®¡ä¿¡æ¯
                const statsRes = await fetch(`${API_BASE}/statistics`);
                const stats = await statsRes.json();

                document.getElementById('statTotal').textContent = stats.total_records || 0;
                document.getElementById('recordCount').textContent = stats.total_records || 0;
                document.getElementById('dbRecordCount').textContent = stats.total_records || 0;
                const minTemp = stats.min_temperature !== null && stats.min_temperature !== undefined
                    ? stats.min_temperature.toFixed(0)
                    : 0;
                const maxTemp = stats.max_temperature !== null && stats.max_temperature !== undefined
                    ? stats.max_temperature.toFixed(0)
                    : 0;
                const minPressure = stats.min_pressure !== null && stats.min_pressure !== undefined
                    ? stats.min_pressure.toFixed(1)
                    : 0;
                const maxPressure = stats.max_pressure !== null && stats.max_pressure !== undefined
                    ? stats.max_pressure.toFixed(0)
                    : 0;
                document.getElementById('statTempRange').textContent = `${minTemp}-${maxTemp}`;
                document.getElementById('statPressureRange').textContent = `${minPressure}-${maxPressure}`;

                // è·å–æœ€è¿‘è®°å½•
                const recordsRes = await fetch(`${API_BASE}/records?page=1&per_page=5`);
                const records = await recordsRes.json();
                
                const tbody = document.getElementById('recentRecords');
                tbody.innerHTML = records.records.map(r => `
                    <tr>
                        <td>#${r.id}</td>
                        <td style="color: #ecc94b;">${r.temperature.toFixed(1)}</td>
                        <td style="color: #4299e1;">${r.pressure.toFixed(3)}</td>
                        <td>${r.x_ch4.toFixed(3)}</td>
                        <td>${r.created_at ? new Date(r.created_at).toLocaleDateString() : '-'}</td>
                    </tr>
                `).join('');

                // æ›´æ–°æœåŠ¡å™¨æ—¶é—´
                document.getElementById('serverTime').textContent = new Date().toLocaleString();
                document.getElementById('lastUpdate').textContent = new Date().toLocaleString();

                // ä¼°ç®—æ•°æ®åº“å¤§å°
                const dbSize = (stats.total_records * 0.1).toFixed(1);
                document.getElementById('statDbSize').textContent = `${dbSize} KB`;

            } catch (error) {
                console.error('åŠ è½½æ•°æ®å¤±è´¥:', error);
            }
        }

        // ==================== å¯è§†åŒ– ====================
        function getVizNumber(id, fallback, min, max) {
            const input = document.getElementById(id);
            const raw = parseInt(input.value, 10);
            let value = Number.isFinite(raw) ? raw : fallback;
            if (min !== null && value < min) value = min;
            if (max !== null && value > max) value = max;
            input.value = value;
            return value;
        }

        function initVisualizationCharts() {
            if (!scatterChart) {
                scatterChart = echarts.init(document.getElementById('scatterChart'));
            }
            if (!visualizationReady) {
                window.addEventListener('resize', () => {
                    if (scatterChart) scatterChart.resize();
                });
                visualizationReady = true;
            }
        }

        async function loadVisualization() {
            if (!window.echarts) {
                showToast('å¯è§†åŒ–ç»„ä»¶æœªåŠ è½½', 'error');
                return;
            }

            initVisualizationCharts();

            try {
                const scatterRes = await fetch(`${API_BASE}/chart/scatter-distribution`);
                const scatterData = await scatterRes.json();
                renderScatter(scatterData);
            } catch (error) {
                console.error('å¯è§†åŒ–åŠ è½½å¤±è´¥:', error);
                showToast('å¯è§†åŒ–åŠ è½½å¤±è´¥', 'error');
            }
        }

        function renderScatter(payload) {
            const hasData = payload.data && payload.data.length > 0;
            const pressureMin = hasData ? payload.pressure_min : 0;
            const pressureMax = hasData ? payload.pressure_max : 1;

            scatterChart.setOption({
                backgroundColor: 'transparent',
                tooltip: {
                    trigger: 'item',
                    formatter: (params) => {
                        const point = (params.data && params.data.value) ? params.data.value : (params.data || []);
                        const temp = point[0] !== null && point[0] !== undefined ? point[0] : 0;
                        const pressure = point[1] !== null && point[1] !== undefined ? point[1] : 0;
                        return `æ¸©åº¦ ${temp.toFixed(2)} K<br>å‹åŠ› ${pressure.toFixed(4)} MPa`;
                    }
                },
                grid: { left: 60, right: 70, top: 20, bottom: 50 },
                xAxis: {
                    name: 'æ¸©åº¦ (K)',
                    nameTextStyle: { color: '#a0aec0' },
                    axisLabel: { color: '#a0aec0' },
                    axisLine: { lineStyle: { color: '#2d3748' } },
                    splitLine: { lineStyle: { color: '#1f2937' } }
                },
                yAxis: {
                    name: 'å‹åŠ› (MPa)',
                    nameTextStyle: { color: '#a0aec0' },
                    axisLabel: { color: '#a0aec0' },
                    axisLine: { lineStyle: { color: '#2d3748' } },
                    splitLine: { lineStyle: { color: '#1f2937' } }
                },
                visualMap: {
                    min: pressureMin,
                    max: pressureMax,
                    dimension: 2,
                    right: 10,
                    top: 'middle',
                    calculable: true,
                    textStyle: { color: '#a0aec0' },
                    inRange: {
                        color: ['#4299e1', '#48bb78', '#f6ad55', '#f56565']
                    }
                },
                series: [{
                    type: 'scatter',
                    data: payload.data || [],
                    symbolSize: 8,
                    itemStyle: { opacity: 0.8 }
                }]
            }, true);

            scatterChart.off('click');
            scatterChart.on('click', (params) => {
                const recordId = params.data ? params.data.id : null;
                if (!recordId) return;
                pendingRecordId = recordId;
                currentPage = 1;
                showPage('records');
                showToast(`å·²å®šä½è®°å½• #${recordId}`);
            });
        }

        function renderRecordRow(record, highlight = false) {
            const highlightClass = highlight ? 'highlight-row' : '';
            return `
                <tr id="record-${record.id}" class="${highlightClass}">
                    <td>#${record.id}</td>
                    <td style="color: #ecc94b;">${record.temperature.toFixed(1)}</td>
                    <td>${record.x_ch4.toFixed(3)}</td>
                    <td>${record.x_c2h6.toFixed(3)}</td>
                    <td>${record.x_c3h8.toFixed(3)}</td>
                    <td>${record.x_co2.toFixed(3)}</td>
                    <td>${record.x_n2.toFixed(3)}</td>
                    <td>${record.x_h2s.toFixed(3)}</td>
                    <td>${record.x_ic4h10.toFixed(3)}</td>
                    <td style="color: #4299e1;">${record.pressure.toFixed(3)}</td>
                </tr>
            `;
        }

        async function highlightPendingRecord(currentRecords) {
            if (!pendingRecordId) return;

            const existingRow = document.getElementById(`record-${pendingRecordId}`);
            if (existingRow) {
                existingRow.classList.add('highlight-row');
                existingRow.scrollIntoView({ behavior: 'smooth', block: 'center' });
                clearTimeout(highlightTimer);
                highlightTimer = setTimeout(() => {
                    existingRow.classList.remove('highlight-row');
                }, 5000);
                pendingRecordId = null;
                return;
            }

            try {
                const res = await fetch(`${API_BASE}/records/${pendingRecordId}`);
                if (!res.ok) return;
                const record = await res.json();
                const tbody = document.getElementById('allRecords');
                tbody.insertAdjacentHTML('afterbegin', renderRecordRow(record, true));
                const newRow = document.getElementById(`record-${pendingRecordId}`);
                if (newRow) {
                    newRow.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
                clearTimeout(highlightTimer);
                highlightTimer = setTimeout(() => {
                    if (newRow) newRow.classList.remove('highlight-row');
                }, 5000);
                pendingRecordId = null;
            } catch (error) {
                console.error('å®šä½è®°å½•å¤±è´¥:', error);
            }
        }

        // åŠ è½½æ‰€æœ‰è®°å½•
        async function loadAllRecords() {
            try {
                const res = await fetch(`${API_BASE}/records?page=${currentPage}&per_page=${perPage}`);
                const data = await res.json();

                const tbody = document.getElementById('allRecords');
                if (currentPage === 1) tbody.innerHTML = '';

                tbody.innerHTML += data.records.map(r => renderRecordRow(r)).join('');
                await highlightPendingRecord(data.records);

                // éšè—/æ˜¾ç¤ºåŠ è½½æ›´å¤šæŒ‰é’®
                document.getElementById('loadMoreBtn').style.display = 
                    currentPage >= data.total_pages ? 'none' : 'inline-block';
            } catch (error) {
                console.error('åŠ è½½è®°å½•å¤±è´¥:', error);
            }
        }

        function loadMoreRecords() {
            currentPage++;
            loadAllRecords();
        }

        // åˆ·æ–°æ•°æ®
        function refreshData() {
            loadDashboardData();
            showToast('æ•°æ®å·²åˆ·æ–°');
        }

        // å¯¼å‡ºåŠŸèƒ½
        async function downloadFile(url, filename) {
            try {
                const res = await fetch(url, { headers: getAuthHeaderOnly() });
                if (!res.ok) {
                    const err = await res.json().catch(() => ({}));
                    showToast(err.detail || 'ä¸‹è½½å¤±è´¥', 'error');
                    return;
                }
                const blob = await res.blob();
                const link = document.createElement('a');
                link.href = window.URL.createObjectURL(blob);
                link.download = filename;
                document.body.appendChild(link);
                link.click();
                link.remove();
                window.URL.revokeObjectURL(link.href);
                showToast(`å¼€å§‹ä¸‹è½½ ${filename}`);
            } catch (error) {
                showToast('ä¸‹è½½å¤±è´¥: ' + error.message, 'error');
            }
        }

        function exportCSV() {
            downloadFile(`${API_BASE}/export/csv`, 'gas_data_export.csv');
            addLog('ğŸ“¥', 'å¯¼å‡ºæ•°æ®', 'å¯¼å‡º CSV æ ¼å¼æ•°æ®', 'export');
        }

        function exportExcel() {
            downloadFile(`${API_BASE}/export/excel`, 'gas_data_export.xlsx');
            addLog('ğŸ“¥', 'å¯¼å‡ºæ•°æ®', 'å¯¼å‡º Excel æ ¼å¼æ•°æ®', 'export');
        }

        function exportAllData() {
            exportExcel();
        }

        // å¯¼å…¥åŠŸèƒ½
        async function handleImport(event) {
            const file = event.target.files[0];
            if (!file) return;

            const formData = new FormData();
            formData.append('file', file);

            try {
                const res = await fetch(`${API_BASE}/import`, {
                    method: 'POST',
                    headers: getAuthHeaderOnly(),
                    body: formData
                });
                const result = await res.json();

                if (result.success) {
                    showToast(result.message);
                    addLog('ğŸ“¤', 'å¯¼å…¥æ•°æ®', `æˆåŠŸå¯¼å…¥æ•°æ®: ${file.name}`, 'create');
                    loadDashboardData();
                } else {
                    const detail = result.detail || {};
                    if (detail && detail.errors) {
                        const summary = detail.summary || {};
                        showToast(
                            `å¯¼å…¥æ ¡éªŒå¤±è´¥ï¼š${summary.invalid_count || detail.errors.length} æ¡æ•°æ®ä¸åˆæ³•`,
                            'error'
                        );
                        renderImportPreview({
                            summary: {
                                total: summary.total || 0,
                                valid_count: summary.valid_count || 0,
                                invalid_count: summary.invalid_count || detail.errors.length,
                                warning_count: 0,
                                skipped_count: summary.skipped_count || 0
                            },
                            errors: detail.errors || [],
                            warnings: []
                        });
                    } else {
                        showToast(result.detail || 'å¯¼å…¥å¤±è´¥', 'error');
                    }
                }
            } catch (error) {
                showToast('å¯¼å…¥å¤±è´¥: ' + error.message, 'error');
            }

            event.target.value = '';
        }

        function renderImportPreview(preview) {
            const container = document.getElementById('importPreviewResult');
            if (!preview) {
                container.innerHTML = '';
                lastImportPreview = null;
                return;
            }
            const summary = preview.summary || {};
            const errors = preview.errors || [];
            const warnings = preview.warnings || [];
            lastImportPreview = preview;

            let html = `
                <div style="background: var(--bg-dark); padding: 12px; border-radius: 8px; border: 1px solid var(--border);">
                    <div style="font-weight: 600; margin-bottom: 8px;">å¯¼å…¥æ ¡éªŒé¢„è§ˆ</div>
                    <div style="font-size: 12px; color: var(--text-dim); line-height: 1.6;">
                        æ€»è®¡ ${summary.total || 0} è¡Œï¼Œåˆæ³• ${summary.valid_count || 0} è¡Œï¼Œ
                        ä¸åˆæ³• ${summary.invalid_count || 0} è¡Œï¼Œè½¯æç¤º ${summary.warning_count || 0} è¡Œï¼Œ
                        è·³è¿‡ç©ºè¡Œ ${summary.skipped_count || 0} è¡Œ
                    </div>
                </div>
            `;

            if (errors.length > 0) {
                const shown = errors.slice(0, 10);
                html += `
                    <div style="margin-top: 12px; background: rgba(239,68,68,0.08); border: 1px solid rgba(239,68,68,0.3); padding: 10px; border-radius: 8px;">
                        <div style="font-weight: 600; color: #ef4444; margin-bottom: 6px;">é”™è¯¯ç¤ºä¾‹</div>
                        <ul style="margin: 0; padding-left: 18px; font-size: 12px; color: var(--text);">
                            ${shown.map(item => `<li>ç¬¬ ${item.row} è¡Œï¼š${(item.errors || []).join('ï¼›')}</li>`).join('')}
                        </ul>
                        ${errors.length > shown.length ? `<div style="margin-top: 6px; font-size: 12px; color: var(--text-dim);">ä»…å±•ç¤ºå‰ ${shown.length} æ¡</div>` : ''}
                    </div>
                `;
            }

            if (warnings.length > 0) {
                const shownWarnings = warnings.slice(0, 10);
                html += `
                    <div style="margin-top: 12px; background: rgba(245,158,11,0.08); border: 1px solid rgba(245,158,11,0.3); padding: 10px; border-radius: 8px;">
                        <div style="font-weight: 600; color: #f59e0b; margin-bottom: 6px;">è½¯æç¤ºç¤ºä¾‹</div>
                        <ul style="margin: 0; padding-left: 18px; font-size: 12px; color: var(--text);">
                            ${shownWarnings.map(item => `<li>ç¬¬ ${item.row} è¡Œï¼š${(item.warnings || []).join('ï¼›')}</li>`).join('')}
                        </ul>
                        ${warnings.length > shownWarnings.length ? `<div style="margin-top: 6px; font-size: 12px; color: var(--text-dim);">ä»…å±•ç¤ºå‰ ${shownWarnings.length} æ¡</div>` : ''}
                    </div>
                `;
            }

            if (errors.length > 0 || warnings.length > 0) {
                html += `
                    <div style="margin-top: 12px; display: flex; gap: 8px; flex-wrap: wrap;">
                        ${errors.length > 0 ? '<button class="btn btn-secondary" onclick="downloadImportReport(\'errors\')">ä¸‹è½½é”™è¯¯æŠ¥å‘Š</button>' : ''}
                        ${warnings.length > 0 ? '<button class="btn btn-secondary" onclick="downloadImportReport(\'warnings\')">ä¸‹è½½è½¯æç¤ºæŠ¥å‘Š</button>' : ''}
                    </div>
                `;
            }

            container.innerHTML = html;
        }

        async function handleImportPreview(event) {
            const file = event.target.files[0];
            if (!file) return;

            const formData = new FormData();
            formData.append('file', file);

            try {
                const res = await fetch(`${API_BASE}/import/preview`, {
                    method: 'POST',
                    headers: getAuthHeaderOnly(),
                    body: formData
                });
                const result = await res.json();

                if (result.success) {
                    renderImportPreview(result.data);
                    showToast('æ ¡éªŒé¢„è§ˆå·²ç”Ÿæˆ');
                } else {
                    showToast(result.detail || 'é¢„è§ˆå¤±è´¥', 'error');
                    renderImportPreview(null);
                }
            } catch (error) {
                showToast('é¢„è§ˆå¤±è´¥: ' + error.message, 'error');
                renderImportPreview(null);
            }

            event.target.value = '';
        }

        function buildCsvLine(values) {
            return values.map(value => {
                const text = value === null || value === undefined ? '' : String(value);
                const escaped = text.replace(/"/g, '""');
                return `"${escaped}"`;
            }).join(',');
        }

        function downloadCsvContent(rows, filename) {
            const csv = rows.join('\n');
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            link.remove();
            URL.revokeObjectURL(link.href);
        }

        function downloadImportReport(kind) {
            if (!lastImportPreview) {
                showToast('æš‚æ— å¯ä¸‹è½½çš„æ ¡éªŒç»“æœ', 'error');
                return;
            }
            const rows = [];
            if (kind === 'errors') {
                const errors = lastImportPreview.errors || [];
                if (errors.length === 0) {
                    showToast('æ²¡æœ‰é”™è¯¯è®°å½•', 'error');
                    return;
                }
                rows.push(buildCsvLine(['row', 'errors']));
                errors.forEach(item => {
                    rows.push(buildCsvLine([item.row, (item.errors || []).join('ï¼›')]));
                });
                downloadCsvContent(rows, 'import_errors.csv');
            } else if (kind === 'warnings') {
                const warnings = lastImportPreview.warnings || [];
                if (warnings.length === 0) {
                    showToast('æ²¡æœ‰è½¯æç¤ºè®°å½•', 'error');
                    return;
                }
                rows.push(buildCsvLine(['row', 'warnings']));
                warnings.forEach(item => {
                    rows.push(buildCsvLine([item.row, (item.warnings || []).join('ï¼›')]));
                });
                downloadCsvContent(rows, 'import_warnings.csv');
            }
        }

        // æ•°æ®åº“æ“ä½œ
        async function backupDatabase() {
            await createBackup();
        }

        function optimizeDatabase() {
            showToast('æ•°æ®åº“ä¼˜åŒ–å®Œæˆ');
            addLog('âš¡', 'ä¼˜åŒ–æ•°æ®åº“', 'æ‰§è¡Œæ•°æ®åº“ä¼˜åŒ–æ“ä½œ', 'update');
        }

        function showClearConfirm() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ•°æ®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
                if (confirm('å†æ¬¡ç¡®è®¤ï¼šè¿™å°†åˆ é™¤æ‰€æœ‰è®°å½•ï¼Œæ˜¯å¦ç»§ç»­ï¼Ÿ')) {
                    showToast('åŠŸèƒ½å·²ç¦ç”¨ï¼Œè¯·è”ç³»å¼€å‘è€…', 'error');
                }
            }
        }

        // ==================== å¤‡ä»½åŠŸèƒ½ ====================
        async function loadBackups() {
            try {
                // è·å–å¤‡ä»½çŠ¶æ€
                const statusRes = await fetch(`${API_BASE}/backup/status`, {
                    headers: getAuthHeaders()
                });
                if (statusRes.ok) {
                    const statusData = await statusRes.json();
                    const status = statusData.data;
                    document.getElementById('backupCount').textContent = status.backup_count || 0;
                    document.getElementById('backupTotalSize').textContent = status.total_size || '0 KB';
                    document.getElementById('backupInterval').textContent = status.backup_interval_hours
                        ? `${status.backup_interval_hours}h`
                        : '-';

                    const statusBox = document.getElementById('backupStatus');
                    const createBtn = document.getElementById('backupCreateButton');
                    if (status.backup_interval_hours === 0) {
                        if (statusBox) {
                            statusBox.innerHTML = `
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <span style="color: var(--warning); font-size: 20px;">â—</span>
                                    <span>å½“å‰ä¸ºæ‰˜ç®¡æ•°æ®åº“ï¼Œå¤‡ä»½è¯·åœ¨äº‘æ§åˆ¶å°å®Œæˆ</span>
                                </div>
                            `;
                        }
                        if (createBtn) createBtn.disabled = true;
                    } else {
                        if (statusBox) {
                            statusBox.innerHTML = `
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <span style="color: var(--success); font-size: 20px;">â—</span>
                                    <span>è‡ªåŠ¨å¤‡ä»½å·²å¯ç”¨</span>
                                </div>
                            `;
                        }
                        if (createBtn) createBtn.disabled = false;
                    }
                }

                // è·å–å¤‡ä»½åˆ—è¡¨
                const listRes = await fetch(`${API_BASE}/backup/list`, {
                    headers: getAuthHeaders()
                });
                if (listRes.ok) {
                    const listData = await listRes.json();
                    const backups = listData.data || [];
                    const tbody = document.getElementById('backupList');
                    
                    if (backups.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: var(--text-dim);">æš‚æ— å¤‡ä»½æ–‡ä»¶</td></tr>';
                    } else {
                        tbody.innerHTML = backups.map(b => `
                            <tr>
                                <td>${b.filename}</td>
                                <td><span style="background: ${b.type === 'manual' ? 'var(--accent)' : 'var(--success)'}; padding: 2px 8px; border-radius: 4px; font-size: 12px;">${b.type === 'manual' ? 'æ‰‹åŠ¨' : 'è‡ªåŠ¨'}</span></td>
                                <td>${b.size_formatted}</td>
                                <td>${new Date(b.created_at).toLocaleString()}</td>
                                <td>
                                    <button class="btn btn-secondary" style="padding: 6px 12px; font-size: 12px;" onclick="downloadBackup('${b.filename}')">ä¸‹è½½</button>
                                    <button class="btn btn-secondary" style="padding: 6px 12px; font-size: 12px;" onclick="restoreBackup('${b.filename}')">æ¢å¤</button>
                                    <button class="btn btn-danger" style="padding: 6px 12px; font-size: 12px;" onclick="deleteBackupFile('${b.filename}')">åˆ é™¤</button>
                                </td>
                            </tr>
                        `).join('');
                    }
                }
            } catch (error) {
                console.error('åŠ è½½å¤‡ä»½åˆ—è¡¨å¤±è´¥:', error);
            }
        }

        async function createBackup() {
            try {
                const res = await fetch(`${API_BASE}/backup/create`, {
                    method: 'POST',
                    headers: getAuthHeaders()
                });
                const data = await res.json();
                if (data.success) {
                    showToast('å¤‡ä»½åˆ›å»ºæˆåŠŸ');
                    addLog('ğŸ’¾', 'åˆ›å»ºå¤‡ä»½', 'æ‰‹åŠ¨åˆ›å»ºæ•°æ®åº“å¤‡ä»½', 'create');
                    loadBackups();
                } else {
                    showToast(data.message || data.detail || 'å¤‡ä»½å¤±è´¥', 'error');
                }
            } catch (error) {
                showToast('å¤‡ä»½å¤±è´¥: ' + error.message, 'error');
            }
        }

        function downloadBackup(filename) {
            window.location.href = `${API_BASE}/backup/download/${filename}?token=${authToken}`;
            addLog('ğŸ“¥', 'ä¸‹è½½å¤‡ä»½', `ä¸‹è½½å¤‡ä»½æ–‡ä»¶: ${filename}`, 'export');
        }

        async function restoreBackup(filename) {
            if (!confirm(`ç¡®å®šè¦æ¢å¤å¤‡ä»½ ${filename} å—ï¼Ÿå½“å‰æ•°æ®å°†è¢«è¦†ç›–ï¼`)) return;
            
            try {
                const res = await fetch(`${API_BASE}/backup/restore/${filename}`, {
                    method: 'POST',
                    headers: getAuthHeaders()
                });
                const data = await res.json();
                if (data.success) {
                    showToast('å¤‡ä»½æ¢å¤æˆåŠŸ');
                    addLog('ğŸ”„', 'æ¢å¤å¤‡ä»½', `æ¢å¤å¤‡ä»½: ${filename}`, 'update');
                    loadDashboardData();
                } else {
                    showToast(data.message || data.detail || 'æ¢å¤å¤±è´¥', 'error');
                }
            } catch (error) {
                showToast('æ¢å¤å¤±è´¥: ' + error.message, 'error');
            }
        }

        async function deleteBackupFile(filename) {
            if (!confirm(`ç¡®å®šè¦åˆ é™¤å¤‡ä»½ ${filename} å—ï¼Ÿ`)) return;
            
            try {
                const res = await fetch(`${API_BASE}/backup/${filename}`, {
                    method: 'DELETE',
                    headers: getAuthHeaders()
                });
                const data = await res.json();
                if (data.success) {
                    showToast('å¤‡ä»½å·²åˆ é™¤');
                    addLog('ğŸ—‘ï¸', 'åˆ é™¤å¤‡ä»½', `åˆ é™¤å¤‡ä»½: ${filename}`, 'delete');
                    loadBackups();
                } else {
                    showToast(data.message || data.detail || 'åˆ é™¤å¤±è´¥', 'error');
                }
            } catch (error) {
                showToast('åˆ é™¤å¤±è´¥: ' + error.message, 'error');
            }
        }

        // ==================== ç”¨æˆ·ç®¡ç† ====================
        async function loadUsers() {
            try {
                const res = await fetch(`${API_BASE}/auth/users`, {
                    headers: getAuthHeaders()
                });
                if (res.ok) {
                    const data = await res.json();
                    const users = data.data || [];
                    const tbody = document.getElementById('userList');
                    tbody.innerHTML = users.map(u => `
                        <tr>
                            <td>${u.username}</td>
                            <td><span style="background: ${u.role === 'admin' ? 'var(--accent)' : 'var(--text-dim)'}; padding: 4px 12px; border-radius: 20px; font-size: 12px;">${u.role === 'admin' ? 'ç®¡ç†å‘˜' : 'ç”¨æˆ·'}</span></td>
                            <td>${u.created_at || '-'}</td>
                            <td><span style="color: var(--success);">â— æ´»è·ƒ</span></td>
                            <td>
                                <button class="btn btn-secondary" onclick="resetUserPassword('${u.username}')" style="padding: 4px 10px;">é‡ç½®å¯†ç </button>
                                <button class="btn btn-danger" onclick="revokeUserSessions('${u.username}')" style="padding: 4px 10px;">æ’¤é”€ä¼šè¯</button>
                            </td>
                        </tr>
                    `).join('');
                }
            } catch (error) {
                console.error('åŠ è½½ç”¨æˆ·åˆ—è¡¨å¤±è´¥:', error);
            }
        }

        async function changePassword() {
            const oldPwd = document.getElementById('oldPassword').value;
            const newPwd = document.getElementById('newPassword').value;
            const confirmPwd = document.getElementById('confirmPassword').value;

            if (!oldPwd || !newPwd || !confirmPwd) {
                showToast('è¯·å¡«å†™æ‰€æœ‰å¯†ç å­—æ®µ', 'error');
                return;
            }

            if (newPwd !== confirmPwd) {
                showToast('ä¸¤æ¬¡è¾“å…¥çš„æ–°å¯†ç ä¸ä¸€è‡´', 'error');
                return;
            }

            try {
                const res = await fetch(`${API_BASE}/auth/change-password`, {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({
                        old_password: oldPwd,
                        new_password: newPwd
                    })
                });
                const data = await res.json();
                if (data.success) {
                    showToast('å¯†ç ä¿®æ”¹æˆåŠŸï¼Œè¯·é‡æ–°ç™»å½•');
                    addLog('ğŸ”‘', 'ä¿®æ”¹å¯†ç ', 'ç®¡ç†å‘˜ä¿®æ”¹äº†å¯†ç ', 'update');
                    // æ¸…ç©ºè¡¨å•
                    document.getElementById('oldPassword').value = '';
                    document.getElementById('newPassword').value = '';
                    document.getElementById('confirmPassword').value = '';
                } else {
                    showToast(data.detail || 'å¯†ç ä¿®æ”¹å¤±è´¥', 'error');
                }
            } catch (error) {
                showToast('ä¿®æ”¹å¤±è´¥: ' + error.message, 'error');
            }
        }

        function showCreateUserModal() {
            const username = prompt('è¯·è¾“å…¥æ–°ç”¨æˆ·å:');
            if (!username) return;
            
            const password = prompt('è¯·è¾“å…¥å¯†ç :');
            if (!password) return;
            
            createUser(username, password);
        }

        async function createUser(username, password) {
            try {
                const res = await fetch(`${API_BASE}/auth/users`, {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({
                        username,
                        password,
                        role: 'user'
                    })
                });
                const data = await res.json();
                if (data.success) {
                    showToast('ç”¨æˆ·åˆ›å»ºæˆåŠŸ');
                    addLog('ğŸ‘¤', 'åˆ›å»ºç”¨æˆ·', `åˆ›å»ºæ–°ç”¨æˆ·: ${username}`, 'create');
                    loadUsers();
                } else {
                    showToast(data.detail || 'åˆ›å»ºå¤±è´¥', 'error');
                }
            } catch (error) {
                showToast('åˆ›å»ºå¤±è´¥: ' + error.message, 'error');
            }
        }

        async function resetUserPassword(username) {
            const newPassword = prompt(`è¯·è¾“å…¥ ${username} çš„æ–°å¯†ç :`);
            if (!newPassword) return;

            try {
                const res = await fetch(`${API_BASE}/auth/users/${encodeURIComponent(username)}/reset-password`, {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({ new_password: newPassword })
                });
                const data = await res.json();
                if (data.success) {
                    showToast('å¯†ç å·²é‡ç½®');
                    addLog('ğŸ”‘', 'é‡ç½®å¯†ç ', `é‡ç½®ç”¨æˆ· ${username} å¯†ç `, 'update');
                } else {
                    showToast(data.detail || 'é‡ç½®å¤±è´¥', 'error');
                }
            } catch (error) {
                showToast('é‡ç½®å¤±è´¥: ' + error.message, 'error');
            }
        }

        async function revokeUserSessions(username) {
            if (!confirm(`ç¡®å®šè¦æ’¤é”€ ${username} çš„æ‰€æœ‰ä¼šè¯å—ï¼Ÿ`)) return;

            try {
                const res = await fetch(`${API_BASE}/auth/users/${encodeURIComponent(username)}/sessions/revoke-all`, {
                    method: 'POST',
                    headers: getAuthHeaders()
                });
                const data = await res.json();
                if (data.success) {
                    showToast(data.message || 'ä¼šè¯å·²æ’¤é”€');
                    addLog('ğŸ”’', 'æ’¤é”€ä¼šè¯', `æ’¤é”€ç”¨æˆ· ${username} ä¼šè¯`, 'update');
                } else {
                    showToast(data.detail || 'æ’¤é”€å¤±è´¥', 'error');
                }
            } catch (error) {
                showToast('æ’¤é”€å¤±è´¥: ' + error.message, 'error');
            }
        }

        // æ—¥å¿—åŠŸèƒ½
        function addLog(icon, title, desc, type) {
            const logsContainer = document.getElementById('activityLogs');
            const logHtml = `
                <div class="activity-item">
                    <div class="activity-icon ${type}">${icon}</div>
                    <div class="activity-content">
                        <h4>${title}</h4>
                        <p>${desc}</p>
                    </div>
                    <div class="activity-time">åˆšåˆš</div>
                </div>
            `;
            logsContainer.insertAdjacentHTML('afterbegin', logHtml);
        }

        function clearLogs() {
            document.getElementById('activityLogs').innerHTML = `
                <div class="activity-item">
                    <div class="activity-icon update">ğŸ—‘ï¸</div>
                    <div class="activity-content">
                        <h4>æ—¥å¿—å·²æ¸…ç©º</h4>
                        <p>æ‰€æœ‰æ“ä½œæ—¥å¿—å·²è¢«æ¸…é™¤</p>
                    </div>
                    <div class="activity-time">åˆšåˆš</div>
                </div>
            `;
            showToast('æ—¥å¿—å·²æ¸…ç©º');
        }

        // Toast æç¤º
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 16px 24px;
                background: ${type === 'error' ? '#f56565' : '#48bb78'};
                color: white;
                border-radius: 10px;
                font-weight: 500;
                z-index: 10000;
                animation: slideIn 0.3s ease;
            `;
            toast.textContent = message;
            document.body.appendChild(toast);

            setTimeout(() => {
                toast.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // ==================== TOTP ä¸¤æ­¥éªŒè¯ ====================
        let totpSecret = '';

        async function loadTOTPStatus() {
            try {
                const res = await fetch(`${API_BASE}/auth/totp/status`, {
                    headers: getAuthHeaders()
                });
                if (res.ok) {
                    const data = await res.json();
                    const status = data.data;
                    
                    if (status.enabled) {
                        document.getElementById('totpEnabled').style.display = 'block';
                        document.getElementById('totpNotEnabled').style.display = 'none';
                    } else {
                        document.getElementById('totpEnabled').style.display = 'none';
                        document.getElementById('totpNotEnabled').style.display = 'block';
                    }
                    document.getElementById('totpSetup').style.display = 'none';
                }
            } catch (error) {
                console.error('åŠ è½½TOTPçŠ¶æ€å¤±è´¥:', error);
            }
        }

        async function setupTOTP() {
            try {
                const res = await fetch(`${API_BASE}/auth/totp/setup`, {
                    method: 'POST',
                    headers: getAuthHeaders()
                });
                if (res.ok) {
                    const data = await res.json();
                    totpSecret = data.data.secret;
                    document.getElementById('totpSecret').textContent = totpSecret;
                    document.getElementById('totpSetup').style.display = 'block';
                    document.getElementById('totpNotEnabled').style.display = 'none';
                }
            } catch (error) {
                showToast('è®¾ç½®å¤±è´¥: ' + error.message, 'error');
            }
        }

        async function enableTOTP() {
            const code = document.getElementById('totpCode').value;
            if (!code || code.length !== 6) {
                showToast('è¯·è¾“å…¥6ä½éªŒè¯ç ', 'error');
                return;
            }

            try {
                const res = await fetch(`${API_BASE}/auth/totp/enable`, {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({ code })
                });
                const data = await res.json();
                if (data.success) {
                    showToast('ä¸¤æ­¥éªŒè¯å·²å¯ç”¨');
                    loadTOTPStatus();
                } else {
                    showToast(data.detail || 'éªŒè¯ç é”™è¯¯', 'error');
                }
            } catch (error) {
                showToast('å¯ç”¨å¤±è´¥: ' + error.message, 'error');
            }
        }

        async function disableTOTP() {
            if (!confirm('ç¡®å®šè¦ç¦ç”¨ä¸¤æ­¥éªŒè¯å—ï¼Ÿè¿™å°†é™ä½è´¦æˆ·å®‰å…¨æ€§ã€‚')) return;

            try {
                const res = await fetch(`${API_BASE}/auth/totp/disable`, {
                    method: 'POST',
                    headers: getAuthHeaders()
                });
                if (res.ok) {
                    showToast('ä¸¤æ­¥éªŒè¯å·²ç¦ç”¨');
                    loadTOTPStatus();
                }
            } catch (error) {
                showToast('ç¦ç”¨å¤±è´¥: ' + error.message, 'error');
            }
        }

        function cancelTOTPSetup() {
            document.getElementById('totpSetup').style.display = 'none';
            document.getElementById('totpNotEnabled').style.display = 'block';
        }

        async function regenerateBackupCodes() {
            if (!confirm('é‡æ–°ç”Ÿæˆå¤‡ç”¨ç å°†ä½¿åŸæœ‰å¤‡ç”¨ç å¤±æ•ˆï¼Œç¡®å®šç»§ç»­ï¼Ÿ')) return;

            try {
                const res = await fetch(`${API_BASE}/auth/totp/backup-codes`, {
                    method: 'POST',
                    headers: getAuthHeaders()
                });
                const data = await res.json();
                if (data.success) {
                    alert('æ–°çš„å¤‡ç”¨ç ï¼š\n\n' + data.data.backup_codes.join('\n') + '\n\nè¯·å¦¥å–„ä¿å­˜ï¼');
                }
            } catch (error) {
                showToast('ç”Ÿæˆå¤±è´¥: ' + error.message, 'error');
            }
        }

        // ==================== ä¼šè¯ç®¡ç† ====================
        async function loadSessions() {
            try {
                const res = await fetch(`${API_BASE}/auth/sessions`, {
                    headers: getAuthHeaders()
                });
                if (res.ok) {
                    const data = await res.json();
                    const sessions = data.data || [];
                    const tbody = document.getElementById('sessionList');
                    
                    if (sessions.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: var(--text-dim);">æš‚æ— ä¼šè¯è®°å½•</td></tr>';
                    } else {
                        tbody.innerHTML = sessions.map((s, idx) => `
                            <tr>
                                <td>${s.ip_address || '-'}</td>
                                <td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis;">${s.user_agent || '-'}</td>
                                <td>${s.created_at ? new Date(s.created_at).toLocaleString() : '-'}</td>
                                <td>${s.last_active ? new Date(s.last_active).toLocaleString() : '-'}</td>
                                <td><span style="color: var(--success);">â— æ´»è·ƒ</span></td>
                            </tr>
                        `).join('');
                    }
                }

                // åŠ è½½é™æµçŠ¶æ€
                const rateRes = await fetch(`${API_BASE}/security/rate-limit`);
                if (rateRes.ok) {
                    const rateData = await rateRes.json();
                    const status = rateData.data;
                    document.getElementById('currentIP').textContent = status.ip;
                    document.getElementById('requestCount').textContent = `${status.requests_in_window} / ${status.max_requests}`;
                    document.getElementById('rateLimitStatus').innerHTML = status.is_blocked 
                        ? `<span style="color: var(--danger);">â— å·²é™æµ</span>`
                        : `<span style="color: var(--success);">â— æ­£å¸¸</span>`;
                }
            } catch (error) {
                console.error('åŠ è½½ä¼šè¯å¤±è´¥:', error);
            }
        }

        async function revokeAllSessions() {
            if (!confirm('ç¡®å®šè¦æ’¤é”€æ‰€æœ‰å…¶ä»–ä¼šè¯å—ï¼Ÿå…¶ä»–è®¾å¤‡å°†è¢«å¼ºåˆ¶ä¸‹çº¿ã€‚')) return;

            try {
                const res = await fetch(`${API_BASE}/auth/sessions/revoke-all`, {
                    method: 'POST',
                    headers: getAuthHeaders()
                });
                const data = await res.json();
                if (data.success) {
                    showToast(data.message);
                    loadSessions();
                }
            } catch (error) {
                showToast('æ“ä½œå¤±è´¥: ' + error.message, 'error');
            }
        }

        // ==================== æ•°æ®å†å² ====================
        async function loadHistory() {
            try {
                const recordIdInput = document.getElementById('historyRecordId');
                const actionInput = document.getElementById('historyAction');
                const usernameInput = document.getElementById('historyUsername');
                const recordId = recordIdInput ? recordIdInput.value : '';
                const action = actionInput ? actionInput.value : '';
                const username = usernameInput ? usernameInput.value : '';

                const params = new URLSearchParams();
                params.set('limit', '200');
                if (recordId) params.set('record_id', recordId);
                if (action) params.set('action', action);
                if (username) params.set('username', username);

                const res = await fetch(`${API_BASE}/history?${params.toString()}`, {
                    headers: getAuthHeaders()
                });
                if (res.ok) {
                    const data = await res.json();
                    const history = data.data || [];
                    const tbody = document.getElementById('historyList');
                    
                    if (history.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: var(--text-dim);">æš‚æ— å†å²è®°å½•</td></tr>';
                    } else {
                        tbody.innerHTML = history.map(h => `
                            <tr>
                                <td>#${h.record_id}</td>
                                <td><span style="background: ${h.action === 'CREATE' ? 'var(--success)' : h.action === 'DELETE' ? 'var(--danger)' : 'var(--accent)'}; padding: 2px 8px; border-radius: 4px; font-size: 12px;">${h.action}</span></td>
                                <td>${h.field_name || '-'}</td>
                                <td style="max-width: 100px; overflow: hidden; text-overflow: ellipsis;">${h.old_value || '-'}</td>
                                <td style="max-width: 100px; overflow: hidden; text-overflow: ellipsis;">${h.new_value || '-'}</td>
                                <td>${h.username || '-'}</td>
                                <td>${h.created_at ? new Date(h.created_at).toLocaleString() : '-'}</td>
                            </tr>
                        `).join('');
                    }
                }
            } catch (error) {
                console.error('åŠ è½½å†å²å¤±è´¥:', error);
            }
        }

        async function exportHistoryCsv() {
            try {
                const recordIdInput = document.getElementById('historyRecordId');
                const actionInput = document.getElementById('historyAction');
                const usernameInput = document.getElementById('historyUsername');
                const recordId = recordIdInput ? recordIdInput.value : '';
                const action = actionInput ? actionInput.value : '';
                const username = usernameInput ? usernameInput.value : '';

                const params = new URLSearchParams();
                params.set('limit', '500');
                if (recordId) params.set('record_id', recordId);
                if (action) params.set('action', action);
                if (username) params.set('username', username);

                const res = await fetch(`${API_BASE}/history?${params.toString()}`, {
                    headers: getAuthHeaders()
                });
                const data = await res.json();
                if (!data.success) {
                    showToast(data.detail || 'å¯¼å‡ºå¤±è´¥', 'error');
                    return;
                }
                const rows = [];
                rows.push(buildCsvLine(['record_id', 'action', 'field', 'old_value', 'new_value', 'username', 'created_at']));
                (data.data || []).forEach(h => {
                    rows.push(buildCsvLine([
                        h.record_id,
                        h.action,
                        h.field_name || '',
                        h.old_value || '',
                        h.new_value || '',
                        h.username || '',
                        h.created_at || ''
                    ]));
                });
                downloadCsvContent(rows, 'data_history.csv');
            } catch (error) {
                showToast('å¯¼å‡ºå¤±è´¥: ' + error.message, 'error');
            }
        }

        // ==================== ç™»å½•æ—¥å¿— ====================
        async function loadLoginLogs() {
            try {
                const res = await fetch(`${API_BASE}/security/login-logs?limit=100`, {
                    headers: getAuthHeaders()
                });
                if (res.ok) {
                    const data = await res.json();
                    const logs = data.data || [];
                    const tbody = document.getElementById('loginLogList');
                    
                    if (logs.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: var(--text-dim);">æš‚æ— ç™»å½•è®°å½•</td></tr>';
                    } else {
                        tbody.innerHTML = logs.map(log => `
                            <tr>
                                <td>${log.username}</td>
                                <td>${log.ip_address}</td>
                                <td>${log.success 
                                    ? '<span style="color: var(--success);">âœ“ æˆåŠŸ</span>' 
                                    : '<span style="color: var(--danger);">âœ— å¤±è´¥</span>'}</td>
                                <td>${log.failure_reason || '-'}</td>
                                <td>${log.created_at ? new Date(log.created_at).toLocaleString() : '-'}</td>
                            </tr>
                        `).join('');
                    }
                }
            } catch (error) {
                console.error('åŠ è½½ç™»å½•æ—¥å¿—å¤±è´¥:', error);
            }
        }

        // ==================== å®¡è®¡æ—¥å¿— ====================
        async function loadAuditLogs() {
            try {
                const usernameInput = document.getElementById('auditUsername');
                const actionInput = document.getElementById('auditAction');
                const username = usernameInput ? usernameInput.value : '';
                const action = actionInput ? actionInput.value : '';
                const params = new URLSearchParams();
                params.set('limit', '200');
                if (username) params.set('username', username);
                if (action) params.set('action', action);

                const res = await fetch(`${API_BASE}/security/audit-logs?${params.toString()}`, {
                    headers: getAuthHeaders()
                });
                if (res.ok) {
                    const data = await res.json();
                    const logs = data.data || [];
                    const tbody = document.getElementById('auditLogList');
                    if (!tbody) return;
                    if (logs.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: var(--text-dim);">æš‚æ— å®¡è®¡è®°å½•</td></tr>';
                    } else {
                        tbody.innerHTML = logs.map(log => `
                            <tr>
                                <td>${log.username}</td>
                                <td>${log.action}</td>
                                <td>${log.resource || '-'}</td>
                                <td>${log.resource_id || '-'}</td>
                                <td>${log.ip_address || '-'}</td>
                                <td>${log.created_at ? new Date(log.created_at).toLocaleString() : '-'}</td>
                            </tr>
                        `).join('');
                    }
                }
            } catch (error) {
                console.error('åŠ è½½å®¡è®¡æ—¥å¿—å¤±è´¥:', error);
            }
        }

        async function exportAuditCsv() {
            try {
                const usernameInput = document.getElementById('auditUsername');
                const actionInput = document.getElementById('auditAction');
                const username = usernameInput ? usernameInput.value : '';
                const action = actionInput ? actionInput.value : '';
                const params = new URLSearchParams();
                params.set('limit', '500');
                if (username) params.set('username', username);
                if (action) params.set('action', action);

                const res = await fetch(`${API_BASE}/security/audit-logs?${params.toString()}`, {
                    headers: getAuthHeaders()
                });
                const data = await res.json();
                if (!data.success) {
                    showToast(data.detail || 'å¯¼å‡ºå¤±è´¥', 'error');
                    return;
                }
                const rows = [];
                rows.push(buildCsvLine(['username', 'action', 'resource', 'resource_id', 'ip_address', 'created_at']));
                (data.data || []).forEach(log => {
                    rows.push(buildCsvLine([
                        log.username,
                        log.action,
                        log.resource || '',
                        log.resource_id || '',
                        log.ip_address || '',
                        log.created_at || ''
                    ]));
                });
                downloadCsvContent(rows, 'audit_logs.csv');
            } catch (error) {
                showToast('å¯¼å‡ºå¤±è´¥: ' + error.message, 'error');
            }
        }

        // ==================== æ•°æ®å®¡æ ¸ ====================
        async function loadReviewStats() {
            try {
                const res = await fetch(`${API_BASE}/review/stats`, {
                    headers: getAuthHeaders()
                });
                if (res.ok) {
                    const data = await res.json();
                    const stats = data.data;
                    document.getElementById('pendingGroups').textContent = stats.pending_groups || 0;
                    document.getElementById('pendingRecords').textContent = stats.pending_records || 0;
                    document.getElementById('approvedRecords').textContent = stats.approved || 0;
                    document.getElementById('rejectedRecords').textContent = stats.rejected || 0;
                    document.getElementById('reviewCount').textContent = stats.pending_groups || 0;
                }
            } catch (error) {
                console.error('åŠ è½½å®¡æ ¸ç»Ÿè®¡å¤±è´¥:', error);
            }
        }

        async function scanDuplicates() {
            try {
                showToast('æ­£åœ¨æ‰«æé‡å¤æ•°æ®...');
                const res = await fetch(`${API_BASE}/review/duplicates`, {
                    headers: getAuthHeaders()
                });
                if (res.ok) {
                    const data = await res.json();
                    const duplicates = data.data || [];
                    
                    if (duplicates.length === 0) {
                        document.getElementById('duplicateResults').innerHTML = 
                            '<p style="color: var(--success);">âœ“ æœªå‘ç°é‡å¤æ•°æ®</p>';
                    } else {
                        let html = `<p style="margin-bottom: 15px;">å‘ç° <strong style="color: var(--warning);">${duplicates.length}</strong> ç»„é‡å¤æ•°æ®ï¼š</p>`;
                        html += '<div style="max-height: 300px; overflow-y: auto;">';
                        
                        duplicates.slice(0, 20).forEach((dup, idx) => {
                            html += `
                                <div style="background: var(--bg-input); padding: 12px; border-radius: 8px; margin-bottom: 10px;">
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                        <span>ç»„ #${idx + 1}</span>
                                        <span style="color: var(--warning);">${dup.count} ä¸ªä¸åŒå‹åŠ›å€¼</span>
                                    </div>
                                    <div style="font-size: 13px; color: var(--text-dim);">
                                        æ¸©åº¦: ${dup.temperature.toFixed(2)} K | 
                                        CHâ‚„: ${dup.composition.x_ch4.toFixed(3)} | 
                                        Câ‚‚Hâ‚†: ${dup.composition.x_c2h6.toFixed(3)} | 
                                        Câ‚ƒHâ‚ˆ: ${dup.composition.x_c3h8.toFixed(3)}
                                    </div>
                                    <div style="font-size: 13px; margin-top: 5px;">
                                        å‹åŠ›: ${dup.pressures.map(p => p.toFixed(2)).join(', ')} MPa
                                    </div>
                                </div>
                            `;
                        });
                        
                        if (duplicates.length > 20) {
                            html += `<p style="text-align: center; color: var(--text-dim);">...è¿˜æœ‰ ${duplicates.length - 20} ç»„</p>`;
                        }
                        html += '</div>';
                        
                        document.getElementById('duplicateResults').innerHTML = html;
                    }
                    showToast(`æ‰«æå®Œæˆï¼Œå‘ç° ${duplicates.length} ç»„é‡å¤æ•°æ®`);
                }
            } catch (error) {
                showToast('æ‰«æå¤±è´¥: ' + error.message, 'error');
            }
        }

        async function moveDuplicatesToReview() {
            if (!confirm('ç¡®å®šè¦å°†æ‰€æœ‰é‡å¤æ•°æ®ç§»åˆ°å¾…å®¡æ ¸åŒºå—ï¼Ÿè¿™äº›æ•°æ®å°†æš‚æ—¶ä»æ­£å¼æ•°æ®åº“ä¸­ç§»é™¤ã€‚')) return;

            try {
                const res = await fetch(`${API_BASE}/review/move-duplicates`, {
                    method: 'POST',
                    headers: getAuthHeaders()
                });
                const data = await res.json();
                if (data.success) {
                    showToast(data.message);
                    loadReviewStats();
                    loadPendingGroups();
                    document.getElementById('duplicateResults').innerHTML = '';
                } else {
                    showToast(data.detail || 'æ“ä½œå¤±è´¥', 'error');
                }
            } catch (error) {
                showToast('æ“ä½œå¤±è´¥: ' + error.message, 'error');
            }
        }

        function renderPendingPagination(meta) {
            const pagination = document.getElementById('pendingGroupsPagination');
            if (!meta || typeof meta.total !== 'number' || meta.total <= pendingPerPage) {
                pagination.innerHTML = '';
                return;
            }

            const prevDisabled = meta.page <= 1 ? 'disabled' : '';
            const nextDisabled = meta.page >= meta.total_pages ? 'disabled' : '';

            pagination.innerHTML = `
                <div style="color: var(--text-dim); font-size: 12px;">
                    å…± ${meta.total} ç»„ï¼Œç¬¬ ${meta.page} / ${meta.total_pages} é¡µ
                </div>
                <div style="display: flex; gap: 8px;">
                    <button class="btn btn-secondary" ${prevDisabled} onclick="changePendingPage(${meta.page - 1})">ä¸Šä¸€é¡µ</button>
                    <button class="btn btn-secondary" ${nextDisabled} onclick="changePendingPage(${meta.page + 1})">ä¸‹ä¸€é¡µ</button>
                </div>
            `;
        }

        function changePendingPage(targetPage) {
            if (targetPage < 1) return;
            pendingPage = targetPage;
            loadPendingGroups();
        }

        function updatePendingSelectionSummary() {
            const counter = document.getElementById('pendingSelectedCount');
            if (counter) counter.textContent = pendingSelection.size;
        }

        function togglePendingGroupSelection(groupId, checked) {
            if (checked) {
                pendingSelection.add(groupId);
            } else {
                pendingSelection.delete(groupId);
            }
            updatePendingSelectionSummary();
        }

        function toggleSelectAllPending(checked) {
            pendingSelection = new Set();
            pendingGroupIds.forEach(groupId => {
                if (checked) {
                    pendingSelection.add(groupId);
                }
                const checkbox = document.getElementById(`pending-select-${groupId}`);
                if (checkbox) checkbox.checked = checked;
            });
            updatePendingSelectionSummary();
        }

        async function loadPendingGroups() {
            // å…ˆåˆ·æ–°ç»Ÿè®¡
            await loadReviewStats();
            
            try {
                const groupIdInput = document.getElementById('pendingFilterGroupId');
                const tempMinInput = document.getElementById('pendingTempMin');
                const tempMaxInput = document.getElementById('pendingTempMax');
                const groupId = groupIdInput && groupIdInput.value ? groupIdInput.value.trim() : '';
                const tempMin = tempMinInput ? tempMinInput.value : '';
                const tempMax = tempMaxInput ? tempMaxInput.value : '';

                const params = new URLSearchParams();
                params.set('page', pendingPage);
                params.set('per_page', pendingPerPage);
                if (groupId) params.set('group_id', groupId);
                if (tempMin !== '' && tempMin !== null && tempMin !== undefined) params.set('temp_min', tempMin);
                if (tempMax !== '' && tempMax !== null && tempMax !== undefined) params.set('temp_max', tempMax);

                const res = await fetch(`${API_BASE}/review/pending?${params.toString()}`, {
                    headers: getAuthHeaders()
                });
                if (res.ok) {
                    const data = await res.json();
                    const payload = data.data || [];
                    const groups = Array.isArray(payload) ? payload : (payload.groups || []);
                    pendingGroupIds = groups.map(group => group.group_id);
                    pendingSelection = new Set();
                    const selectAll = document.getElementById('pendingSelectAll');
                    if (selectAll) selectAll.checked = false;
                    updatePendingSelectionSummary();
                    
                    const container = document.getElementById('pendingGroupsContainer');
                    
                    if (groups.length === 0) {
                        pendingGroupIds = [];
                        pendingSelection = new Set();
                        const selectAll = document.getElementById('pendingSelectAll');
                        if (selectAll) selectAll.checked = false;
                        updatePendingSelectionSummary();
                        container.innerHTML = '<p style="color: var(--text-dim); text-align: center;">æš‚æ— å¾…å®¡æ ¸æ•°æ®</p>';
                        renderPendingPagination(Array.isArray(payload) ? null : payload);
                        return;
                    }
                    
                    let html = '';
                    groups.forEach(group => {
                        html += `
                            <div class="review-group" style="background: var(--bg-input); padding: 20px; border-radius: 12px; margin-bottom: 15px; border: 1px solid var(--border);">
                                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
                                    <div style="display: flex; align-items: center; gap: 10px;">
                                        <label style="display: flex; align-items: center; gap: 6px; font-size: 12px; color: var(--text-dim);">
                                            <input type="checkbox" id="pending-select-${group.group_id}" onchange="togglePendingGroupSelection('${group.group_id}', this.checked)" style="accent-color: var(--accent);">
                                            é€‰ä¸­
                                        </label>
                                        <div>
                                            <h4 style="margin-bottom: 8px;">${group.group_id}</h4>
                                        <div style="font-size: 13px; color: var(--text-dim);">
                                            æ¸©åº¦: <span style="color: #ef4444; font-weight: 600;">${group.temperature.toFixed(2)} K</span>
                                        </div>
                                        </div>
                                    </div>
                                    <div style="text-align: right;">
                                        <span style="background: var(--warning); color: #000; padding: 4px 12px; border-radius: 20px; font-size: 12px;">
                                            ${group.pressure_count} ä¸ªå‹åŠ›å€¼
                                        </span>
                                    </div>
                                </div>
                                
                                <div style="background: var(--bg-dark); padding: 12px; border-radius: 8px; margin-bottom: 15px;">
                                    <div style="font-size: 12px; color: var(--text-dim); margin-bottom: 8px;">ç»„åˆ†é…æ¯”</div>
                                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; font-size: 13px;">
                                        <div>CHâ‚„: ${group.composition.x_ch4.toFixed(4)}</div>
                                        <div>Câ‚‚Hâ‚†: ${group.composition.x_c2h6.toFixed(4)}</div>
                                        <div>Câ‚ƒHâ‚ˆ: ${group.composition.x_c3h8.toFixed(4)}</div>
                                        <div>COâ‚‚: ${group.composition.x_co2.toFixed(4)}</div>
                                        <div>Nâ‚‚: ${group.composition.x_n2.toFixed(4)}</div>
                                        <div>Hâ‚‚S: ${group.composition.x_h2s.toFixed(4)}</div>
                                        <div>i-Câ‚„Hâ‚â‚€: ${group.composition.x_ic4h10.toFixed(4)}</div>
                                    </div>
                                </div>
                                
                                <div style="margin-bottom: 15px;">
                                    <div style="font-size: 12px; color: var(--text-dim); margin-bottom: 8px;">é€‰æ‹©è¦ä¿ç•™çš„å‹åŠ›å€¼ï¼ˆå¯å¤šé€‰ï¼‰</div>
                                    <div style="display: flex; flex-wrap: wrap; gap: 10px;" id="pressures-${group.group_id}">
                                        ${group.pressures.map(p => `
                                            <label style="display: flex; align-items: center; gap: 8px; background: var(--bg-dark); padding: 8px 16px; border-radius: 8px; cursor: pointer;">
                                                <input type="checkbox" name="pressure-${group.group_id}" value="${p.id}" checked style="accent-color: var(--accent);">
                                                <input type="number" value="${p.pressure.toFixed(4)}" step="0.0001" 
                                                    style="width: 100px; padding: 4px 8px; background: var(--bg-input); border: 1px solid var(--border); border-radius: 4px; color: var(--text);"
                                                    onchange="updatePressure(${p.id}, this.value)">
                                                <span style="color: var(--text-dim);">MPa</span>
                                            </label>
                                        `).join('')}
                                    </div>
                                </div>
                                
                                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                                    <button class="btn btn-danger" onclick="rejectGroup('${group.group_id}')" style="padding: 8px 20px;">
                                        âœ— å…¨éƒ¨æ‹’ç»
                                    </button>
                                    <button class="btn btn-primary" onclick="approveGroup('${group.group_id}')" style="padding: 8px 20px;">
                                        âœ“ ç¡®è®¤é€‰ä¸­
                                    </button>
                                </div>
                            </div>
                        `;
                    });
                    
                    container.innerHTML = html;
                    renderPendingPagination(Array.isArray(payload) ? null : payload);
                }
            } catch (error) {
                console.error('åŠ è½½å¾…å®¡æ ¸æ•°æ®å¤±è´¥:', error);
            }
        }

        function applyPendingFilters() {
            pendingPage = 1;
            loadPendingGroups();
        }

        function clearPendingFilters() {
            const groupId = document.getElementById('pendingFilterGroupId');
            const tempMin = document.getElementById('pendingTempMin');
            const tempMax = document.getElementById('pendingTempMax');
            if (groupId) groupId.value = '';
            if (tempMin) tempMin.value = '';
            if (tempMax) tempMax.value = '';
            pendingPage = 1;
            loadPendingGroups();
        }

        async function updatePressure(pendingId, newValue) {
            try {
                const res = await fetch(`${API_BASE}/review/pressure/${pendingId}?pressure=${newValue}`, {
                    method: 'PUT',
                    headers: getAuthHeaders()
                });
                if (res.ok) {
                    showToast('å‹åŠ›å€¼å·²æ›´æ–°');
                }
            } catch (error) {
                showToast('æ›´æ–°å¤±è´¥', 'error');
            }
        }

        async function approveGroup(groupId) {
            const checkboxes = document.querySelectorAll(`input[name="pressure-${groupId}"]:checked`);
            const selectedIds = Array.from(checkboxes).map(cb => parseInt(cb.value));
            
            if (selectedIds.length === 0) {
                showToast('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªå‹åŠ›å€¼', 'error');
                return;
            }

            try {
                const res = await fetch(`${API_BASE}/review/approve/${groupId}`, {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({ selected_ids: selectedIds })
                });
                const data = await res.json();
                if (data.success) {
                    showToast(data.message);
                    loadReviewStats();
                    loadPendingGroups();
                }
            } catch (error) {
                showToast('å®¡æ ¸å¤±è´¥: ' + error.message, 'error');
            }
        }

        async function rejectGroup(groupId) {
            if (!confirm('ç¡®å®šè¦æ‹’ç»è¿™ç»„æ‰€æœ‰æ•°æ®å—ï¼Ÿ')) return;

            try {
                const res = await fetch(`${API_BASE}/review/reject/${groupId}`, {
                    method: 'POST',
                    headers: getAuthHeaders()
                });
                const data = await res.json();
                if (data.success) {
                    showToast(data.message);
                    loadReviewStats();
                    loadPendingGroups();
                }
            } catch (error) {
                showToast('æ“ä½œå¤±è´¥: ' + error.message, 'error');
            }
        }

        async function batchApproveGroups() {
            if (pendingSelection.size === 0) {
                showToast('è¯·å…ˆé€‰ä¸­è¦å®¡æ ¸çš„ç»„', 'error');
                return;
            }

            const items = [];
            const missing = [];

            pendingSelection.forEach(groupId => {
                const checkboxes = document.querySelectorAll(`input[name="pressure-${groupId}"]:checked`);
                const selectedIds = Array.from(checkboxes).map(cb => parseInt(cb.value));
                if (selectedIds.length === 0) {
                    missing.push(groupId);
                    return;
                }
                items.push({ group_id: groupId, selected_ids: selectedIds });
            });

            if (items.length === 0) {
                showToast('æ‰€é€‰ç»„æ²¡æœ‰å‹¾é€‰ä»»ä½•å‹åŠ›å€¼', 'error');
                return;
            }

            if (missing.length > 0) {
                showToast(`æœ‰ ${missing.length} ç»„æœªé€‰æ‹©å‹åŠ›å€¼ï¼Œå·²è·³è¿‡`, 'error');
            }

            if (!confirm(`ç¡®å®šè¦æ‰¹é‡é€šè¿‡ ${items.length} ç»„æ•°æ®å—ï¼Ÿ`)) return;

            try {
                const res = await fetch(`${API_BASE}/review/approve-batch`, {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({ items })
                });
                const data = await res.json();
                if (data.success) {
                    showToast(data.message);
                    loadReviewStats();
                    loadPendingGroups();
                } else {
                    showToast(data.detail || 'æ‰¹é‡å®¡æ ¸å¤±è´¥', 'error');
                }
            } catch (error) {
                showToast('æ‰¹é‡å®¡æ ¸å¤±è´¥: ' + error.message, 'error');
            }
        }

        async function batchRejectGroups() {
            if (pendingSelection.size === 0) {
                showToast('è¯·å…ˆé€‰ä¸­è¦æ‹’ç»çš„ç»„', 'error');
                return;
            }

            const groupIds = Array.from(pendingSelection);
            if (!confirm(`ç¡®å®šè¦æ‰¹é‡æ‹’ç» ${groupIds.length} ç»„æ•°æ®å—ï¼Ÿ`)) return;

            try {
                const res = await fetch(`${API_BASE}/review/reject-batch`, {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({ group_ids: groupIds })
                });
                const data = await res.json();
                if (data.success) {
                    showToast(data.message);
                    loadReviewStats();
                    loadPendingGroups();
                } else {
                    showToast(data.detail || 'æ‰¹é‡æ‹’ç»å¤±è´¥', 'error');
                }
            } catch (error) {
                showToast('æ‰¹é‡æ‹’ç»å¤±è´¥: ' + error.message, 'error');
            }
        }

        // ==================== æ•°æ®æ¨¡æ¿ä¸‹è½½ ====================
        function downloadCSVTemplate() {
            window.location.href = `${API_BASE}/template/csv`;
            showToast('æ­£åœ¨ä¸‹è½½ CSV æ¨¡æ¿...');
        }

        function downloadExcelTemplate() {
            window.location.href = `${API_BASE}/template/excel`;
            showToast('æ­£åœ¨ä¸‹è½½ Excel æ¨¡æ¿...');
        }

        // åŠ¨ç”»æ ·å¼
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from { transform: translateX(100px); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOut {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100px); opacity: 0; }
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>

