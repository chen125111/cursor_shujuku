<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ°”ä½“æ°´åˆç‰©ç›¸å¹³è¡¡æŸ¥è¯¢ç³»ç»Ÿ</title>
    
    <!-- Chart.js æ•°æ®å¯è§†åŒ–åº“ -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- jsPDF å¯¼å‡ºåº“ -->
    <script src="https://cdn.jsdelivr.net/npm/jspdf@latest/dist/jspdf.umd.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: linear-gradient(135deg, #0c1929 0%, #1a2940 50%, #0d2137 100%);
            min-height: 100vh;
            color: #e2e8f0;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
        }

        h1 {
            font-size: 28px;
            background: linear-gradient(135deg, #60a5fa, #34d399);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 8px;
        }

        .subtitle {
            color: #94a3b8;
            font-size: 14px;
        }

        .card {
            background: rgba(30, 41, 59, 0.8);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 20px;
            border: 1px solid rgba(71, 85, 105, 0.5);
            backdrop-filter: blur(10px);
        }

        .card-title {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
            font-size: 16px;
            color: #f1f5f9;
        }

        .card-title .step {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 600;
        }

        /* ç»„åˆ†é€‰æ‹©æŒ‰é’® */
        .component-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .comp-btn {
            padding: 10px 18px;
            background: rgba(15, 23, 42, 0.6);
            border: 2px solid #334155;
            border-radius: 10px;
            color: #94a3b8;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
        }

        .comp-btn:hover:not(.disabled) {
            border-color: #3b82f6;
            color: #f1f5f9;
        }

        .comp-btn.selected {
            background: rgba(59, 130, 246, 0.2);
            border-color: #3b82f6;
            color: #60a5fa;
        }

        .comp-btn.disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .comp-btn .formula {
            font-size: 12px;
            opacity: 0.7;
        }

        /* å·²é€‰ç»„åˆ†æ ‡ç­¾ */
        .selected-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
            min-height: 40px;
        }

        .tag {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 12px 8px 16px;
            border-radius: 25px;
            font-size: 14px;
            font-weight: 500;
        }

        .tag .remove-btn {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .tag .remove-btn:hover {
            background: rgba(255,255,255,0.4);
        }

        /* ç¡®è®¤æŒ‰é’® */
        .btn-confirm {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #10b981, #059669);
            border: none;
            border-radius: 10px;
            color: white;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            margin-top: 20px;
        }

        .btn-confirm:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(16, 185, 129, 0.4);
        }

        .btn-confirm:disabled {
            background: #475569;
            cursor: not-allowed;
        }

        /* ç»„åˆ†åŒºé—´æ˜¾ç¤º */
        .range-display {
            margin-top: 20px;
        }

        .range-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: rgba(15, 23, 42, 0.6);
            border-radius: 10px;
            margin-bottom: 10px;
        }

        .range-item .comp-name {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .range-item .comp-name .dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }

        .range-item .comp-name .name {
            font-weight: 500;
        }

        .range-item .comp-name .formula {
            color: #64748b;
            font-size: 12px;
        }

        .range-item .range-value {
            font-size: 16px;
            font-weight: 600;
            color: #34d399;
        }

        .range-item .range-value.no-data {
            color: #f87171;
        }

        /* åŒ¹é…ç»Ÿè®¡ */
        .match-stats {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-top: 20px;
            padding: 15px;
            background: rgba(15, 23, 42, 0.6);
            border-radius: 10px;
        }

        .stat-item {
            text-align: center;
        }

        .stat-item .stat-value {
            font-size: 24px;
            font-weight: 700;
            color: #60a5fa;
        }

        .stat-item .stat-label {
            font-size: 12px;
            color: #94a3b8;
            margin-top: 4px;
        }

        /* æ¸©åº¦è¾“å…¥ */
        .temp-input-group {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .temp-input-group label {
            font-size: 14px;
            color: #94a3b8;
            min-width: 60px;
        }

        .temp-input-group input {
            flex: 1;
            padding: 12px 16px;
            background: rgba(15, 23, 42, 0.8);
            border: 1px solid #334155;
            border-radius: 8px;
            color: #f1f5f9;
            font-size: 16px;
            outline: none;
        }

        .temp-input-group input:focus {
            border-color: #3b82f6;
        }

        .unit {
            color: #64748b;
            font-size: 14px;
        }

        /* æŸ¥è¯¢æŒ‰é’® */
        .btn-query {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            border: none;
            border-radius: 12px;
            color: white;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            margin-top: 20px;
        }

        .btn-query:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(59, 130, 246, 0.4);
        }

        .btn-query:disabled {
            background: #475569;
            cursor: not-allowed;
        }

        /* ç»“æœå±•ç¤º */
        .result-card {
            display: none;
        }

        .result-card.show {
            display: block;
        }

        .result-success {
            text-align: center;
            padding: 30px;
        }

        .result-value {
            font-size: 64px;
            font-weight: 700;
            background: linear-gradient(135deg, #34d399, #10b981);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .result-unit {
            font-size: 24px;
            color: #94a3b8;
            margin-bottom: 20px;
        }

        .result-info {
            background: rgba(15, 23, 42, 0.6);
            border-radius: 12px;
            padding: 20px;
            text-align: left;
        }

        .result-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid rgba(71, 85, 105, 0.3);
        }

        .result-row:last-child {
            border-bottom: none;
        }

        .result-label {
            color: #64748b;
        }

        .result-data {
            color: #f1f5f9;
            font-weight: 500;
        }

        .result-error {
            text-align: center;
            padding: 40px;
        }

        .result-error .icon {
            font-size: 60px;
            margin-bottom: 20px;
        }

        /* æç¤º */
        .hint-box {
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.3);
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
            font-size: 13px;
            color: #93c5fd;
        }

        /* é¡µè„š */
        footer {
            text-align: center;
            margin-top: 40px;
            color: #475569;
            font-size: 12px;
        }

        /* é¢œè‰²æ–¹æ¡ˆ */
        .color-ch4 { background: linear-gradient(135deg, #ef4444, #dc2626); }
        .color-c2h6 { background: linear-gradient(135deg, #f97316, #ea580c); }
        .color-c3h8 { background: linear-gradient(135deg, #eab308, #ca8a04); }
        .color-co2 { background: linear-gradient(135deg, #22c55e, #16a34a); }
        .color-n2 { background: linear-gradient(135deg, #06b6d4, #0891b2); }
        .color-h2s { background: linear-gradient(135deg, #8b5cf6, #7c3aed); }
        .color-ic4h10 { background: linear-gradient(135deg, #ec4899, #db2777); }

        .dot-ch4 { background: #ef4444; }
        .dot-c2h6 { background: #f97316; }
        .dot-c3h8 { background: #eab308; }
        .dot-co2 { background: #22c55e; }
        .dot-n2 { background: #06b6d4; }
        .dot-h2s { background: #8b5cf6; }
        .dot-ic4h10 { background: #ec4899; }

        /* å›¾è¡¨å¡ç‰‡æ ·å¼ */
        .charts-card {
            margin-top: 30px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-bottom: 25px;
        }

        .stat-card {
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid rgba(71, 85, 105, 0.3);
            border-radius: 12px;
            padding: 18px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            border-color: #3b82f6;
            box-shadow: 0 4px 20px rgba(59, 130, 246, 0.2);
        }

        .stat-icon {
            font-size: 24px;
            margin-bottom: 10px;
        }

        .stat-label {
            font-size: 12px;
            color: #94a3b8;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-value {
            font-size: 24px;
            font-weight: 700;
            color: #f1f5f9;
            font-family: 'Courier New', monospace;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-bottom: 20px;
        }

        .chart-card {
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid rgba(71, 85, 105, 0.3);
            border-radius: 12px;
            padding: 20px;
        }

        .chart-card h3 {
            font-size: 14px;
            color: #94a3b8;
            margin-bottom: 15px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .chart-card.chart-wide {
            grid-column: span 2;
        }

        .chart-card canvas {
            width: 100% !important;
            height: 250px !important;
        }

        .chart-card.chart-wide canvas {
            height: 300px !important;
        }

        .chart-actions {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid rgba(71, 85, 105, 0.3);
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .charts-grid {
                grid-template-columns: 1fr;
            }

            .chart-card.chart-wide {
                grid-column: span 1;
            }
        }

        @media (max-width: 480px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }

            .stat-card {
                padding: 15px;
            }

            .stat-value {
                font-size: 20px;
            }
        }

        /* æŸ¥è¯¢å·¥å…·åŒº */
        .tools-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
        }

        .tool-panel {
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid rgba(71, 85, 105, 0.3);
            border-radius: 12px;
            padding: 16px;
            min-height: 220px;
        }

        .panel-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
        }

        .panel-header h3 {
            font-size: 14px;
            color: #e2e8f0;
        }

        .item-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-height: 280px;
            overflow-y: auto;
            padding-right: 4px;
        }

        .item-card {
            border: 1px solid rgba(71, 85, 105, 0.35);
            border-radius: 10px;
            padding: 10px;
            background: rgba(15, 23, 42, 0.5);
        }

        .item-title {
            font-size: 13px;
            font-weight: 600;
            color: #f1f5f9;
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .item-meta {
            font-size: 12px;
            color: #94a3b8;
            line-height: 1.5;
        }

        .item-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-top: 8px;
        }

        .badge {
            display: inline-flex;
            align-items: center;
            padding: 2px 8px;
            border-radius: 999px;
            font-size: 11px;
            font-weight: 600;
        }

        .badge-success {
            background: rgba(34, 197, 94, 0.2);
            color: #86efac;
        }

        .badge-warn {
            background: rgba(249, 115, 22, 0.2);
            color: #fdba74;
        }

        .badge-error {
            background: rgba(248, 113, 113, 0.2);
            color: #fecaca;
        }

        .badge-info {
            background: rgba(59, 130, 246, 0.2);
            color: #93c5fd;
        }

        .btn-mini {
            padding: 6px 10px;
            border-radius: 8px;
            border: 1px solid transparent;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            background: rgba(59, 130, 246, 0.2);
            color: #93c5fd;
            transition: all 0.2s;
        }

        .btn-mini:hover {
            border-color: #3b82f6;
            color: #e2e8f0;
        }

        .btn-mini.secondary {
            background: rgba(148, 163, 184, 0.15);
            color: #cbd5f5;
        }

        .btn-mini.danger {
            background: rgba(248, 113, 113, 0.2);
            color: #fecaca;
        }

        .result-actions {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 16px;
            flex-wrap: wrap;
        }

        .batch-input textarea {
            width: 100%;
            min-height: 120px;
            padding: 12px 14px;
            background: rgba(15, 23, 42, 0.8);
            border: 1px solid #334155;
            border-radius: 10px;
            color: #f1f5f9;
            font-size: 14px;
            resize: vertical;
        }

        .batch-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 12px;
        }

        .batch-status {
            margin-top: 10px;
            font-size: 12px;
            color: #94a3b8;
        }

        .batch-summary {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-top: 16px;
        }

        .batch-summary .stat-card {
            padding: 14px;
        }

        .batch-table {
            width: 100%;
            margin-top: 16px;
            border-collapse: collapse;
            font-size: 13px;
        }

        .batch-table th,
        .batch-table td {
            padding: 10px 12px;
            border-bottom: 1px solid rgba(71, 85, 105, 0.3);
            text-align: left;
        }

        .batch-table th {
            color: #94a3b8;
            font-weight: 600;
        }

        .batch-table tr:hover td {
            background: rgba(59, 130, 246, 0.08);
        }

        .pdf-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 12px;
        }

        @media (max-width: 900px) {
            .tools-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>âš—ï¸ æ°”ä½“æ°´åˆç‰©ç›¸å¹³è¡¡æŸ¥è¯¢</h1>
            <p class="subtitle">Gas Hydrate Phase Equilibrium Query System</p>
        </header>

        <!-- æ­¥éª¤1: é€‰æ‹©ç»„åˆ† -->
        <div class="card">
            <div class="card-title">
                <span class="step">1</span>
                <span>é€‰æ‹©æ°”ä½“ç»„åˆ†</span>
            </div>
            <div class="component-buttons" id="componentButtons"></div>
            <div class="selected-tags" id="selectedTags"></div>
            <button class="btn-confirm" id="confirmBtn" onclick="confirmComponents()" disabled>
                âœ“ ç¡®è®¤ç»„åˆ†ç»„åˆ
            </button>
            <div class="hint-box" id="selectionHint">
                ğŸ’¡ è¯·é€‰æ‹©æ°”ä½“æ··åˆç‰©åŒ…å«çš„ç»„åˆ†ï¼Œç‚¹å‡»ç¡®è®¤åæŸ¥çœ‹æ•°æ®åº“ä¸­çš„ç»„åˆ†åŒºé—´
            </div>
        </div>

        <!-- æ­¥éª¤2: æ˜¾ç¤ºç»„åˆ†åŒºé—´ -->
        <div class="card" id="rangeCard" style="display: none;">
            <div class="card-title">
                <span class="step">2</span>
                <span>æ•°æ®åº“ä¸­çš„ç»„åˆ†åŒºé—´</span>
            </div>
            <div class="range-display" id="rangeDisplay"></div>
            <div class="match-stats" id="matchStats"></div>
        </div>

        <!-- æ­¥éª¤3: æ¸©åº¦å’ŒæŸ¥è¯¢ -->
        <div class="card" id="queryCard" style="display: none;">
            <div class="card-title">
                <span class="step">3</span>
                <span>è¾“å…¥æ¸©åº¦å¹¶æŸ¥è¯¢</span>
            </div>
            <div class="temp-input-group">
                <label>æ¸©åº¦</label>
                <input type="number" id="temperature" placeholder="ä¾‹å¦‚: 275" step="0.1" min="100" max="400">
                <span class="unit">K</span>
            </div>
            <button class="btn-query" id="queryBtn" onclick="doQuery()">ğŸ” æŸ¥è¯¢ç›¸å¹³è¡¡å‹åŠ›</button>
        </div>

        <!-- ç»“æœå±•ç¤º -->
        <div class="card result-card" id="resultCard">
            <div id="resultContent"></div>
        </div>

        <!-- æŸ¥è¯¢å†å²ä¸æ”¶è— -->
        <div class="card" id="historyCard">
            <div class="card-title">
                <span class="step">ğŸ—‚ï¸</span>
                <span>æŸ¥è¯¢å†å²ä¸æ”¶è—</span>
            </div>
            <div class="tools-grid">
                <div class="tool-panel">
                    <div class="panel-header">
                        <h3>æŸ¥è¯¢å†å²</h3>
                        <button class="btn-mini secondary" onclick="clearQueryHistory()">æ¸…ç©º</button>
                    </div>
                    <div class="item-list" id="queryHistoryList"></div>
                </div>
                <div class="tool-panel">
                    <div class="panel-header">
                        <h3>æ”¶è—å¤¹</h3>
                        <button class="btn-mini secondary" onclick="clearFavorites()">æ¸…ç©º</button>
                    </div>
                    <div class="item-list" id="favoriteList"></div>
                </div>
            </div>
            <div class="hint-box" id="historyHint">
                ğŸ’¡ æŸ¥è¯¢å†å²å’Œæ”¶è—ä¿å­˜åœ¨æœ¬åœ°æµè§ˆå™¨ï¼Œå¯ç”¨äºå¿«é€Ÿå¤ç°æŸ¥è¯¢ã€‚
            </div>
        </div>

        <!-- æ‰¹é‡æŸ¥è¯¢ä¸å¯¹æ¯” -->
        <div class="card" id="batchCard">
            <div class="card-title">
                <span class="step">4</span>
                <span>æ‰¹é‡æŸ¥è¯¢ä¸å¯¹æ¯”</span>
            </div>
            <div class="batch-input">
                <textarea id="batchTemperatures" placeholder="è¾“å…¥å¤šä¸ªæ¸©åº¦ï¼ˆä¾‹å¦‚: 270, 275, 280 æˆ–æ¯è¡Œä¸€ä¸ªæ¸©åº¦ï¼‰"></textarea>
                <div class="batch-actions">
                    <button class="btn-mini" id="batchQueryBtn" onclick="runBatchQuery()">ğŸš€ æ‰¹é‡æŸ¥è¯¢</button>
                    <button class="btn-mini secondary" onclick="clearBatchInput()">æ¸…ç©º</button>
                    <button class="btn-mini secondary" onclick="exportBatchPdf()">ğŸ“„ å¯¼å‡º PDF</button>
                </div>
                <div class="batch-status" id="batchStatus"></div>
            </div>
            <div class="batch-summary" id="batchSummary" style="display: none;"></div>
            <div id="batchResults"></div>
        </div>

        <!-- æ•°æ®å¯è§†åŒ– -->
        <div class="card charts-card">
            <div class="card-title">
                <span class="step">ğŸ“Š</span>
                <span>æ•°æ®å¯è§†åŒ–åˆ†æ</span>
            </div>
            
            <!-- ç»Ÿè®¡å¡ç‰‡ -->
            <div class="stats-grid" id="statsGrid">
                <div class="stat-card">
                    <div class="stat-icon">ğŸ“ˆ</div>
                    <div class="stat-label">æ€»è®°å½•æ•°</div>
                    <div class="stat-value" id="totalRecords">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">ğŸŒ¡ï¸</div>
                    <div class="stat-label">å¹³å‡æ¸©åº¦</div>
                    <div class="stat-value" id="avgTemperature">0 K</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">âš–ï¸</div>
                    <div class="stat-label">å¹³å‡å‹åŠ›</div>
                    <div class="stat-value" id="avgPressure">0 MPa</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">ğŸ“</div>
                    <div class="stat-label">æ¸©åº¦èŒƒå›´</div>
                    <div class="stat-value" id="tempRange">0-0 K</div>
                </div>
            </div>

            <!-- å›¾è¡¨ç½‘æ ¼ -->
            <div class="charts-grid">
                <div class="chart-card">
                    <h3>æ¸©åº¦åˆ†å¸ƒ</h3>
                    <canvas id="temperatureChart" height="250"></canvas>
                </div>
                <div class="chart-card">
                    <h3>å‹åŠ›åˆ†å¸ƒ</h3>
                    <canvas id="pressureChart" height="250"></canvas>
                </div>
                <div class="chart-card chart-wide">
                    <h3>æ¸©åº¦-å‹åŠ›å…³ç³»</h3>
                    <canvas id="scatterChart" height="300"></canvas>
                </div>
                <div class="chart-card">
                    <h3>ç»„åˆ†æ¯”ä¾‹</h3>
                    <canvas id="compositionChart" height="250"></canvas>
                </div>
            </div>

            <div class="chart-actions">
                <button class="btn btn-secondary btn-sm" onclick="gasCharts.exportChart('temperatureChart', 'æ¸©åº¦åˆ†å¸ƒ.png')">
                    ğŸ“¥ å¯¼å‡ºæ¸©åº¦å›¾
                </button>
                <button class="btn btn-secondary btn-sm" onclick="gasCharts.exportChart('pressureChart', 'å‹åŠ›åˆ†å¸ƒ.png')">
                    ğŸ“¥ å¯¼å‡ºå‹åŠ›å›¾
                </button>
                <button class="btn btn-secondary btn-sm" onclick="gasCharts.exportChart('scatterChart', 'æ¸©åº¦å‹åŠ›å…³ç³».png')">
                    ğŸ“¥ å¯¼å‡ºæ•£ç‚¹å›¾
                </button>
                <button class="btn btn-primary btn-sm" onclick="gasCharts.updateStatsCards()">
                    ğŸ”„ åˆ·æ–°æ•°æ®
                </button>
            </div>
        </div>

        <footer>
            Â© 2024 Gas Hydrate Database | æ¬¢è¿ä½¿ç”¨ï¼Œæå‡æ•°æ®åº“å½±å“åŠ›
        </footer>
    </div>

    <script>
        // ç»„åˆ†é…ç½®
        const COMPONENTS = {
            'x_ch4': { name: 'ç”²çƒ·', formula: 'CHâ‚„', color: 'color-ch4', dot: 'dot-ch4' },
            'x_c2h6': { name: 'ä¹™çƒ·', formula: 'Câ‚‚Hâ‚†', color: 'color-c2h6', dot: 'dot-c2h6' },
            'x_c3h8': { name: 'ä¸™çƒ·', formula: 'Câ‚ƒHâ‚ˆ', color: 'color-c3h8', dot: 'dot-c3h8' },
            'x_co2': { name: 'äºŒæ°§åŒ–ç¢³', formula: 'COâ‚‚', color: 'color-co2', dot: 'dot-co2' },
            'x_n2': { name: 'æ°®æ°”', formula: 'Nâ‚‚', color: 'color-n2', dot: 'dot-n2' },
            'x_h2s': { name: 'ç¡«åŒ–æ°¢', formula: 'Hâ‚‚S', color: 'color-h2s', dot: 'dot-h2s' },
            'x_ic4h10': { name: 'å¼‚ä¸çƒ·', formula: 'i-Câ‚„Hâ‚â‚€', color: 'color-ic4h10', dot: 'dot-ic4h10' }
        };
        const COMPONENTS_ASCII = {
            'x_ch4': 'CH4',
            'x_c2h6': 'C2H6',
            'x_c3h8': 'C3H8',
            'x_co2': 'CO2',
            'x_n2': 'N2',
            'x_h2s': 'H2S',
            'x_ic4h10': 'i-C4H10'
        };

        const API_BASE = '/api';

        let selectedComponents = [];
        let availableComponents = Object.keys(COMPONENTS);
        let componentRanges = {};
        const STORAGE_KEYS = {
            history: 'hydrate_query_history',
            favorites: 'hydrate_query_favorites'
        };
        const HISTORY_LIMIT = 30;
        const FAVORITE_LIMIT = 30;
        const BATCH_LIMIT = 50;
        let queryHistory = [];
        let favorites = [];
        let lastQueryResult = null;
        let lastBatchResult = null;

        document.addEventListener('DOMContentLoaded', () => {
            renderComponentButtons();
            initQueryTools();
        });

        function renderComponentButtons() {
            const container = document.getElementById('componentButtons');
            container.innerHTML = '';

            Object.entries(COMPONENTS).forEach(([key, comp]) => {
                const btn = document.createElement('button');
                btn.className = 'comp-btn';
                btn.dataset.comp = key;
                
                const isSelected = selectedComponents.includes(key);
                const isAvailable = availableComponents.includes(key);
                
                if (isSelected) btn.classList.add('selected');
                if (!isAvailable && !isSelected) btn.classList.add('disabled');
                
                btn.innerHTML = `${comp.name} <span class="formula">${comp.formula}</span>`;
                btn.onclick = () => toggleComponent(key);
                
                container.appendChild(btn);
            });

            renderSelectedTags();
            updateConfirmButton();
        }

        function renderSelectedTags() {
            const container = document.getElementById('selectedTags');
            container.innerHTML = '';

            if (selectedComponents.length === 0) {
                container.innerHTML = '<span style="color: #64748b; font-size: 13px;">å°šæœªé€‰æ‹©ä»»ä½•ç»„åˆ†</span>';
                return;
            }

            selectedComponents.forEach(key => {
                const comp = COMPONENTS[key];
                const tag = document.createElement('div');
                tag.className = `tag ${comp.color}`;
                tag.innerHTML = `
                    <span>${comp.name} (${comp.formula})</span>
                    <button class="remove-btn" onclick="removeComponent('${key}')" title="ç§»é™¤">âœ•</button>
                `;
                container.appendChild(tag);
            });
        }

        function updateConfirmButton() {
            const btn = document.getElementById('confirmBtn');
            btn.disabled = selectedComponents.length === 0;
        }

        async function toggleComponent(key) {
            if (selectedComponents.includes(key)) {
                removeComponent(key);
                return;
            }
            if (!availableComponents.includes(key)) return;

            selectedComponents.push(key);
            await updateAvailableComponents();
            renderComponentButtons();
            
            // éšè—åŒºé—´æ˜¾ç¤ºï¼ˆéœ€è¦é‡æ–°ç¡®è®¤ï¼‰
            document.getElementById('rangeCard').style.display = 'none';
            document.getElementById('queryCard').style.display = 'none';
        }

        async function removeComponent(key) {
            selectedComponents = selectedComponents.filter(k => k !== key);
            await updateAvailableComponents();
            renderComponentButtons();
            
            // éšè—åŒºé—´æ˜¾ç¤º
            document.getElementById('rangeCard').style.display = 'none';
            document.getElementById('queryCard').style.display = 'none';
        }

        async function updateAvailableComponents() {
            if (selectedComponents.length === 0) {
                availableComponents = Object.keys(COMPONENTS);
                return;
            }

            try {
                const res = await fetch(`${API_BASE}/components/available`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ selected: selectedComponents })
                });
                const data = await res.json();
                if (data.success) {
                    availableComponents = data.available;
                }
            } catch (e) {
                console.error(e);
            }
        }

        async function confirmComponents() {
            if (selectedComponents.length === 0) return;

            try {
                // è°ƒç”¨APIè·å–ç»„åˆ†åŒºé—´
                const res = await fetch(`${API_BASE}/components/ranges`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ components: selectedComponents })
                });
                const data = await res.json();
                
                if (data.success) {
                    componentRanges = data.ranges;
                    displayRanges(data);
                    document.getElementById('rangeCard').style.display = 'block';
                    document.getElementById('queryCard').style.display = data.total_records > 0 ? 'block' : 'none';
                } else {
                    alert('æŸ¥è¯¢å¤±è´¥ï¼š' + data.message);
                }
            } catch (e) {
                console.error(e);
                alert('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•');
            }
        }

        function displayRanges(data) {
            const rangeContainer = document.getElementById('rangeDisplay');
            rangeContainer.innerHTML = '';

            selectedComponents.forEach(key => {
                const comp = COMPONENTS[key];
                const range = data.ranges[key];
                
                const item = document.createElement('div');
                item.className = 'range-item';
                
                if (range) {
                    item.innerHTML = `
                        <div class="comp-name">
                            <span class="dot ${comp.dot}"></span>
                            <span class="name">${comp.name}</span>
                            <span class="formula">${comp.formula}</span>
                        </div>
                        <div class="range-value">${(range.min * 100).toFixed(1)}% - ${(range.max * 100).toFixed(1)}%</div>
                    `;
                } else {
                    item.innerHTML = `
                        <div class="comp-name">
                            <span class="dot ${comp.dot}"></span>
                            <span class="name">${comp.name}</span>
                            <span class="formula">${comp.formula}</span>
                        </div>
                        <div class="range-value no-data">æ— æ•°æ®</div>
                    `;
                }
                
                rangeContainer.appendChild(item);
            });

            // æ˜¾ç¤ºç»Ÿè®¡
            const statsContainer = document.getElementById('matchStats');
            statsContainer.innerHTML = `
                <div class="stat-item">
                    <div class="stat-value">${data.total_records}</div>
                    <div class="stat-label">åŒ¹é…è®°å½•æ•°</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">${data.temp_range ? data.temp_range.min.toFixed(1) + ' - ' + data.temp_range.max.toFixed(1) : '--'}</div>
                    <div class="stat-label">æ¸©åº¦èŒƒå›´ (K)</div>
                </div>
            `;
        }

        async function doQuery() {
            const temperature = parseFloat(document.getElementById('temperature').value);

            if (!temperature || temperature < 100 || temperature > 400) {
                showError('è¯·è¾“å…¥æœ‰æ•ˆçš„æ¸©åº¦ï¼ˆ100-400 Kï¼‰');
                return;
            }

            try {
                const res = await fetch(`${API_BASE}/query/by-components`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        components: selectedComponents,
                        temperature: temperature
                    })
                });

                const data = await res.json();
                
                if (data.success && data.data) {
                    lastQueryResult = {
                        temperature,
                        result: data.data,
                        components: [...selectedComponents],
                        createdAt: new Date().toISOString()
                    };
                    showResult(data.data, temperature);
                    addHistoryEntry({
                        id: generateId('single'),
                        type: 'single',
                        status: 'success',
                        temperature,
                        components: [...selectedComponents],
                        result: data.data,
                        createdAt: new Date().toISOString()
                    });
                } else {
                    showNoData(data.message);
                    lastQueryResult = null;
                    addHistoryEntry({
                        id: generateId('single'),
                        type: 'single',
                        status: 'no-data',
                        temperature,
                        components: [...selectedComponents],
                        message: data.message || 'æœªæ‰¾åˆ°åŒ¹é…æ•°æ®',
                        createdAt: new Date().toISOString()
                    });
                }
            } catch (error) {
                showError('æŸ¥è¯¢å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
                lastQueryResult = null;
                addHistoryEntry({
                    id: generateId('single'),
                    type: 'single',
                    status: 'error',
                    temperature,
                    components: [...selectedComponents],
                    message: error.message || 'æŸ¥è¯¢å¤±è´¥',
                    createdAt: new Date().toISOString()
                });
            }
        }

        function showResult(result, queryTemp) {
            const compInfo = selectedComponents.map(k => COMPONENTS[k].formula).join(' + ');
            
            document.getElementById('resultContent').innerHTML = `
                <div class="result-success">
                    <div class="result-value">${result.pressure.toFixed(3)}</div>
                    <div class="result-unit">MPa</div>
                    <div class="result-info">
                        <div class="result-row">
                            <span class="result-label">æ°”ä½“ç»„åˆ†</span>
                            <span class="result-data">${compInfo}</span>
                        </div>
                        <div class="result-row">
                            <span class="result-label">æŸ¥è¯¢æ¸©åº¦</span>
                            <span class="result-data">${queryTemp} K</span>
                        </div>
                        <div class="result-row">
                            <span class="result-label">åŒ¹é…æ¸©åº¦</span>
                            <span class="result-data">${result.temperature.toFixed(2)} K</span>
                        </div>
                        <div class="result-row">
                            <span class="result-label">ç»„åˆ†è¯¦æƒ…</span>
                            <span class="result-data">${formatComposition(result.composition)}</span>
                        </div>
                    </div>
                    <div class="result-actions">
                        <button class="btn-mini" onclick="addCurrentToFavorites()">â­ æ”¶è—ç»“æœ</button>
                        <button class="btn-mini secondary" onclick="exportResultPdf()">ğŸ“„ å¯¼å‡º PDF</button>
                    </div>
                </div>
            `;
            
            document.getElementById('resultCard').classList.add('show');
        }

        function formatComposition(comp) {
            if (!comp) return '--';
            const parts = [];
            for (const [key, value] of Object.entries(comp)) {
                if (value > 0.001 && COMPONENTS[key]) {
                    parts.push(`${COMPONENTS[key].formula}: ${(value * 100).toFixed(1)}%`);
                }
            }
            return parts.join(', ') || '--';
        }

        function showNoData(message) {
            document.getElementById('resultContent').innerHTML = `
                <div class="result-error">
                    <div class="icon">ğŸ”</div>
                    <div style="font-size: 18px; margin-bottom: 10px;">æœªæ‰¾åˆ°åŒ¹é…æ•°æ®</div>
                    <div style="color: #94a3b8; font-size: 14px;">${message || 'è¯·å°è¯•è°ƒæ•´æ¸©åº¦'}</div>
                </div>
            `;
            document.getElementById('resultCard').classList.add('show');
        }

        function showError(msg) {
            document.getElementById('resultContent').innerHTML = `
                <div class="result-error">
                    <div class="icon">âš ï¸</div>
                    <div style="font-size: 18px;">${msg}</div>
                </div>
            `;
            document.getElementById('resultCard').classList.add('show');
        }

        // ==================== æŸ¥è¯¢å†å²ä¸æ”¶è— ====================
        function initQueryTools() {
            queryHistory = loadStoredList(STORAGE_KEYS.history);
            favorites = loadStoredList(STORAGE_KEYS.favorites);
            renderHistoryList();
            renderFavorites();
            setHistoryHint('ğŸ’¡ æŸ¥è¯¢å†å²å’Œæ”¶è—ä¿å­˜åœ¨æœ¬åœ°æµè§ˆå™¨ï¼Œå¯ç”¨äºå¿«é€Ÿå¤ç°æŸ¥è¯¢ã€‚');
        }

        function loadStoredList(key) {
            try {
                const raw = localStorage.getItem(key);
                if (!raw) return [];
                const parsed = JSON.parse(raw);
                return Array.isArray(parsed) ? parsed : [];
            } catch (error) {
                console.error('è¯»å–æœ¬åœ°å­˜å‚¨å¤±è´¥:', error);
                return [];
            }
        }

        function saveStoredList(key, list) {
            try {
                localStorage.setItem(key, JSON.stringify(list));
            } catch (error) {
                console.error('ä¿å­˜æœ¬åœ°å­˜å‚¨å¤±è´¥:', error);
            }
        }

        function generateId(prefix) {
            return `${prefix}_${Date.now()}_${Math.random().toString(16).slice(2, 8)}`;
        }

        function escapeHtml(value) {
            if (value === null || value === undefined) return '';
            return String(value)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
        }

        function formatComponents(components, useAscii = false) {
            return (components || [])
                .map(key => {
                    if (useAscii) return COMPONENTS_ASCII[key] || key;
                    return COMPONENTS[key] ? COMPONENTS[key].formula : key;
                })
                .join(' + ');
        }

        function formatTime(value) {
            if (!value) return '';
            const date = new Date(value);
            if (Number.isNaN(date.getTime())) return '';
            return date.toLocaleString();
        }

        function setHistoryHint(text, type = 'info') {
            const hint = document.getElementById('historyHint');
            if (!hint) return;
            hint.textContent = text;
            if (type === 'error') {
                hint.style.color = '#fecaca';
            } else if (type === 'success') {
                hint.style.color = '#86efac';
            } else {
                hint.style.color = '#93c5fd';
            }
        }

        function addHistoryEntry(entry) {
            queryHistory.unshift(entry);
            if (queryHistory.length > HISTORY_LIMIT) {
                queryHistory = queryHistory.slice(0, HISTORY_LIMIT);
            }
            saveStoredList(STORAGE_KEYS.history, queryHistory);
            renderHistoryList();
        }

        function clearQueryHistory() {
            queryHistory = [];
            saveStoredList(STORAGE_KEYS.history, queryHistory);
            renderHistoryList();
            setHistoryHint('å·²æ¸…ç©ºæŸ¥è¯¢å†å²', 'success');
        }

        function removeHistoryEntry(entryId) {
            queryHistory = queryHistory.filter(item => item.id !== entryId);
            saveStoredList(STORAGE_KEYS.history, queryHistory);
            renderHistoryList();
        }

        function getStatusBadge(status) {
            switch (status) {
                case 'success':
                    return '<span class="badge badge-success">æˆåŠŸ</span>';
                case 'no-data':
                    return '<span class="badge badge-warn">æ— æ•°æ®</span>';
                case 'error':
                    return '<span class="badge badge-error">å¤±è´¥</span>';
                case 'batch':
                    return '<span class="badge badge-info">æ‰¹é‡</span>';
                default:
                    return '<span class="badge badge-info">è®°å½•</span>';
            }
        }

        function renderHistoryList() {
            const container = document.getElementById('queryHistoryList');
            if (!container) return;
            if (queryHistory.length === 0) {
                container.innerHTML = '<div class="item-meta">æš‚æ— å†å²è®°å½•</div>';
                return;
            }

            container.innerHTML = queryHistory.map(entry => {
                if (entry.type === 'batch') {
                    const batch = entry.batch || {};
                    const temperatures = batch.temperatures || [];
                    const results = batch.results || [];
                    const summary = batch.summary || computeBatchSummary(results);
                    const successCount = summary.successCount || 0;
                    const rangeText = summary.hasData
                        ? `${summary.minPressure.toFixed(3)}-${summary.maxPressure.toFixed(3)} MPa`
                        : 'æ— å¯ç”¨ç»“æœ';
                    return `
                        <div class="item-card">
                            <div class="item-title">${getStatusBadge('batch')} æ‰¹é‡æŸ¥è¯¢</div>
                            <div class="item-meta">
                                ç»„åˆ†ï¼š${escapeHtml(formatComponents(entry.components))}
                                <br>æ•°é‡ï¼š${temperatures.length} æ¡ï¼ŒæˆåŠŸ ${successCount} æ¡
                                <br>å‹åŠ›èŒƒå›´ï¼š${escapeHtml(rangeText)}
                                <br>æ—¶é—´ï¼š${escapeHtml(formatTime(entry.createdAt))}
                            </div>
                            <div class="item-actions">
                                <button class="btn-mini" onclick="applyBatchFromHistory('${entry.id}')">å¡«å…¥æ‰¹é‡</button>
                                <button class="btn-mini secondary" onclick="exportBatchPdfFromHistory('${entry.id}')">PDF</button>
                                <button class="btn-mini danger" onclick="removeHistoryEntry('${entry.id}')">åˆ é™¤</button>
                            </div>
                        </div>
                    `;
                }

                const pressureText = entry.status === 'success' && entry.result
                    ? `å‹åŠ› ${entry.result.pressure.toFixed(3)} MPa Â· åŒ¹é…æ¸©åº¦ ${entry.result.temperature.toFixed(2)} K`
                    : escapeHtml(entry.message || 'æœªæ‰¾åˆ°åŒ¹é…æ•°æ®');

                const hasFavorite = isFavorite(entry.components, entry.temperature);
                return `
                    <div class="item-card">
                        <div class="item-title">${getStatusBadge(entry.status)} å•æ¬¡æŸ¥è¯¢</div>
                        <div class="item-meta">
                            ç»„åˆ†ï¼š${escapeHtml(formatComponents(entry.components))}
                            <br>æ¸©åº¦ï¼š${entry.temperature} K
                            <br>${escapeHtml(pressureText)}
                            <br>æ—¶é—´ï¼š${escapeHtml(formatTime(entry.createdAt))}
                        </div>
                        <div class="item-actions">
                            <button class="btn-mini" onclick="rerunHistoryQuery('${entry.id}')">é‡æ–°æŸ¥è¯¢</button>
                            ${entry.status === 'success' && !hasFavorite
                                ? `<button class="btn-mini secondary" onclick="addFavoriteFromHistory('${entry.id}')">æ”¶è—</button>`
                                : ''}
                            ${entry.status === 'success'
                                ? `<button class="btn-mini secondary" onclick="exportSinglePdfFromHistory('${entry.id}')">PDF</button>`
                                : ''}
                            <button class="btn-mini danger" onclick="removeHistoryEntry('${entry.id}')">åˆ é™¤</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function addCurrentToFavorites() {
            if (!lastQueryResult || !lastQueryResult.result) {
                setHistoryHint('å½“å‰æ²¡æœ‰å¯æ”¶è—çš„ç»“æœ', 'error');
                return;
            }
            const note = window.prompt('ä¸ºæ”¶è—æ·»åŠ å¤‡æ³¨ï¼ˆå¯é€‰ï¼‰', '');
            if (note === null) return;
            const entry = {
                id: generateId('fav'),
                components: [...lastQueryResult.components],
                temperature: lastQueryResult.temperature,
                result: lastQueryResult.result,
                note: note.trim(),
                createdAt: new Date().toISOString()
            };
            if (isFavorite(entry.components, entry.temperature)) {
                setHistoryHint('è¯¥æŸ¥è¯¢å·²åœ¨æ”¶è—ä¸­', 'error');
                return;
            }
            favorites.unshift(entry);
            if (favorites.length > FAVORITE_LIMIT) {
                favorites = favorites.slice(0, FAVORITE_LIMIT);
            }
            saveStoredList(STORAGE_KEYS.favorites, favorites);
            renderFavorites();
            setHistoryHint('å·²æ”¶è—å½“å‰ç»“æœ', 'success');
        }

        function addFavoriteFromHistory(entryId) {
            const entry = queryHistory.find(item => item.id === entryId);
            if (!entry || entry.status !== 'success') {
                setHistoryHint('è¯¥å†å²è®°å½•æ— æ³•æ”¶è—', 'error');
                return;
            }
            const note = window.prompt('ä¸ºæ”¶è—æ·»åŠ å¤‡æ³¨ï¼ˆå¯é€‰ï¼‰', '');
            if (note === null) return;
            const favorite = {
                id: generateId('fav'),
                components: [...entry.components],
                temperature: entry.temperature,
                result: entry.result,
                note: note.trim(),
                createdAt: new Date().toISOString()
            };
            if (isFavorite(favorite.components, favorite.temperature)) {
                setHistoryHint('è¯¥æŸ¥è¯¢å·²åœ¨æ”¶è—ä¸­', 'error');
                return;
            }
            favorites.unshift(favorite);
            if (favorites.length > FAVORITE_LIMIT) {
                favorites = favorites.slice(0, FAVORITE_LIMIT);
            }
            saveStoredList(STORAGE_KEYS.favorites, favorites);
            renderFavorites();
            setHistoryHint('å·²æ”¶è—å†å²ç»“æœ', 'success');
        }

        function isFavorite(components, temperature) {
            return favorites.some(item =>
                Number(item.temperature) === Number(temperature)
                && JSON.stringify(item.components || []) === JSON.stringify(components || [])
            );
        }

        function clearFavorites() {
            favorites = [];
            saveStoredList(STORAGE_KEYS.favorites, favorites);
            renderFavorites();
            setHistoryHint('å·²æ¸…ç©ºæ”¶è—å¤¹', 'success');
        }

        function removeFavorite(entryId) {
            favorites = favorites.filter(item => item.id !== entryId);
            saveStoredList(STORAGE_KEYS.favorites, favorites);
            renderFavorites();
        }

        function renderFavorites() {
            const container = document.getElementById('favoriteList');
            if (!container) return;
            if (favorites.length === 0) {
                container.innerHTML = '<div class="item-meta">æš‚æ— æ”¶è—è®°å½•</div>';
                return;
            }
            container.innerHTML = favorites.map(entry => `
                <div class="item-card">
                    <div class="item-title">
                        <span class="badge badge-success">æ”¶è—</span>
                        ${escapeHtml(entry.note || 'æ”¶è—ç»“æœ')}
                    </div>
                    <div class="item-meta">
                        ç»„åˆ†ï¼š${escapeHtml(formatComponents(entry.components))}
                        <br>æ¸©åº¦ï¼š${entry.temperature} K
                        <br>å‹åŠ›ï¼š${entry.result ? entry.result.pressure.toFixed(3) : '--'} MPa
                        <br>æ—¶é—´ï¼š${escapeHtml(formatTime(entry.createdAt))}
                    </div>
                    <div class="item-actions">
                        <button class="btn-mini" onclick="applyFavorite('${entry.id}')">ä½¿ç”¨</button>
                        <button class="btn-mini secondary" onclick="exportFavoritePdf('${entry.id}')">PDF</button>
                        <button class="btn-mini danger" onclick="removeFavorite('${entry.id}')">åˆ é™¤</button>
                    </div>
                </div>
            `).join('');
        }

        async function applyComponentsForQuery(components) {
            selectedComponents = [...components];
            await updateAvailableComponents();
            renderComponentButtons();
            await confirmComponents();
        }

        async function rerunHistoryQuery(entryId) {
            const entry = queryHistory.find(item => item.id === entryId);
            if (!entry) return;
            await applyComponentsForQuery(entry.components);
            const tempInput = document.getElementById('temperature');
            if (tempInput) tempInput.value = entry.temperature;
            await doQuery();
        }

        async function applyFavorite(entryId) {
            const entry = favorites.find(item => item.id === entryId);
            if (!entry) return;
            await applyComponentsForQuery(entry.components);
            const tempInput = document.getElementById('temperature');
            if (tempInput) tempInput.value = entry.temperature;
            setHistoryHint('å·²å¡«å…¥æ”¶è—æ¡ä»¶ï¼Œå¯ç›´æ¥ç‚¹å‡»æŸ¥è¯¢', 'success');
        }

        async function applyBatchFromHistory(entryId) {
            const entry = queryHistory.find(item => item.id === entryId);
            if (!entry || entry.type !== 'batch') return;
            await applyComponentsForQuery(entry.components);
            const textarea = document.getElementById('batchTemperatures');
            if (textarea) {
                textarea.value = (entry.batch && entry.batch.temperatures || []).join('\n');
            }
            document.getElementById('batchCard').scrollIntoView({ behavior: 'smooth', block: 'start' });
            setBatchStatus('å·²å¡«å…¥æ‰¹é‡æ¸©åº¦ï¼Œå¯ç›´æ¥ç‚¹å‡»æ‰¹é‡æŸ¥è¯¢', 'success');
        }

        // ==================== æ‰¹é‡æŸ¥è¯¢ä¸å¯¹æ¯” ====================
        function parseBatchTemperatures(raw) {
            const parts = raw.split(/[\s,;]+/).map(item => item.trim()).filter(Boolean);
            const values = [];
            const seen = new Set();
            for (const item of parts) {
                const value = parseFloat(item);
                if (!Number.isFinite(value)) continue;
                const key = value.toString();
                if (seen.has(key)) continue;
                seen.add(key);
                values.push(value);
            }
            return values;
        }

        function clearBatchInput() {
            const textarea = document.getElementById('batchTemperatures');
            if (textarea) textarea.value = '';
            document.getElementById('batchResults').innerHTML = '';
            document.getElementById('batchSummary').style.display = 'none';
            setBatchStatus('å·²æ¸…ç©ºæ‰¹é‡è¾“å…¥', 'success');
            lastBatchResult = null;
        }

        function setBatchStatus(message, type = 'info') {
            const status = document.getElementById('batchStatus');
            if (!status) return;
            status.textContent = message;
            if (type === 'error') {
                status.style.color = '#fecaca';
            } else if (type === 'success') {
                status.style.color = '#86efac';
            } else {
                status.style.color = '#94a3b8';
            }
        }

        async function runBatchQuery() {
            if (selectedComponents.length === 0) {
                setBatchStatus('è¯·å…ˆé€‰æ‹©å¹¶ç¡®è®¤ç»„åˆ†ç»„åˆ', 'error');
                return;
            }

            const textarea = document.getElementById('batchTemperatures');
            const temps = parseBatchTemperatures(textarea ? textarea.value : '');
            if (temps.length === 0) {
                setBatchStatus('è¯·è¾“å…¥è‡³å°‘ä¸€ä¸ªæœ‰æ•ˆæ¸©åº¦', 'error');
                return;
            }
            if (temps.length > BATCH_LIMIT) {
                setBatchStatus(`æ‰¹é‡æŸ¥è¯¢æœ€å¤šæ”¯æŒ ${BATCH_LIMIT} æ¡æ¸©åº¦`, 'error');
                return;
            }

            const btn = document.getElementById('batchQueryBtn');
            if (btn) {
                btn.disabled = true;
                btn.textContent = 'æŸ¥è¯¢ä¸­...';
            }

            const results = [];
            for (let i = 0; i < temps.length; i++) {
                const temp = temps[i];
                if (temp < 100 || temp > 400) {
                    results.push({
                        temperature: temp,
                        success: false,
                        status: 'invalid',
                        message: 'æ¸©åº¦è¶…å‡ºèŒƒå›´(100-400K)'
                    });
                    setBatchStatus(`å¤„ç†ä¸­ ${i + 1}/${temps.length}ï¼ˆå«æ— æ•ˆæ¸©åº¦ï¼‰...`);
                    continue;
                }
                try {
                    const res = await fetch(`${API_BASE}/query/by-components`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            components: selectedComponents,
                            temperature: temp
                        })
                    });
                    const data = await res.json();
                    if (data.success && data.data) {
                        results.push({
                            temperature: temp,
                            success: true,
                            status: 'success',
                            pressure: data.data.pressure,
                            matchedTemperature: data.data.temperature
                        });
                    } else {
                        results.push({
                            temperature: temp,
                            success: false,
                            status: 'no-data',
                            message: data.message || 'æœªæ‰¾åˆ°åŒ¹é…æ•°æ®'
                        });
                    }
                } catch (error) {
                    results.push({
                        temperature: temp,
                        success: false,
                        status: 'error',
                        message: error.message || 'æŸ¥è¯¢å¤±è´¥'
                    });
                }
                setBatchStatus(`å¤„ç†ä¸­ ${i + 1}/${temps.length}...`);
            }

            if (btn) {
                btn.disabled = false;
                btn.textContent = 'ğŸš€ æ‰¹é‡æŸ¥è¯¢';
            }

            const summary = computeBatchSummary(results);
            lastBatchResult = {
                components: [...selectedComponents],
                results: results.map(item => ({
                    temperature: item.temperature,
                    pressure: item.pressure || null,
                    matchedTemperature: item.matchedTemperature || null,
                    success: item.success,
                    status: item.status,
                    message: item.message || ''
                })),
                summary,
                createdAt: new Date().toISOString()
            };

            renderBatchResults(results, summary);
            setBatchStatus(`æ‰¹é‡æŸ¥è¯¢å®Œæˆï¼šæˆåŠŸ ${summary.successCount}/${summary.total} æ¡`, 'success');

            addHistoryEntry({
                id: generateId('batch'),
                type: 'batch',
                status: 'batch',
                components: [...selectedComponents],
                batch: {
                    temperatures: temps,
                    results: lastBatchResult.results,
                    summary
                },
                createdAt: new Date().toISOString()
            });
        }

        function computeBatchSummary(results) {
            const total = results.length;
            const successItems = results.filter(item => item.success);
            if (successItems.length === 0) {
                return {
                    hasData: false,
                    total,
                    successCount: 0,
                    minPressure: 0,
                    maxPressure: 0,
                    avgPressure: 0,
                    minTemp: null,
                    maxTemp: null
                };
            }
            const pressures = successItems.map(item => item.pressure);
            const minPressure = Math.min(...pressures);
            const maxPressure = Math.max(...pressures);
            const avgPressure = pressures.reduce((sum, value) => sum + value, 0) / pressures.length;
            const minItem = successItems.find(item => item.pressure === minPressure);
            const maxItem = successItems.find(item => item.pressure === maxPressure);
            return {
                hasData: true,
                total,
                successCount: successItems.length,
                minPressure,
                maxPressure,
                avgPressure,
                minTemp: minItem ? minItem.temperature : null,
                maxTemp: maxItem ? maxItem.temperature : null
            };
        }

        function renderBatchResults(results, summary) {
            const summaryEl = document.getElementById('batchSummary');
            const resultsEl = document.getElementById('batchResults');
            if (!summaryEl || !resultsEl) return;

            summaryEl.style.display = 'grid';
            summaryEl.innerHTML = `
                <div class="stat-card">
                    <div class="stat-label">æˆåŠŸ/æ€»æ•°</div>
                    <div class="stat-value">${summary.successCount}/${summary.total}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">å‹åŠ›èŒƒå›´</div>
                    <div class="stat-value">
                        ${summary.hasData ? `${summary.minPressure.toFixed(3)}-${summary.maxPressure.toFixed(3)} MPa` : 'N/A'}
                    </div>
                    <div class="stat-label">
                        ${summary.hasData ? `å¯¹åº”æ¸©åº¦ ${summary.minTemp.toFixed(1)} / ${summary.maxTemp.toFixed(1)} K` : ''}
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">å¹³å‡å‹åŠ›</div>
                    <div class="stat-value">${summary.hasData ? `${summary.avgPressure.toFixed(3)} MPa` : 'N/A'}</div>
                </div>
            `;

            const rows = results.map((item, index) => {
                const statusBadge = item.success
                    ? '<span class="badge badge-success">æˆåŠŸ</span>'
                    : item.status === 'invalid'
                        ? '<span class="badge badge-error">æ— æ•ˆ</span>'
                        : '<span class="badge badge-warn">æ— æ•°æ®</span>';
                const pressureText = item.success ? item.pressure.toFixed(3) : '--';
                const matchedText = item.success ? item.matchedTemperature.toFixed(2) : '--';
                const messageText = item.success ? 'åŒ¹é…æˆåŠŸ' : (item.message || 'æœªæ‰¾åˆ°åŒ¹é…æ•°æ®');
                return `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${item.temperature}</td>
                        <td>${matchedText}</td>
                        <td>${pressureText}</td>
                        <td>${statusBadge}</td>
                        <td>${escapeHtml(messageText)}</td>
                        <td>
                            <button class="btn-mini secondary" onclick="applySingleTemperature(${item.temperature})">å•æ¬¡æŸ¥è¯¢</button>
                        </td>
                    </tr>
                `;
            }).join('');

            resultsEl.innerHTML = `
                <table class="batch-table">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>æŸ¥è¯¢æ¸©åº¦(K)</th>
                            <th>åŒ¹é…æ¸©åº¦(K)</th>
                            <th>å‹åŠ›(MPa)</th>
                            <th>çŠ¶æ€</th>
                            <th>è¯´æ˜</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${rows}
                    </tbody>
                </table>
            `;
        }

        async function applySingleTemperature(temperature) {
            if (lastBatchResult && lastBatchResult.components) {
                await applyComponentsForQuery(lastBatchResult.components);
            }
            const tempInput = document.getElementById('temperature');
            if (tempInput) tempInput.value = temperature;
            await doQuery();
        }

        // ==================== PDF å¯¼å‡º ====================
        function getPdfDoc() {
            if (!window.jspdf || !window.jspdf.jsPDF) {
                throw new Error('PDF å¯¼å‡ºåº“æœªåŠ è½½');
            }
            return new window.jspdf.jsPDF({ unit: 'pt', format: 'a4' });
        }

        function formatTimeForPdf(value) {
            if (!value) return '';
            const date = new Date(value);
            if (Number.isNaN(date.getTime())) return '';
            return date.toLocaleString('en-US');
        }

        function formatCompositionAscii(comp) {
            if (!comp) return '--';
            const parts = [];
            for (const [key, value] of Object.entries(comp)) {
                if (value > 0.001 && COMPONENTS_ASCII[key]) {
                    parts.push(`${COMPONENTS_ASCII[key]}: ${(value * 100).toFixed(1)}%`);
                }
            }
            return parts.join(', ') || '--';
        }

        function exportResultPdf() {
            if (!lastQueryResult || !lastQueryResult.result) {
                setHistoryHint('æ²¡æœ‰å¯å¯¼å‡ºçš„æŸ¥è¯¢ç»“æœ', 'error');
                return;
            }
            exportSinglePdf(lastQueryResult, 'query-result.pdf');
        }

        function exportSinglePdfFromHistory(entryId) {
            const entry = queryHistory.find(item => item.id === entryId);
            if (!entry || entry.status !== 'success') {
                setHistoryHint('å†å²è®°å½•æ— æ³•å¯¼å‡º', 'error');
                return;
            }
            exportSinglePdf({
                temperature: entry.temperature,
                components: entry.components,
                result: entry.result,
                createdAt: entry.createdAt
            }, 'query-result-history.pdf');
        }

        function exportFavoritePdf(entryId) {
            const entry = favorites.find(item => item.id === entryId);
            if (!entry || !entry.result) {
                setHistoryHint('æ”¶è—è®°å½•æ— æ³•å¯¼å‡º', 'error');
                return;
            }
            exportSinglePdf({
                temperature: entry.temperature,
                components: entry.components,
                result: entry.result,
                createdAt: entry.createdAt
            }, 'query-favorite.pdf');
        }

        function exportSinglePdf(payload, filename) {
            try {
                const doc = getPdfDoc();
                let y = 48;
                doc.setFontSize(16);
                doc.text('Gas Hydrate Query Result', 40, y);
                y += 20;
                doc.setFontSize(11);
                doc.text(`Generated: ${formatTimeForPdf(payload.createdAt)}`, 40, y);
                y += 18;
                doc.text(`Components: ${formatComponents(payload.components, true)}`, 40, y);
                y += 18;
                doc.text(`Query Temperature (K): ${payload.temperature}`, 40, y);
                y += 18;
                doc.text(`Matched Temperature (K): ${payload.result.temperature.toFixed(2)}`, 40, y);
                y += 18;
                doc.text(`Pressure (MPa): ${payload.result.pressure.toFixed(3)}`, 40, y);
                y += 18;
                doc.text(`Composition: ${formatCompositionAscii(payload.result.composition)}`, 40, y, { maxWidth: 520 });
                doc.save(filename || 'query-result.pdf');
                setHistoryHint('PDF å·²ç”Ÿæˆ', 'success');
            } catch (error) {
                setHistoryHint(`PDF å¯¼å‡ºå¤±è´¥: ${error.message}`, 'error');
            }
        }

        function exportBatchPdf() {
            if (!lastBatchResult || !lastBatchResult.results) {
                setBatchStatus('æ²¡æœ‰å¯å¯¼å‡ºçš„æ‰¹é‡ç»“æœ', 'error');
                return;
            }
            exportBatchPdfPayload(lastBatchResult, 'batch-query.pdf');
        }

        function exportBatchPdfFromHistory(entryId) {
            const entry = queryHistory.find(item => item.id === entryId);
            if (!entry || entry.type !== 'batch') {
                setHistoryHint('æ‰¹é‡è®°å½•æ— æ³•å¯¼å‡º', 'error');
                return;
            }
            exportBatchPdfPayload({
                components: entry.components,
                results: entry.batch ? entry.batch.results : [],
                summary: entry.batch ? entry.batch.summary : computeBatchSummary(entry.batch ? entry.batch.results : []),
                createdAt: entry.createdAt
            }, 'batch-query-history.pdf');
        }

        function exportBatchPdfPayload(payload, filename) {
            try {
                const doc = getPdfDoc();
                let y = 48;
                doc.setFontSize(16);
                doc.text('Batch Query Results', 40, y);
                y += 20;
                doc.setFontSize(11);
                doc.text(`Generated: ${formatTimeForPdf(payload.createdAt)}`, 40, y);
                y += 18;
                doc.text(`Components: ${formatComponents(payload.components, true)}`, 40, y);
                y += 18;
                const summary = payload.summary || computeBatchSummary(payload.results || []);
                const rangeText = summary.hasData
                    ? `${summary.minPressure.toFixed(3)}-${summary.maxPressure.toFixed(3)} MPa`
                    : 'N/A';
                doc.text(`Success/Total: ${summary.successCount}/${summary.total}`, 40, y);
                y += 16;
                doc.text(`Pressure Range: ${rangeText}`, 40, y);
                y += 16;
                doc.text(`Avg Pressure: ${summary.hasData ? summary.avgPressure.toFixed(3) : 'N/A'} MPa`, 40, y);
                y += 22;

                doc.setFontSize(10);
                const columns = [40, 90, 160, 250, 330];
                doc.text('#', columns[0], y);
                doc.text('Query K', columns[1], y);
                doc.text('Match K', columns[2], y);
                doc.text('Pressure', columns[3], y);
                doc.text('Status', columns[4], y);
                y += 14;

                const rows = payload.results || [];
                rows.forEach((item, index) => {
                    if (y > 760) {
                        doc.addPage();
                        y = 48;
                    }
                    const statusText = item.success ? 'OK' : (item.status === 'invalid' ? 'INVALID' : item.status === 'error' ? 'ERROR' : 'NO_DATA');
                    doc.text(String(index + 1), columns[0], y);
                    doc.text(String(item.temperature), columns[1], y);
                    doc.text(item.matchedTemperature ? item.matchedTemperature.toFixed(2) : '--', columns[2], y);
                    doc.text(item.pressure ? item.pressure.toFixed(3) : '--', columns[3], y);
                    doc.text(statusText, columns[4], y);
                    y += 14;
                });

                doc.save(filename || 'batch-query.pdf');
                setBatchStatus('PDF å·²ç”Ÿæˆ', 'success');
            } catch (error) {
                setBatchStatus(`PDF å¯¼å‡ºå¤±è´¥: ${error.message}`, 'error');
            }
        }
    </script>

    <!-- æ•°æ®å¯è§†åŒ–æ¨¡å— -->
    <script src="js/charts.js"></script>
</body>
</html>
