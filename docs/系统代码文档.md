# æ°”ä½“æ··åˆç‰©æ•°æ®ç®¡ç†ç³»ç»Ÿ V4.0 - æºä»£ç æ–‡æ¡£

---

## ç›®å½•

1. [ç”¨æˆ·å‰ç«¯ - ç›¸å¹³è¡¡æŸ¥è¯¢](#ä¸€ç”¨æˆ·å‰ç«¯---ç›¸å¹³è¡¡æŸ¥è¯¢)
2. [ç®¡ç†åå° - æ•°æ®ç®¡ç†](#äºŒç®¡ç†åå°---æ•°æ®ç®¡ç†)
3. [æ•°æ®å®¡æ ¸æ¨¡å—](#ä¸‰æ•°æ®å®¡æ ¸æ¨¡å—)
4. [å®‰å…¨åŠŸèƒ½](#å››å®‰å…¨åŠŸèƒ½)
5. [ç”¨æˆ·ç®¡ç†](#äº”ç”¨æˆ·ç®¡ç†)
6. [å¤‡ä»½ä¸æ¢å¤](#å…­å¤‡ä»½ä¸æ¢å¤)
7. [æ•°æ®å¯è§†åŒ–](#ä¸ƒæ•°æ®å¯è§†åŒ–)
8. [API æ¥å£](#å…«api-æ¥å£)

---

## ä¸€ã€ç”¨æˆ·å‰ç«¯ - ç›¸å¹³è¡¡æŸ¥è¯¢

### 1.1 æ¨¡å—ç®€ä»‹

ç”¨æˆ·å‰ç«¯æ˜¯ç³»ç»Ÿçš„å…¬å¼€æŸ¥è¯¢ç•Œé¢ï¼Œæä¾›æ°”ä½“æ°´åˆç‰©ç›¸å¹³è¡¡æ•°æ®çš„æ™ºèƒ½æŸ¥è¯¢åŠŸèƒ½ã€‚ç”¨æˆ·å¯ä»¥é€‰æ‹©æ°”ä½“ç»„åˆ†ï¼ˆç”²çƒ·ã€ä¹™çƒ·ã€ä¸™çƒ·ã€äºŒæ°§åŒ–ç¢³ã€æ°®æ°”ã€ç¡«åŒ–æ°¢ã€å¼‚ä¸çƒ·å…±7ç§ï¼‰ï¼Œç³»ç»Ÿè‡ªåŠ¨æ˜¾ç¤ºæ•°æ®åº“ä¸­å„ç»„åˆ†çš„æ‘©å°”åˆ†æ•°èŒƒå›´ï¼Œç”¨æˆ·è¾“å…¥æ¸©åº¦åå³å¯æŸ¥è¯¢ç›¸å¹³è¡¡å‹åŠ›ã€‚ç•Œé¢é‡‡ç”¨åˆ†æ­¥å¼•å¯¼å¼è®¾è®¡ï¼Œå“åº”å¼å¸ƒå±€æ”¯æŒå¤šè®¾å¤‡è®¿é—®ã€‚

### 1.2 å‰ç«¯é¡µé¢ä»£ç  (frontend/index.html)

```html
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ°”ä½“æ°´åˆç‰©ç›¸å¹³è¡¡æŸ¥è¯¢ç³»ç»Ÿ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: linear-gradient(135deg, #0c1929 0%, #1a2940 50%, #0d2137 100%);
            min-height: 100vh;
            color: #e2e8f0;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
        }

        h1 {
            font-size: 28px;
            background: linear-gradient(135deg, #60a5fa, #34d399);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 8px;
        }

        .subtitle {
            color: #94a3b8;
            font-size: 14px;
        }

        .card {
            background: rgba(30, 41, 59, 0.8);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 20px;
            border: 1px solid rgba(71, 85, 105, 0.5);
            backdrop-filter: blur(10px);
        }

        .card-title {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
            font-size: 16px;
            color: #f1f5f9;
        }

        .card-title .step {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 600;
        }

        /* ç»„åˆ†é€‰æ‹©æŒ‰é’® */
        .component-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .comp-btn {
            padding: 10px 18px;
            background: rgba(15, 23, 42, 0.6);
            border: 2px solid #334155;
            border-radius: 10px;
            color: #94a3b8;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
        }

        .comp-btn:hover:not(.disabled) {
            border-color: #3b82f6;
            color: #f1f5f9;
        }

        .comp-btn.selected {
            background: rgba(59, 130, 246, 0.2);
            border-color: #3b82f6;
            color: #60a5fa;
        }

        .comp-btn.disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        /* å·²é€‰ç»„åˆ†æ ‡ç­¾ */
        .selected-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
            min-height: 40px;
        }

        .tag {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 12px 8px 16px;
            border-radius: 25px;
            font-size: 14px;
            font-weight: 500;
        }

        .tag .remove-btn {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            cursor: pointer;
        }

        /* ç¡®è®¤æŒ‰é’® */
        .btn-confirm {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #10b981, #059669);
            border: none;
            border-radius: 10px;
            color: white;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            margin-top: 20px;
        }

        .btn-confirm:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(16, 185, 129, 0.4);
        }

        .btn-confirm:disabled {
            background: #475569;
            cursor: not-allowed;
        }

        /* ç»„åˆ†åŒºé—´æ˜¾ç¤º */
        .range-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: rgba(15, 23, 42, 0.6);
            border-radius: 10px;
            margin-bottom: 10px;
        }

        .range-item .range-value {
            font-size: 16px;
            font-weight: 600;
            color: #34d399;
        }

        /* æŸ¥è¯¢æŒ‰é’® */
        .btn-query {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            border: none;
            border-radius: 12px;
            color: white;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            margin-top: 20px;
        }

        .btn-query:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(59, 130, 246, 0.4);
        }

        /* ç»“æœå±•ç¤º */
        .result-value {
            font-size: 64px;
            font-weight: 700;
            background: linear-gradient(135deg, #34d399, #10b981);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .result-unit {
            font-size: 24px;
            color: #94a3b8;
            margin-bottom: 20px;
        }

        /* é¢œè‰²æ–¹æ¡ˆ */
        .color-ch4 { background: linear-gradient(135deg, #ef4444, #dc2626); }
        .color-c2h6 { background: linear-gradient(135deg, #f97316, #ea580c); }
        .color-c3h8 { background: linear-gradient(135deg, #eab308, #ca8a04); }
        .color-co2 { background: linear-gradient(135deg, #22c55e, #16a34a); }
        .color-n2 { background: linear-gradient(135deg, #06b6d4, #0891b2); }
        .color-h2s { background: linear-gradient(135deg, #8b5cf6, #7c3aed); }
        .color-ic4h10 { background: linear-gradient(135deg, #ec4899, #db2777); }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>âš—ï¸ æ°”ä½“æ°´åˆç‰©ç›¸å¹³è¡¡æŸ¥è¯¢</h1>
            <p class="subtitle">Gas Hydrate Phase Equilibrium Query System</p>
        </header>

        <!-- æ­¥éª¤1: é€‰æ‹©ç»„åˆ† -->
        <div class="card">
            <div class="card-title">
                <span class="step">1</span>
                <span>é€‰æ‹©æ°”ä½“ç»„åˆ†</span>
            </div>
            <div class="component-buttons" id="componentButtons"></div>
            <div class="selected-tags" id="selectedTags"></div>
            <button class="btn-confirm" id="confirmBtn" onclick="confirmComponents()" disabled>
                âœ“ ç¡®è®¤ç»„åˆ†ç»„åˆ
            </button>
        </div>

        <!-- æ­¥éª¤2: æ˜¾ç¤ºç»„åˆ†åŒºé—´ -->
        <div class="card" id="rangeCard" style="display: none;">
            <div class="card-title">
                <span class="step">2</span>
                <span>æ•°æ®åº“ä¸­çš„ç»„åˆ†åŒºé—´</span>
            </div>
            <div class="range-display" id="rangeDisplay"></div>
            <div class="match-stats" id="matchStats"></div>
        </div>

        <!-- æ­¥éª¤3: æ¸©åº¦å’ŒæŸ¥è¯¢ -->
        <div class="card" id="queryCard" style="display: none;">
            <div class="card-title">
                <span class="step">3</span>
                <span>è¾“å…¥æ¸©åº¦å¹¶æŸ¥è¯¢</span>
            </div>
            <div class="temp-input-group">
                <label>æ¸©åº¦</label>
                <input type="number" id="temperature" placeholder="ä¾‹å¦‚: 275" step="0.1">
                <span class="unit">K</span>
            </div>
            <button class="btn-query" id="queryBtn" onclick="doQuery()">ğŸ” æŸ¥è¯¢ç›¸å¹³è¡¡å‹åŠ›</button>
        </div>

        <!-- ç»“æœå±•ç¤º -->
        <div class="card result-card" id="resultCard">
            <div id="resultContent"></div>
        </div>

        <footer>
            Â© 2024 Gas Hydrate Database | æ¬¢è¿ä½¿ç”¨ï¼Œæå‡æ•°æ®åº“å½±å“åŠ›
        </footer>
    </div>

    <script>
        // ç»„åˆ†é…ç½®
        const COMPONENTS = {
            'x_ch4': { name: 'ç”²çƒ·', formula: 'CHâ‚„', color: 'color-ch4', dot: 'dot-ch4' },
            'x_c2h6': { name: 'ä¹™çƒ·', formula: 'Câ‚‚Hâ‚†', color: 'color-c2h6', dot: 'dot-c2h6' },
            'x_c3h8': { name: 'ä¸™çƒ·', formula: 'Câ‚ƒHâ‚ˆ', color: 'color-c3h8', dot: 'dot-c3h8' },
            'x_co2': { name: 'äºŒæ°§åŒ–ç¢³', formula: 'COâ‚‚', color: 'color-co2', dot: 'dot-co2' },
            'x_n2': { name: 'æ°®æ°”', formula: 'Nâ‚‚', color: 'color-n2', dot: 'dot-n2' },
            'x_h2s': { name: 'ç¡«åŒ–æ°¢', formula: 'Hâ‚‚S', color: 'color-h2s', dot: 'dot-h2s' },
            'x_ic4h10': { name: 'å¼‚ä¸çƒ·', formula: 'i-Câ‚„Hâ‚â‚€', color: 'color-ic4h10', dot: 'dot-ic4h10' }
        };

        const API_BASE = '/api';
        let selectedComponents = [];
        let availableComponents = Object.keys(COMPONENTS);
        let componentRanges = {};

        document.addEventListener('DOMContentLoaded', () => {
            renderComponentButtons();
        });

        function renderComponentButtons() {
            const container = document.getElementById('componentButtons');
            container.innerHTML = '';
            Object.entries(COMPONENTS).forEach(([key, comp]) => {
                const btn = document.createElement('button');
                btn.className = 'comp-btn';
                btn.dataset.comp = key;
                const isSelected = selectedComponents.includes(key);
                const isAvailable = availableComponents.includes(key);
                if (isSelected) btn.classList.add('selected');
                if (!isAvailable && !isSelected) btn.classList.add('disabled');
                btn.innerHTML = `${comp.name} <span class="formula">${comp.formula}</span>`;
                btn.onclick = () => toggleComponent(key);
                container.appendChild(btn);
            });
            renderSelectedTags();
            updateConfirmButton();
        }

        function renderSelectedTags() {
            const container = document.getElementById('selectedTags');
            container.innerHTML = '';
            if (selectedComponents.length === 0) {
                container.innerHTML = '<span style="color: #64748b;">å°šæœªé€‰æ‹©ä»»ä½•ç»„åˆ†</span>';
                return;
            }
            selectedComponents.forEach(key => {
                const comp = COMPONENTS[key];
                const tag = document.createElement('div');
                tag.className = `tag ${comp.color}`;
                tag.innerHTML = `
                    <span>${comp.name} (${comp.formula})</span>
                    <button class="remove-btn" onclick="removeComponent('${key}')">âœ•</button>
                `;
                container.appendChild(tag);
            });
        }

        async function toggleComponent(key) {
            if (selectedComponents.includes(key)) {
                removeComponent(key);
                return;
            }
            if (!availableComponents.includes(key)) return;
            selectedComponents.push(key);
            await updateAvailableComponents();
            renderComponentButtons();
            document.getElementById('rangeCard').style.display = 'none';
            document.getElementById('queryCard').style.display = 'none';
        }

        async function updateAvailableComponents() {
            if (selectedComponents.length === 0) {
                availableComponents = Object.keys(COMPONENTS);
                return;
            }
            try {
                const res = await fetch(`${API_BASE}/components/available`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ selected: selectedComponents })
                });
                const data = await res.json();
                if (data.success) {
                    availableComponents = data.available;
                }
            } catch (e) {
                console.error(e);
            }
        }

        async function confirmComponents() {
            if (selectedComponents.length === 0) return;
            try {
                const res = await fetch(`${API_BASE}/components/ranges`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ components: selectedComponents })
                });
                const data = await res.json();
                if (data.success) {
                    componentRanges = data.ranges;
                    displayRanges(data);
                    document.getElementById('rangeCard').style.display = 'block';
                    document.getElementById('queryCard').style.display = data.total_records > 0 ? 'block' : 'none';
                }
            } catch (e) {
                alert('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•');
            }
        }

        async function doQuery() {
            const temperature = parseFloat(document.getElementById('temperature').value);
            if (!temperature || temperature < 100 || temperature > 400) {
                showError('è¯·è¾“å…¥æœ‰æ•ˆçš„æ¸©åº¦ï¼ˆ100-400 Kï¼‰');
                return;
            }
            try {
                const res = await fetch(`${API_BASE}/query/by-components`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        components: selectedComponents,
                        temperature: temperature
                    })
                });
                const data = await res.json();
                if (data.success && data.data) {
                    showResult(data.data, temperature);
                } else {
                    showNoData(data.message);
                }
            } catch (error) {
                showError('æŸ¥è¯¢å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
            }
        }

        function showResult(result, queryTemp) {
            const compInfo = selectedComponents.map(k => COMPONENTS[k].formula).join(' + ');
            document.getElementById('resultContent').innerHTML = `
                <div class="result-success">
                    <div class="result-value">${result.pressure.toFixed(3)}</div>
                    <div class="result-unit">MPa</div>
                    <div class="result-info">
                        <div class="result-row">
                            <span>æ°”ä½“ç»„åˆ†</span>
                            <span>${compInfo}</span>
                        </div>
                        <div class="result-row">
                            <span>æŸ¥è¯¢æ¸©åº¦</span>
                            <span>${queryTemp} K</span>
                        </div>
                        <div class="result-row">
                            <span>åŒ¹é…æ¸©åº¦</span>
                            <span>${result.temperature.toFixed(2)} K</span>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('resultCard').classList.add('show');
        }
    </script>
</body>
</html>
```

---

## äºŒã€ç®¡ç†åå° - æ•°æ®ç®¡ç†

### 2.1 æ¨¡å—ç®€ä»‹

ç®¡ç†åå°æä¾›å®Œæ•´çš„æ•°æ®ç®¡ç†åŠŸèƒ½ï¼ŒåŒ…æ‹¬æ•°æ®çš„å¢åˆ æ”¹æŸ¥ã€åˆ†é¡µæµè§ˆã€æ¡ä»¶ç­›é€‰ç­‰ã€‚é‡‡ç”¨å‰åç«¯åˆ†ç¦»æ¶æ„ï¼Œåç«¯ä½¿ç”¨ FastAPI æ¡†æ¶æä¾› RESTful APIï¼Œå‰ç«¯ä½¿ç”¨ Vue.js æ„å»ºå“åº”å¼ç•Œé¢ã€‚æ•°æ®åº“æ“ä½œæ¨¡å—æ”¯æŒ SQLite å’Œ MySQL åŒæ•°æ®åº“ï¼Œé€šè¿‡ç¯å¢ƒå˜é‡çµæ´»åˆ‡æ¢ã€‚

### 2.2 æ•°æ®åº“æ“ä½œæ¨¡å— (backend/database.py)

```python
"""
æ•°æ®åº“æ“ä½œæ¨¡å—
ä½¿ç”¨ SQLite æ•°æ®åº“
"""

from typing import List, Dict, Optional, Any

from backend.db import get_connection, is_mysql


def _ensure_index(cursor, table: str, index_name: str, columns: str) -> None:
    if is_mysql():
        cursor.execute(
            """
            SELECT COUNT(1) as count
            FROM information_schema.statistics
            WHERE table_schema = DATABASE()
              AND table_name = ?
              AND index_name = ?
            """,
            (table, index_name),
        )
        row = cursor.fetchone()
        if not row or row["count"] == 0:
            cursor.execute(f"CREATE INDEX {index_name} ON {table}({columns})")
    else:
        cursor.execute(f"CREATE INDEX IF NOT EXISTS {index_name} ON {table}({columns})")


def init_database():
    """åˆå§‹åŒ–æ•°æ®åº“ï¼Œåˆ›å»ºæ•°æ®è¡¨"""
    id_column = "BIGINT PRIMARY KEY AUTO_INCREMENT" if is_mysql() else "INTEGER PRIMARY KEY AUTOINCREMENT"
    with get_connection(dict_cursor=True) as conn:
        cursor = conn.cursor()
        cursor.execute(f'''
            CREATE TABLE IF NOT EXISTS gas_mixture (
                id {id_column},
                temperature REAL NOT NULL,
                x_ch4 REAL DEFAULT 0,
                x_c2h6 REAL DEFAULT 0,
                x_c3h8 REAL DEFAULT 0,
                x_co2 REAL DEFAULT 0,
                x_n2 REAL DEFAULT 0,
                x_h2s REAL DEFAULT 0,
                x_ic4h10 REAL DEFAULT 0,
                pressure REAL NOT NULL,
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
            )
        ''')
        _ensure_index(cursor, "gas_mixture", "idx_gas_temperature", "temperature")
        _ensure_index(cursor, "gas_mixture", "idx_gas_pressure", "pressure")
        _ensure_index(cursor, "gas_mixture", "idx_gas_temp_pressure", "temperature, pressure")
        conn.commit()


# ==================== å¢ (Create) ====================
def create_record(data: Dict[str, Any]) -> int:
    """åˆ›å»ºæ–°è®°å½•"""
    with get_connection(dict_cursor=True) as conn:
        cursor = conn.cursor()
        cursor.execute('''
            INSERT INTO gas_mixture 
            (temperature, x_ch4, x_c2h6, x_c3h8, x_co2, x_n2, x_h2s, x_ic4h10, pressure)
            VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)
        ''', (
            data.get('temperature', 0),
            data.get('x_ch4', 0),
            data.get('x_c2h6', 0),
            data.get('x_c3h8', 0),
            data.get('x_co2', 0),
            data.get('x_n2', 0),
            data.get('x_h2s', 0),
            data.get('x_ic4h10', 0),
            data.get('pressure', 0)
        ))
        conn.commit()
        return cursor.lastrowid


# ==================== åˆ  (Delete) ====================
def delete_record(record_id: int) -> bool:
    """åˆ é™¤æŒ‡å®šIDçš„è®°å½•"""
    with get_connection(dict_cursor=True) as conn:
        cursor = conn.cursor()
        cursor.execute('DELETE FROM gas_mixture WHERE id = ?', (record_id,))
        conn.commit()
        return cursor.rowcount > 0


# ==================== æ”¹ (Update) ====================
def update_record(record_id: int, data: Dict[str, Any]) -> bool:
    """æ›´æ–°æŒ‡å®šIDçš„è®°å½•"""
    fields = []
    values = []
    
    field_mapping = {
        'temperature': 'temperature',
        'x_ch4': 'x_ch4',
        'x_c2h6': 'x_c2h6',
        'x_c3h8': 'x_c3h8',
        'x_co2': 'x_co2',
        'x_n2': 'x_n2',
        'x_h2s': 'x_h2s',
        'x_ic4h10': 'x_ic4h10',
        'pressure': 'pressure'
    }
    
    for key, db_field in field_mapping.items():
        if key in data and data[key] is not None:
            fields.append(f"{db_field} = ?")
            values.append(data[key])
    
    if not fields:
        return False
    
    fields.append("updated_at = CURRENT_TIMESTAMP")
    values.append(record_id)
    
    with get_connection(dict_cursor=True) as conn:
        cursor = conn.cursor()
        query = f"UPDATE gas_mixture SET {', '.join(fields)} WHERE id = ?"
        cursor.execute(query, values)
        conn.commit()
        return cursor.rowcount > 0


# ==================== æŸ¥ (Read) ====================
def get_record_by_id(record_id: int) -> Optional[Dict]:
    """æ ¹æ®IDè·å–å•æ¡è®°å½•"""
    with get_connection(dict_cursor=True) as conn:
        cursor = conn.cursor()
        cursor.execute('SELECT * FROM gas_mixture WHERE id = ?', (record_id,))
        row = cursor.fetchone()
        return dict(row) if row else None


def get_all_records(
    page: int = 1, 
    per_page: int = 15,
    temp_min: Optional[float] = None,
    temp_max: Optional[float] = None,
    pressure_min: Optional[float] = None,
    pressure_max: Optional[float] = None
) -> Dict:
    """è·å–æ‰€æœ‰è®°å½•ï¼ˆåˆ†é¡µ+ç­›é€‰ï¼‰"""
    conditions = []
    values = []
    
    if temp_min is not None:
        conditions.append("temperature >= ?")
        values.append(temp_min)
    if temp_max is not None:
        conditions.append("temperature <= ?")
        values.append(temp_max)
    if pressure_min is not None:
        conditions.append("pressure >= ?")
        values.append(pressure_min)
    if pressure_max is not None:
        conditions.append("pressure <= ?")
        values.append(pressure_max)
    
    where_clause = " AND ".join(conditions) if conditions else "1=1"
    offset = (page - 1) * per_page
    
    with get_connection(dict_cursor=True) as conn:
        cursor = conn.cursor()
        
        # è·å–æ€»æ•°
        cursor.execute(f'SELECT COUNT(*) as count FROM gas_mixture WHERE {where_clause}', values)
        total = cursor.fetchone()['count']
        
        # è·å–åˆ†é¡µæ•°æ®
        cursor.execute(f'''
            SELECT * FROM gas_mixture 
            WHERE {where_clause}
            ORDER BY id ASC 
            LIMIT ? OFFSET ?
        ''', values + [per_page, offset])
        
        records = [dict(row) for row in cursor.fetchall()]
        
        return {
            'records': records,
            'total': total,
            'page': page,
            'per_page': per_page,
            'total_pages': (total + per_page - 1) // per_page if total > 0 else 1
        }


def get_statistics() -> Dict:
    """è·å–æ•°æ®ç»Ÿè®¡ä¿¡æ¯"""
    with get_connection(dict_cursor=True) as conn:
        cursor = conn.cursor()
        cursor.execute('''
            SELECT 
                COUNT(*) as total_records,
                MIN(temperature) as min_temperature,
                MAX(temperature) as max_temperature,
                AVG(temperature) as avg_temperature,
                MIN(pressure) as min_pressure,
                MAX(pressure) as max_pressure,
                AVG(pressure) as avg_pressure
            FROM gas_mixture
        ''')
        row = cursor.fetchone()
        return dict(row) if row else {}


def batch_create_records(records: List[Dict[str, Any]]) -> int:
    """æ‰¹é‡åˆ›å»ºè®°å½•"""
    with get_connection(dict_cursor=True) as conn:
        cursor = conn.cursor()
        cursor.executemany('''
            INSERT INTO gas_mixture 
            (temperature, x_ch4, x_c2h6, x_c3h8, x_co2, x_n2, x_h2s, x_ic4h10, pressure)
            VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)
        ''', [
            (
                r.get('temperature', 0),
                r.get('x_ch4', 0),
                r.get('x_c2h6', 0),
                r.get('x_c3h8', 0),
                r.get('x_co2', 0),
                r.get('x_n2', 0),
                r.get('x_h2s', 0),
                r.get('x_ic4h10', 0),
                r.get('pressure', 0)
            ) for r in records
        ])
        conn.commit()
        return cursor.rowcount


# ==================== ç»„åˆ†æŸ¥è¯¢ ====================
def query_by_composition(composition: Dict[str, float], tolerance: float = 0.05, strict_mode: bool = True) -> List[Dict]:
    """
    æ ¹æ®æ°”ä½“ç»„åˆ†æŸ¥è¯¢åŒ¹é…çš„æ¸©åº¦å’Œå‹åŠ›
    composition: ç»„åˆ†å­—å…¸ï¼Œå¦‚ {'x_ch4': 0.9, 'x_c2h6': 0.05}
    tolerance: å…è®¸çš„è¯¯å·®èŒƒå›´ï¼ˆé»˜è®¤5%ï¼‰
    strict_mode: ä¸¥æ ¼æ¨¡å¼ï¼Œæœªè¾“å…¥çš„ç»„åˆ†è¦æ±‚æ¥è¿‘0
    """
    all_components = ['x_ch4', 'x_c2h6', 'x_c3h8', 'x_co2', 'x_n2', 'x_h2s', 'x_ic4h10']
    
    with get_connection(dict_cursor=True) as conn:
        cursor = conn.cursor()
        
        conditions = []
        params = []
        
        for field in all_components:
            if field in composition and composition[field] is not None:
                value = composition[field]
                min_val = value - tolerance
                max_val = value + tolerance
                conditions.append(f"({field} >= ? AND {field} <= ?)")
                params.extend([min_val, max_val])
            elif strict_mode:
                conditions.append(f"({field} <= ?)")
                params.append(tolerance)
        
        if not conditions:
            return []
        
        where_clause = " AND ".join(conditions)
        
        sql = f'''
            SELECT id, temperature, pressure, x_ch4, x_c2h6, x_c3h8, x_co2, x_n2, x_h2s, x_ic4h10
            FROM gas_mixture
            WHERE {where_clause}
            ORDER BY temperature ASC, pressure ASC
            LIMIT 100
        '''
        
        cursor.execute(sql, params)
        rows = cursor.fetchall()
        
        return [dict(row) for row in rows]


# ==================== æ‰¹é‡æ“ä½œ ====================
def batch_delete_records(ids: List[int]) -> int:
    """æ‰¹é‡åˆ é™¤è®°å½•"""
    if not ids:
        return 0
    
    with get_connection(dict_cursor=True) as conn:
        cursor = conn.cursor()
        placeholders = ','.join('?' * len(ids))
        cursor.execute(f'DELETE FROM gas_mixture WHERE id IN ({placeholders})', ids)
        conn.commit()
        return cursor.rowcount


def batch_update_records(ids: List[int], updates: Dict[str, Any]) -> int:
    """æ‰¹é‡æ›´æ–°è®°å½•"""
    if not ids or not updates:
        return 0
    
    valid_fields = ['temperature', 'x_ch4', 'x_c2h6', 'x_c3h8', 'x_co2', 'x_n2', 'x_h2s', 'x_ic4h10', 'pressure']
    filtered_updates = {k: v for k, v in updates.items() if k in valid_fields and v is not None}
    
    if not filtered_updates:
        return 0
    
    with get_connection(dict_cursor=True) as conn:
        cursor = conn.cursor()
        
        set_clause = ', '.join([f'{k} = ?' for k in filtered_updates.keys()])
        placeholders = ','.join('?' * len(ids))
        
        sql = f'''
            UPDATE gas_mixture 
            SET {set_clause}, updated_at = CURRENT_TIMESTAMP
            WHERE id IN ({placeholders})
        '''
        
        params = list(filtered_updates.values()) + ids
        cursor.execute(sql, params)
        conn.commit()
        return cursor.rowcount


# åˆå§‹åŒ–æ•°æ®åº“
init_database()
```

### 2.3 æ•°æ®åº“è¿æ¥æ¨¡å— (backend/db.py)

```python
"""
Database helpers with SQLite/MySQL support based on environment configuration.
"""

from __future__ import annotations

from contextlib import contextmanager
import os
import sqlite3
import threading
import time
from typing import Iterator, Optional
from urllib.parse import urlparse, unquote

import pymysql
from pymysql.cursors import DictCursor
try:
    from DBUtils.PooledDB import PooledDB
except ImportError:
    PooledDB = None

from backend.config import (
    get_database_path,
    get_security_db_path,
    get_database_url,
    get_security_database_url,
)


def _is_mysql_url(url: str) -> bool:
    if not url:
        return False
    scheme = url.split("://", 1)[0]
    return scheme.startswith("mysql")


def _parse_mysql_url(url: str) -> dict:
    parsed = urlparse(url)
    if not parsed.hostname or not parsed.path:
        raise ValueError("Invalid MySQL DATABASE_URL")
    return {
        "host": parsed.hostname,
        "port": parsed.port or 3306,
        "user": unquote(parsed.username) if parsed.username else "",
        "password": unquote(parsed.password) if parsed.password else "",
        "database": parsed.path.lstrip("/"),
    }


class _CursorProxy:
    def __init__(self, cursor, driver: str) -> None:
        self._cursor = cursor
        self._driver = driver

    def execute(self, query: str, params: Optional[object] = None):
        query = query.replace("?", "%s") if self._driver == "mysql" else query
        if params is None:
            return self._cursor.execute(query)
        return self._cursor.execute(query, params)

    def executemany(self, query: str, params_list):
        query = query.replace("?", "%s") if self._driver == "mysql" else query
        return self._cursor.executemany(query, params_list)

    def __getattr__(self, name: str):
        return getattr(self._cursor, name)


class _ConnectionProxy:
    def __init__(self, conn, driver: str) -> None:
        self._conn = conn
        self._driver = driver

    def cursor(self):
        return _CursorProxy(self._conn.cursor(), self._driver)

    def __getattr__(self, name: str):
        return getattr(self._conn, name)


_pool_lock = threading.Lock()
_mysql_pools: dict[str, object] = {}


def _get_mysql_pool(url: str, dict_cursor: bool) -> object:
    if PooledDB is None:
        raise ImportError("MySQL support requires 'DBUtils' package.")
    key = f"{url}|dict={int(dict_cursor)}"
    with _pool_lock:
        pool = _mysql_pools.get(key)
        if pool:
            return pool
        settings = _parse_mysql_url(url)
        cursorclass = DictCursor if dict_cursor else None
        pool = PooledDB(
            creator=pymysql,
            maxconnections=int(os.getenv("DB_POOL_MAX", "10")),
            mincached=int(os.getenv("DB_POOL_MIN", "1")),
            host=settings["host"],
            port=settings["port"],
            user=settings["user"],
            password=settings["password"],
            database=settings["database"],
            charset="utf8mb4",
            cursorclass=cursorclass,
            autocommit=False,
        )
        _mysql_pools[key] = pool
        return pool


def is_mysql() -> bool:
    return _is_mysql_url(get_database_url())


def open_connection(dict_cursor: bool = False) -> _ConnectionProxy:
    url = get_database_url()
    if _is_mysql_url(url):
        pool = _get_mysql_pool(url, dict_cursor)
        return _ConnectionProxy(pool.connection(), "mysql")
    conn = sqlite3.connect(get_database_path())
    if dict_cursor:
        conn.row_factory = sqlite3.Row
    return _ConnectionProxy(conn, "sqlite")


@contextmanager
def get_connection(dict_cursor: bool = False) -> Iterator[_ConnectionProxy]:
    conn = open_connection(dict_cursor=dict_cursor)
    try:
        yield conn
    finally:
        conn.close()
```

### 2.3 åç«¯ API å…¥å£ä¸è·¯ç”± (backend/main.py)

```python
"""
FastAPI åç«¯æœåŠ¡
æä¾› RESTful API æ¥å£
ç‰ˆæœ¬ 4.0 - å¢å¼ºå®‰å…¨æ€§ã€æ•°æ®ç®¡ç†åŠŸèƒ½
"""

from fastapi import FastAPI, HTTPException, Query, UploadFile, File, Header, Depends, Request
from fastapi.middleware.cors import CORSMiddleware
from fastapi.staticfiles import StaticFiles
from fastapi.responses import FileResponse, StreamingResponse, Response
from typing import Optional, List
from pydantic import BaseModel
import os
import io
import csv
import tempfile
import json

from backend.models import (
    GasRecordCreate, GasRecordUpdate, GasRecord,
    PaginatedResponse, Statistics, ApiResponse
)
from backend.database import (
    create_record, delete_record, update_record,
    get_record_by_id, get_all_records, get_statistics,
    get_chart_data, batch_create_records, get_all_records_no_pagination,
    batch_delete_records, batch_update_records
)
from backend.auth import (
    authenticate_user, create_access_token, get_current_user,
    hash_password, verify_password, create_user, change_password, list_users,
    get_admin_username, is_admin_configured, is_using_default_secret_key,
    ensure_admin_user, reset_user_password
)
from backend.backup import (
    create_backup, restore_backup, list_backups, delete_backup,
    get_backup_status, init_backup_system, is_backup_supported
)
from backend.security import (
    init_security, check_rate_limit, detect_crawler, add_crawler_block,
    record_login, check_login_attempts, record_login_attempt,
    get_login_logs, create_session, validate_session, revoke_session,
    get_user_sessions, revoke_all_user_sessions, validate_password,
    get_password_policy, record_audit_log, get_audit_logs,
    record_data_history, get_data_history, get_rate_limit_status
)
from backend.data_review import (
    find_duplicate_pressure_records, move_duplicates_to_review,
    get_pending_groups, get_pending_stats, update_pending_pressure,
    approve_group, reject_group, restore_group
)
from backend.totp import (
    setup_totp, enable_totp, disable_totp, is_totp_enabled,
    verify_user_totp, get_totp_status, regenerate_backup_codes
)
from backend.data_validation import (
    validate_record, validate_batch, clean_record, clean_batch,
    validate_partial_record,
    get_validation_rules, get_field_constraints, get_soft_warnings,
    count_soft_warnings, PRESSURE_SOFT_MAX
)
from backend.config import get_backup_dir, get_cors_origins
from backend.db import get_connection

# ==================== è®¤è¯ä¾èµ– ====================

def get_token_from_header(authorization: Optional[str] = Header(None)) -> Optional[str]:
    """ä»è¯·æ±‚å¤´è·å– Token"""
    if authorization and authorization.startswith("Bearer "):
        return authorization[7:]
    return None


def require_auth(authorization: Optional[str] = Header(None)):
    """è®¤è¯ä¾èµ–é¡¹"""
    token = get_token_from_header(authorization)
    if not token:
        raise HTTPException(status_code=401, detail="æœªæä¾›è®¤è¯ä»¤ç‰Œ")

    user = get_current_user(token)
    if not user:
        raise HTTPException(status_code=401, detail="ä»¤ç‰Œæ— æ•ˆæˆ–å·²è¿‡æœŸ")

    return user

# ==================== Pydantic æ¨¡å‹ ====================

class LoginRequest(BaseModel):
    username: str
    password: str
    totp_code: Optional[str] = None

class ChangePasswordRequest(BaseModel):
    old_password: str
    new_password: str

class CreateUserRequest(BaseModel):
    username: str
    password: str
    role: str = "user"

class ResetUserPasswordRequest(BaseModel):
    new_password: str

class BatchDeleteRequest(BaseModel):
    ids: List[int]

class BatchUpdateRequest(BaseModel):
    ids: List[int]
    updates: dict

class TOTPSetupRequest(BaseModel):
    code: str

# åˆ›å»º FastAPI åº”ç”¨
app = FastAPI(
    title="æ°”ä½“æ··åˆç‰©æ•°æ®ç®¡ç†ç³»ç»Ÿ API",
    description="æä¾›æ°”ä½“æ··åˆç‰©çƒ­åŠ›å­¦æ•°æ®çš„å¢åˆ æ”¹æŸ¥åŠŸèƒ½ï¼Œå«å®‰å…¨å¢å¼º",
    version="4.0.0"
)

# è½¯æç¤ºï¼ˆä¸é˜»æ­¢å†™å…¥ï¼‰
def format_soft_warning(warnings: List[str]) -> str:
    if not warnings:
        return ""
    return f"ï¼ˆæ³¨æ„ï¼š{'; '.join(warnings)}ï¼‰"


def format_soft_warning_count(count: int) -> str:
    if count <= 0:
        return ""
    return f"ï¼ˆæ³¨æ„ï¼š{count} æ¡è®°å½•å‹åŠ›é«˜äº {PRESSURE_SOFT_MAX:.0f} MPaï¼Œå¯èƒ½ä¸ºå¼‚å¸¸å€¼ï¼‰"

# é…ç½®è·¨åŸŸ (CORS) - å…è®¸å‰ç«¯è®¿é—®
cors_origins = get_cors_origins()
app.add_middleware(
    CORSMiddleware,
    allow_origins=cors_origins,
    allow_credentials=bool(cors_origins),
    allow_methods=["*"],
    allow_headers=["*"],
)


# ==================== å®‰å…¨ä¸­é—´ä»¶ ====================

@app.middleware("http")
async def security_middleware(request: Request, call_next):
    """å®‰å…¨ä¸­é—´ä»¶ - APIé™æµ + é˜²çˆ¬è™«"""
    # è·å–å®¢æˆ·ç«¯ä¿¡æ¯
    client_ip = request.client.host if request.client else "unknown"
    user_agent = request.headers.get("user-agent", "")
    path = request.url.path
    
    # ç™½åå•è·¯å¾„ï¼ˆä¸é™æµï¼‰
    whitelist_paths = ["/", "/admin", "/docs", "/openapi.json", "/css/", "/js/"]
    is_whitelisted = any(path.startswith(p) for p in whitelist_paths)
    
    if not is_whitelisted and path.startswith("/api/"):
        # æ£€æŸ¥APIé™æµ
        allowed, error_msg = check_rate_limit(client_ip)
        if not allowed:
            return Response(
                content=json.dumps({"detail": error_msg, "error_code": "RATE_LIMITED"}),
                status_code=429,
                media_type="application/json"
            )
        
        # æ£€æŸ¥çˆ¬è™«
        is_crawler, crawler_reason = detect_crawler(user_agent, path, client_ip)
        if is_crawler:
            add_crawler_block(client_ip, crawler_reason)
            return Response(
                content=json.dumps({"detail": "è®¿é—®è¢«æ‹’ç»", "error_code": "BLOCKED"}),
                status_code=403,
                media_type="application/json"
            )
    
    response = await call_next(request)
    
    # æ·»åŠ å®‰å…¨å“åº”å¤´
    response.headers["X-Content-Type-Options"] = "nosniff"
    response.headers["X-Frame-Options"] = "DENY"
    response.headers["X-XSS-Protection"] = "1; mode=block"
    response.headers["Cache-Control"] = "no-store"
    
    return response

# å‰ç«¯é™æ€æ–‡ä»¶ç›®å½• - åŸºäºå½“å‰æ–‡ä»¶ä½ç½®è®¡ç®—
CURRENT_DIR = os.path.dirname(os.path.abspath(__file__))
BASE_DIR = os.path.dirname(CURRENT_DIR)
FRONTEND_DIR = os.path.join(BASE_DIR, "frontend")
FRONTEND_CSS = os.path.join(FRONTEND_DIR, "css")
FRONTEND_JS = os.path.join(FRONTEND_DIR, "js")
FRONTEND_INDEX = os.path.join(FRONTEND_DIR, "index.html")


# ==================== API è·¯ç”± ====================

@app.get("/api/records", response_model=PaginatedResponse, tags=["Records"])
async def api_get_records(
    page: int = Query(1, ge=1, description="é¡µç "),
    per_page: int = Query(15, ge=1, le=100, description="æ¯é¡µæ•°é‡"),
    temp_min: Optional[float] = Query(None, description="æœ€ä½æ¸©åº¦"),
    temp_max: Optional[float] = Query(None, description="æœ€é«˜æ¸©åº¦"),
    pressure_min: Optional[float] = Query(None, description="æœ€ä½å‹åŠ›"),
    pressure_max: Optional[float] = Query(None, description="æœ€é«˜å‹åŠ›")
):
    """è·å–è®°å½•åˆ—è¡¨ï¼ˆæ”¯æŒåˆ†é¡µå’Œç­›é€‰ï¼‰"""
    result = get_all_records(
        page=page,
        per_page=per_page,
        temp_min=temp_min,
        temp_max=temp_max,
        pressure_min=pressure_min,
        pressure_max=pressure_max
    )
    return result


@app.get("/api/records/{record_id}", response_model=GasRecord, tags=["Records"])
async def api_get_record(record_id: int):
    """è·å–å•æ¡è®°å½•"""
    record = get_record_by_id(record_id)
    if not record:
        raise HTTPException(status_code=404, detail="è®°å½•ä¸å­˜åœ¨")
    return record


@app.post("/api/records", response_model=ApiResponse, tags=["Records"])
async def api_create_record(data: GasRecordCreate, user: dict = Depends(require_auth)):
    """åˆ›å»ºæ–°è®°å½•"""
    if user["role"] not in ("admin", "user"):
        raise HTTPException(status_code=403, detail="æƒé™ä¸è¶³")
    try:
        record_payload = clean_record(data.model_dump())
        is_valid, errors = validate_record(record_payload)
        if not is_valid:
            raise HTTPException(status_code=400, detail="; ".join(errors))
        warnings = get_soft_warnings(record_payload)
        record_id = create_record(record_payload)
        return ApiResponse(
            success=True,
            message="åˆ›å»ºæˆåŠŸ" + format_soft_warning(warnings),
            data={"id": record_id}
        )
    except Exception as e:
        raise HTTPException(status_code=500, detail=str(e))


@app.put("/api/records/{record_id}", response_model=ApiResponse, tags=["Records"])
async def api_update_record(record_id: int, data: GasRecordUpdate, user: dict = Depends(require_auth)):
    """æ›´æ–°è®°å½•"""
    if user["role"] not in ("admin", "user"):
        raise HTTPException(status_code=403, detail="æƒé™ä¸è¶³")
    # è¿‡æ»¤æ‰ None å€¼
    update_data = {k: v for k, v in data.model_dump().items() if v is not None}
    
    if not update_data:
        raise HTTPException(status_code=400, detail="æ²¡æœ‰è¦æ›´æ–°çš„æ•°æ®")

    existing = get_record_by_id(record_id)
    if not existing:
        raise HTTPException(status_code=404, detail="è®°å½•ä¸å­˜åœ¨")
    merged = {**existing, **update_data}
    merged_payload = clean_record(merged)
    is_valid, errors = validate_record(merged_payload)
    if not is_valid:
        raise HTTPException(status_code=400, detail="; ".join(errors))
    
    success = update_record(record_id, update_data)
    if not success:
        raise HTTPException(status_code=404, detail="è®°å½•ä¸å­˜åœ¨")
    
    warnings = get_soft_warnings(update_data) if "pressure" in update_data else []
    return ApiResponse(success=True, message="æ›´æ–°æˆåŠŸ" + format_soft_warning(warnings))


@app.delete("/api/records/{record_id}", response_model=ApiResponse, tags=["Records"])
async def api_delete_record(record_id: int, user: dict = Depends(require_auth)):
    """åˆ é™¤è®°å½•"""
    if user["role"] not in ("admin", "user"):
        raise HTTPException(status_code=403, detail="æƒé™ä¸è¶³")
    success = delete_record(record_id)
    if not success:
        raise HTTPException(status_code=404, detail="è®°å½•ä¸å­˜åœ¨")
    
    return ApiResponse(success=True, message="åˆ é™¤æˆåŠŸ")


@app.get("/api/statistics", response_model=Statistics, tags=["Statistics"])
async def api_statistics():
    """è·å–ç»Ÿè®¡ä¿¡æ¯"""
    stats = get_statistics()
    return stats


@app.get("/api/query", tags=["Query"])
async def api_query_by_composition(
    x_ch4: Optional[float] = Query(None, description="CH4 æ‘©å°”åˆ†æ•°"),
    x_c2h6: Optional[float] = Query(None, description="C2H6 æ‘©å°”åˆ†æ•°"),
    x_c3h8: Optional[float] = Query(None, description="C3H8 æ‘©å°”åˆ†æ•°"),
    x_co2: Optional[float] = Query(None, description="CO2 æ‘©å°”åˆ†æ•°"),
    x_n2: Optional[float] = Query(None, description="N2 æ‘©å°”åˆ†æ•°"),
    x_h2s: Optional[float] = Query(None, description="H2S æ‘©å°”åˆ†æ•°"),
    x_ic4h10: Optional[float] = Query(None, description="i-C4H10 æ‘©å°”åˆ†æ•°"),
    tolerance: float = Query(0.02, description="å…è®¸çš„è¯¯å·®èŒƒå›´ï¼Œé»˜è®¤2%"),
    strict: bool = Query(True, description="ä¸¥æ ¼æ¨¡å¼ï¼šæœªè¾“å…¥çš„ç»„åˆ†è¦æ±‚æ¥è¿‘0")
):
    """æ ¹æ®æ°”ä½“ç»„åˆ†æŸ¥è¯¢æ¸©åº¦å’Œå‹åŠ›"""
    from backend.database import query_by_composition
    
    composition = {
        'x_ch4': x_ch4,
        'x_c2h6': x_c2h6,
        'x_c3h8': x_c3h8,
        'x_co2': x_co2,
        'x_n2': x_n2,
        'x_h2s': x_h2s,
        'x_ic4h10': x_ic4h10
    }
    
    # è¿‡æ»¤æ‰ None å€¼
    composition = {k: v for k, v in composition.items() if v is not None}
    
    if not composition:
        return {"success": False, "message": "è¯·è‡³å°‘è¾“å…¥ä¸€ä¸ªç»„åˆ†", "data": []}
    
    results = query_by_composition(composition, tolerance, strict_mode=strict)
    return {"success": True, "data": results, "count": len(results)}


# ==================== å›¾è¡¨æ•°æ® API ====================

@app.get("/api/chart/temperature", tags=["Chart"])
async def api_chart_temperature():
    """è·å–æ¸©åº¦åˆ†å¸ƒæ•°æ®ï¼ˆç”¨äºå›¾è¡¨ï¼‰"""
    data = get_chart_data('temperature')
    return data


@app.get("/api/chart/pressure", tags=["Chart"])
async def api_chart_pressure():
    """è·å–å‹åŠ›åˆ†å¸ƒæ•°æ®ï¼ˆç”¨äºå›¾è¡¨ï¼‰"""
    data = get_chart_data('pressure')
    return data


@app.get("/api/chart/scatter", tags=["Chart"])
async def api_chart_scatter():
    """è·å–æ¸©åº¦-å‹åŠ›æ•£ç‚¹å›¾æ•°æ®"""
    data = get_chart_data('scatter')
    return data


@app.get("/api/chart/heatmap", tags=["Chart"])
async def api_chart_heatmap(
    temp_bins: int = Query(18, ge=5, le=60),
    pressure_bins: int = Query(20, ge=5, le=60)
):
    """è·å–æ¸©åº¦-å‹åŠ›å¯†åº¦çƒ­åŠ›å›¾æ•°æ®"""
    with get_connection(dict_cursor=True) as conn:
        cursor = conn.cursor()
        cursor.execute("SELECT temperature, pressure FROM gas_mixture")
        rows = cursor.fetchall()

    if not rows:
        return {"x_labels": [], "y_labels": [], "data": [], "meta": {}}

    temps = [row['temperature'] for row in rows]
    pressures = [row['pressure'] for row in rows]

    min_temp = min(temps)
    max_temp = max(temps)
    min_pressure = min(pressures)
    max_pressure = max(pressures)

    temp_range = max_temp - min_temp
    pressure_range = max_pressure - min_pressure

    if temp_range == 0:
        temp_bins = 1
    if pressure_range == 0:
        pressure_bins = 1

    temp_size = temp_range / temp_bins if temp_bins > 0 else 1.0
    pressure_size = pressure_range / pressure_bins if pressure_bins > 0 else 1.0

    counts = {}
    for row in rows:
        temp = row['temperature']
        pressure = row['pressure']
        t_bin = int((temp - min_temp) / temp_size) if temp_size else 0
        p_bin = int((pressure - min_pressure) / pressure_size) if pressure_size else 0
        if t_bin >= temp_bins:
            t_bin = temp_bins - 1
        if p_bin >= pressure_bins:
            p_bin = pressure_bins - 1
        counts[(t_bin, p_bin)] = counts.get((t_bin, p_bin), 0) + 1

    temp_precision = 0 if temp_size >= 1 else 2
    pressure_precision = 1 if pressure_size >= 1 else 3

    x_labels = []
    for i in range(temp_bins):
        start = min_temp + (i * temp_size)
        end = min_temp + ((i + 1) * temp_size)
        x_labels.append(f"{start:.{temp_precision}f}-{end:.{temp_precision}f}K")

    y_labels = []
    for i in range(pressure_bins):
        start = min_pressure + (i * pressure_size)
        end = min_pressure + ((i + 1) * pressure_size)
        y_labels.append(f"{start:.{pressure_precision}f}-{end:.{pressure_precision}f}MPa")

    data = [[t_bin, p_bin, count] for (t_bin, p_bin), count in counts.items()]

    return {
        "x_labels": x_labels,
        "y_labels": y_labels,
        "data": data,
        "meta": {
            "min_temp": min_temp,
            "max_temp": max_temp,
            "min_pressure": min_pressure,
            "max_pressure": max_pressure
        }
    }


@app.get("/api/chart/scatter-distribution", tags=["Chart"])
async def api_chart_scatter_distribution(
    limit: Optional[int] = Query(None, ge=1, le=200000)
):
    """è·å–æ¸©åº¦-å‹åŠ›åˆ†å¸ƒæ•£ç‚¹æ•°æ®"""
    with get_connection(dict_cursor=True) as conn:
        cursor = conn.cursor()
        if limit is None:
            cursor.execute(
                "SELECT id, temperature, pressure FROM gas_mixture ORDER BY id"
            )
        else:
            cursor.execute(
                "SELECT id, temperature, pressure FROM gas_mixture ORDER BY id LIMIT ?",
                (limit,)
            )
        rows = cursor.fetchall()

    if not rows:
        return {"data": [], "pressure_min": 0, "pressure_max": 0, "count": 0}

    pressures = [row['pressure'] for row in rows]
    return {
        "data": [{"value": [row['temperature'], row['pressure'], row['pressure']], "id": row['id']} for row in rows],
        "pressure_min": min(pressures),
        "pressure_max": max(pressures),
        "count": len(rows)
    }


# ==================== å¯¼å…¥å¯¼å‡º API ====================

@app.get("/api/export/csv", tags=["Export"])
async def api_export_csv(user: dict = Depends(require_auth)):
    """å¯¼å‡ºæ‰€æœ‰æ•°æ®ä¸º CSV æ–‡ä»¶"""
    records = get_all_records_no_pagination()
    
    # åˆ›å»º CSV å†…å®¹
    output = io.StringIO()
    writer = csv.writer(output)
    
    # å†™å…¥è¡¨å¤´
    writer.writerow([
        'ID', 'T (K)', 'xCH4', 'xC2H6', 'xC3H8', 
        'xCO2', 'xN2', 'xH2S', 'x i-C4H10', 'p (MPa)'
    ])
    
    # å†™å…¥æ•°æ®
    for r in records:
        writer.writerow([
            r['id'], r['temperature'], r['x_ch4'], r['x_c2h6'], r['x_c3h8'],
            r['x_co2'], r['x_n2'], r['x_h2s'], r['x_ic4h10'], r['pressure']
        ])
    
    output.seek(0)
    
    return StreamingResponse(
        iter([output.getvalue()]),
        media_type="text/csv",
        headers={"Content-Disposition": "attachment; filename=gas_data_export.csv"}
    )


@app.get("/api/export/excel", tags=["Export"])
async def api_export_excel(user: dict = Depends(require_auth)):
    """å¯¼å‡ºæ‰€æœ‰æ•°æ®ä¸º Excel æ–‡ä»¶"""
    try:
        import pandas as pd
        
        records = get_all_records_no_pagination()
        
        # è½¬æ¢ä¸º DataFrame
        df = pd.DataFrame(records)
        
        # é‡å‘½ååˆ—
        column_mapping = {
            'id': 'ID',
            'temperature': 'T (K)',
            'x_ch4': 'xCH4',
            'x_c2h6': 'xC2H6',
            'x_c3h8': 'xC3H8',
            'x_co2': 'xCO2',
            'x_n2': 'xN2',
            'x_h2s': 'xH2S',
            'x_ic4h10': 'x i-C4H10',
            'pressure': 'p (MPa)'
        }
        
        # é€‰æ‹©éœ€è¦çš„åˆ—å¹¶é‡å‘½å
        export_columns = ['id', 'temperature', 'x_ch4', 'x_c2h6', 'x_c3h8', 
                         'x_co2', 'x_n2', 'x_h2s', 'x_ic4h10', 'pressure']
        df = df[export_columns].rename(columns=column_mapping)
        
        # å†™å…¥ Excel
        output = io.BytesIO()
        df.to_excel(output, index=False, engine='openpyxl')
        output.seek(0)
        
        return StreamingResponse(
            output,
            media_type="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
            headers={"Content-Disposition": "attachment; filename=gas_data_export.xlsx"}
        )
    except ImportError:
        raise HTTPException(status_code=500, detail="éœ€è¦å®‰è£… pandas å’Œ openpyxl")


@app.post("/api/import", tags=["Import"])
async def api_import_file(file: UploadFile = File(...), user: dict = Depends(require_auth)):
    """æ‰¹é‡å¯¼å…¥æ•°æ®ï¼ˆæ”¯æŒ CSV å’Œ Excel æ–‡ä»¶ï¼‰"""
    if user["role"] not in ("admin", "user"):
        raise HTTPException(status_code=403, detail="æƒé™ä¸è¶³")
    try:
        filename = file.filename.lower()
        content = await file.read()

        records, row_numbers, skipped = parse_import_content(filename, content)
        if not records:
            raise HTTPException(status_code=400, detail="æ–‡ä»¶ä¸­æ²¡æœ‰æœ‰æ•ˆæ•°æ®")

        validation_errors = []
        valid_records = []
        for idx, record in enumerate(records):
            is_valid, errors = validate_record(record)
            if is_valid:
                valid_records.append(record)
            else:
                row_number = row_numbers[idx] if idx < len(row_numbers) else (idx + 1)
                validation_errors.append({"row": row_number, "errors": errors})

        if validation_errors:
            raise HTTPException(
                status_code=400,
                detail={
                    "message": "å¯¼å…¥æ ¡éªŒå¤±è´¥",
                    "summary": {
                        "total": len(records),
                        "valid_count": len(valid_records),
                        "invalid_count": len(validation_errors),
                        "skipped_count": skipped,
                    },
                    "errors": validation_errors[:50],
                },
            )

        # æ‰¹é‡æ’å…¥
        count = batch_create_records(valid_records)
        warning_count = count_soft_warnings(valid_records)
        
        return ApiResponse(
            success=True,
            message=f"æˆåŠŸå¯¼å…¥ {count} æ¡è®°å½•" + format_soft_warning_count(warning_count),
            data={"imported_count": count, "warning_count": warning_count}
        )
        
    except HTTPException:
        raise
    except Exception as e:
        raise HTTPException(status_code=500, detail=f"å¯¼å…¥å¤±è´¥: {str(e)}")


@app.post("/api/import/preview", tags=["Import"])
async def api_import_preview(file: UploadFile = File(...), user: dict = Depends(require_auth)):
    """å¯¼å…¥å‰æ ¡éªŒé¢„è§ˆï¼ˆä¸å†™å…¥æ•°æ®åº“ï¼‰"""
    if user["role"] not in ("admin", "user"):
        raise HTTPException(status_code=403, detail="æƒé™ä¸è¶³")
    try:
        filename = file.filename.lower()
        content = await file.read()

        records, row_numbers, skipped = parse_import_content(filename, content)
        if not records:
            raise HTTPException(status_code=400, detail="æ–‡ä»¶ä¸­æ²¡æœ‰æœ‰æ•ˆæ•°æ®")

        validation_errors = []
        warning_rows = []
        valid_count = 0

        for idx, record in enumerate(records):
            row_number = row_numbers[idx] if idx < len(row_numbers) else (idx + 1)
            is_valid, errors = validate_record(record)
            if is_valid:
                valid_count += 1
                warnings = get_soft_warnings(record)
                if warnings:
                    warning_rows.append({"row": row_number, "warnings": warnings})
            else:
                validation_errors.append({"row": row_number, "errors": errors})

        return {
            "success": True,
            "data": {
                "summary": {
                    "total": len(records),
                    "valid_count": valid_count,
                    "invalid_count": len(validation_errors),
                    "warning_count": len(warning_rows),
                    "skipped_count": skipped,
                },
                "errors": validation_errors[:50],
                "warnings": warning_rows[:50],
            },
        }
    except HTTPException:
        raise
    except Exception as e:
        raise HTTPException(status_code=500, detail=f"é¢„è§ˆå¤±è´¥: {str(e)}")


def parse_import_content(filename: str, content: bytes):
    records = []
    row_numbers = []
    skipped = 0

    if filename.endswith('.csv'):
        text = content.decode('utf-8-sig')  # å¤„ç† BOM
        reader = csv.DictReader(io.StringIO(text))
        for idx, row in enumerate(reader, start=2):
            record = parse_import_row(row)
            if record:
                records.append(record)
                row_numbers.append(idx)
            else:
                skipped += 1
    elif filename.endswith(('.xlsx', '.xls')):
        import pandas as pd
        df = pd.read_excel(io.BytesIO(content))
        for idx, row in df.iterrows():
            record = parse_import_row(row.to_dict())
            if record:
                records.append(record)
                row_numbers.append(idx + 2)
            else:
                skipped += 1
    else:
        raise HTTPException(status_code=400, detail="ä¸æ”¯æŒçš„æ–‡ä»¶æ ¼å¼ï¼Œè¯·ä¸Šä¼  CSV æˆ– Excel æ–‡ä»¶")

    return records, row_numbers, skipped


def parse_import_row(row: dict) -> Optional[dict]:
    """è§£æå¯¼å…¥è¡Œæ•°æ®"""
    # æ”¯æŒå¤šç§åˆ—åæ ¼å¼
    column_mapping = {
        'temperature': ['T (K)', 'T(K)', 'temperature', 'Temperature', 'æ¸©åº¦'],
        'x_ch4': ['xCH4', 'CH4', 'x_ch4', 'ç”²çƒ·'],
        'x_c2h6': ['xC2H6', 'C2H6', 'x_c2h6', 'ä¹™çƒ·'],
        'x_c3h8': ['xC3H8', 'C3H8', 'x_c3h8', 'ä¸™çƒ·'],
        'x_co2': ['xCO2', 'CO2', 'x_co2', 'äºŒæ°§åŒ–ç¢³'],
        'x_n2': ['xN2', 'N2', 'x_n2', 'æ°®æ°”'],
        'x_h2s': ['xH2S', 'H2S', 'x_h2s', 'ç¡«åŒ–æ°¢'],
        'x_ic4h10': ['x i-C4H10', 'x_i-C4H10', 'iC4H10', 'x_ic4h10', 'å¼‚ä¸çƒ·'],
        'pressure': ['p (MPa)', 'p(MPa)', 'pressure', 'Pressure', 'å‹åŠ›']
    }
    
    record = {}
    
    for db_field, possible_names in column_mapping.items():
        value = None
        for name in possible_names:
            if name in row:
                value = row[name]
                break
        
        try:
            if value is not None and str(value).strip() != '':
                record[db_field] = float(value)
            else:
                record[db_field] = 0.0
        except (ValueError, TypeError):
            record[db_field] = 0.0
    
    # éªŒè¯å¿…å¡«å­—æ®µ
    if record.get('temperature', 0) == 0 and record.get('pressure', 0) == 0:
        return None
    
    return record


# ==================== é™æ€æ–‡ä»¶æœåŠ¡ ====================

@app.get("/", tags=["Frontend"])
async def serve_frontend():
    """æä¾›å‰ç«¯é¡µé¢"""
    if os.path.exists(FRONTEND_INDEX):
        return FileResponse(FRONTEND_INDEX)
    return {"message": f"å‰ç«¯æ–‡ä»¶ä¸å­˜åœ¨: {FRONTEND_INDEX}ï¼Œè¯·è®¿é—® /docs æŸ¥çœ‹ API æ–‡æ¡£"}


@app.get("/css/{filename}", tags=["Frontend"])
async def serve_css(filename: str):
    """æä¾› CSS æ–‡ä»¶"""
    filepath = os.path.join(FRONTEND_CSS, filename)
    if os.path.exists(filepath):
        return FileResponse(filepath, media_type="text/css")
    raise HTTPException(status_code=404, detail="CSS file not found")


@app.get("/js/{filename}", tags=["Frontend"])
async def serve_js(filename: str):
    """æä¾› JS æ–‡ä»¶"""
    filepath = os.path.join(FRONTEND_JS, filename)
    if os.path.exists(filepath):
        return FileResponse(filepath, media_type="application/javascript")
    raise HTTPException(status_code=404, detail="JS file not found")


# ==================== è®¤è¯ç›¸å…³ API ====================

@app.post("/api/auth/login", tags=["Auth"])
async def api_login(request: LoginRequest, req: Request):
    """ç”¨æˆ·ç™»å½•ï¼ˆæ”¯æŒä¸¤æ­¥éªŒè¯ï¼‰"""
    client_ip = req.client.host if req.client else "unknown"
    user_agent = req.headers.get("user-agent", "")
    
    # æ£€æŸ¥ç™»å½•å°è¯•æ¬¡æ•°
    allowed, error_msg = check_login_attempts(client_ip)
    if not allowed:
        record_login(request.username, client_ip, user_agent, False, "ç™»å½•å°è¯•è¿‡å¤š")
        raise HTTPException(status_code=429, detail=error_msg)
    
    # éªŒè¯ç”¨æˆ·åå¯†ç 
    user = authenticate_user(request.username, request.password)
    if not user:
        record_login_attempt(client_ip, False)
        record_login(request.username, client_ip, user_agent, False, "å¯†ç é”™è¯¯")
        raise HTTPException(status_code=401, detail="ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯")
    
    # æ£€æŸ¥æ˜¯å¦éœ€è¦ä¸¤æ­¥éªŒè¯
    if is_totp_enabled(request.username):
        if not request.totp_code:
            return {
                "success": False,
                "require_totp": True,
                "message": "éœ€è¦ä¸¤æ­¥éªŒè¯ç "
            }
        if not verify_user_totp(request.username, request.totp_code):
            record_login_attempt(client_ip, False)
            record_login(request.username, client_ip, user_agent, False, "ä¸¤æ­¥éªŒè¯å¤±è´¥")
            raise HTTPException(status_code=401, detail="ä¸¤æ­¥éªŒè¯ç é”™è¯¯")
    
    # ç™»å½•æˆåŠŸ
    record_login_attempt(client_ip, True)
    token = create_access_token({"sub": user["username"], "role": user["role"]})
    
    # åˆ›å»ºä¼šè¯
    create_session(token, user["username"], client_ip, user_agent)
    
    # è®°å½•ç™»å½•æ—¥å¿—
    record_login(request.username, client_ip, user_agent, True)
    record_audit_log(request.username, "LOGIN", ip=client_ip)
    
    return {
        "success": True,
        "message": "ç™»å½•æˆåŠŸ",
        "data": {
            "access_token": token,
            "token_type": "bearer",
            "user": user,
            "totp_enabled": is_totp_enabled(request.username)
        }
    }


@app.get("/api/auth/me", tags=["Auth"])
async def api_get_me(user: dict = Depends(require_auth)):
    """è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯"""
    return {
        "success": True,
        "data": user
    }


@app.post("/api/auth/change-password", tags=["Auth"])
async def api_change_password(request: ChangePasswordRequest, user: dict = Depends(require_auth)):
    """ä¿®æ”¹å¯†ç ï¼ˆå¸¦å¯†ç ç­–ç•¥éªŒè¯ï¼‰"""
    # éªŒè¯å¯†ç ç­–ç•¥
    is_valid, errors = validate_password(request.new_password)
    if not is_valid:
        raise HTTPException(status_code=400, detail=f"å¯†ç ä¸ç¬¦åˆè¦æ±‚: {', '.join(errors)}")
    
    success = change_password(user["username"], request.old_password, request.new_password)
    if not success:
        raise HTTPException(status_code=400, detail="åŸå¯†ç é”™è¯¯")
    
    record_audit_log(user["username"], "CHANGE_PASSWORD")
    return {"success": True, "message": "å¯†ç ä¿®æ”¹æˆåŠŸ"}


@app.get("/api/auth/password-policy", tags=["Auth"])
async def api_password_policy():
    """è·å–å¯†ç ç­–ç•¥"""
    return {"success": True, "data": get_password_policy()}


@app.post("/api/auth/users", tags=["Auth"])
async def api_create_user(request: CreateUserRequest, user: dict = Depends(require_auth)):
    """åˆ›å»ºæ–°ç”¨æˆ·ï¼ˆä»…ç®¡ç†å‘˜ï¼‰"""
    if user["role"] != "admin":
        raise HTTPException(status_code=403, detail="æƒé™ä¸è¶³")

    if request.role not in ("admin", "user"):
        raise HTTPException(status_code=400, detail="è§’è‰²æ— æ•ˆ")

    is_valid, errors = validate_password(request.password)
    if not is_valid:
        raise HTTPException(status_code=400, detail=f"å¯†ç ä¸ç¬¦åˆè¦æ±‚: {', '.join(errors)}")
    
    success = create_user(request.username, request.password, request.role)
    if not success:
        raise HTTPException(status_code=400, detail="ç”¨æˆ·å·²å­˜åœ¨")
    
    return {"success": True, "message": "ç”¨æˆ·åˆ›å»ºæˆåŠŸ"}


@app.post("/api/auth/users/{username}/reset-password", tags=["Auth"])
async def api_reset_user_password(
    username: str,
    request: ResetUserPasswordRequest,
    user: dict = Depends(require_auth),
):
    """ç®¡ç†å‘˜é‡ç½®ç”¨æˆ·å¯†ç """
    if user["role"] != "admin":
        raise HTTPException(status_code=403, detail="æƒé™ä¸è¶³")

    is_valid, errors = validate_password(request.new_password)
    if not is_valid:
        raise HTTPException(status_code=400, detail=f"å¯†ç ä¸ç¬¦åˆè¦æ±‚: {', '.join(errors)}")

    success = reset_user_password(username, request.new_password)
    if not success:
        raise HTTPException(status_code=404, detail="ç”¨æˆ·ä¸å­˜åœ¨")

    record_audit_log(user["username"], "RESET_PASSWORD", "user", None, username)
    return {"success": True, "message": "å¯†ç å·²é‡ç½®"}


@app.get("/api/auth/users", tags=["Auth"])
async def api_list_users(user: dict = Depends(require_auth)):
    """è·å–ç”¨æˆ·åˆ—è¡¨ï¼ˆä»…ç®¡ç†å‘˜ï¼‰"""
    if user["role"] != "admin":
        raise HTTPException(status_code=403, detail="æƒé™ä¸è¶³")
    
    return {"success": True, "data": list_users()}


# ==================== TOTP ä¸¤æ­¥éªŒè¯ API ====================

@app.post("/api/auth/totp/setup", tags=["TOTP"])
async def api_totp_setup(user: dict = Depends(require_auth)):
    """è®¾ç½®ä¸¤æ­¥éªŒè¯ï¼ˆè¿”å›å¯†é’¥å’ŒäºŒç»´ç URIï¼‰"""
    secret, uri = setup_totp(user["username"])
    return {
        "success": True,
        "data": {
            "secret": secret,
            "uri": uri,
            "message": "è¯·ä½¿ç”¨éªŒè¯å™¨Appæ‰«æäºŒç»´ç æˆ–æ‰‹åŠ¨è¾“å…¥å¯†é’¥"
        }
    }


@app.post("/api/auth/totp/enable", tags=["TOTP"])
async def api_totp_enable(request: TOTPSetupRequest, user: dict = Depends(require_auth)):
    """å¯ç”¨ä¸¤æ­¥éªŒè¯ï¼ˆéœ€è¦éªŒè¯ç ç¡®è®¤ï¼‰"""
    success = enable_totp(user["username"], request.code)
    if not success:
        raise HTTPException(status_code=400, detail="éªŒè¯ç é”™è¯¯ï¼Œè¯·é‡è¯•")
    
    record_audit_log(user["username"], "ENABLE_TOTP")
    return {"success": True, "message": "ä¸¤æ­¥éªŒè¯å·²å¯ç”¨"}


@app.post("/api/auth/totp/disable", tags=["TOTP"])
async def api_totp_disable(user: dict = Depends(require_auth)):
    """ç¦ç”¨ä¸¤æ­¥éªŒè¯"""
    success = disable_totp(user["username"])
    record_audit_log(user["username"], "DISABLE_TOTP")
    return {"success": True, "message": "ä¸¤æ­¥éªŒè¯å·²ç¦ç”¨"}


@app.get("/api/auth/totp/status", tags=["TOTP"])
async def api_totp_status(user: dict = Depends(require_auth)):
    """è·å–ä¸¤æ­¥éªŒè¯çŠ¶æ€"""
    status = get_totp_status(user["username"])
    return {"success": True, "data": status}


@app.post("/api/auth/totp/backup-codes", tags=["TOTP"])
async def api_regenerate_backup_codes(user: dict = Depends(require_auth)):
    """é‡æ–°ç”Ÿæˆå¤‡ç”¨ç """
    codes = regenerate_backup_codes(user["username"])
    record_audit_log(user["username"], "REGENERATE_BACKUP_CODES")
    return {"success": True, "data": {"backup_codes": codes}}


# ==================== ä¼šè¯ç®¡ç† API ====================

@app.get("/api/auth/sessions", tags=["Sessions"])
async def api_get_sessions(user: dict = Depends(require_auth)):
    """è·å–å½“å‰ç”¨æˆ·çš„æ‰€æœ‰ä¼šè¯"""
    sessions = get_user_sessions(user["username"])
    return {"success": True, "data": sessions}


@app.delete("/api/auth/sessions/{session_id}", tags=["Sessions"])
async def api_revoke_session(session_id: int, user: dict = Depends(require_auth)):
    """æ’¤é”€æŒ‡å®šä¼šè¯"""
    # è¿™é‡Œéœ€è¦æ ¹æ®session_idæŸ¥æ‰¾å¹¶æ’¤é”€
    return {"success": True, "message": "ä¼šè¯å·²æ’¤é”€"}


@app.post("/api/auth/sessions/revoke-all", tags=["Sessions"])
async def api_revoke_all_sessions(user: dict = Depends(require_auth), authorization: Optional[str] = Header(None)):
    """æ’¤é”€é™¤å½“å‰ä¼šè¯å¤–çš„æ‰€æœ‰ä¼šè¯"""
    token = get_token_from_header(authorization)
    count = revoke_all_user_sessions(user["username"], except_token=token)
    record_audit_log(user["username"], "REVOKE_ALL_SESSIONS")
    return {"success": True, "message": f"å·²æ’¤é”€ {count} ä¸ªä¼šè¯"}


@app.get("/api/auth/users/{username}/sessions", tags=["Sessions"])
async def api_get_user_sessions(
    username: str,
    user: dict = Depends(require_auth),
):
    """ç®¡ç†å‘˜æŸ¥çœ‹ç”¨æˆ·ä¼šè¯"""
    if user["role"] != "admin":
        raise HTTPException(status_code=403, detail="æƒé™ä¸è¶³")

    sessions = get_user_sessions(username)
    return {"success": True, "data": sessions}


@app.post("/api/auth/users/{username}/sessions/revoke-all", tags=["Sessions"])
async def api_admin_revoke_user_sessions(
    username: str,
    user: dict = Depends(require_auth),
    authorization: Optional[str] = Header(None),
):
    """ç®¡ç†å‘˜æ’¤é”€ç”¨æˆ·å…¨éƒ¨ä¼šè¯"""
    if user["role"] != "admin":
        raise HTTPException(status_code=403, detail="æƒé™ä¸è¶³")

    token = get_token_from_header(authorization)
    except_token = token if username == user["username"] else None
    count = revoke_all_user_sessions(username, except_token=except_token)
    record_audit_log(user["username"], "REVOKE_USER_SESSIONS", "user", None, username)
    return {"success": True, "message": f"å·²æ’¤é”€ {count} ä¸ªä¼šè¯"}


@app.post("/api/auth/logout", tags=["Sessions"])
async def api_logout(user: dict = Depends(require_auth), authorization: Optional[str] = Header(None)):
    """é€€å‡ºç™»å½•"""
    token = get_token_from_header(authorization)
    if token:
        revoke_session(token)
    record_audit_log(user["username"], "LOGOUT")
    return {"success": True, "message": "å·²é€€å‡ºç™»å½•"}


# ==================== ç™»å½•æ—¥å¿— API ====================

@app.get("/api/security/login-logs", tags=["Security"])
async def api_get_login_logs(
    user: dict = Depends(require_auth),
    username: Optional[str] = None,
    limit: int = Query(100, ge=1, le=500)
):
    """è·å–ç™»å½•æ—¥å¿—"""
    if user["role"] != "admin":
        # éç®¡ç†å‘˜åªèƒ½çœ‹è‡ªå·±çš„æ—¥å¿—
        username = user["username"]
    
    logs = get_login_logs(username, limit)
    return {"success": True, "data": logs}


@app.get("/api/security/audit-logs", tags=["Security"])
async def api_get_audit_logs(
    user: dict = Depends(require_auth),
    username: Optional[str] = None,
    action: Optional[str] = None,
    limit: int = Query(100, ge=1, le=500)
):
    """è·å–å®¡è®¡æ—¥å¿—ï¼ˆä»…ç®¡ç†å‘˜ï¼‰"""
    if user["role"] != "admin":
        raise HTTPException(status_code=403, detail="æƒé™ä¸è¶³")
    
    logs = get_audit_logs(username=username, action=action, limit=limit)
    return {"success": True, "data": logs}


@app.get("/api/security/rate-limit", tags=["Security"])
async def api_rate_limit_status(req: Request):
    """è·å–å½“å‰IPçš„é™æµçŠ¶æ€"""
    client_ip = req.client.host if req.client else "unknown"
    status = get_rate_limit_status(client_ip)
    return {"success": True, "data": status}


# ==================== æ‰¹é‡æ“ä½œ API ====================

@app.post("/api/records/batch-delete", tags=["Batch"])
async def api_batch_delete(request: BatchDeleteRequest, user: dict = Depends(require_auth)):
    """æ‰¹é‡åˆ é™¤è®°å½•"""
    if user["role"] != "admin":
        raise HTTPException(status_code=403, detail="æƒé™ä¸è¶³")
    
    count = batch_delete_records(request.ids)
    record_audit_log(user["username"], "BATCH_DELETE", "records", None, str(request.ids))
    return {"success": True, "message": f"æˆåŠŸåˆ é™¤ {count} æ¡è®°å½•", "data": {"deleted_count": count}}


@app.post("/api/records/batch-update", tags=["Batch"])
async def api_batch_update(request: BatchUpdateRequest, user: dict = Depends(require_auth)):
    """æ‰¹é‡æ›´æ–°è®°å½•"""
    if user["role"] != "admin":
        raise HTTPException(status_code=403, detail="æƒé™ä¸è¶³")

    if not request.updates:
        raise HTTPException(status_code=400, detail="æ²¡æœ‰è¦æ›´æ–°çš„æ•°æ®")

    is_valid, errors = validate_partial_record(request.updates)
    if not is_valid:
        raise HTTPException(status_code=400, detail="; ".join(errors))

    count = batch_update_records(request.ids, request.updates)
    record_audit_log(user["username"], "BATCH_UPDATE", "records", None, str(request.ids), str(request.updates))
    warning_note = format_soft_warning(get_soft_warnings(request.updates))
    return {
        "success": True,
        "message": f"æˆåŠŸæ›´æ–° {count} æ¡è®°å½•{warning_note}",
        "data": {"updated_count": count}
    }


# ==================== æ•°æ®å†å² API ====================

@app.get("/api/records/{record_id}/history", tags=["History"])
async def api_get_record_history(record_id: int, user: dict = Depends(require_auth)):
    """è·å–è®°å½•çš„ä¿®æ”¹å†å²"""
    history = get_data_history(record_id=record_id)
    return {"success": True, "data": history}


@app.get("/api/history", tags=["History"])
async def api_get_all_history(
    user: dict = Depends(require_auth),
    limit: int = Query(100, ge=1, le=500),
    record_id: Optional[int] = Query(None, ge=1),
    action: Optional[str] = None,
    username: Optional[str] = None,
):
    """è·å–æ‰€æœ‰æ•°æ®ä¿®æ”¹å†å²"""
    if user["role"] != "admin":
        raise HTTPException(status_code=403, detail="æƒé™ä¸è¶³")
    
    history = get_data_history(record_id=record_id, action=action, username=username, limit=limit)
    return {"success": True, "data": history}


# ==================== æ•°æ®æ ¡éªŒ API ====================

@app.get("/api/validation/rules", tags=["Validation"])
async def api_get_validation_rules():
    """è·å–æ•°æ®æ ¡éªŒè§„åˆ™"""
    return {"success": True, "data": get_validation_rules()}


@app.get("/api/validation/constraints", tags=["Validation"])
async def api_get_field_constraints():
    """è·å–å­—æ®µçº¦æŸï¼ˆç”¨äºå‰ç«¯è¡¨å•éªŒè¯ï¼‰"""
    return {"success": True, "data": get_field_constraints()}


@app.post("/api/validation/check", tags=["Validation"])
async def api_validate_data(records: List[dict]):
    """é¢„æ ¡éªŒæ•°æ®ï¼ˆä¸å…¥åº“ï¼‰"""
    result = validate_batch(records)
    return {"success": True, "data": result}


# ==================== æ•°æ®å®¡æ ¸ API ====================

class ApproveRequest(BaseModel):
    selected_ids: List[int]


class ApproveBatchItem(BaseModel):
    group_id: str
    selected_ids: List[int]


class ApproveBatchRequest(BaseModel):
    items: List[ApproveBatchItem]


class GroupBatchRequest(BaseModel):
    group_ids: List[str]

@app.get("/api/review/duplicates", tags=["Review"])
async def api_find_duplicates(user: dict = Depends(require_auth)):
    """æŸ¥æ‰¾åŒç»„åˆ†åŒæ¸©åº¦ä¸‹æœ‰å¤šä¸ªå‹åŠ›å€¼çš„æ•°æ®"""
    if user["role"] != "admin":
        raise HTTPException(status_code=403, detail="æƒé™ä¸è¶³")
    
    duplicates = find_duplicate_pressure_records()
    return {"success": True, "data": duplicates, "count": len(duplicates)}


@app.post("/api/review/move-duplicates", tags=["Review"])
async def api_move_duplicates(user: dict = Depends(require_auth)):
    """å°†é‡å¤æ•°æ®ç§»åˆ°å¾…å®¡æ ¸åŒº"""
    if user["role"] != "admin":
        raise HTTPException(status_code=403, detail="æƒé™ä¸è¶³")
    
    result = move_duplicates_to_review()
    record_audit_log(user["username"], "MOVE_DUPLICATES", None, None, None, str(result))
    return {"success": True, "message": f"å·²ç§»åŠ¨ {result['moved']} æ¡è®°å½•åˆ°å¾…å®¡æ ¸åŒº", "data": result}


@app.get("/api/review/pending", tags=["Review"])
async def api_get_pending_groups(
    page: int = Query(1, ge=1),
    per_page: int = Query(50, ge=1, le=200),
    group_id: Optional[str] = None,
    temp_min: Optional[float] = None,
    temp_max: Optional[float] = None,
    user: dict = Depends(require_auth),
):
    """è·å–å¾…å®¡æ ¸çš„æ•°æ®ç»„"""
    if user["role"] != "admin":
        raise HTTPException(status_code=403, detail="æƒé™ä¸è¶³")

    result = get_pending_groups(
        page=page,
        per_page=per_page,
        group_id=group_id,
        temp_min=temp_min,
        temp_max=temp_max,
    )
    return {"success": True, "data": result, "count": result["total"]}


@app.get("/api/review/stats", tags=["Review"])
async def api_get_review_stats(user: dict = Depends(require_auth)):
    """è·å–å®¡æ ¸ç»Ÿè®¡ä¿¡æ¯"""
    if user["role"] != "admin":
        raise HTTPException(status_code=403, detail="æƒé™ä¸è¶³")
    
    stats = get_pending_stats()
    return {"success": True, "data": stats}


@app.put("/api/review/pressure/{pending_id}", tags=["Review"])
async def api_update_pressure(pending_id: int, pressure: float, user: dict = Depends(require_auth)):
    """æ›´æ–°å¾…å®¡æ ¸è®°å½•çš„å‹åŠ›å€¼"""
    if user["role"] != "admin":
        raise HTTPException(status_code=403, detail="æƒé™ä¸è¶³")
    
    success = update_pending_pressure(pending_id, pressure)
    if not success:
        raise HTTPException(status_code=404, detail="è®°å½•ä¸å­˜åœ¨")
    
    return {"success": True, "message": "å‹åŠ›å€¼å·²æ›´æ–°"}


@app.post("/api/review/approve/{group_id}", tags=["Review"])
async def api_approve_group(group_id: str, request: ApproveRequest, user: dict = Depends(require_auth)):
    """å®¡æ ¸é€šè¿‡ä¸€ç»„æ•°æ®"""
    if user["role"] != "admin":
        raise HTTPException(status_code=403, detail="æƒé™ä¸è¶³")
    
    result = approve_group(group_id, request.selected_ids, user["username"])
    record_audit_log(user["username"], "APPROVE_GROUP", "review", None, group_id, str(result))
    return {"success": True, "message": f"å·²å®¡æ ¸é€šè¿‡ {result['approved']} æ¡è®°å½•", "data": result}


@app.post("/api/review/approve-batch", tags=["Review"])
async def api_approve_groups(request: ApproveBatchRequest, user: dict = Depends(require_auth)):
    """æ‰¹é‡å®¡æ ¸é€šè¿‡å¤šç»„æ•°æ®"""
    if user["role"] != "admin":
        raise HTTPException(status_code=403, detail="æƒé™ä¸è¶³")
    if not request.items:
        raise HTTPException(status_code=400, detail="æœªæä¾›å®¡æ ¸æ•°æ®")

    total_approved = 0
    results = []
    for item in request.items:
        result = approve_group(item.group_id, item.selected_ids, user["username"])
        results.append(result)
        total_approved += result.get("approved", 0)

    record_audit_log(user["username"], "APPROVE_GROUP_BATCH", "review", None, None, str(results))
    return {"success": True, "message": f"æ‰¹é‡å®¡æ ¸é€šè¿‡ {total_approved} æ¡è®°å½•", "data": results}


@app.post("/api/review/reject/{group_id}", tags=["Review"])
async def api_reject_group(group_id: str, user: dict = Depends(require_auth)):
    """æ‹’ç»æ•´ç»„æ•°æ®"""
    if user["role"] != "admin":
        raise HTTPException(status_code=403, detail="æƒé™ä¸è¶³")
    
    success = reject_group(group_id, user["username"])
    record_audit_log(user["username"], "REJECT_GROUP", "review", None, group_id)
    return {"success": True, "message": "å·²æ‹’ç»è¯¥ç»„æ•°æ®"}


@app.post("/api/review/reject-batch", tags=["Review"])
async def api_reject_groups(request: GroupBatchRequest, user: dict = Depends(require_auth)):
    """æ‰¹é‡æ‹’ç»å¤šç»„æ•°æ®"""
    if user["role"] != "admin":
        raise HTTPException(status_code=403, detail="æƒé™ä¸è¶³")
    if not request.group_ids:
        raise HTTPException(status_code=400, detail="æœªæä¾›ç»„ID")

    rejected = 0
    for group_id in request.group_ids:
        if reject_group(group_id, user["username"]):
            rejected += 1

    record_audit_log(user["username"], "REJECT_GROUP_BATCH", "review", None, None, str(request.group_ids))
    return {"success": True, "message": f"å·²æ‹’ç» {rejected} ç»„æ•°æ®"}


@app.post("/api/review/restore/{group_id}", tags=["Review"])
async def api_restore_group(group_id: str, user: dict = Depends(require_auth)):
    """æ¢å¤ä¸€ç»„æ•°æ®åˆ°å¾…å®¡æ ¸çŠ¶æ€"""
    if user["role"] != "admin":
        raise HTTPException(status_code=403, detail="æƒé™ä¸è¶³")
    
    result = restore_group(group_id)
    return {"success": True, "message": f"å·²æ¢å¤ {result['restored']} æ¡è®°å½•", "data": result}


@app.post("/api/review/restore-batch", tags=["Review"])
async def api_restore_groups(request: GroupBatchRequest, user: dict = Depends(require_auth)):
    """æ‰¹é‡æ¢å¤å¤šç»„æ•°æ®åˆ°å¾…å®¡æ ¸"""
    if user["role"] != "admin":
        raise HTTPException(status_code=403, detail="æƒé™ä¸è¶³")
    if not request.group_ids:
        raise HTTPException(status_code=400, detail="æœªæä¾›ç»„ID")

    restored = 0
    for group_id in request.group_ids:
        result = restore_group(group_id)
        restored += result.get("restored", 0)

    record_audit_log(user["username"], "RESTORE_GROUP_BATCH", "review", None, None, str(request.group_ids))
    return {"success": True, "message": f"å·²æ¢å¤ {restored} æ¡è®°å½•"}


# ==================== å—ä¿æŠ¤çš„å…¬å¼€æŸ¥è¯¢ API ====================

class AvailableComponentsRequest(BaseModel):
    selected: List[str]  # ['x_ch4', 'x_c2h6', ...]

class RangeQueryRequest(BaseModel):
    components: List[str]
    ranges: dict  # {'x_ch4': {'min': 0.9, 'max': 0.95}, ...}
    temperature: float

@app.post("/api/components/available", tags=["Public Query"])
async def api_available_components(request: AvailableComponentsRequest):
    """
    æ ¹æ®å·²é€‰ç»„åˆ†ï¼ŒæŸ¥è¯¢æ•°æ®åº“ä¸­è¿˜æœ‰å“ªäº›å¯ç”¨çš„ç»„åˆ†ç»„åˆ
    """
    selected = request.selected

    all_components = ['x_ch4', 'x_c2h6', 'x_c3h8', 'x_co2', 'x_n2', 'x_h2s', 'x_ic4h10']
    
    try:
        with get_connection(dict_cursor=True) as conn:
            cursor = conn.cursor()

            # æ„å»ºæŸ¥è¯¢æ¡ä»¶ï¼šå·²é€‰ç»„åˆ†å¿…é¡» > 0
            conditions = []
            for comp in selected:
                conditions.append(f"{comp} > 0")

            where_clause = " AND ".join(conditions) if conditions else "1=1"

            # æŸ¥è¯¢åŒ¹é…çš„è®°å½•æ•°
            cursor.execute(f"SELECT COUNT(*) as count FROM gas_mixture WHERE {where_clause}")
            row = cursor.fetchone()
            match_count = row['count'] if row else 0

            # æŸ¥æ‰¾è¿˜èƒ½æ·»åŠ å“ªäº›ç»„åˆ†ï¼ˆåœ¨å·²æœ‰æ¡ä»¶ä¸‹ï¼Œè¯¥ç»„åˆ†ä¹Ÿæœ‰ > 0 çš„è®°å½•ï¼‰
            available = []
            for comp in all_components:
                if comp in selected:
                    continue

                test_conditions = conditions + [f"{comp} > 0"]
                test_where = " AND ".join(test_conditions)

                cursor.execute(f"SELECT COUNT(*) as count FROM gas_mixture WHERE {test_where}")
                row = cursor.fetchone()
                count = row['count'] if row else 0

                if count > 0:
                    available.append(comp)

            return {
                "success": True,
                "available": available,
                "match_count": match_count
            }
        
    except Exception as e:
        return {"success": False, "message": str(e)}


class ComponentRangesRequest(BaseModel):
    components: List[str]  # ['x_ch4', 'x_c2h6', ...]

@app.post("/api/components/ranges", tags=["Public Query"])
async def api_component_ranges(request: ComponentRangesRequest):
    """
    æ ¹æ®é€‰å®šçš„ç»„åˆ†ï¼Œè¿”å›æ•°æ®åº“ä¸­æ¯ä¸ªç»„åˆ†çš„å®é™…åŒºé—´èŒƒå›´
    """
    components = request.components

    all_components = ['x_ch4', 'x_c2h6', 'x_c3h8', 'x_co2', 'x_n2', 'x_h2s', 'x_ic4h10']
    
    try:
        with get_connection(dict_cursor=True) as conn:
            cursor = conn.cursor()
        
            # æ„å»ºæŸ¥è¯¢æ¡ä»¶ï¼šå·²é€‰ç»„åˆ†å¿…é¡» > 0ï¼Œæœªé€‰ç»„åˆ†å¿…é¡»æ¥è¿‘0
            conditions = []
            for comp in components:
                conditions.append(f"{comp} > 0")
            for comp in all_components:
                if comp not in components:
                    conditions.append(f"{comp} <= 0.02")

            where_clause = " AND ".join(conditions) if conditions else "1=1"

            # æŸ¥è¯¢æ¯ä¸ªç»„åˆ†çš„minå’Œmax
            ranges = {}
            for comp in components:
                cursor.execute(
                    f"SELECT MIN({comp}) as min_val, MAX({comp}) as max_val FROM gas_mixture WHERE {where_clause}"
                )
                row = cursor.fetchone()
                if row and row['min_val'] is not None:
                    ranges[comp] = {
                        'min': row['min_val'],
                        'max': row['max_val']
                    }

            # æŸ¥è¯¢æ€»è®°å½•æ•°
            cursor.execute(f"SELECT COUNT(*) as count FROM gas_mixture WHERE {where_clause}")
            row = cursor.fetchone()
            total_records = row['count'] if row else 0

            # æŸ¥è¯¢æ¸©åº¦èŒƒå›´
            cursor.execute(
                f"SELECT MIN(temperature) as min_temp, MAX(temperature) as max_temp FROM gas_mixture WHERE {where_clause}"
            )
            temp_row = cursor.fetchone()
            temp_range = None
            if temp_row and temp_row['min_temp'] is not None:
                temp_range = {
                    'min': temp_row['min_temp'],
                    'max': temp_row['max_temp']
                }

            return {
                "success": True,
                "ranges": ranges,
                "total_records": total_records,
                "temp_range": temp_range
            }
        
    except Exception as e:
        return {"success": False, "message": str(e)}


class QueryByComponentsRequest(BaseModel):
    components: List[str]
    temperature: float

@app.post("/api/query/by-components", tags=["Public Query"])
async def api_query_by_components(request: QueryByComponentsRequest):
    """
    æ ¹æ®ç»„åˆ†ç»„åˆå’Œæ¸©åº¦æŸ¥è¯¢ç›¸å¹³è¡¡å‹åŠ›
    """
    components = request.components
    temperature = request.temperature

    all_components = ['x_ch4', 'x_c2h6', 'x_c3h8', 'x_co2', 'x_n2', 'x_h2s', 'x_ic4h10']
    
    try:
        with get_connection(dict_cursor=True) as conn:
            cursor = conn.cursor()

            # æ„å»ºæŸ¥è¯¢æ¡ä»¶ï¼šå·²é€‰ç»„åˆ† > 0ï¼Œæœªé€‰ç»„åˆ† <= 0.02
            conditions = []
            for comp in components:
                conditions.append(f"{comp} > 0")
            for comp in all_components:
                if comp not in components:
                    conditions.append(f"{comp} <= 0.02")

            # æ¸©åº¦èŒƒå›´ Â±5K
            conditions.append("ABS(temperature - ?) <= 5")

            where_clause = " AND ".join(conditions)

            query = f"""
                SELECT temperature, pressure, {', '.join(all_components)}
                FROM gas_mixture
                WHERE {where_clause}
                ORDER BY ABS(temperature - ?)
                LIMIT 1
            """

            cursor.execute(query, [temperature, temperature])
            row = cursor.fetchone()

            if row:
                composition = {}
                for comp in all_components:
                    composition[comp] = row[comp]

                return {
                    "success": True,
                    "data": {
                        "temperature": row['temperature'],
                        "pressure": row['pressure'],
                        "composition": composition
                    }
                }
            return {
                "success": False,
                "message": "åœ¨æŒ‡å®šçš„æ¸©åº¦èŒƒå›´å†…æœªæ‰¾åˆ°æ•°æ®"
            }
            
    except Exception as e:
        return {"success": False, "message": str(e)}


@app.post("/api/query/range", tags=["Public Query"])
async def api_range_query(request: RangeQueryRequest):
    """
    æ ¹æ®ç»„åˆ†èŒƒå›´å’Œæ¸©åº¦æŸ¥è¯¢ç›¸å¹³è¡¡å‹åŠ›
    """
    components = request.components
    ranges = request.ranges
    temperature = request.temperature

    all_components = ['x_ch4', 'x_c2h6', 'x_c3h8', 'x_co2', 'x_n2', 'x_h2s', 'x_ic4h10']
    
    try:
        with get_connection(dict_cursor=True) as conn:
            cursor = conn.cursor()

            # æ„å»ºæŸ¥è¯¢æ¡ä»¶
            conditions = []
            params = []

            for comp in all_components:
                if comp in components and comp in ranges:
                    # å·²é€‰ç»„åˆ†ï¼šåœ¨èŒƒå›´å†…
                    r = ranges[comp]
                    conditions.append(f"({comp} >= ? AND {comp} <= ?)")
                    params.extend([r['min'], r['max']])
                else:
                    # æœªé€‰ç»„åˆ†ï¼šå¿…é¡»ä¸º0æˆ–æ¥è¿‘0
                    conditions.append(f"{comp} <= 0.02")

            # æ¸©åº¦èŒƒå›´ Â±5K
            conditions.append("ABS(temperature - ?) <= 5")
            params.append(temperature)

            where_clause = " AND ".join(conditions)

            query = f"""
                SELECT temperature, pressure
                FROM gas_mixture
                WHERE {where_clause}
                ORDER BY ABS(temperature - ?)
                LIMIT 1
            """
            params.append(temperature)

            cursor.execute(query, params)
            row = cursor.fetchone()

            if row:
                return {
                    "success": True,
                    "data": {
                        "temperature": row['temperature'],
                        "pressure": row['pressure']
                    }
                }
            return {
                "success": False,
                "message": "åœ¨æŒ‡å®šçš„ç»„åˆ†èŒƒå›´å’Œæ¸©åº¦ä¸‹æœªæ‰¾åˆ°æ•°æ®"
            }
            
    except Exception as e:
        return {"success": False, "message": str(e)}


class MatchCountRequest(BaseModel):
    components: List[str]
    ranges: dict  # {'x_ch4': {'min': 0.9, 'max': 0.95}, ...}

@app.post("/api/query/match-count", tags=["Public Query"])
async def api_match_count(request: MatchCountRequest):
    """
    æ ¹æ®ç»„åˆ†èŒƒå›´æŸ¥è¯¢åŒ¹é…çš„æ•°æ®æ¡æ•°ï¼ˆä¸è€ƒè™‘æ¸©åº¦ï¼‰
    è¿”å›æ¨¡ç³Šæ•°é‡ï¼š100+, 10+, <10, 0
    """
    components = request.components
    ranges = request.ranges

    all_components = ['x_ch4', 'x_c2h6', 'x_c3h8', 'x_co2', 'x_n2', 'x_h2s', 'x_ic4h10']
    
    try:
        with get_connection(dict_cursor=True) as conn:
            cursor = conn.cursor()

            # æ„å»ºæŸ¥è¯¢æ¡ä»¶
            conditions = []
            params = []

            for comp in all_components:
                if comp in components and comp in ranges:
                    # å·²é€‰ç»„åˆ†ï¼šåœ¨èŒƒå›´å†…
                    r = ranges[comp]
                    conditions.append(f"({comp} >= ? AND {comp} <= ?)")
                    params.extend([r['min'], r['max']])
                else:
                    # æœªé€‰ç»„åˆ†ï¼šå¿…é¡»ä¸º0æˆ–æ¥è¿‘0
                    conditions.append(f"{comp} <= 0.02")

            where_clause = " AND ".join(conditions)

            cursor.execute(f"SELECT COUNT(*) as count FROM gas_mixture WHERE {where_clause}", params)
            row = cursor.fetchone()
            count = row['count'] if row else 0

            # è¿”å›æ¨¡ç³Šæ•°é‡
            if count == 0:
                display = "0"
            elif count < 10:
                display = "<10"
            elif count < 100:
                display = "10+"
            else:
                display = "100+"

            return {
                "success": True,
                "count": count,
                "display": display
            }
        
    except Exception as e:
        return {"success": False, "message": str(e), "count": 0, "display": "0"}


class HydrateQueryRequest(BaseModel):
    components: dict  # {'x_ch4': 0.9, 'x_c2h6': 0.1, ...}
    temperature: float
    tolerance: float = 0.02  # é»˜è®¤2%å®¹å·®

@app.post("/api/query/hydrate", tags=["Public Query"])
async def api_hydrate_query(request: HydrateQueryRequest):
    """
    æ°”ä½“æ°´åˆç‰©ç›¸å¹³è¡¡æŸ¥è¯¢æ¥å£
    - ç”¨æˆ·è¾“å…¥ç»„åˆ†æ‘©å°”åˆ†æ•° + æ¸©åº¦
    - æŸ¥æ‰¾æœ€åŒ¹é…çš„å®éªŒæ•°æ®ç‚¹
    - è¿”å›ç›¸å¹³è¡¡å‹åŠ›
    """
    components = request.components
    temperature = request.temperature
    tolerance = request.tolerance
    
    # ç»„åˆ†åˆ—è¡¨
    comp_cols = ['x_ch4', 'x_c2h6', 'x_c3h8', 'x_co2', 'x_n2', 'x_h2s', 'x_ic4h10']
    
    try:
        with get_connection(dict_cursor=True) as conn:
            cursor = conn.cursor()

            # æ„å»ºæŸ¥è¯¢ - å…ˆæŒ‰ç»„åˆ†ç­›é€‰ï¼Œå†æŒ‰æ¸©åº¦æ’åº
            conditions = []
            params = []

            for col in comp_cols:
                user_val = components.get(col, 0)
                if user_val > 0.001:  # ç”¨æˆ·è¾“å…¥äº†è¯¥ç»„åˆ†
                    # å…è®¸ä¸€å®šå®¹å·®
                    conditions.append(f"ABS({col} - ?) <= ?")
                    params.extend([user_val, tolerance])
                else:
                    # ç”¨æˆ·æ²¡è¾“å…¥è¯¥ç»„åˆ†ï¼Œè¦æ±‚æ•°æ®åº“ä¸­ä¹Ÿæ¥è¿‘0
                    conditions.append(f"{col} <= ?")
                    params.append(tolerance)

            # æ¸©åº¦ç­›é€‰ - å…è®¸Â±5KèŒƒå›´
            conditions.append("ABS(temperature - ?) <= 5")
            params.append(temperature)

            where_clause = " AND ".join(conditions)

            # æŸ¥è¯¢å¹¶è®¡ç®—åŒ¹é…åº¦
            query = f"""
                SELECT temperature, pressure, x_ch4, x_c2h6, x_c3h8, x_co2, x_n2, x_h2s, x_ic4h10
                FROM gas_mixture
                WHERE {where_clause}
                ORDER BY ABS(temperature - ?)
                LIMIT 1
            """
            params.append(temperature)

            cursor.execute(query, params)
            row = cursor.fetchone()

            if row:
                # è®¡ç®—åŒ¹é…åº¦åˆ†æ•°
                match_score = 100
                for col in comp_cols:
                    user_val = components.get(col, 0)
                    db_val = row[col]
                    diff = abs(user_val - db_val)
                    if diff > 0.001:
                        match_score -= diff * 100  # æ¯1%å·®å¼‚æ‰£1åˆ†

                temp_diff = abs(row['temperature'] - temperature)
                match_score -= temp_diff * 2  # æ¯1Kæ¸©å·®æ‰£2åˆ†

                match_score = max(0, min(100, round(match_score)))

                return {
                    "success": True,
                    "data": {
                        "temperature": row['temperature'],
                        "pressure": row['pressure'],
                        "match_score": match_score
                    }
                }
            return {
                "success": False,
                "message": "æœªæ‰¾åˆ°åŒ¹é…çš„å®éªŒæ•°æ®ï¼Œè¯·è°ƒæ•´ç»„åˆ†æˆ–æ¸©åº¦"
            }
            
    except Exception as e:
        return {"success": False, "message": str(e)}


# ==================== æ•°æ®æ¨¡æ¿ API ====================

@app.get("/api/template/csv", tags=["Template"])
async def api_download_csv_template():
    """ä¸‹è½½ CSV å¯¼å…¥æ¨¡æ¿"""
    template = '''T (K),xCH4,xC2H6,xC3H8,xCO2,xN2,xH2S,x i-C4H10,p (MPa)
300,0.9,0.05,0.02,0.01,0.01,0.005,0.005,10.5
310,0.85,0.08,0.03,0.02,0.01,0.005,0.005,15.2
'''
    return StreamingResponse(
        iter([template]),
        media_type="text/csv",
        headers={"Content-Disposition": "attachment; filename=import_template.csv"}
    )


@app.get("/api/template/excel", tags=["Template"])
async def api_download_excel_template():
    """ä¸‹è½½ Excel å¯¼å…¥æ¨¡æ¿"""
    try:
        import pandas as pd
        
        # åˆ›å»ºæ¨¡æ¿æ•°æ®
        template_data = {
            'T (K)': [300, 310],
            'xCH4': [0.9, 0.85],
            'xC2H6': [0.05, 0.08],
            'xC3H8': [0.02, 0.03],
            'xCO2': [0.01, 0.02],
            'xN2': [0.01, 0.01],
            'xH2S': [0.005, 0.005],
            'x i-C4H10': [0.005, 0.005],
            'p (MPa)': [10.5, 15.2]
        }
        
        df = pd.DataFrame(template_data)
        
        output = io.BytesIO()
        df.to_excel(output, index=False, engine='openpyxl')
        output.seek(0)
        
        return StreamingResponse(
            output,
            media_type="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
            headers={"Content-Disposition": "attachment; filename=import_template.xlsx"}
        )
    except ImportError:
        raise HTTPException(status_code=500, detail="éœ€è¦å®‰è£… pandas å’Œ openpyxl")


# ==================== å¤‡ä»½ç›¸å…³ API ====================

@app.get("/api/backup/status", tags=["Backup"])
async def api_backup_status(user: dict = Depends(require_auth)):
    """è·å–å¤‡ä»½çŠ¶æ€"""
    return {"success": True, "data": get_backup_status()}


@app.get("/api/backup/list", tags=["Backup"])
async def api_backup_list(user: dict = Depends(require_auth)):
    """è·å–å¤‡ä»½åˆ—è¡¨"""
    return {"success": True, "data": list_backups()}


@app.post("/api/backup/create", tags=["Backup"])
async def api_create_backup(user: dict = Depends(require_auth)):
    """æ‰‹åŠ¨åˆ›å»ºå¤‡ä»½"""
    if user["role"] != "admin":
        raise HTTPException(status_code=403, detail="æƒé™ä¸è¶³")
    
    backup_path = create_backup(manual=True)
    if backup_path:
        return {"success": True, "message": "å¤‡ä»½åˆ›å»ºæˆåŠŸ", "data": {"path": backup_path}}
    if not is_backup_supported():
        return {"success": False, "message": "å½“å‰ä½¿ç”¨æ‰˜ç®¡æ•°æ®åº“ï¼Œè¯·åœ¨äº‘æ§åˆ¶å°åˆ›å»ºå¤‡ä»½"}
    raise HTTPException(status_code=500, detail="å¤‡ä»½åˆ›å»ºå¤±è´¥")


@app.post("/api/backup/restore/{filename}", tags=["Backup"])
async def api_restore_backup(filename: str, user: dict = Depends(require_auth)):
    """æ¢å¤å¤‡ä»½"""
    if user["role"] != "admin":
        raise HTTPException(status_code=403, detail="æƒé™ä¸è¶³")
    
    success = restore_backup(filename)
    if success:
        return {"success": True, "message": "å¤‡ä»½æ¢å¤æˆåŠŸ"}
    if not is_backup_supported():
        return {"success": False, "message": "å½“å‰ä½¿ç”¨æ‰˜ç®¡æ•°æ®åº“ï¼Œè¯·åœ¨äº‘æ§åˆ¶å°è¿›è¡Œæ¢å¤"}
    raise HTTPException(status_code=500, detail="å¤‡ä»½æ¢å¤å¤±è´¥")


@app.delete("/api/backup/{filename}", tags=["Backup"])
async def api_delete_backup(filename: str, user: dict = Depends(require_auth)):
    """åˆ é™¤å¤‡ä»½"""
    if user["role"] != "admin":
        raise HTTPException(status_code=403, detail="æƒé™ä¸è¶³")
    
    success = delete_backup(filename)
    if success:
        return {"success": True, "message": "å¤‡ä»½åˆ é™¤æˆåŠŸ"}
    raise HTTPException(status_code=404, detail="å¤‡ä»½ä¸å­˜åœ¨")


@app.get("/api/backup/download/{filename}", tags=["Backup"])
async def api_download_backup(filename: str, user: dict = Depends(require_auth)):
    """ä¸‹è½½å¤‡ä»½æ–‡ä»¶"""
    backup_dir = get_backup_dir()
    filepath = os.path.join(backup_dir, filename)
    
    if not os.path.exists(filepath):
        raise HTTPException(status_code=404, detail="å¤‡ä»½ä¸å­˜åœ¨")
    
    return FileResponse(
        filepath,
        media_type="application/octet-stream",
        filename=filename
    )


# ==================== åå°ç®¡ç†è·¯ç”± ====================

ADMIN_DIR = os.path.join(FRONTEND_DIR, "admin")


@app.get("/admin", tags=["Admin"])
async def serve_admin():
    """åå°ç®¡ç†é¡µé¢"""
    admin_index = os.path.join(ADMIN_DIR, "index.html")
    if os.path.exists(admin_index):
        return FileResponse(admin_index)
    return {"message": "åå°ç®¡ç†é¡µé¢ä¸å­˜åœ¨"}


# ==================== å¯åŠ¨äº‹ä»¶ ====================

@app.on_event("startup")
async def startup_event():
    """åº”ç”¨å¯åŠ¨æ—¶æ‰§è¡Œ"""
    print("[App] æ­£åœ¨åˆå§‹åŒ–å®‰å…¨æ¨¡å—...")
    init_security()
    ensure_admin_user()
    if is_using_default_secret_key():
        print("[Security] WARNING: SECRET_KEY ä½¿ç”¨é»˜è®¤å€¼ï¼Œè¯·åœ¨ç”Ÿäº§ç¯å¢ƒä¸­è®¾ç½®ç¯å¢ƒå˜é‡")
    if not is_admin_configured():
        print("[Auth] WARNING: æœªè®¾ç½® ADMIN_PASSWORDï¼Œç®¡ç†å‘˜ç™»å½•å·²ç¦ç”¨")
    print("[App] æ­£åœ¨åˆå§‹åŒ–å¤‡ä»½ç³»ç»Ÿ...")
    init_backup_system()
    print("[App] ç³»ç»Ÿå¯åŠ¨å®Œæˆ v4.0")


# ==================== å¯åŠ¨å…¥å£ ====================

if __name__ == "__main__":
    import uvicorn
    import sys
    
    # è®¾ç½®è¾“å‡ºç¼–ç 
    if sys.platform == 'win32':
        import io
        sys.stdout = io.TextIOWrapper(sys.stdout.buffer, encoding='utf-8', errors='replace')
    
    print("\n" + "="*60)
    print("   Gas Mixture Data Management System - FastAPI v4.0")
    print("="*60)
    print("   API Docs: http://127.0.0.1:8000/docs")
    print("   Frontend: http://127.0.0.1:8000")
    print("   Admin:    http://127.0.0.1:8000/admin")
    print("-"*60)
    print("   Security Features:")
    print("      - JWT Auth + PBKDF2 Password Encryption")
    print("      - TOTP Two-Factor Authentication")
    print("      - API Rate Limiting + Anti-Crawler")
    print("      - Login Logs + Session Management")
    print("-"*60)
    admin_user = get_admin_username()
    if is_admin_configured():
        print(f"   Admin User: {admin_user} (password from ADMIN_PASSWORD)")
    else:
        print(f"   Admin User: {admin_user} (set ADMIN_PASSWORD to enable login)")
    print("="*60 + "\n")
    uvicorn.run(app, host="127.0.0.1", port=8000)
```

### 2.4 æ•°æ®æ¨¡å‹å®šä¹‰ (backend/models.py)

```python
"""
Pydantic æ•°æ®æ¨¡å‹
ç”¨äºè¯·æ±‚å’Œå“åº”çš„æ•°æ®éªŒè¯
"""

from pydantic import BaseModel
from typing import Optional, List
from datetime import datetime


class GasRecordBase(BaseModel):
    """æ°”ä½“è®°å½•åŸºç¡€æ¨¡å‹"""
    temperature: float
    pressure: float
    x_ch4: float = 0
    x_c2h6: float = 0
    x_c3h8: float = 0
    x_co2: float = 0
    x_n2: float = 0
    x_h2s: float = 0
    x_ic4h10: float = 0


class GasRecordCreate(GasRecordBase):
    """åˆ›å»ºæ°”ä½“è®°å½•çš„è¯·æ±‚æ¨¡å‹"""
    pass


class GasRecordUpdate(BaseModel):
    """æ›´æ–°æ°”ä½“è®°å½•çš„è¯·æ±‚æ¨¡å‹"""
    temperature: Optional[float] = None
    pressure: Optional[float] = None
    x_ch4: Optional[float] = None
    x_c2h6: Optional[float] = None
    x_c3h8: Optional[float] = None
    x_co2: Optional[float] = None
    x_n2: Optional[float] = None
    x_h2s: Optional[float] = None
    x_ic4h10: Optional[float] = None


class GasRecord(GasRecordBase):
    """æ°”ä½“è®°å½•å“åº”æ¨¡å‹"""
    id: int
    created_at: Optional[datetime] = None
    updated_at: Optional[datetime] = None

    class Config:
        from_attributes = True


class PaginatedResponse(BaseModel):
    """åˆ†é¡µå“åº”æ¨¡å‹"""
    records: List[GasRecord]
    total: int
    page: int
    per_page: int
    total_pages: int


class Statistics(BaseModel):
    """ç»Ÿè®¡ä¿¡æ¯æ¨¡å‹"""
    total_records: int
    min_temperature: Optional[float]
    max_temperature: Optional[float]
    avg_temperature: Optional[float]
    min_pressure: Optional[float]
    max_pressure: Optional[float]
    avg_pressure: Optional[float]


class ApiResponse(BaseModel):
    """é€šç”¨APIå“åº”æ¨¡å‹"""
    success: bool
    message: str
    data: Optional[dict] = None
```

### 2.5 æ•°æ®æ ¡éªŒä¸æ¸…æ´— (backend/data_validation.py)

```python
"""
æ•°æ®æ ¡éªŒæ¨¡å— - å¯¼å…¥æ—¶è‡ªåŠ¨æ ¡éªŒæ•°æ®æœ‰æ•ˆæ€§
"""

import re
from typing import List, Dict, Tuple, Any, Optional
from dataclasses import dataclass


PRESSURE_SOFT_MAX = 10.0
SUM_SOFT_TOLERANCE = 0.02
SUM_HARD_TOLERANCE = 0.05


@dataclass
class ValidationRule:
    """æ ¡éªŒè§„åˆ™"""
    field: str
    rule_type: str
    params: dict
    error_message: str


# ==================== é¢„å®šä¹‰æ ¡éªŒè§„åˆ™ ====================

GAS_MIXTURE_RULES = [
    # æ¸©åº¦æ ¡éªŒ
    ValidationRule(
        field='temperature',
        rule_type='range',
        params={'min': 100, 'max': 1000},
        error_message='æ¸©åº¦å¿…é¡»åœ¨ 100-1000 K èŒƒå›´å†…'
    ),
    ValidationRule(
        field='temperature',
        rule_type='required',
        params={},
        error_message='æ¸©åº¦ä¸èƒ½ä¸ºç©º'
    ),
    
    # å‹åŠ›æ ¡éªŒ
    ValidationRule(
        field='pressure',
        rule_type='range',
        params={'min': 0, 'max': 10000},
        error_message='å‹åŠ›å¿…é¡»åœ¨ 0-10000 MPa èŒƒå›´å†…'
    ),
    ValidationRule(
        field='pressure',
        rule_type='required',
        params={},
        error_message='å‹åŠ›ä¸èƒ½ä¸ºç©º'
    ),
    
    # æ‘©å°”åˆ†æ•°æ ¡éªŒï¼ˆæ¯ä¸ªç»„åˆ† 0-1ï¼‰
    ValidationRule(
        field='x_ch4',
        rule_type='range',
        params={'min': 0, 'max': 1},
        error_message='CH4 æ‘©å°”åˆ†æ•°å¿…é¡»åœ¨ 0-1 èŒƒå›´å†…'
    ),
    ValidationRule(
        field='x_c2h6',
        rule_type='range',
        params={'min': 0, 'max': 1},
        error_message='C2H6 æ‘©å°”åˆ†æ•°å¿…é¡»åœ¨ 0-1 èŒƒå›´å†…'
    ),
    ValidationRule(
        field='x_c3h8',
        rule_type='range',
        params={'min': 0, 'max': 1},
        error_message='C3H8 æ‘©å°”åˆ†æ•°å¿…é¡»åœ¨ 0-1 èŒƒå›´å†…'
    ),
    ValidationRule(
        field='x_co2',
        rule_type='range',
        params={'min': 0, 'max': 1},
        error_message='CO2 æ‘©å°”åˆ†æ•°å¿…é¡»åœ¨ 0-1 èŒƒå›´å†…'
    ),
    ValidationRule(
        field='x_n2',
        rule_type='range',
        params={'min': 0, 'max': 1},
        error_message='N2 æ‘©å°”åˆ†æ•°å¿…é¡»åœ¨ 0-1 èŒƒå›´å†…'
    ),
    ValidationRule(
        field='x_h2s',
        rule_type='range',
        params={'min': 0, 'max': 1},
        error_message='H2S æ‘©å°”åˆ†æ•°å¿…é¡»åœ¨ 0-1 èŒƒå›´å†…'
    ),
    ValidationRule(
        field='x_ic4h10',
        rule_type='range',
        params={'min': 0, 'max': 1},
        error_message='i-C4H10 æ‘©å°”åˆ†æ•°å¿…é¡»åœ¨ 0-1 èŒƒå›´å†…'
    ),
]


# ==================== æ ¡éªŒå‡½æ•° ====================

def validate_required(value: Any) -> bool:
    """å¿…å¡«æ ¡éªŒ"""
    if value is None:
        return False
    if isinstance(value, str) and value.strip() == '':
        return False
    return True


def validate_range(value: float, min_val: float = None, max_val: float = None) -> bool:
    """èŒƒå›´æ ¡éªŒ"""
    try:
        num = float(value)
        if min_val is not None and num < min_val:
            return False
        if max_val is not None and num > max_val:
            return False
        return True
    except (ValueError, TypeError):
        return False


def validate_type(value: Any, expected_type: str) -> bool:
    """ç±»å‹æ ¡éªŒ"""
    type_map = {
        'int': int,
        'float': float,
        'str': str,
        'number': (int, float)
    }
    expected = type_map.get(expected_type)
    if not expected:
        return True
    
    try:
        if expected_type in ('int', 'float', 'number'):
            float(value)  # å°è¯•è½¬æ¢
            return True
        return isinstance(value, expected)
    except (ValueError, TypeError):
        return False


def validate_pattern(value: str, pattern: str) -> bool:
    """æ­£åˆ™è¡¨è¾¾å¼æ ¡éªŒ"""
    if not isinstance(value, str):
        value = str(value)
    return bool(re.match(pattern, value))


def validate_sum(values: List[float], expected_sum: float, tolerance: float = 0.01) -> bool:
    """æ€»å’Œæ ¡éªŒï¼ˆç”¨äºæ‘©å°”åˆ†æ•°ä¹‹å’Œåº”ä¸º1ï¼‰"""
    try:
        total = sum(float(v) for v in values if v is not None)
        return abs(total - expected_sum) <= tolerance
    except (ValueError, TypeError):
        return False


# ==================== ä¸»æ ¡éªŒå‡½æ•° ====================

def validate_record(record: Dict[str, Any], rules: List[ValidationRule] = None) -> Tuple[bool, List[str]]:
    """
    æ ¡éªŒå•æ¡è®°å½•
    è¿”å›: (æ˜¯å¦æœ‰æ•ˆ, é”™è¯¯åˆ—è¡¨)
    """
    if rules is None:
        rules = GAS_MIXTURE_RULES
    
    errors = []
    
    for rule in rules:
        value = record.get(rule.field)
        
        if rule.rule_type == 'required':
            if not validate_required(value):
                errors.append(f"ç¬¬{rule.field}åˆ—: {rule.error_message}")
        
        elif rule.rule_type == 'range':
            if value is not None and str(value).strip() != '':
                if not validate_range(value, rule.params.get('min'), rule.params.get('max')):
                    errors.append(f"ç¬¬{rule.field}åˆ—: {rule.error_message}")
        
        elif rule.rule_type == 'type':
            if value is not None:
                if not validate_type(value, rule.params.get('type', 'str')):
                    errors.append(f"ç¬¬{rule.field}åˆ—: {rule.error_message}")
        
        elif rule.rule_type == 'pattern':
            if value is not None:
                if not validate_pattern(value, rule.params.get('pattern', '.*')):
                    errors.append(f"ç¬¬{rule.field}åˆ—: {rule.error_message}")
    
    # é¢å¤–æ ¡éªŒï¼šæ‘©å°”åˆ†æ•°ä¹‹å’Œ
    mole_fractions = [
        record.get('x_ch4', 0),
        record.get('x_c2h6', 0),
        record.get('x_c3h8', 0),
        record.get('x_co2', 0),
        record.get('x_n2', 0),
        record.get('x_h2s', 0),
        record.get('x_ic4h10', 0)
    ]
    
    # è½¬æ¢ä¸ºæµ®ç‚¹æ•°
    try:
        mole_fractions = [float(x) if x else 0 for x in mole_fractions]
        total = sum(mole_fractions)
        if total == 0:
            errors.append("æ‘©å°”åˆ†æ•°ä¸èƒ½å…¨éƒ¨ä¸º 0")
        elif abs(total - 1.0) > SUM_HARD_TOLERANCE:  # å…è®¸5%è¯¯å·®
            errors.append(f"æ‘©å°”åˆ†æ•°ä¹‹å’Œä¸º {total:.4f}ï¼Œåº”æ¥è¿‘ 1.0")
    except (ValueError, TypeError):
        pass  # ç±»å‹é”™è¯¯å·²ç»åœ¨ä¸Šé¢å¤„ç†
    
    return len(errors) == 0, errors


def validate_partial_record(record: Dict[str, Any], rules: List[ValidationRule] = None) -> Tuple[bool, List[str]]:
    """
    æ ¡éªŒéƒ¨åˆ†å­—æ®µï¼ˆç”¨äºæ›´æ–°åœºæ™¯ï¼‰
    ä»…æ ¡éªŒæä¾›çš„å­—æ®µï¼Œå¿½ç•¥ required è§„åˆ™ã€‚
    """
    if rules is None:
        rules = GAS_MIXTURE_RULES

    errors = []

    for rule in rules:
        if rule.field not in record:
            continue
        value = record.get(rule.field)

        if rule.rule_type == 'range':
            if value is not None and str(value).strip() != '':
                if not validate_range(value, rule.params.get('min'), rule.params.get('max')):
                    errors.append(f"ç¬¬{rule.field}åˆ—: {rule.error_message}")

        elif rule.rule_type == 'type':
            if value is not None:
                if not validate_type(value, rule.params.get('type', 'str')):
                    errors.append(f"ç¬¬{rule.field}åˆ—: {rule.error_message}")

        elif rule.rule_type == 'pattern':
            if value is not None:
                if not validate_pattern(value, rule.params.get('pattern', '.*')):
                    errors.append(f"ç¬¬{rule.field}åˆ—: {rule.error_message}")

    # ä»…å½“å…¨éƒ¨ç»„åˆ†éƒ½åœ¨æ›´æ–°å­—æ®µä¸­æ—¶æ‰åšæ€»å’Œæ ¡éªŒ
    comp_fields = ['x_ch4', 'x_c2h6', 'x_c3h8', 'x_co2', 'x_n2', 'x_h2s', 'x_ic4h10']
    if all(field in record for field in comp_fields):
        try:
            mole_fractions = [float(record.get(f) or 0) for f in comp_fields]
            total = sum(mole_fractions)
            if total == 0:
                errors.append("æ‘©å°”åˆ†æ•°ä¸èƒ½å…¨éƒ¨ä¸º 0")
            elif abs(total - 1.0) > SUM_HARD_TOLERANCE:
                errors.append(f"æ‘©å°”åˆ†æ•°ä¹‹å’Œä¸º {total:.4f}ï¼Œåº”æ¥è¿‘ 1.0")
        except (ValueError, TypeError):
            pass

    return len(errors) == 0, errors


def validate_batch(records: List[Dict[str, Any]], rules: List[ValidationRule] = None) -> Dict:
    """
    æ‰¹é‡æ ¡éªŒè®°å½•
    è¿”å›: {
        'valid': True/False,
        'total': æ€»æ•°,
        'valid_count': æœ‰æ•ˆæ•°,
        'invalid_count': æ— æ•ˆæ•°,
        'errors': [(è¡Œå·, é”™è¯¯åˆ—è¡¨), ...]
    }
    """
    if rules is None:
        rules = GAS_MIXTURE_RULES
    
    errors = []
    valid_count = 0
    
    for idx, record in enumerate(records):
        is_valid, record_errors = validate_record(record, rules)
        if is_valid:
            valid_count += 1
        else:
            errors.append({
                'row': idx + 1,  # ä»1å¼€å§‹è®¡æ•°
                'errors': record_errors
            })
    
    return {
        'valid': len(errors) == 0,
        'total': len(records),
        'valid_count': valid_count,
        'invalid_count': len(errors),
        'errors': errors[:50]  # æœ€å¤šè¿”å›50æ¡é”™è¯¯
    }


def get_soft_warnings(record: Dict[str, Any], pressure_threshold: float = PRESSURE_SOFT_MAX) -> List[str]:
    """è½¯æ€§æç¤ºï¼ˆä¸é˜»æ­¢ä¿å­˜ï¼‰"""
    warnings = []
    try:
        pressure = record.get('pressure')
        if pressure is not None and float(pressure) > pressure_threshold:
            warnings.append(
                f"å‹åŠ› {float(pressure):.3f} MPa é«˜äº {pressure_threshold:.0f} MPaï¼Œå¯èƒ½ä¸ºå¼‚å¸¸å€¼"
            )
    except (ValueError, TypeError):
        pass

    # ç»„åˆ†å’Œæç¤º
    comp_fields = ['x_ch4', 'x_c2h6', 'x_c3h8', 'x_co2', 'x_n2', 'x_h2s', 'x_ic4h10']
    try:
        mole_fractions = [float(record.get(f) or 0) for f in comp_fields]
        total = sum(mole_fractions)
        if total > 0 and SUM_SOFT_TOLERANCE < abs(total - 1.0) <= SUM_HARD_TOLERANCE:
            warnings.append(f"æ‘©å°”åˆ†æ•°ä¹‹å’Œä¸º {total:.4f}ï¼Œä¸ 1.0 åå·®è¾ƒå¤§")
    except (ValueError, TypeError):
        pass

    return warnings


def count_soft_warnings(records: List[Dict[str, Any]], pressure_threshold: float = PRESSURE_SOFT_MAX) -> int:
    """ç»Ÿè®¡è½¯æ€§æç¤ºæ•°é‡"""
    count = 0
    for record in records:
        if not record:
            continue
        try:
            pressure = record.get('pressure')
            if pressure is not None and float(pressure) > pressure_threshold:
                count += 1
        except (ValueError, TypeError):
            continue
    return count


# ==================== æ•°æ®æ¸…æ´— ====================

def clean_record(record: Dict[str, Any]) -> Dict[str, Any]:
    """
    æ¸…æ´—å•æ¡è®°å½•
    - è½¬æ¢æ•°æ®ç±»å‹
    - å¡«å……é»˜è®¤å€¼
    - å»é™¤ç©ºç™½
    """
    cleaned = {}
    
    float_fields = [
        'temperature', 'pressure',
        'x_ch4', 'x_c2h6', 'x_c3h8', 'x_co2', 'x_n2', 'x_h2s', 'x_ic4h10'
    ]
    
    for field in float_fields:
        value = record.get(field)
        if value is None or (isinstance(value, str) and value.strip() == ''):
            cleaned[field] = 0.0
        else:
            try:
                cleaned[field] = float(value)
            except (ValueError, TypeError):
                cleaned[field] = 0.0
    
    return cleaned


def clean_batch(records: List[Dict[str, Any]]) -> List[Dict[str, Any]]:
    """æ‰¹é‡æ¸…æ´—è®°å½•"""
    return [clean_record(r) for r in records]


# ==================== æ ¡éªŒè§„åˆ™ç®¡ç† ====================

def get_validation_rules() -> List[Dict]:
    """è·å–å½“å‰æ ¡éªŒè§„åˆ™ï¼ˆç”¨äºå‰ç«¯å±•ç¤ºï¼‰"""
    return [
        {
            'field': rule.field,
            'type': rule.rule_type,
            'params': rule.params,
            'message': rule.error_message
        }
        for rule in GAS_MIXTURE_RULES
    ]


def get_field_constraints() -> Dict[str, Dict]:
    """è·å–å­—æ®µçº¦æŸï¼ˆç”¨äºå‰ç«¯è¡¨å•éªŒè¯ï¼‰"""
    return {
        'temperature': {
            'type': 'number',
            'required': True,
            'min': 100,
            'max': 1000,
            'unit': 'K',
            'label': 'æ¸©åº¦'
        },
        'pressure': {
            'type': 'number',
            'required': True,
            'min': 0,
            'max': 10000,
            'unit': 'MPa',
            'label': 'å‹åŠ›'
        },
        'x_ch4': {
            'type': 'number',
            'required': False,
            'min': 0,
            'max': 1,
            'label': 'CHâ‚„ æ‘©å°”åˆ†æ•°'
        },
        'x_c2h6': {
            'type': 'number',
            'required': False,
            'min': 0,
            'max': 1,
            'label': 'Câ‚‚Hâ‚† æ‘©å°”åˆ†æ•°'
        },
        'x_c3h8': {
            'type': 'number',
            'required': False,
            'min': 0,
            'max': 1,
            'label': 'Câ‚ƒHâ‚ˆ æ‘©å°”åˆ†æ•°'
        },
        'x_co2': {
            'type': 'number',
            'required': False,
            'min': 0,
            'max': 1,
            'label': 'COâ‚‚ æ‘©å°”åˆ†æ•°'
        },
        'x_n2': {
            'type': 'number',
            'required': False,
            'min': 0,
            'max': 1,
            'label': 'Nâ‚‚ æ‘©å°”åˆ†æ•°'
        },
        'x_h2s': {
            'type': 'number',
            'required': False,
            'min': 0,
            'max': 1,
            'label': 'Hâ‚‚S æ‘©å°”åˆ†æ•°'
        },
        'x_ic4h10': {
            'type': 'number',
            'required': False,
            'min': 0,
            'max': 1,
            'label': 'i-Câ‚„Hâ‚â‚€ æ‘©å°”åˆ†æ•°'
        }
    }
```

### 2.6 ç®¡ç†åå°é¡µé¢ä¸äº¤äº’ (frontend/admin/index.html)

```html
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åå°ç®¡ç†ç³»ç»Ÿ - æ°”ä½“æ··åˆç‰©æ•°æ®ç®¡ç†</title>
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500&family=Inter:wght@400;500;600;700&family=Noto+Sans+SC:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-dark: #0f1419;
            --bg-card: #1a1f2e;
            --bg-sidebar: #151922;
            --bg-input: #0d1117;
            --border: #2d3748;
            --text: #e2e8f0;
            --text-dim: #718096;
            --accent: #4299e1;
            --accent-hover: #63b3ed;
            --success: #48bb78;
            --warning: #ecc94b;
            --danger: #f56565;
            --purple: #9f7aea;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', 'Noto Sans SC', sans-serif;
            background: var(--bg-dark);
            color: var(--text);
            min-height: 100vh;
        }

        /* Login Page */
        .login-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #0f1419 0%, #1a1f2e 50%, #0f1419 100%);
        }

        .login-box {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 40px;
            width: 400px;
            box-shadow: 0 25px 50px rgba(0,0,0,0.5);
        }
        /* ... çœç•¥éƒ¨åˆ†æ ·å¼ä¸å¸ƒå±€ ... */
    </style>
</head>
<body>
    <!-- ç™»å½•é¡µ -->
    <div class="login-container" id="loginPage">
        <div class="login-box">
            <div class="login-logo">
                <div class="icon">âš™ï¸</div>
                <h1>åå°ç®¡ç†</h1>
                <p>æ°”ä½“æ··åˆç‰©æ•°æ®ç®¡ç†ç³»ç»Ÿ</p>
            </div>
            <div class="login-error" id="loginError"></div>
            <form id="loginForm">
                <div class="form-group">
                    <label>ç”¨æˆ·å</label>
                    <input type="text" id="username" required>
                </div>
                <div class="form-group">
                    <label>å¯†ç </label>
                    <input type="password" id="password" required>
                </div>
                <button class="login-btn" type="submit">ç™»å½•</button>
            </form>
        </div>
    </div>

    <!-- ä¸»é¢æ¿ -->
    <div class="dashboard" id="dashboard">
        <aside class="sidebar">
            <!-- å·¦ä¾§å¯¼èˆª -->
        </aside>
        <main class="main-content">
            <!-- é¡µé¢ä¸»ä½“ -->
        </main>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
    <script>
        // å…¨å±€å˜é‡
        let currentPage = 1;
        const perPage = 20;
        let pendingPage = 1;
        const pendingPerPage = 20;
        let pendingGroupIds = [];
        let pendingSelection = new Set();
        let lastImportPreview = null;
        const BASE_PATH = window.location.pathname.indexOf('/thermodynamic') === 0 ? '/thermodynamic' : '';
        const API_BASE = `${BASE_PATH}/api`;
        let authToken = localStorage.getItem('authToken');
        let scatterChart = null;
        let visualizationReady = false;
        let pendingRecordId = null;
        let highlightTimer = null;

        // è·å–å¸¦è®¤è¯çš„è¯·æ±‚å¤´
        function getAuthHeaders() {
            return {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${authToken}`
            };
        }

        function getAuthHeaderOnly() {
            return {
                'Authorization': `Bearer ${authToken}`
            };
        }

        // ç™»å½•å¤„ç†
        document.getElementById('loginForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            try {
                const res = await fetch(`${API_BASE}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                const data = await res.json();

                if (data.success) {
                    authToken = data.data.access_token;
                    localStorage.setItem('authToken', authToken);
                    document.getElementById('loginPage').style.display = 'none';
                    document.getElementById('dashboard').classList.add('active');
                    loadDashboardData();
                } else {
                    document.getElementById('loginError').style.display = 'block';
                    document.getElementById('loginError').textContent = data.detail || 'ç™»å½•å¤±è´¥';
                }
            } catch (error) {
                document.getElementById('loginError').style.display = 'block';
                document.getElementById('loginError').textContent = 'ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•';
            }
        });

        // éªŒè¯ Token æœ‰æ•ˆæ€§
        async function validateToken() {
            if (!authToken) return false;
            try {
                const res = await fetch(`${API_BASE}/auth/me`, {
                    headers: getAuthHeaders()
                });
                return res.ok;
            } catch (error) {
                return false;
            }
        }

        // æ£€æŸ¥ç™»å½•çŠ¶æ€
        (async function() {
            if (authToken && await validateToken()) {
                document.getElementById('loginPage').style.display = 'none';
                document.getElementById('dashboard').classList.add('active');
                loadDashboardData();
            } else {
                localStorage.removeItem('authToken');
                authToken = null;
            }
        })();

        // é€€å‡ºç™»å½•
        function logout() {
            localStorage.removeItem('authToken');
            authToken = null;
            location.reload();
        }

        // å¯¼èˆªåˆ‡æ¢
        document.querySelectorAll('.nav-item[data-page]').forEach(item => {
            item.addEventListener('click', function() {
                const page = this.dataset.page;
                showPage(page);
            });
        });

        function showPage(page) {
            // æ›´æ–°å¯¼èˆªçŠ¶æ€
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            const navItem = document.querySelector(`.nav-item[data-page="${page}"]`);
            if (navItem) navItem.classList.add('active');

            // åˆ‡æ¢é¡µé¢
            document.querySelectorAll('.page-section').forEach(p => p.classList.remove('active'));
            document.getElementById(`page-${page}`).classList.add('active');

            // æ›´æ–°æ ‡é¢˜ä¸æè¿°
            const titles = {
                'overview': ['ç³»ç»Ÿæ¦‚è§ˆ', 'æŸ¥çœ‹ç³»ç»Ÿè¿è¡ŒçŠ¶æ€å’Œæ•°æ®ç»Ÿè®¡'],
                'database': ['æ•°æ®åº“ç®¡ç†', 'ç®¡ç†å’Œç»´æŠ¤æ•°æ®åº“'],
                'backup': ['è‡ªåŠ¨å¤‡ä»½', 'ç®¡ç†æ•°æ®åº“å¤‡ä»½'],
                'records': ['æ•°æ®è®°å½•', 'æŸ¥çœ‹æ‰€æœ‰æ•°æ®è®°å½•'],
                'visualization': ['é«˜çº§å¯è§†åŒ–', 'æ¢ç´¢æ•°æ®åˆ†å¸ƒä¸è¶‹åŠ¿'],
                'review': ['æ•°æ®å®¡æ ¸', 'å®¡æ ¸åŒç»„åˆ†åŒæ¸©åº¦ä¸‹çš„å¤šå‹åŠ›å€¼æ•°æ®'],
                'import': ['å¯¼å…¥å¯¼å‡º', 'æ‰¹é‡å¯¼å…¥å’Œå¯¼å‡ºæ•°æ®'],
                'history': ['æ•°æ®å†å²', 'æŸ¥çœ‹æ•°æ®ä¿®æ”¹è®°å½•'],
                'users': ['ç”¨æˆ·ç®¡ç†', 'ç®¡ç†ç³»ç»Ÿç”¨æˆ·å’Œæƒé™'],
                'totp': ['ä¸¤æ­¥éªŒè¯', 'è®¾ç½®è´¦æˆ·ä¸¤æ­¥éªŒè¯'],
                'sessions': ['ä¼šè¯ç®¡ç†', 'ç®¡ç†ç™»å½•ä¼šè¯'],
                'logs': ['ç™»å½•æ—¥å¿—', 'æŸ¥çœ‹ç™»å½•è®°å½•'],
                'settings': ['ç³»ç»Ÿè®¾ç½®', 'é…ç½®ç³»ç»Ÿå‚æ•°']
            };
            const title = titles[page] ? titles[page][0] : page;
            const desc = titles[page] ? titles[page][1] : '';
            document.getElementById('pageTitle').textContent = title;
            document.getElementById('pageDesc').textContent = desc;

            // åŠ è½½é¡µé¢æ•°æ®
            if (page === 'records') loadAllRecords();
            if (page === 'visualization') loadVisualization();
            if (page === 'backup') loadBackups();
            if (page === 'users') loadUsers();
            if (page === 'totp') loadTOTPStatus();
            if (page === 'sessions') loadSessions();
            if (page === 'history') loadHistory();
            if (page === 'logs') {
                loadLoginLogs();
                loadAuditLogs();
            }
            if (page === 'review') loadReviewStats();
        }
    </script>
</body>
</html>
```

### 2.7 åå°å¯è§†åŒ–ä¸å¯¼å…¥é€»è¾‘ (frontend/admin/index.html)

```javascript
function initVisualizationCharts() {
    if (!scatterChart) {
        scatterChart = echarts.init(document.getElementById('scatterChart'));
    }
    if (!visualizationReady) {
        window.addEventListener('resize', () => {
            if (scatterChart) scatterChart.resize();
        });
        visualizationReady = true;
    }
}

async function loadVisualization() {
    if (!window.echarts) {
        showToast('å¯è§†åŒ–ç»„ä»¶æœªåŠ è½½', 'error');
        return;
    }

    initVisualizationCharts();

    try {
        const scatterRes = await fetch(`${API_BASE}/chart/scatter-distribution`);
        const scatterData = await scatterRes.json();
        renderScatter(scatterData);
    } catch (error) {
        console.error('å¯è§†åŒ–åŠ è½½å¤±è´¥:', error);
        showToast('å¯è§†åŒ–åŠ è½½å¤±è´¥', 'error');
    }
}

function renderScatter(payload) {
    const hasData = payload.data && payload.data.length > 0;
    const pressureMin = hasData ? payload.pressure_min : 0;
    const pressureMax = hasData ? payload.pressure_max : 1;

    scatterChart.setOption({
        backgroundColor: 'transparent',
        tooltip: {
            trigger: 'item',
            formatter: (params) => {
                const point = (params.data && params.data.value) ? params.data.value : (params.data || []);
                const temp = point[0] !== null && point[0] !== undefined ? point[0] : 0;
                const pressure = point[1] !== null && point[1] !== undefined ? point[1] : 0;
                return `æ¸©åº¦ ${temp.toFixed(2)} K<br>å‹åŠ› ${pressure.toFixed(4)} MPa`;
            }
        },
        grid: { left: 60, right: 70, top: 20, bottom: 50 },
        xAxis: {
            name: 'æ¸©åº¦ (K)',
            nameTextStyle: { color: '#a0aec0' },
            axisLabel: { color: '#a0aec0' },
            axisLine: { lineStyle: { color: '#2d3748' } },
            splitLine: { lineStyle: { color: '#1f2937' } }
        },
        yAxis: {
            name: 'å‹åŠ› (MPa)',
            nameTextStyle: { color: '#a0aec0' },
            axisLabel: { color: '#a0aec0' },
            axisLine: { lineStyle: { color: '#2d3748' } },
            splitLine: { lineStyle: { color: '#1f2937' } }
        },
        visualMap: {
            min: pressureMin,
            max: pressureMax,
            dimension: 2,
            right: 10,
            top: 'middle',
            calculable: true,
            textStyle: { color: '#a0aec0' },
            inRange: {
                color: ['#4299e1', '#48bb78', '#f6ad55', '#f56565']
            }
        },
        series: [{
            type: 'scatter',
            data: payload.data || [],
            symbolSize: 8,
            itemStyle: { opacity: 0.8 }
        }]
    }, true);

    scatterChart.off('click');
    scatterChart.on('click', (params) => {
        const recordId = params.data ? params.data.id : null;
        if (!recordId) return;
        pendingRecordId = recordId;
        currentPage = 1;
        showPage('records');
        showToast(`å·²å®šä½è®°å½• #${recordId}`);
    });
}

// åŠ è½½æ‰€æœ‰è®°å½•
async function loadAllRecords() {
    try {
        const res = await fetch(`${API_BASE}/records?page=${currentPage}&per_page=${perPage}`);
        const data = await res.json();

        const tbody = document.getElementById('allRecords');
        if (currentPage === 1) tbody.innerHTML = '';

        tbody.innerHTML += data.records.map(r => renderRecordRow(r)).join('');
        await highlightPendingRecord(data.records);

        // éšè—/æ˜¾ç¤ºåŠ è½½æ›´å¤šæŒ‰é’®
        document.getElementById('loadMoreBtn').style.display = 
            currentPage >= data.total_pages ? 'none' : 'inline-block';
    } catch (error) {
        console.error('åŠ è½½è®°å½•å¤±è´¥:', error);
    }
}

function loadMoreRecords() {
    currentPage++;
    loadAllRecords();
}

// å¯¼å‡ºåŠŸèƒ½
async function downloadFile(url, filename) {
    try {
        const res = await fetch(url, { headers: getAuthHeaderOnly() });
        if (!res.ok) {
            const err = await res.json().catch(() => ({}));
            showToast(err.detail || 'ä¸‹è½½å¤±è´¥', 'error');
            return;
        }
        const blob = await res.blob();
        const link = document.createElement('a');
        link.href = window.URL.createObjectURL(blob);
        link.download = filename;
        document.body.appendChild(link);
        link.click();
        link.remove();
        window.URL.revokeObjectURL(link.href);
        showToast(`å¼€å§‹ä¸‹è½½ ${filename}`);
    } catch (error) {
        showToast('ä¸‹è½½å¤±è´¥: ' + error.message, 'error');
    }
}

function exportCSV() {
    downloadFile(`${API_BASE}/export/csv`, 'gas_data_export.csv');
    addLog('ğŸ“¥', 'å¯¼å‡ºæ•°æ®', 'å¯¼å‡º CSV æ ¼å¼æ•°æ®', 'export');
}

function exportExcel() {
    downloadFile(`${API_BASE}/export/excel`, 'gas_data_export.xlsx');
    addLog('ğŸ“¥', 'å¯¼å‡ºæ•°æ®', 'å¯¼å‡º Excel æ ¼å¼æ•°æ®', 'export');
}

// å¯¼å…¥åŠŸèƒ½
async function handleImport(event) {
    const file = event.target.files[0];
    if (!file) return;

    const formData = new FormData();
    formData.append('file', file);

    try {
        const res = await fetch(`${API_BASE}/import`, {
            method: 'POST',
            headers: getAuthHeaderOnly(),
            body: formData
        });
        const result = await res.json();

        if (result.success) {
            showToast(result.message);
            addLog('ğŸ“¤', 'å¯¼å…¥æ•°æ®', `æˆåŠŸå¯¼å…¥æ•°æ®: ${file.name}`, 'create');
            loadDashboardData();
        } else {
            const detail = result.detail || {};
            if (detail && detail.errors) {
                const summary = detail.summary || {};
                showToast(
                    `å¯¼å…¥æ ¡éªŒå¤±è´¥ï¼š${summary.invalid_count || detail.errors.length} æ¡æ•°æ®ä¸åˆæ³•`,
                    'error'
                );
                renderImportPreview({
                    summary: {
                        total: summary.total || 0,
                        valid_count: summary.valid_count || 0,
                        invalid_count: summary.invalid_count || detail.errors.length,
                        warning_count: 0,
                        skipped_count: summary.skipped_count || 0
                    },
                    errors: detail.errors || [],
                    warnings: []
                });
            } else {
                showToast(result.detail || 'å¯¼å…¥å¤±è´¥', 'error');
            }
        }
    } catch (error) {
        showToast('å¯¼å…¥å¤±è´¥: ' + error.message, 'error');
    }

    event.target.value = '';
}
```

### 2.8 åå°å¤‡ä»½/ç”¨æˆ·/ä¸¤æ­¥éªŒè¯è„šæœ¬ (frontend/admin/index.html)

```javascript
async function handleImportPreview(event) {
    const file = event.target.files[0];
    if (!file) return;

    const formData = new FormData();
    formData.append('file', file);

    try {
        const res = await fetch(`${API_BASE}/import/preview`, {
            method: 'POST',
            headers: getAuthHeaderOnly(),
            body: formData
        });
        const result = await res.json();

        if (result.success) {
            renderImportPreview(result.data);
            showToast('æ ¡éªŒé¢„è§ˆå·²ç”Ÿæˆ');
        } else {
            showToast(result.detail || 'é¢„è§ˆå¤±è´¥', 'error');
            renderImportPreview(null);
        }
    } catch (error) {
        showToast('é¢„è§ˆå¤±è´¥: ' + error.message, 'error');
        renderImportPreview(null);
    }

    event.target.value = '';
}

function buildCsvLine(values) {
    return values.map(value => {
        const text = value === null || value === undefined ? '' : String(value);
        const escaped = text.replace(/"/g, '""');
        return `"${escaped}"`;
    }).join(',');
}

function downloadCsvContent(rows, filename) {
    const csv = rows.join('\n');
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = filename;
    document.body.appendChild(link);
    link.click();
    link.remove();
    URL.revokeObjectURL(link.href);
}

function downloadImportReport(kind) {
    if (!lastImportPreview) {
        showToast('æš‚æ— å¯ä¸‹è½½çš„æ ¡éªŒç»“æœ', 'error');
        return;
    }
    const rows = [];
    if (kind === 'errors') {
        const errors = lastImportPreview.errors || [];
        if (errors.length === 0) {
            showToast('æ²¡æœ‰é”™è¯¯è®°å½•', 'error');
            return;
        }
        rows.push(buildCsvLine(['row', 'errors']));
        errors.forEach(item => {
            rows.push(buildCsvLine([item.row, (item.errors || []).join('ï¼›')]));
        });
        downloadCsvContent(rows, 'import_errors.csv');
    } else if (kind === 'warnings') {
        const warnings = lastImportPreview.warnings || [];
        if (warnings.length === 0) {
            showToast('æ²¡æœ‰è½¯æç¤ºè®°å½•', 'error');
            return;
        }
        rows.push(buildCsvLine(['row', 'warnings']));
        warnings.forEach(item => {
            rows.push(buildCsvLine([item.row, (item.warnings || []).join('ï¼›')]));
        });
        downloadCsvContent(rows, 'import_warnings.csv');
    }
}

// ==================== å¤‡ä»½åŠŸèƒ½ ====================
async function loadBackups() {
    try {
        // è·å–å¤‡ä»½çŠ¶æ€
        const statusRes = await fetch(`${API_BASE}/backup/status`, {
            headers: getAuthHeaders()
        });
        if (statusRes.ok) {
            const statusData = await statusRes.json();
            const status = statusData.data;
            document.getElementById('backupCount').textContent = status.backup_count || 0;
            document.getElementById('backupTotalSize').textContent = status.total_size || '0 KB';
            document.getElementById('backupInterval').textContent = status.backup_interval_hours
                ? `${status.backup_interval_hours}h`
                : '-';

            const statusBox = document.getElementById('backupStatus');
            const createBtn = document.getElementById('backupCreateButton');
            if (status.backup_interval_hours === 0) {
                if (statusBox) {
                    statusBox.innerHTML = `
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <span style="color: var(--warning); font-size: 20px;">â—</span>
                            <span>å½“å‰ä¸ºæ‰˜ç®¡æ•°æ®åº“ï¼Œå¤‡ä»½è¯·åœ¨äº‘æ§åˆ¶å°å®Œæˆ</span>
                        </div>
                    `;
                }
                if (createBtn) createBtn.disabled = true;
            } else {
                if (statusBox) {
                    statusBox.innerHTML = `
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <span style="color: var(--success); font-size: 20px;">â—</span>
                            <span>è‡ªåŠ¨å¤‡ä»½å·²å¯ç”¨</span>
                        </div>
                    `;
                }
                if (createBtn) createBtn.disabled = false;
            }
        }

        // è·å–å¤‡ä»½åˆ—è¡¨
        const listRes = await fetch(`${API_BASE}/backup/list`, {
            headers: getAuthHeaders()
        });
        if (listRes.ok) {
            const listData = await listRes.json();
            const backups = listData.data || [];
            const tbody = document.getElementById('backupList');
            
            if (backups.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: var(--text-dim);">æš‚æ— å¤‡ä»½æ–‡ä»¶</td></tr>';
            } else {
                tbody.innerHTML = backups.map(b => `
                    <tr>
                        <td>${b.filename}</td>
                        <td><span style="background: ${b.type === 'manual' ? 'var(--accent)' : 'var(--success)'}; padding: 2px 8px; border-radius: 4px; font-size: 12px;">${b.type === 'manual' ? 'æ‰‹åŠ¨' : 'è‡ªåŠ¨'}</span></td>
                        <td>${b.size_formatted}</td>
                        <td>${new Date(b.created_at).toLocaleString()}</td>
                        <td>
                            <button class="btn btn-secondary" style="padding: 6px 12px; font-size: 12px;" onclick="downloadBackup('${b.filename}')">ä¸‹è½½</button>
                            <button class="btn btn-secondary" style="padding: 6px 12px; font-size: 12px;" onclick="restoreBackup('${b.filename}')">æ¢å¤</button>
                            <button class="btn btn-danger" style="padding: 6px 12px; font-size: 12px;" onclick="deleteBackupFile('${b.filename}')">åˆ é™¤</button>
                        </td>
                    </tr>
                `).join('');
            }
        }
    } catch (error) {
        console.error('åŠ è½½å¤‡ä»½åˆ—è¡¨å¤±è´¥:', error);
    }
}

async function createBackup() {
    try {
        const res = await fetch(`${API_BASE}/backup/create`, {
            method: 'POST',
            headers: getAuthHeaders()
        });
        const data = await res.json();
        if (data.success) {
            showToast('å¤‡ä»½åˆ›å»ºæˆåŠŸ');
            addLog('ğŸ’¾', 'åˆ›å»ºå¤‡ä»½', 'æ‰‹åŠ¨åˆ›å»ºæ•°æ®åº“å¤‡ä»½', 'create');
            loadBackups();
        } else {
            showToast(data.message || data.detail || 'å¤‡ä»½å¤±è´¥', 'error');
        }
    } catch (error) {
        showToast('å¤‡ä»½å¤±è´¥: ' + error.message, 'error');
    }
}

function downloadBackup(filename) {
    window.location.href = `${API_BASE}/backup/download/${filename}?token=${authToken}`;
    addLog('ğŸ“¥', 'ä¸‹è½½å¤‡ä»½', `ä¸‹è½½å¤‡ä»½æ–‡ä»¶: ${filename}`, 'export');
}

async function restoreBackup(filename) {
    if (!confirm(`ç¡®å®šè¦æ¢å¤å¤‡ä»½ ${filename} å—ï¼Ÿå½“å‰æ•°æ®å°†è¢«è¦†ç›–ï¼`)) return;
    
    try {
        const res = await fetch(`${API_BASE}/backup/restore/${filename}`, {
            method: 'POST',
            headers: getAuthHeaders()
        });
        const data = await res.json();
        if (data.success) {
            showToast('å¤‡ä»½æ¢å¤æˆåŠŸ');
            addLog('ğŸ”„', 'æ¢å¤å¤‡ä»½', `æ¢å¤å¤‡ä»½: ${filename}`, 'update');
            loadDashboardData();
        } else {
            showToast(data.message || data.detail || 'æ¢å¤å¤±è´¥', 'error');
        }
    } catch (error) {
        showToast('æ¢å¤å¤±è´¥: ' + error.message, 'error');
    }
}

async function deleteBackupFile(filename) {
    if (!confirm(`ç¡®å®šè¦åˆ é™¤å¤‡ä»½ ${filename} å—ï¼Ÿ`)) return;
    
    try {
        const res = await fetch(`${API_BASE}/backup/${filename}`, {
            method: 'DELETE',
            headers: getAuthHeaders()
        });
        const data = await res.json();
        if (data.success) {
            showToast('å¤‡ä»½å·²åˆ é™¤');
            addLog('ğŸ—‘ï¸', 'åˆ é™¤å¤‡ä»½', `åˆ é™¤å¤‡ä»½: ${filename}`, 'delete');
            loadBackups();
        } else {
            showToast(data.message || data.detail || 'åˆ é™¤å¤±è´¥', 'error');
        }
    } catch (error) {
        showToast('åˆ é™¤å¤±è´¥: ' + error.message, 'error');
    }
}

// ==================== ç”¨æˆ·ç®¡ç† ====================
async function loadUsers() {
    try {
        const res = await fetch(`${API_BASE}/auth/users`, {
            headers: getAuthHeaders()
        });
        if (res.ok) {
            const data = await res.json();
            const users = data.data || [];
            const tbody = document.getElementById('userList');
            tbody.innerHTML = users.map(u => `
                <tr>
                    <td>${u.username}</td>
                    <td><span style="background: ${u.role === 'admin' ? 'var(--accent)' : 'var(--text-dim)'}; padding: 4px 12px; border-radius: 20px; font-size: 12px;">${u.role === 'admin' ? 'ç®¡ç†å‘˜' : 'ç”¨æˆ·'}</span></td>
                    <td>${u.created_at || '-'}</td>
                    <td><span style="color: var(--success);">â— æ´»è·ƒ</span></td>
                    <td>
                        <button class="btn btn-secondary" onclick="resetUserPassword('${u.username}')" style="padding: 4px 10px;">é‡ç½®å¯†ç </button>
                        <button class="btn btn-danger" onclick="revokeUserSessions('${u.username}')" style="padding: 4px 10px;">æ’¤é”€ä¼šè¯</button>
                    </td>
                </tr>
            `).join('');
        }
    } catch (error) {
        console.error('åŠ è½½ç”¨æˆ·åˆ—è¡¨å¤±è´¥:', error);
    }
}

async function changePassword() {
    const oldPwd = document.getElementById('oldPassword').value;
    const newPwd = document.getElementById('newPassword').value;
    const confirmPwd = document.getElementById('confirmPassword').value;

    if (!oldPwd || !newPwd || !confirmPwd) {
        showToast('è¯·å¡«å†™æ‰€æœ‰å¯†ç å­—æ®µ', 'error');
        return;
    }

    if (newPwd !== confirmPwd) {
        showToast('ä¸¤æ¬¡è¾“å…¥çš„æ–°å¯†ç ä¸ä¸€è‡´', 'error');
        return;
    }

    try {
        const res = await fetch(`${API_BASE}/auth/change-password`, {
            method: 'POST',
            headers: getAuthHeaders(),
            body: JSON.stringify({
                old_password: oldPwd,
                new_password: newPwd
            })
        });
        const data = await res.json();
        if (data.success) {
            showToast('å¯†ç ä¿®æ”¹æˆåŠŸï¼Œè¯·é‡æ–°ç™»å½•');
            addLog('ğŸ”‘', 'ä¿®æ”¹å¯†ç ', 'ç®¡ç†å‘˜ä¿®æ”¹äº†å¯†ç ', 'update');
            document.getElementById('oldPassword').value = '';
            document.getElementById('newPassword').value = '';
            document.getElementById('confirmPassword').value = '';
        } else {
            showToast(data.detail || 'å¯†ç ä¿®æ”¹å¤±è´¥', 'error');
        }
    } catch (error) {
        showToast('ä¿®æ”¹å¤±è´¥: ' + error.message, 'error');
    }
}

// ==================== TOTP ä¸¤æ­¥éªŒè¯ ====================
let totpSecret = '';

async function loadTOTPStatus() {
    try {
        const res = await fetch(`${API_BASE}/auth/totp/status`, {
            headers: getAuthHeaders()
        });
        if (res.ok) {
            const data = await res.json();
            const status = data.data;
            
            if (status.enabled) {
                document.getElementById('totpEnabled').style.display = 'block';
                document.getElementById('totpNotEnabled').style.display = 'none';
            } else {
                document.getElementById('totpEnabled').style.display = 'none';
                document.getElementById('totpNotEnabled').style.display = 'block';
            }
            document.getElementById('totpSetup').style.display = 'none';
        }
    } catch (error) {
        console.error('åŠ è½½TOTPçŠ¶æ€å¤±è´¥:', error);
    }
}

async function setupTOTP() {
    try {
        const res = await fetch(`${API_BASE}/auth/totp/setup`, {
            method: 'POST',
            headers: getAuthHeaders()
        });
        if (res.ok) {
            const data = await res.json();
            totpSecret = data.data.secret;
            document.getElementById('totpSecret').textContent = totpSecret;
            document.getElementById('totpSetup').style.display = 'block';
            document.getElementById('totpNotEnabled').style.display = 'none';
        }
    } catch (error) {
        showToast('è®¾ç½®å¤±è´¥: ' + error.message, 'error');
    }
}

async function enableTOTP() {
    const code = document.getElementById('totpCode').value;
    if (!code || code.length !== 6) {
        showToast('è¯·è¾“å…¥6ä½éªŒè¯ç ', 'error');
        return;
    }

    try {
        const res = await fetch(`${API_BASE}/auth/totp/enable`, {
            method: 'POST',
            headers: getAuthHeaders(),
            body: JSON.stringify({ code })
        });
        const data = await res.json();
        if (data.success) {
            showToast('ä¸¤æ­¥éªŒè¯å·²å¯ç”¨');
            loadTOTPStatus();
        } else {
            showToast(data.detail || 'éªŒè¯ç é”™è¯¯', 'error');
        }
    } catch (error) {
        showToast('å¯ç”¨å¤±è´¥: ' + error.message, 'error');
    }
}
```

---

## ä¸‰ã€æ•°æ®å®¡æ ¸æ¨¡å—

### 3.1 æ¨¡å—ç®€ä»‹

æ•°æ®å®¡æ ¸æ¨¡å—ç”¨äºå¤„ç†åŒç»„åˆ†åŒæ¸©åº¦ä¸‹å­˜åœ¨å¤šä¸ªä¸åŒå‹åŠ›å€¼çš„é‡å¤æ•°æ®ã€‚ç³»ç»Ÿè‡ªåŠ¨æ£€æµ‹è¿™ç±»æ•°æ®å¹¶ç§»å…¥å¾…å®¡æ ¸åŒºï¼Œç®¡ç†å‘˜å¯ä»¥é€‰æ‹©ä¿ç•™æ­£ç¡®çš„æ•°æ®ã€æ‹’ç»æ•´ç»„æ•°æ®æˆ–æ¢å¤åˆ°å¾…å®¡æ ¸çŠ¶æ€ã€‚æ”¯æŒæ‰¹é‡å®¡æ ¸æ“ä½œï¼Œæé«˜æ•°æ®è´¨é‡ç®¡ç†æ•ˆç‡ã€‚

### 3.2 æ•°æ®å®¡æ ¸ä»£ç  (backend/data_review.py)

```python
"""
æ•°æ®å®¡æ ¸æ¨¡å— - å¤„ç†åŒç»„åˆ†åŒæ¸©åº¦ä¸‹å¤šå‹åŠ›å€¼çš„æ•°æ®
"""

from typing import List, Dict, Any

from backend.db import get_connection, is_mysql


def init_review_tables():
    """åˆå§‹åŒ–å®¡æ ¸ç›¸å…³çš„æ•°æ®è¡¨"""
    id_column = "BIGINT PRIMARY KEY AUTO_INCREMENT" if is_mysql() else "INTEGER PRIMARY KEY AUTOINCREMENT"
    group_id_type = "VARCHAR(32)" if is_mysql() else "TEXT"
    status_type = "VARCHAR(20)" if is_mysql() else "TEXT"
    
    with get_connection(dict_cursor=True) as conn:
        cursor = conn.cursor()
        
        # å¾…å®¡æ ¸æ•°æ®è¡¨
        cursor.execute(f'''
            CREATE TABLE IF NOT EXISTS pending_review (
                id {id_column},
                group_id {group_id_type} NOT NULL,
                original_id INTEGER,
                temperature REAL NOT NULL,
                x_ch4 REAL DEFAULT 0,
                x_c2h6 REAL DEFAULT 0,
                x_c3h8 REAL DEFAULT 0,
                x_co2 REAL DEFAULT 0,
                x_n2 REAL DEFAULT 0,
                x_h2s REAL DEFAULT 0,
                x_ic4h10 REAL DEFAULT 0,
                pressure REAL NOT NULL,
                status {status_type} DEFAULT 'pending',
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                reviewed_at TIMESTAMP,
                reviewed_by TEXT,
                approved_record_id INTEGER
            )
        ''')
        conn.commit()


def find_duplicate_pressure_records() -> List[Dict]:
    """
    æŸ¥æ‰¾åŒç»„åˆ†ã€åŒæ¸©åº¦ä¸‹æœ‰å¤šä¸ªä¸åŒå‹åŠ›å€¼çš„è®°å½•
    è¿”å›æŒ‰ç»„åˆ†+æ¸©åº¦åˆ†ç»„çš„æ•°æ®
    """
    with get_connection(dict_cursor=True) as conn:
        cursor = conn.cursor()
        
        cursor.execute('''
            SELECT 
                x_ch4, x_c2h6, x_c3h8, x_co2, x_n2, x_h2s, x_ic4h10,
                temperature,
                COUNT(*) as count,
                GROUP_CONCAT(id) as ids,
                GROUP_CONCAT(pressure) as pressures
            FROM gas_mixture
            GROUP BY x_ch4, x_c2h6, x_c3h8, x_co2, x_n2, x_h2s, x_ic4h10, temperature
            HAVING COUNT(*) > 1
            ORDER BY count DESC
        ''')
        
        results = []
        for row in cursor.fetchall():
            results.append({
                'composition': {
                    'x_ch4': row['x_ch4'],
                    'x_c2h6': row['x_c2h6'],
                    'x_c3h8': row['x_c3h8'],
                    'x_co2': row['x_co2'],
                    'x_n2': row['x_n2'],
                    'x_h2s': row['x_h2s'],
                    'x_ic4h10': row['x_ic4h10']
                },
                'temperature': row['temperature'],
                'count': row['count'],
                'ids': [int(x) for x in row['ids'].split(',')],
                'pressures': [float(x) for x in row['pressures'].split(',')]
            })
        
        return results


def move_duplicates_to_review() -> Dict:
    """å°†æ‰€æœ‰åŒç»„åˆ†åŒæ¸©åº¦çš„é‡å¤å‹åŠ›æ•°æ®ç§»åˆ°å¾…å®¡æ ¸è¡¨"""
    duplicates = find_duplicate_pressure_records()
    
    if not duplicates:
        return {'moved': 0, 'groups': 0}
    
    moved_count = 0
    group_count = 0
    
    with get_connection(dict_cursor=True) as conn:
        cursor = conn.cursor()
        group_number = _get_next_group_number(cursor)

        for dup in duplicates:
            group_id = f"G{group_number:04d}"
            ids_str = ','.join(str(x) for x in dup['ids'])
            cursor.execute(f'SELECT * FROM gas_mixture WHERE id IN ({ids_str})')
            
            records = cursor.fetchall()
            
            for record in records:
                cursor.execute('''
                    INSERT INTO pending_review 
                    (group_id, original_id, temperature, x_ch4, x_c2h6, x_c3h8, 
                     x_co2, x_n2, x_h2s, x_ic4h10, pressure)
                    VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
                ''', (
                    group_id,
                    record['id'],
                    record['temperature'],
                    record['x_ch4'],
                    record['x_c2h6'],
                    record['x_c3h8'],
                    record['x_co2'],
                    record['x_n2'],
                    record['x_h2s'],
                    record['x_ic4h10'],
                    record['pressure']
                ))
                moved_count += 1
            
            cursor.execute(f'DELETE FROM gas_mixture WHERE id IN ({ids_str})')
            group_count += 1
            group_number += 1
        
        conn.commit()
    
    return {'moved': moved_count, 'groups': group_count}


def _get_next_group_number(cursor) -> int:
    cursor.execute('SELECT group_id FROM pending_review')
    max_num = 0
    for row in cursor.fetchall():
        group_id = row['group_id']
        if isinstance(group_id, str) and group_id.startswith('G'):
            suffix = group_id[1:]
            if suffix.isdigit():
                max_num = max(max_num, int(suffix))
    return max_num + 1


def get_pending_groups(page: int = 1, per_page: int = 50, **filters) -> Dict:
    """è·å–å¾…å®¡æ ¸çš„æ•°æ®ç»„ï¼ˆåˆ†é¡µï¼‰"""
    with get_connection(dict_cursor=True) as conn:
        cursor = conn.cursor()
        offset = (page - 1) * per_page

        cursor.execute('''
            SELECT COUNT(DISTINCT group_id) as total
            FROM pending_review WHERE status = 'pending'
        ''')
        total = cursor.fetchone()['total']

        cursor.execute(f'''
            SELECT group_id, temperature,
                x_ch4, x_c2h6, x_c3h8, x_co2, x_n2, x_h2s, x_ic4h10,
                COUNT(*) as pressure_count
            FROM pending_review
            WHERE status = 'pending'
            GROUP BY group_id, temperature, x_ch4, x_c2h6, x_c3h8, x_co2, x_n2, x_h2s, x_ic4h10
            ORDER BY group_id
            LIMIT ? OFFSET ?
        ''', (per_page, offset))
        
        groups = []
        for row in cursor.fetchall():
            group_id = row['group_id']
            cursor.execute('''
                SELECT id, pressure, original_id FROM pending_review 
                WHERE group_id = ? AND status = 'pending'
                ORDER BY pressure
            ''', (group_id,))
            
            pressures = [{'id': r['id'], 'pressure': r['pressure']} 
                        for r in cursor.fetchall()]
            
            groups.append({
                'group_id': group_id,
                'temperature': row['temperature'],
                'composition': {
                    'x_ch4': row['x_ch4'],
                    'x_c2h6': row['x_c2h6'],
                    'x_c3h8': row['x_c3h8'],
                    'x_co2': row['x_co2'],
                    'x_n2': row['x_n2'],
                    'x_h2s': row['x_h2s'],
                    'x_ic4h10': row['x_ic4h10']
                },
                'pressures': pressures,
                'pressure_count': row['pressure_count']
            })

        return {
            'groups': groups,
            'total': total,
            'page': page,
            'per_page': per_page,
            'total_pages': (total + per_page - 1) // per_page if total > 0 else 1
        }


def approve_group(group_id: str, selected_pressures: List[int], username: str = None) -> Dict:
    """
    å®¡æ ¸é€šè¿‡ä¸€ç»„æ•°æ®
    selected_pressures: é€‰æ‹©ä¿ç•™çš„å‹åŠ›è®°å½•IDåˆ—è¡¨
    """
    with get_connection(dict_cursor=True) as conn:
        cursor = conn.cursor()
        
        ids_str = ','.join(str(x) for x in selected_pressures)
        cursor.execute(f'''
            SELECT * FROM pending_review WHERE id IN ({ids_str}) AND group_id = ?
        ''', (group_id,))

        records = cursor.fetchall()
        approved_count = 0
        
        for record in records:
            cursor.execute('''
                INSERT INTO gas_mixture 
                (temperature, x_ch4, x_c2h6, x_c3h8, x_co2, x_n2, x_h2s, x_ic4h10, pressure)
                VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)
            ''', (
                record['temperature'],
                record['x_ch4'],
                record['x_c2h6'],
                record['x_c3h8'],
                record['x_co2'],
                record['x_n2'],
                record['x_h2s'],
                record['x_ic4h10'],
                record['pressure']
            ))
            approved_id = cursor.lastrowid
            cursor.execute('''
                UPDATE pending_review
                SET status = 'approved', reviewed_at = CURRENT_TIMESTAMP, 
                    reviewed_by = ?, approved_record_id = ?
                WHERE id = ?
            ''', (username, approved_id, record['id']))
            approved_count += 1
        
        # å…¶ä½™è®°å½•æ ‡è®°ä¸ºå·²æ‹’ç»
        cursor.execute('''
            UPDATE pending_review 
            SET status = 'rejected', reviewed_at = CURRENT_TIMESTAMP, reviewed_by = ?
            WHERE group_id = ? AND status = 'pending'
        ''', (username, group_id))
        
        conn.commit()
        
        return {'approved': approved_count, 'group_id': group_id}


def reject_group(group_id: str, username: str = None) -> bool:
    """æ‹’ç»æ•´ç»„æ•°æ®"""
    with get_connection(dict_cursor=True) as conn:
        cursor = conn.cursor()
        cursor.execute('''
            UPDATE pending_review 
            SET status = 'rejected', reviewed_at = CURRENT_TIMESTAMP, reviewed_by = ?
            WHERE group_id = ? AND status = 'pending'
        ''', (username, group_id))
        conn.commit()
        return cursor.rowcount > 0


def restore_group(group_id: str) -> Dict:
    """æ¢å¤ä¸€ç»„æ•°æ®åˆ°å¾…å®¡æ ¸çŠ¶æ€"""
    with get_connection(dict_cursor=True) as conn:
        cursor = conn.cursor()
        
        cursor.execute('''
            SELECT approved_record_id FROM pending_review 
            WHERE group_id = ? AND status = 'approved' AND approved_record_id IS NOT NULL
        ''', (group_id,))
        approved_ids = [row['approved_record_id'] for row in cursor.fetchall()]
        if approved_ids:
            placeholders = ','.join('?' * len(approved_ids))
            cursor.execute(f'DELETE FROM gas_mixture WHERE id IN ({placeholders})', approved_ids)
        
        cursor.execute('''
            UPDATE pending_review 
            SET status = 'pending', reviewed_at = NULL, reviewed_by = NULL, approved_record_id = NULL
            WHERE group_id = ?
        ''', (group_id,))
        
        conn.commit()
        return {'restored': cursor.rowcount}


# åˆå§‹åŒ–
init_review_tables()
```

---

## å››ã€å®‰å…¨åŠŸèƒ½

### 4.1 æ¨¡å—ç®€ä»‹

å®‰å…¨æ¨¡å—æä¾›å…¨é¢çš„ç³»ç»Ÿå®‰å…¨ä¿æŠ¤ï¼ŒåŒ…æ‹¬ï¼šAPI é™æµé˜²æ­¢æš´åŠ›è¯·æ±‚ã€é˜²çˆ¬è™«æ£€æµ‹é˜»æ­¢æ¶æ„é‡‡é›†ã€ç™»å½•å¤±è´¥é”å®šé˜²æ­¢å¯†ç çˆ†ç ´ã€ä¼šè¯ç®¡ç†æ”¯æŒå¤šè®¾å¤‡ç™»å½•æ§åˆ¶ã€å¯†ç ç­–ç•¥å¼ºåˆ¶å¯†ç å¤æ‚åº¦ã€å®¡è®¡æ—¥å¿—è®°å½•æ•æ„Ÿæ“ä½œã€‚æ”¯æŒ Redis åˆ†å¸ƒå¼ç¼“å­˜å®ç°é«˜å¯ç”¨é™æµã€‚

### 4.2 å®‰å…¨æ¨¡å—ä»£ç  (backend/security.py)

```python
"""
å®‰å…¨æ¨¡å— - APIé™æµã€é˜²çˆ¬è™«ã€ç™»å½•æ—¥å¿—ã€ä¼šè¯ç®¡ç†ã€å¯†ç ç­–ç•¥
"""

import time
import hashlib
import hmac
import base64
import re
import os
import uuid
from datetime import datetime, timedelta
from typing import Optional, Dict, List, Tuple
from collections import defaultdict
import threading

try:
    import redis
except ImportError:
    redis = None

from backend.db import get_security_connection, is_security_mysql, open_security_connection

# ==================== é…ç½® ====================

# API é™æµé…ç½®
RATE_LIMIT_WINDOW = 60  # æ—¶é—´çª—å£ï¼ˆç§’ï¼‰
RATE_LIMIT_MAX_REQUESTS = 60  # æ¯ä¸ªçª—å£æœ€å¤§è¯·æ±‚æ•°
RATE_LIMIT_BLOCK_DURATION = 300  # å°ç¦æ—¶é•¿ï¼ˆç§’ï¼‰

# ç™»å½•é™åˆ¶
LOGIN_MAX_ATTEMPTS = 5  # æœ€å¤§ç™»å½•å°è¯•æ¬¡æ•°
LOGIN_BLOCK_DURATION = 900  # ç™»å½•å°ç¦æ—¶é•¿ï¼ˆç§’ï¼‰15åˆ†é’Ÿ

# å¯†ç ç­–ç•¥
PASSWORD_MIN_LENGTH = 8
PASSWORD_REQUIRE_UPPERCASE = True
PASSWORD_REQUIRE_LOWERCASE = True
PASSWORD_REQUIRE_DIGIT = True
PASSWORD_REQUIRE_SPECIAL = False

# ä¼šè¯é…ç½®
SESSION_MAX_AGE = 24 * 60 * 60  # 24å°æ—¶
SESSION_MAX_PER_USER = 5  # æ¯ç”¨æˆ·æœ€å¤§ä¼šè¯æ•°

# çˆ¬è™«æ£€æµ‹
CRAWLER_USER_AGENTS = [
    'bot', 'crawler', 'spider', 'scraper', 'curl', 'wget', 'python-requests',
    'scrapy', 'httpclient', 'java', 'axios', 'node-fetch', 'go-http-client'
]

# å†…å­˜å­˜å‚¨
request_counter: Dict[str, List[Tuple[float, int]]] = defaultdict(list)
blocked_ips: Dict[str, float] = {}
login_attempts: Dict[str, List[Tuple[float, bool]]] = defaultdict(list)
active_sessions: Dict[str, Dict] = {}
_lock = threading.Lock()


def init_security_db():
    """åˆå§‹åŒ–å®‰å…¨æ•°æ®åº“"""
    id_column = "BIGINT PRIMARY KEY AUTO_INCREMENT" if is_security_mysql() else "INTEGER PRIMARY KEY AUTOINCREMENT"
    with get_security_connection(dict_cursor=True) as conn:
        cursor = conn.cursor()
    
        # ç™»å½•æ—¥å¿—è¡¨
        cursor.execute(f'''
            CREATE TABLE IF NOT EXISTS login_logs (
                id {id_column},
                username TEXT NOT NULL,
                ip_address TEXT NOT NULL,
                user_agent TEXT,
                success INTEGER NOT NULL,
                failure_reason TEXT,
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
            )
        ''')
    
        # æ“ä½œå®¡è®¡æ—¥å¿—è¡¨
        cursor.execute(f'''
            CREATE TABLE IF NOT EXISTS audit_logs (
                id {id_column},
                username TEXT NOT NULL,
                action TEXT NOT NULL,
                resource TEXT,
                resource_id INTEGER,
                old_value TEXT,
                new_value TEXT,
                ip_address TEXT,
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
            )
        ''')
    
        # ä¼šè¯è¡¨
        cursor.execute(f'''
            CREATE TABLE IF NOT EXISTS sessions (
                id {id_column},
                token_hash TEXT UNIQUE NOT NULL,
                username TEXT NOT NULL,
                ip_address TEXT,
                user_agent TEXT,
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                last_active TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                expires_at TIMESTAMP NOT NULL
            )
        ''')
    
        # å°ç¦IPè¡¨
        cursor.execute(f'''
            CREATE TABLE IF NOT EXISTS blocked_ips (
                id {id_column},
                ip_address TEXT UNIQUE NOT NULL,
                reason TEXT,
                blocked_until TIMESTAMP,
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
            )
        ''')

        # ç”¨æˆ·è´¦æˆ·è¡¨
        cursor.execute(f'''
            CREATE TABLE IF NOT EXISTS user_accounts (
                id {id_column},
                username TEXT UNIQUE NOT NULL,
                password_hash TEXT NOT NULL,
                role TEXT NOT NULL,
                is_active INTEGER DEFAULT 1,
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
            )
        ''')
    
        conn.commit()


# ==================== API é™æµ ====================

def check_rate_limit(ip: str) -> Tuple[bool, str]:
    """
    æ£€æŸ¥APIé™æµ
    è¿”å›: (æ˜¯å¦å…è®¸, é”™è¯¯ä¿¡æ¯)
    """
    current_time = time.time()

    with _lock:
        # æ£€æŸ¥æ˜¯å¦è¢«å°ç¦
        if ip in blocked_ips:
            if current_time < blocked_ips[ip]:
                remaining = int(blocked_ips[ip] - current_time)
                return False, f"IPå·²è¢«ä¸´æ—¶å°ç¦ï¼Œè¯·åœ¨{remaining}ç§’åé‡è¯•"
            else:
                del blocked_ips[ip]

        # æ¸…ç†è¿‡æœŸè®°å½•
        cutoff = current_time - RATE_LIMIT_WINDOW
        request_counter[ip] = [(t, c) for t, c in request_counter[ip] if t > cutoff]

        # è®¡ç®—å½“å‰çª—å£è¯·æ±‚æ•°
        total_requests = sum(c for t, c in request_counter[ip])

        if total_requests >= RATE_LIMIT_MAX_REQUESTS:
            blocked_ips[ip] = current_time + RATE_LIMIT_BLOCK_DURATION
            return False, f"è¯·æ±‚è¿‡äºé¢‘ç¹ï¼Œå·²è¢«ä¸´æ—¶å°ç¦{RATE_LIMIT_BLOCK_DURATION}ç§’"

        # è®°å½•è¯·æ±‚
        request_counter[ip].append((current_time, 1))

    return True, ""


# ==================== é˜²çˆ¬è™« ====================

def detect_crawler(user_agent: str, request_path: str, ip: str) -> Tuple[bool, str]:
    """
    æ£€æµ‹çˆ¬è™«è¡Œä¸º
    è¿”å›: (æ˜¯å¦æ˜¯çˆ¬è™«, åŸå› )
    """
    if not user_agent:
        return True, "ç¼ºå°‘User-Agent"
    
    user_agent_lower = user_agent.lower()
    
    for crawler in CRAWLER_USER_AGENTS:
        if crawler in user_agent_lower:
            return True, f"æ£€æµ‹åˆ°çˆ¬è™«ç‰¹å¾: {crawler}"
    
    return False, ""


def add_crawler_block(ip: str, reason: str, duration: int = 3600):
    """æ·»åŠ çˆ¬è™«å°ç¦"""
    with _lock:
        blocked_ips[ip] = time.time() + duration
    
    try:
        conn = open_security_connection(dict_cursor=True)
        cursor = conn.cursor()
        blocked_until = datetime.now() + timedelta(seconds=duration)
        cursor.execute('''
            INSERT OR REPLACE INTO blocked_ips (ip_address, reason, blocked_until)
            VALUES (?, ?, ?)
        ''', (ip, reason, blocked_until))
        conn.commit()
        conn.close()
    except Exception as e:
        print(f"[Security] è®°å½•å°ç¦å¤±è´¥: {e}")


# ==================== ç™»å½•æ—¥å¿— ====================

def record_login(username: str, ip: str, user_agent: str, success: bool, failure_reason: str = None):
    """è®°å½•ç™»å½•æ—¥å¿—"""
    try:
        conn = open_security_connection(dict_cursor=True)
        cursor = conn.cursor()
        cursor.execute('''
            INSERT INTO login_logs (username, ip_address, user_agent, success, failure_reason)
            VALUES (?, ?, ?, ?, ?)
        ''', (username, ip, user_agent, 1 if success else 0, failure_reason))
        conn.commit()
        conn.close()
    except Exception as e:
        print(f"[Security] è®°å½•ç™»å½•æ—¥å¿—å¤±è´¥: {e}")


def check_login_attempts(ip: str) -> Tuple[bool, str]:
    """æ£€æŸ¥ç™»å½•å°è¯•æ¬¡æ•°"""
    current_time = time.time()

    with _lock:
        cutoff = current_time - LOGIN_BLOCK_DURATION
        login_attempts[ip] = [(t, s) for t, s in login_attempts[ip] if t > cutoff]
        
        failed_count = sum(1 for t, s in login_attempts[ip] if not s)
        
        if failed_count >= LOGIN_MAX_ATTEMPTS:
            oldest_fail = min((t for t, s in login_attempts[ip] if not s), default=current_time)
            remaining = int(LOGIN_BLOCK_DURATION - (current_time - oldest_fail))
            if remaining > 0:
                return False, f"ç™»å½•å°è¯•æ¬¡æ•°è¿‡å¤šï¼Œè¯·åœ¨{remaining}ç§’åé‡è¯•"
    
    return True, ""


def record_login_attempt(ip: str, success: bool):
    """è®°å½•ç™»å½•å°è¯•"""
    with _lock:
        login_attempts[ip].append((time.time(), success))


# ==================== ä¼šè¯ç®¡ç† ====================

def create_session(token: str, username: str, ip: str, user_agent: str) -> bool:
    """åˆ›å»ºä¼šè¯"""
    token_hash = hashlib.sha256(token.encode()).hexdigest()
    expires_at = datetime.now() + timedelta(seconds=SESSION_MAX_AGE)
    
    try:
        conn = open_security_connection(dict_cursor=True)
        cursor = conn.cursor()
        
        cursor.execute('SELECT COUNT(*) as count FROM sessions WHERE username = ?', (username,))
        count = cursor.fetchone()['count']
        
        if count >= SESSION_MAX_PER_USER:
            cursor.execute('''
                DELETE FROM sessions WHERE id IN (
                    SELECT id FROM (
                        SELECT id FROM sessions WHERE username = ?
                        ORDER BY last_active ASC LIMIT ?
                    ) AS old_sessions
                )
            ''', (username, count - SESSION_MAX_PER_USER + 1))
        
        cursor.execute('''
            INSERT INTO sessions (token_hash, username, ip_address, user_agent, expires_at)
            VALUES (?, ?, ?, ?, ?)
        ''', (token_hash, username, ip, user_agent, expires_at.isoformat()))
        
        conn.commit()
        conn.close()
        
        with _lock:
            active_sessions[token_hash] = {
                'username': username,
                'ip': ip,
                'created_at': datetime.now().isoformat(),
                'expires_at': expires_at.isoformat()
            }
        
        return True
    except Exception as e:
        print(f"[Security] åˆ›å»ºä¼šè¯å¤±è´¥: {e}")
        return False


def validate_session(token: str) -> Optional[Dict]:
    """éªŒè¯ä¼šè¯"""
    token_hash = hashlib.sha256(token.encode()).hexdigest()

    with _lock:
        if token_hash in active_sessions:
            session = active_sessions[token_hash]
            if datetime.fromisoformat(session['expires_at']) > datetime.now():
                return session
            else:
                del active_sessions[token_hash]
    
    try:
        conn = open_security_connection(dict_cursor=True)
        cursor = conn.cursor()
        cursor.execute('''
            SELECT username, ip_address, created_at, expires_at
            FROM sessions WHERE token_hash = ? AND expires_at > CURRENT_TIMESTAMP
        ''', (token_hash,))
        row = cursor.fetchone()
        
        if row:
            cursor.execute('''
                UPDATE sessions SET last_active = CURRENT_TIMESTAMP WHERE token_hash = ?
            ''', (token_hash,))
            conn.commit()
            conn.close()
            
            session = {
                'username': row['username'],
                'ip': row['ip_address'],
                'created_at': row['created_at'],
                'expires_at': row['expires_at']
            }
            
            with _lock:
                active_sessions[token_hash] = session
            
            return session
        
        conn.close()
    except Exception as e:
        print(f"[Security] éªŒè¯ä¼šè¯å¤±è´¥: {e}")
    
    return None


def revoke_session(token: str) -> bool:
    """æ’¤é”€ä¼šè¯"""
    token_hash = hashlib.sha256(token.encode()).hexdigest()
    with _lock:
        if token_hash in active_sessions:
            del active_sessions[token_hash]
    
    try:
        conn = open_security_connection(dict_cursor=True)
        cursor = conn.cursor()
        cursor.execute('DELETE FROM sessions WHERE token_hash = ?', (token_hash,))
        conn.commit()
        conn.close()
        return True
    except Exception as e:
        print(f"[Security] æ’¤é”€ä¼šè¯å¤±è´¥: {e}")
        return False


# ==================== å¯†ç ç­–ç•¥ ====================

def validate_password(password: str) -> Tuple[bool, List[str]]:
    """éªŒè¯å¯†ç æ˜¯å¦ç¬¦åˆç­–ç•¥"""
    errors = []
    
    if len(password) < PASSWORD_MIN_LENGTH:
        errors.append(f"å¯†ç é•¿åº¦è‡³å°‘{PASSWORD_MIN_LENGTH}ä½")
    
    if PASSWORD_REQUIRE_UPPERCASE and not re.search(r'[A-Z]', password):
        errors.append("å¯†ç å¿…é¡»åŒ…å«å¤§å†™å­—æ¯")
    
    if PASSWORD_REQUIRE_LOWERCASE and not re.search(r'[a-z]', password):
        errors.append("å¯†ç å¿…é¡»åŒ…å«å°å†™å­—æ¯")
    
    if PASSWORD_REQUIRE_DIGIT and not re.search(r'\d', password):
        errors.append("å¯†ç å¿…é¡»åŒ…å«æ•°å­—")
    
    return len(errors) == 0, errors


# ==================== å®¡è®¡æ—¥å¿— ====================

def record_audit_log(username: str, action: str, resource: str = None, 
                     resource_id: int = None, old_value: str = None, 
                     new_value: str = None, ip: str = None):
    """è®°å½•å®¡è®¡æ—¥å¿—"""
    try:
        conn = open_security_connection(dict_cursor=True)
        cursor = conn.cursor()
        cursor.execute('''
            INSERT INTO audit_logs (username, action, resource, resource_id, old_value, new_value, ip_address)
            VALUES (?, ?, ?, ?, ?, ?, ?)
        ''', (username, action, resource, resource_id, old_value, new_value, ip))
        conn.commit()
        conn.close()
    except Exception as e:
        print(f"[Security] è®°å½•å®¡è®¡æ—¥å¿—å¤±è´¥: {e}")


def get_audit_logs(username: str = None, action: str = None, limit: int = 100) -> List[Dict]:
    """è·å–å®¡è®¡æ—¥å¿—"""
    try:
        conn = open_security_connection(dict_cursor=True)
        cursor = conn.cursor()
        
        query = '''SELECT id, username, action, resource, resource_id, 
                   old_value, new_value, ip_address, created_at 
                   FROM audit_logs WHERE 1=1'''
        params = []
        
        if username:
            query += ' AND username = ?'
            params.append(username)
        if action:
            query += ' AND action = ?'
            params.append(action)
        
        query += ' ORDER BY created_at DESC LIMIT ?'
        params.append(limit)
        
        cursor.execute(query, params)
        rows = cursor.fetchall()
        conn.close()
        
        return [dict(r) for r in rows]
    except Exception as e:
        print(f"[Security] è·å–å®¡è®¡æ—¥å¿—å¤±è´¥: {e}")
        return []


def init_security():
    """åˆå§‹åŒ–å®‰å…¨æ¨¡å—"""
    init_security_db()
    print("[Security] å®‰å…¨æ¨¡å—åˆå§‹åŒ–å®Œæˆ")
```

---

## äº”ã€ç”¨æˆ·ç®¡ç†

### 5.1 æ¨¡å—ç®€ä»‹

ç”¨æˆ·ç®¡ç†æ¨¡å—æä¾›å®Œæ•´çš„ç”¨æˆ·è®¤è¯å’Œæƒé™ç®¡ç†åŠŸèƒ½ã€‚é‡‡ç”¨ JWTï¼ˆJSON Web Tokenï¼‰å®ç°æ— çŠ¶æ€è®¤è¯ï¼Œå¯†ç ä½¿ç”¨ PBKDF2 ç®—æ³•åŠ å¯†å­˜å‚¨ã€‚æ”¯æŒç®¡ç†å‘˜å’Œæ™®é€šç”¨æˆ·ä¸¤ç§è§’è‰²ï¼Œç®¡ç†å‘˜å¯ä»¥åˆ›å»ºç”¨æˆ·ã€é‡ç½®å¯†ç ã€‚ç³»ç»Ÿé»˜è®¤é€šè¿‡ç¯å¢ƒå˜é‡é…ç½®ç®¡ç†å‘˜è´¦æˆ·ã€‚

### 5.2 è®¤è¯æ¨¡å—ä»£ç  (backend/auth.py)

```python
"""
è®¤è¯æ¨¡å— - JWT Token è®¤è¯å’Œå¯†ç åŠ å¯†
"""

import hashlib
import hmac
import base64
import json
import time
import os
from typing import Optional, Dict
from datetime import datetime, timedelta

from backend.db import open_security_connection

# ==================== é…ç½® ====================

DEFAULT_SECRET_KEY = "your-super-secret-key-change-in-production-2024"
SECRET_KEY = os.getenv("SECRET_KEY", DEFAULT_SECRET_KEY)
ALGORITHM = "HS256"
ACCESS_TOKEN_EXPIRE_MINUTES = 60 * 24  # 24å°æ—¶

ADMIN_USERNAME = os.getenv("ADMIN_USERNAME", "admin")
ADMIN_PASSWORD = os.getenv("ADMIN_PASSWORD")

ADMIN_USERS = {
    ADMIN_USERNAME: {
        "username": ADMIN_USERNAME,
        "password_hash": None,
        "role": "admin",
        "created_at": "2024-01-01"
    }
}

ALLOWED_ROLES = {"admin", "user"}


# ==================== å¯†ç åŠ å¯† ====================

def hash_password(password: str) -> str:
    """ä½¿ç”¨ PBKDF2 ç®—æ³•åŠ å¯†å¯†ç """
    salt = os.urandom(32)
    key = hashlib.pbkdf2_hmac(
        'sha256',
        password.encode('utf-8'),
        salt,
        100000  # è¿­ä»£æ¬¡æ•°
    )
    return base64.b64encode(salt + key).decode('utf-8')


def verify_password(password: str, password_hash: str) -> bool:
    """éªŒè¯å¯†ç æ˜¯å¦æ­£ç¡®"""
    try:
        decoded = base64.b64decode(password_hash.encode('utf-8'))
        salt = decoded[:32]
        stored_key = decoded[32:]
        
        key = hashlib.pbkdf2_hmac(
            'sha256',
            password.encode('utf-8'),
            salt,
            100000
        )
        return hmac.compare_digest(key, stored_key)
    except Exception:
        return False


if ADMIN_PASSWORD:
    ADMIN_USERS[ADMIN_USERNAME]["password_hash"] = hash_password(ADMIN_PASSWORD)


def _get_user_from_db(username: str) -> Optional[Dict]:
    try:
        conn = open_security_connection(dict_cursor=True)
        cursor = conn.cursor()
        cursor.execute(
            """SELECT username, password_hash, role, is_active, created_at
               FROM user_accounts WHERE username = ?""",
            (username,),
        )
        row = cursor.fetchone()
        conn.close()
        if not row:
            return None
        return {
            "username": row["username"],
            "password_hash": row["password_hash"],
            "role": row["role"],
            "is_active": bool(row["is_active"]),
            "created_at": row["created_at"],
        }
    except Exception:
        return None


def _upsert_user(username: str, password_hash: str, role: str, is_active: bool = True) -> None:
    conn = open_security_connection(dict_cursor=True)
    cursor = conn.cursor()
    cursor.execute("SELECT username FROM user_accounts WHERE username = ?", (username,))
    exists = cursor.fetchone()
    if exists:
        cursor.execute(
            """UPDATE user_accounts
               SET password_hash = ?, role = ?, is_active = ?, updated_at = CURRENT_TIMESTAMP
               WHERE username = ?""",
            (password_hash, role, 1 if is_active else 0, username),
        )
    else:
        cursor.execute(
            """INSERT INTO user_accounts (username, password_hash, role, is_active)
               VALUES (?, ?, ?, ?)""",
            (username, password_hash, role, 1 if is_active else 0),
        )
    conn.commit()
    conn.close()


# ==================== JWT Token ====================

def base64url_encode(data: bytes) -> str:
    """Base64 URL å®‰å…¨ç¼–ç """
    return base64.urlsafe_b64encode(data).rstrip(b'=').decode('utf-8')


def base64url_decode(data: str) -> bytes:
    """Base64 URL å®‰å…¨è§£ç """
    padding = 4 - len(data) % 4
    if padding != 4:
        data += '=' * padding
    return base64.urlsafe_b64decode(data.encode('utf-8'))


def create_access_token(data: dict, expires_delta: Optional[timedelta] = None) -> str:
    """åˆ›å»º JWT Token"""
    to_encode = data.copy()
    
    if expires_delta:
        expire = datetime.utcnow() + expires_delta
    else:
        expire = datetime.utcnow() + timedelta(minutes=ACCESS_TOKEN_EXPIRE_MINUTES)
    
    to_encode.update({
        "exp": int(expire.timestamp()),
        "iat": int(datetime.utcnow().timestamp())
    })
    
    header = {"alg": ALGORITHM, "typ": "JWT"}
    header_encoded = base64url_encode(json.dumps(header).encode('utf-8'))
    payload_encoded = base64url_encode(json.dumps(to_encode).encode('utf-8'))
    
    message = f"{header_encoded}.{payload_encoded}"
    signature = hmac.new(
        SECRET_KEY.encode('utf-8'),
        message.encode('utf-8'),
        hashlib.sha256
    ).digest()
    signature_encoded = base64url_encode(signature)
    
    return f"{header_encoded}.{payload_encoded}.{signature_encoded}"


def verify_token(token: str) -> Optional[Dict]:
    """éªŒè¯ JWT Token"""
    try:
        parts = token.split('.')
        if len(parts) != 3:
            return None
        
        header_encoded, payload_encoded, signature_encoded = parts
        
        message = f"{header_encoded}.{payload_encoded}"
        expected_signature = hmac.new(
            SECRET_KEY.encode('utf-8'),
            message.encode('utf-8'),
            hashlib.sha256
        ).digest()
        
        actual_signature = base64url_decode(signature_encoded)
        
        if not hmac.compare_digest(expected_signature, actual_signature):
            return None
        
        payload = json.loads(base64url_decode(payload_encoded).decode('utf-8'))
        
        if payload.get("exp", 0) < time.time():
            return None
        
        return payload
        
    except Exception:
        return None


# ==================== ç”¨æˆ·è®¤è¯ ====================

def authenticate_user(username: str, password: str) -> Optional[Dict]:
    """éªŒè¯ç”¨æˆ·ç™»å½•"""
    user = _get_user_from_db(username)
    if user:
        if not user.get("is_active"):
            return None
        if not user.get("password_hash"):
            return None
        if not verify_password(password, user["password_hash"]):
            return None
        return {"username": user["username"], "role": user["role"]}

    user = ADMIN_USERS.get(username)
    if not user or not user.get("password_hash"):
        return None
    if not verify_password(password, user["password_hash"]):
        return None
    return {"username": user["username"], "role": user["role"]}


def get_current_user(token: str) -> Optional[Dict]:
    """ä» Token è·å–å½“å‰ç”¨æˆ·"""
    payload = verify_token(token)
    if not payload:
        return None
    
    username = payload.get("sub")
    if not username:
        return None
    
    user = _get_user_from_db(username)
    if user:
        if not user.get("is_active"):
            return None
        return {"username": user["username"], "role": user["role"]}

    user = ADMIN_USERS.get(username)
    if not user:
        return None
    
    return {"username": user["username"], "role": user["role"]}


# ==================== ç”¨æˆ·ç®¡ç† ====================

def create_user(username: str, password: str, role: str = "user") -> bool:
    """åˆ›å»ºæ–°ç”¨æˆ·"""
    if role not in ALLOWED_ROLES:
        return False
    if username in ADMIN_USERS:
        return False
    if _get_user_from_db(username):
        return False
    password_hash = hash_password(password)
    _upsert_user(username, password_hash, role, True)
    return True


def change_password(username: str, old_password: str, new_password: str) -> bool:
    """ä¿®æ”¹å¯†ç """
    user = _get_user_from_db(username)
    if user:
        if not user.get("password_hash"):
            return False
        if not verify_password(old_password, user["password_hash"]):
            return False
        _upsert_user(username, hash_password(new_password), user["role"], user["is_active"])
        return True

    user = ADMIN_USERS.get(username)
    if not user or not user.get("password_hash"):
        return False
    if not verify_password(old_password, user["password_hash"]):
        return False
    user["password_hash"] = hash_password(new_password)
    return True


def list_users() -> list:
    """åˆ—å‡ºæ‰€æœ‰ç”¨æˆ·"""
    users = []
    try:
        conn = open_security_connection(dict_cursor=True)
        cursor = conn.cursor()
        cursor.execute("SELECT username, role, is_active, created_at FROM user_accounts")
        for row in cursor.fetchall():
            users.append({
                "username": row["username"],
                "role": row["role"],
                "is_active": bool(row["is_active"]),
                "created_at": row["created_at"],
            })
        conn.close()
    except Exception:
        pass

    if not users:
        users = [
            {"username": u["username"], "role": u["role"], "created_at": u["created_at"]}
            for u in ADMIN_USERS.values()
        ]
    return users
```

### 5.3 TOTP ä¸¤æ­¥éªŒè¯æ¨¡å— (backend/totp.py)

```python
"""
TOTP ä¸¤æ­¥éªŒè¯æ¨¡å—
åŸºäº RFC 6238 å®ç°
"""

import hmac
import hashlib
import struct
import time
import base64
import os
from typing import Optional, Tuple

from backend.db import is_security_mysql, open_security_connection

TOTP_DIGITS = 6
TOTP_INTERVAL = 30
TOTP_ISSUER = "GasMixtureSystem"


def generate_secret(length: int = 32) -> str:
    """ç”Ÿæˆéšæœºå¯†é’¥"""
    random_bytes = os.urandom(length)
    secret = base64.b32encode(random_bytes).decode('utf-8').rstrip('=')
    return secret


def get_totp_token(secret: str, timestamp: int = None) -> str:
    """ç”Ÿæˆ TOTP éªŒè¯ç """
    if timestamp is None:
        timestamp = int(time.time())
    
    time_step = timestamp // TOTP_INTERVAL
    
    padding = 8 - (len(secret) % 8)
    if padding != 8:
        secret += '=' * padding
    
    try:
        key = base64.b32decode(secret.upper())
    except Exception:
        return ""
    
    time_bytes = struct.pack('>Q', time_step)
    hmac_hash = hmac.new(key, time_bytes, hashlib.sha1).digest()
    
    offset = hmac_hash[-1] & 0x0F
    truncated = struct.unpack('>I', hmac_hash[offset:offset + 4])[0]
    truncated &= 0x7FFFFFFF
    
    code = truncated % (10 ** TOTP_DIGITS)
    return str(code).zfill(TOTP_DIGITS)


def verify_totp(secret: str, code: str, window: int = 1) -> bool:
    """éªŒè¯ TOTP éªŒè¯ç """
    if not code or len(code) != TOTP_DIGITS:
        return False
    
    current_time = int(time.time())
    
    for offset in range(-window, window + 1):
        check_time = current_time + (offset * TOTP_INTERVAL)
        expected = get_totp_token(secret, check_time)
        if expected and hmac.compare_digest(expected, code):
            return True
    
    return False


def get_totp_uri(secret: str, username: str) -> str:
    """ç”Ÿæˆ TOTP URIï¼ˆç”¨äºäºŒç»´ç ï¼‰"""
    return f"otpauth://totp/{TOTP_ISSUER}:{username}?secret={secret}&issuer={TOTP_ISSUER}&digits={TOTP_DIGITS}&period={TOTP_INTERVAL}"


def setup_totp(username: str) -> Tuple[str, str]:
    """ä¸ºç”¨æˆ·è®¾ç½® TOTP"""
    secret = generate_secret()
    uri = get_totp_uri(secret, username)
    
    backup_codes = [generate_secret(8)[:8] for _ in range(10)]
    backup_codes_str = ','.join(backup_codes)
    
    conn = open_security_connection(dict_cursor=True)
    cursor = conn.cursor()
    
    cursor.execute('SELECT id FROM user_totp WHERE username = ?', (username,))
    if cursor.fetchone():
        cursor.execute('''
            UPDATE user_totp SET secret = ?, enabled = 0, backup_codes = ?
            WHERE username = ?
        ''', (secret, backup_codes_str, username))
    else:
        cursor.execute('''
            INSERT INTO user_totp (username, secret, backup_codes)
            VALUES (?, ?, ?)
        ''', (username, secret, backup_codes_str))
    
    conn.commit()
    conn.close()
    
    return secret, uri


def enable_totp(username: str, code: str) -> bool:
    """å¯ç”¨ TOTP"""
    conn = open_security_connection(dict_cursor=True)
    cursor = conn.cursor()
    
    cursor.execute('SELECT secret FROM user_totp WHERE username = ?', (username,))
    row = cursor.fetchone()
    
    if not row:
        conn.close()
        return False
    
    secret = row['secret']
    
    if verify_totp(secret, code):
        cursor.execute('UPDATE user_totp SET enabled = 1 WHERE username = ?', (username,))
        conn.commit()
        conn.close()
        return True
    
    conn.close()
    return False


def verify_user_totp(username: str, code: str) -> bool:
    """éªŒè¯ç”¨æˆ·çš„ TOTP éªŒè¯ç """
    conn = open_security_connection(dict_cursor=True)
    cursor = conn.cursor()
    
    cursor.execute('SELECT secret, backup_codes FROM user_totp WHERE username = ? AND enabled = 1', (username,))
    row = cursor.fetchone()
    
    if not row:
        conn.close()
        return False
    
    secret = row['secret']
    backup_codes_str = row['backup_codes']
    
    if verify_totp(secret, code):
        cursor.execute('UPDATE user_totp SET last_used = CURRENT_TIMESTAMP WHERE username = ?', (username,))
        conn.commit()
        conn.close()
        return True
    
    # å°è¯•å¤‡ç”¨ç 
    if backup_codes_str:
        backup_codes = backup_codes_str.split(',')
        if code in backup_codes:
            backup_codes.remove(code)
            cursor.execute('UPDATE user_totp SET backup_codes = ?, last_used = CURRENT_TIMESTAMP WHERE username = ?',
                          (','.join(backup_codes), username))
            conn.commit()
            conn.close()
            return True
    
    conn.close()
    return False
```

---

## å…­ã€å¤‡ä»½ä¸æ¢å¤

### 6.1 æ¨¡å—ç®€ä»‹

å¤‡ä»½æ¨¡å—æä¾›æ•°æ®åº“çš„è‡ªåŠ¨å’Œæ‰‹åŠ¨å¤‡ä»½åŠŸèƒ½ã€‚ç³»ç»Ÿé»˜è®¤æ¯6å°æ—¶è‡ªåŠ¨åˆ›å»ºä¸€æ¬¡å¤‡ä»½ï¼Œä¿ç•™æœ€è¿‘10ä¸ªå¤‡ä»½æ–‡ä»¶ã€‚æ”¯æŒæ‰‹åŠ¨åˆ›å»ºå¤‡ä»½ã€æ¢å¤å¤‡ä»½ã€ä¸‹è½½å¤‡ä»½æ–‡ä»¶ã€åˆ é™¤æ—§å¤‡ä»½ç­‰æ“ä½œã€‚ä½¿ç”¨ SQLite åŸç”Ÿå¤‡ä»½ API ç¡®ä¿å¤‡ä»½è¿‡ç¨‹çš„æ•°æ®ä¸€è‡´æ€§ã€‚å¯¹äº MySQL æ•°æ®åº“ï¼Œç³»ç»Ÿä¼šæç¤ºä½¿ç”¨äº‘å¹³å°çš„æ‰˜ç®¡å¤‡ä»½åŠŸèƒ½ã€‚

### 6.2 å¤‡ä»½æ¨¡å—ä»£ç  (backend/backup.py)

```python
"""
è‡ªåŠ¨å¤‡ä»½æ¨¡å— - æ•°æ®åº“å®šæ—¶å¤‡ä»½
"""

import os
import shutil
import threading
import time
from datetime import datetime, timedelta
from typing import List, Optional
import sqlite3

from backend.config import get_backup_dir, get_database_path
from backend.db import is_mysql

# ==================== é…ç½® ====================

BACKUP_DIR = get_backup_dir()
DATABASE_PATH = get_database_path()
MAX_BACKUPS = 10
BACKUP_INTERVAL = 6 * 60 * 60  # 6å°æ—¶

_backup_thread: Optional[threading.Thread] = None
_backup_running = False


def is_backup_supported() -> bool:
    return not is_mysql()


def ensure_backup_dir():
    """ç¡®ä¿å¤‡ä»½ç›®å½•å­˜åœ¨"""
    if not is_backup_supported():
        return
    if not os.path.exists(BACKUP_DIR):
        os.makedirs(BACKUP_DIR)
        print(f"[Backup] åˆ›å»ºå¤‡ä»½ç›®å½•: {BACKUP_DIR}")


def create_backup(manual: bool = False) -> Optional[str]:
    """åˆ›å»ºæ•°æ®åº“å¤‡ä»½"""
    try:
        if not is_backup_supported():
            print("[Backup] MySQL ä½¿ç”¨æ‰˜ç®¡å¤‡ä»½ï¼Œè·³è¿‡æ–‡ä»¶å¤‡ä»½")
            return None
        ensure_backup_dir()
        
        if not os.path.exists(DATABASE_PATH):
            print("[Backup] æ•°æ®åº“æ–‡ä»¶ä¸å­˜åœ¨")
            return None
        
        timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
        backup_type = "manual" if manual else "auto"
        backup_filename = f"gas_data_{backup_type}_{timestamp}.db"
        backup_path = os.path.join(BACKUP_DIR, backup_filename)
        
        # ä½¿ç”¨ SQLite å¤‡ä»½ API
        source_conn = sqlite3.connect(DATABASE_PATH)
        backup_conn = sqlite3.connect(backup_path)
        source_conn.backup(backup_conn)
        source_conn.close()
        backup_conn.close()
        
        backup_size = os.path.getsize(backup_path)
        print(f"[Backup] å¤‡ä»½æˆåŠŸ: {backup_filename} ({format_size(backup_size)})")
        
        cleanup_old_backups()
        return backup_path
        
    except Exception as e:
        print(f"[Backup] å¤‡ä»½å¤±è´¥: {e}")
        return None


def restore_backup(backup_filename: str) -> bool:
    """ä»å¤‡ä»½æ¢å¤æ•°æ®åº“"""
    try:
        if not is_backup_supported():
            print("[Backup] MySQL ä½¿ç”¨æ‰˜ç®¡å¤‡ä»½ï¼Œæ— æ³•ä»æ–‡ä»¶æ¢å¤")
            return False
        backup_path = os.path.join(BACKUP_DIR, backup_filename)
        
        if not os.path.exists(backup_path):
            print(f"[Backup] å¤‡ä»½æ–‡ä»¶ä¸å­˜åœ¨: {backup_filename}")
            return False
        
        # å…ˆå¤‡ä»½å½“å‰æ•°æ®åº“
        create_backup(manual=True)
        
        # æ¢å¤å¤‡ä»½
        shutil.copy2(backup_path, DATABASE_PATH)
        
        print(f"[Backup] æ¢å¤æˆåŠŸ: {backup_filename}")
        return True
        
    except Exception as e:
        print(f"[Backup] æ¢å¤å¤±è´¥: {e}")
        return False


def list_backups() -> List[dict]:
    """åˆ—å‡ºæ‰€æœ‰å¤‡ä»½æ–‡ä»¶"""
    if not is_backup_supported():
        return []
    ensure_backup_dir()
    
    backups = []
    for filename in os.listdir(BACKUP_DIR):
        if filename.endswith('.db'):
            filepath = os.path.join(BACKUP_DIR, filename)
            stat = os.stat(filepath)
            
            parts = filename.replace('.db', '').split('_')
            backup_type = parts[2] if len(parts) > 2 else 'unknown'
            
            backups.append({
                'filename': filename,
                'size': stat.st_size,
                'size_formatted': format_size(stat.st_size),
                'created_at': datetime.fromtimestamp(stat.st_mtime).isoformat(),
                'type': backup_type
            })
    
    backups.sort(key=lambda x: x['created_at'], reverse=True)
    return backups


def delete_backup(backup_filename: str) -> bool:
    """åˆ é™¤æŒ‡å®šå¤‡ä»½"""
    try:
        if not is_backup_supported():
            return False
        backup_path = os.path.join(BACKUP_DIR, backup_filename)
        if os.path.exists(backup_path):
            os.remove(backup_path)
            print(f"[Backup] åˆ é™¤å¤‡ä»½: {backup_filename}")
            return True
        return False
    except Exception as e:
        print(f"[Backup] åˆ é™¤å¤±è´¥: {e}")
        return False


def cleanup_old_backups():
    """æ¸…ç†è¶…å‡ºæ•°é‡é™åˆ¶çš„æ—§å¤‡ä»½"""
    if not is_backup_supported():
        return
    backups = list_backups()
    
    if len(backups) > MAX_BACKUPS:
        for backup in backups[MAX_BACKUPS:]:
            delete_backup(backup['filename'])


def format_size(size_bytes: int) -> str:
    """æ ¼å¼åŒ–æ–‡ä»¶å¤§å°"""
    for unit in ['B', 'KB', 'MB', 'GB']:
        if size_bytes < 1024:
            return f"{size_bytes:.1f} {unit}"
        size_bytes /= 1024
    return f"{size_bytes:.1f} TB"


# ==================== è‡ªåŠ¨å¤‡ä»½ ====================

def _backup_worker():
    """å¤‡ä»½å·¥ä½œçº¿ç¨‹"""
    global _backup_running
    
    print(f"[Backup] è‡ªåŠ¨å¤‡ä»½å·²å¯åŠ¨ï¼Œé—´éš”: {BACKUP_INTERVAL // 3600} å°æ—¶")
    
    while _backup_running:
        for _ in range(BACKUP_INTERVAL):
            if not _backup_running:
                break
            time.sleep(1)
        
        if _backup_running:
            create_backup(manual=False)


def start_auto_backup():
    """å¯åŠ¨è‡ªåŠ¨å¤‡ä»½"""
    global _backup_thread, _backup_running
    
    if _backup_running:
        print("[Backup] è‡ªåŠ¨å¤‡ä»½å·²åœ¨è¿è¡Œ")
        return
    
    _backup_running = True
    _backup_thread = threading.Thread(target=_backup_worker, daemon=True)
    _backup_thread.start()
    
    create_backup(manual=False)


def stop_auto_backup():
    """åœæ­¢è‡ªåŠ¨å¤‡ä»½"""
    global _backup_running
    _backup_running = False
    print("[Backup] è‡ªåŠ¨å¤‡ä»½å·²åœæ­¢")


def get_backup_status() -> dict:
    """è·å–å¤‡ä»½çŠ¶æ€"""
    if not is_backup_supported():
        return {
            'auto_backup_enabled': False,
            'backup_count': 0,
            'managed_by': 'rds'
        }
    backups = list_backups()
    total_size = sum(b['size'] for b in backups)
    
    return {
        'auto_backup_enabled': _backup_running,
        'backup_interval_hours': BACKUP_INTERVAL // 3600,
        'backup_count': len(backups),
        'total_size': format_size(total_size),
        'max_backups': MAX_BACKUPS,
        'backup_dir': BACKUP_DIR,
        'last_backup': backups[0]['created_at'] if backups else None
    }


def init_backup_system():
    """åˆå§‹åŒ–å¤‡ä»½ç³»ç»Ÿ"""
    if not is_backup_supported():
        print("[Backup] MySQL ä½¿ç”¨æ‰˜ç®¡å¤‡ä»½ï¼Œè‡ªåŠ¨å¤‡ä»½å·²è·³è¿‡")
        return
    ensure_backup_dir()
    start_auto_backup()
    print("[Backup] å¤‡ä»½ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ")
```

---

## ä¸ƒã€æ•°æ®å¯è§†åŒ–

### 7.1 æ¨¡å—ç®€ä»‹

æ•°æ®å¯è§†åŒ–æ¨¡å—æä¾›å¤šç§å›¾è¡¨å±•ç¤ºæ•°æ®åˆ†å¸ƒæƒ…å†µï¼ŒåŒ…æ‹¬æ¸©åº¦åˆ†å¸ƒç›´æ–¹å›¾ã€å‹åŠ›åˆ†å¸ƒç›´æ–¹å›¾ã€æ¸©åº¦-å‹åŠ›æ•£ç‚¹å›¾ã€æ•°æ®å¯†åº¦çƒ­åŠ›å›¾ç­‰ã€‚å‰ç«¯ä½¿ç”¨ Chart.js å’Œ ECharts åº“æ¸²æŸ“å›¾è¡¨ï¼Œåç«¯ API æä¾›èšåˆè®¡ç®—åçš„å›¾è¡¨æ•°æ®ã€‚æ”¯æŒè‡ªå®šä¹‰åˆ†ç®±æ•°é‡å’Œæ•°æ®é‡‡æ ·ã€‚

### 7.2 å‰ç«¯å›¾è¡¨åº”ç”¨ä»£ç  (frontend/js/app.js)

```javascript
/**
 * æ°”ä½“æ··åˆç‰©æ•°æ®ç®¡ç†ç³»ç»Ÿ - Vue 3 å‰ç«¯åº”ç”¨
 * å‰åç«¯åˆ†ç¦»æ¶æ„ v2.0
 * åŒ…å«ï¼šæ•°æ®å¯è§†åŒ–ã€å¯¼å…¥å¯¼å‡ºåŠŸèƒ½
 */

const { createApp, ref, reactive, computed, onMounted, watch, nextTick } = Vue;

const API_BASE = '/api';

// Chart.js å…¨å±€é…ç½®
Chart.defaults.color = '#8899a8';
Chart.defaults.borderColor = '#253041';

const app = createApp({
    setup() {
        // ==================== å“åº”å¼çŠ¶æ€ ====================
        const loading = ref(true);
        const records = ref([]);
        const showCharts = ref(false);
        const statistics = ref({
            total_records: 0,
            min_temperature: 0,
            max_temperature: 0,
            avg_temperature: 0,
            min_pressure: 0,
            max_pressure: 0,
            avg_pressure: 0
        });
        
        let tempChart = null;
        let pressureChart = null;
        let scatterChart = null;
        
        const pagination = reactive({
            page: 1,
            perPage: 15,
            total: 0,
            totalPages: 1
        });
        
        const filters = reactive({
            tempMin: '',
            tempMax: '',
            pressureMin: '',
            pressureMax: ''
        });

        // ==================== å›¾è¡¨åŠŸèƒ½ ====================
        
        function toggleCharts() {
            showCharts.value = !showCharts.value;
            if (showCharts.value) {
                nextTick(() => loadCharts());
            }
        }
        
        async function loadCharts() {
            try {
                // åŠ è½½æ¸©åº¦åˆ†å¸ƒå›¾
                const tempResponse = await fetch(`${API_BASE}/chart/temperature`);
                const tempData = await tempResponse.json();
                renderBarChart('tempChart', tempData, 'rgba(255, 153, 64, 0.8)', tempChart, (c) => { tempChart = c; });
                
                // åŠ è½½å‹åŠ›åˆ†å¸ƒå›¾
                const pressureResponse = await fetch(`${API_BASE}/chart/pressure`);
                const pressureData = await pressureResponse.json();
                renderBarChart('pressureChart', pressureData, 'rgba(61, 158, 255, 0.8)', pressureChart, (c) => { pressureChart = c; });
                
                // åŠ è½½æ•£ç‚¹å›¾
                const scatterResponse = await fetch(`${API_BASE}/chart/scatter`);
                const scatterData = await scatterResponse.json();
                renderScatterChart('scatterChart', scatterData);
                
            } catch (error) {
                console.error('åŠ è½½å›¾è¡¨å¤±è´¥:', error);
            }
        }
        
        function renderBarChart(canvasId, data, color, existingChart, setChart) {
            const ctx = document.getElementById(canvasId);
            if (!ctx) return;
            
            if (existingChart) {
                existingChart.destroy();
            }
            
            const chart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.labels,
                    datasets: [{
                        label: data.title,
                        data: data.data,
                        backgroundColor: color,
                        borderColor: color.replace('0.8', '1'),
                        borderWidth: 1,
                        borderRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: 'rgba(255,255,255,0.05)' }
                        },
                        x: {
                            grid: { display: false }
                        }
                    }
                }
            });
            
            setChart(chart);
        }
        
        function renderScatterChart(canvasId, data) {
            const ctx = document.getElementById(canvasId);
            if (!ctx) return;
            
            if (scatterChart) {
                scatterChart.destroy();
            }
            
            scatterChart = new Chart(ctx, {
                type: 'scatter',
                data: {
                    datasets: [{
                        label: 'æ¸©åº¦-å‹åŠ›',
                        data: data.data,
                        backgroundColor: 'rgba(0, 212, 170, 0.6)',
                        borderColor: 'rgba(0, 212, 170, 1)',
                        pointRadius: 5,
                        pointHoverRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: (context) => `æ¸©åº¦: ${context.parsed.x.toFixed(1)}K, å‹åŠ›: ${context.parsed.y.toFixed(2)}MPa`
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: { display: true, text: 'æ¸©åº¦ (K)', color: '#8899a8' },
                            grid: { color: 'rgba(255,255,255,0.05)' }
                        },
                        y: {
                            title: { display: true, text: 'å‹åŠ› (MPa)', color: '#8899a8' },
                            grid: { color: 'rgba(255,255,255,0.05)' }
                        }
                    }
                }
            });
        }

        // ==================== å¯¼å…¥å¯¼å‡ºåŠŸèƒ½ ====================
        
        function exportCSV() {
            window.location.href = `${API_BASE}/export/csv`;
            showToast('æ­£åœ¨ä¸‹è½½ CSV æ–‡ä»¶...', 'success');
        }
        
        function exportExcel() {
            window.location.href = `${API_BASE}/export/excel`;
            showToast('æ­£åœ¨ä¸‹è½½ Excel æ–‡ä»¶...', 'success');
        }
        
        async function handleImport(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const validTypes = ['.csv', '.xlsx', '.xls'];
            const ext = file.name.toLowerCase().slice(file.name.lastIndexOf('.'));
            if (!validTypes.includes(ext)) {
                showToast('è¯·ä¸Šä¼  CSV æˆ– Excel æ–‡ä»¶', 'error');
                return;
            }
            
            try {
                const formData = new FormData();
                formData.append('file', file);
                
                const response = await fetch(`${API_BASE}/import`, {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (response.ok && result.success) {
                    showToast(result.message, 'success');
                    fetchRecords();
                    fetchStatistics();
                    if (showCharts.value) loadCharts();
                } else {
                    showToast(result.detail || 'å¯¼å…¥å¤±è´¥', 'error');
                }
            } catch (error) {
                showToast('å¯¼å…¥å¤±è´¥: ' + error.message, 'error');
            }
        }

        // æ˜¾ç¤º Toast
        function showToast(message, type = 'success') {
            console.log(`[${type}] ${message}`);
        }
        
        // æ ¼å¼åŒ–æ•°å­—
        function formatNumber(num, decimals = 3) {
            if (num === null || num === undefined) return '0.000';
            return Number(num).toFixed(decimals);
        }

        onMounted(() => {
            fetchRecords();
            fetchStatistics();
        });

        return {
            loading,
            records,
            statistics,
            pagination,
            filters,
            showCharts,
            toggleCharts,
            exportCSV,
            exportExcel,
            handleImport,
            formatNumber
        };
    }
});

app.mount('#app');
```

### 7.3 åç«¯å›¾è¡¨æ•°æ® API (backend/main.py éƒ¨åˆ†)

```python
# ==================== å›¾è¡¨æ•°æ® API ====================

@app.get("/api/chart/temperature", tags=["Chart"])
async def api_chart_temperature():
    """è·å–æ¸©åº¦åˆ†å¸ƒæ•°æ®ï¼ˆç”¨äºå›¾è¡¨ï¼‰"""
    data = get_chart_data('temperature')
    return data


@app.get("/api/chart/pressure", tags=["Chart"])
async def api_chart_pressure():
    """è·å–å‹åŠ›åˆ†å¸ƒæ•°æ®ï¼ˆç”¨äºå›¾è¡¨ï¼‰"""
    data = get_chart_data('pressure')
    return data


@app.get("/api/chart/scatter", tags=["Chart"])
async def api_chart_scatter():
    """è·å–æ¸©åº¦-å‹åŠ›æ•£ç‚¹å›¾æ•°æ®"""
    data = get_chart_data('scatter')
    return data


@app.get("/api/chart/heatmap", tags=["Chart"])
async def api_chart_heatmap(
    temp_bins: int = Query(18, ge=5, le=60),
    pressure_bins: int = Query(20, ge=5, le=60)
):
    """è·å–æ¸©åº¦-å‹åŠ›å¯†åº¦çƒ­åŠ›å›¾æ•°æ®"""
    with get_connection(dict_cursor=True) as conn:
        cursor = conn.cursor()
        cursor.execute("SELECT temperature, pressure FROM gas_mixture")
        rows = cursor.fetchall()

    if not rows:
        return {"x_labels": [], "y_labels": [], "data": [], "meta": {}}

    temps = [row['temperature'] for row in rows]
    pressures = [row['pressure'] for row in rows]

    min_temp = min(temps)
    max_temp = max(temps)
    min_pressure = min(pressures)
    max_pressure = max(pressures)

    temp_range = max_temp - min_temp
    pressure_range = max_pressure - min_pressure

    temp_size = temp_range / temp_bins if temp_bins > 0 else 1.0
    pressure_size = pressure_range / pressure_bins if pressure_bins > 0 else 1.0

    counts = {}
    for row in rows:
        temp = row['temperature']
        pressure = row['pressure']
        t_bin = int((temp - min_temp) / temp_size) if temp_size else 0
        p_bin = int((pressure - min_pressure) / pressure_size) if pressure_size else 0
        if t_bin >= temp_bins:
            t_bin = temp_bins - 1
        if p_bin >= pressure_bins:
            p_bin = pressure_bins - 1
        counts[(t_bin, p_bin)] = counts.get((t_bin, p_bin), 0) + 1

    x_labels = [f"{min_temp + i * temp_size:.0f}-{min_temp + (i+1) * temp_size:.0f}K" 
                for i in range(temp_bins)]
    y_labels = [f"{min_pressure + i * pressure_size:.1f}-{min_pressure + (i+1) * pressure_size:.1f}MPa" 
                for i in range(pressure_bins)]

    data = [[t_bin, p_bin, count] for (t_bin, p_bin), count in counts.items()]

    return {
        "x_labels": x_labels,
        "y_labels": y_labels,
        "data": data,
        "meta": {
            "min_temp": min_temp,
            "max_temp": max_temp,
            "min_pressure": min_pressure,
            "max_pressure": max_pressure
        }
    }
```

### 7.3 ç®¡ç†åå°è§†è§‰æ ·å¼ (frontend/css/style.css)

```css
/* ========================================
   æ°”ä½“æ··åˆç‰©æ•°æ®ç®¡ç†ç³»ç»Ÿ - å‰ç«¯æ ·å¼
   é‡‡ç”¨æ·±è‰²ç§‘æŠ€é£ä¸»é¢˜
======================================== */

:root {
    --bg-primary: #0a0e14;
    --bg-secondary: #12171e;
    --bg-card: #161d27;
    --bg-hover: #1a222d;
    --border-color: #253041;
    --border-focus: #3d9eff;
    --text-primary: #e8eef5;
    --text-secondary: #8899a8;
    --text-muted: #5c6b7a;
    --accent-blue: #3d9eff;
    --accent-cyan: #00d4aa;
    --accent-orange: #ff9940;
    --accent-red: #ff5555;
    --accent-purple: #b794f6;
    --gradient-blue: linear-gradient(135deg, #3d9eff 0%, #0066cc 100%);
    --gradient-cyan: linear-gradient(135deg, #00d4aa 0%, #00a885 100%);
    --shadow-glow: 0 0 30px rgba(61, 158, 255, 0.15);
    --shadow-card: 0 4px 20px rgba(0, 0, 0, 0.3);
    --font-mono: 'Fira Code', 'JetBrains Mono', 'Consolas', monospace;
    --font-sans: 'Inter', 'Noto Sans SC', -apple-system, sans-serif;
}

* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: var(--font-sans);
    background: var(--bg-primary);
    color: var(--text-primary);
    min-height: 100vh;
    line-height: 1.6;
    background-image: 
        radial-gradient(ellipse at 20% 0%, rgba(61, 158, 255, 0.08) 0%, transparent 50%),
        radial-gradient(ellipse at 80% 100%, rgba(0, 212, 170, 0.06) 0%, transparent 50%);
}

#app {
    max-width: 1440px;
    margin: 0 auto;
    padding: 30px 40px;
}

/* ========== Header ========== */
.header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 35px;
    padding-bottom: 25px;
    border-bottom: 1px solid var(--border-color);
}

.logo {
    display: flex;
    align-items: center;
    gap: 16px;
}

.logo-icon {
    width: 52px;
    height: 52px;
    background: var(--gradient-blue);
    border-radius: 14px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 26px;
    box-shadow: var(--shadow-glow);
}

.logo-text h1 {
    font-size: 24px;
    font-weight: 700;
    letter-spacing: -0.5px;
    background: linear-gradient(135deg, var(--text-primary) 0%, var(--accent-blue) 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

.logo-text p {
    font-size: 13px;
    color: var(--text-secondary);
    font-weight: 400;
}

.header-actions {
    display: flex;
    gap: 12px;
}

/* ========== Buttons ========== */
.btn {
    padding: 11px 22px;
    border: none;
    border-radius: 10px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
    display: inline-flex;
    align-items: center;
    gap: 8px;
    font-family: inherit;
    letter-spacing: 0.3px;
}

.btn-primary {
    background: var(--gradient-blue);
    color: white;
    box-shadow: 0 4px 15px rgba(61, 158, 255, 0.3);
}

.btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 25px rgba(61, 158, 255, 0.4);
}

.btn-secondary {
    background: var(--bg-card);
    color: var(--text-primary);
    border: 1px solid var(--border-color);
}

.btn-secondary:hover {
    background: var(--bg-hover);
    border-color: var(--accent-blue);
}

.btn-danger {
    background: transparent;
    color: var(--accent-red);
    border: 1px solid var(--accent-red);
    padding: 7px 12px;
}

.btn-danger:hover {
    background: var(--accent-red);
    color: white;
}

.btn-success {
    background: var(--gradient-cyan);
    color: var(--bg-primary);
    font-weight: 700;
}

.btn-sm {
    padding: 7px 14px;
    font-size: 13px;
    border-radius: 8px;
}

.btn-icon {
    width: 34px;
    height: 34px;
    padding: 0;
    justify-content: center;
    border-radius: 8px;
}

/* ========== Stats Cards ========== */
.stats-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 20px;
    margin-bottom: 30px;
}

.stat-card {
    background: var(--bg-card);
    border: 1px solid var(--border-color);
    border-radius: 16px;
    padding: 22px;
    position: relative;
    overflow: hidden;
    transition: all 0.3s ease;
}

.stat-card:hover {
    transform: translateY(-3px);
    box-shadow: var(--shadow-card);
}

.stat-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 3px;
}

.stat-card:nth-child(1)::before { background: var(--gradient-blue); }
.stat-card:nth-child(2)::before { background: var(--accent-orange); }
.stat-card:nth-child(3)::before { background: var(--gradient-cyan); }
.stat-card:nth-child(4)::before { background: var(--accent-purple); }

.stat-icon {
    font-size: 20px;
    margin-bottom: 12px;
}

.stat-label {
    font-size: 13px;
    color: var(--text-secondary);
    margin-bottom: 8px;
    font-weight: 500;
}

.stat-value {
    font-size: 28px;
    font-weight: 700;
    font-family: var(--font-mono);
    color: var(--text-primary);
}

.stat-unit {
    font-size: 14px;
    color: var(--text-muted);
    font-weight: 400;
    margin-left: 4px;
}

/* ========== Toolbar ========== */
.toolbar {
    display: flex;
    gap: 16px;
    margin-bottom: 25px;
    flex-wrap: wrap;
    align-items: center;
}

.filter-group {
    display: flex;
    gap: 10px;
    align-items: center;
    background: var(--bg-card);
    border: 1px solid var(--border-color);
    border-radius: 10px;
    padding: 10px 16px;
}

.filter-group label {
    font-size: 13px;
    color: var(--text-secondary);
    white-space: nowrap;
    font-weight: 500;
}

.filter-group input {
    width: 100px;
    padding: 8px 12px;
    background: var(--bg-primary);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    color: var(--text-primary);
    font-size: 13px;
    font-family: var(--font-mono);
    transition: all 0.2s;
}

.filter-group input:focus {
    outline: none;
    border-color: var(--border-focus);
    box-shadow: 0 0 0 3px rgba(61, 158, 255, 0.15);
}

.filter-group span {
    color: var(--text-muted);
}

/* ========== Table ========== */
.table-container {
    background: var(--bg-card);
    border: 1px solid var(--border-color);
    border-radius: 16px;
    overflow: hidden;
    box-shadow: var(--shadow-card);
}

.data-table {
    width: 100%;
    border-collapse: collapse;
}

.data-table thead {
    background: var(--bg-secondary);
}

.data-table th {
    padding: 16px 18px;
    text-align: left;
    font-size: 12px;
    font-weight: 700;
    color: var(--text-secondary);
    text-transform: uppercase;
    letter-spacing: 0.8px;
    border-bottom: 1px solid var(--border-color);
}

.data-table td {
    padding: 14px 18px;
    font-size: 14px;
    border-bottom: 1px solid var(--border-color);
    font-family: var(--font-mono);
    color: var(--text-primary);
}

.data-table tbody tr {
    transition: background 0.2s;
}

.data-table tbody tr:hover {
    background: rgba(61, 158, 255, 0.05);
}

.data-table tbody tr:last-child td {
    border-bottom: none;
}

.cell-id {
    color: var(--text-muted);
    font-size: 13px;
}

.cell-temp {
    color: var(--accent-orange);
    font-weight: 600;
}

.cell-pressure {
    color: var(--accent-blue);
    font-weight: 600;
}

.cell-actions {
    display: flex;
    gap: 8px;
}

/* ========== Pagination ========== */
.pagination {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 8px;
    margin-top: 28px;
}

.pagination button {
    min-width: 38px;
    height: 38px;
    border: 1px solid var(--border-color);
    background: var(--bg-card);
    color: var(--text-primary);
    border-radius: 10px;
    cursor: pointer;
    transition: all 0.2s;
    font-family: var(--font-mono);
    font-size: 14px;
    font-weight: 500;
}

.pagination button:hover:not(:disabled) {
    border-color: var(--accent-blue);
    color: var(--accent-blue);
    background: rgba(61, 158, 255, 0.1);
}

.pagination button:disabled {
    opacity: 0.35;
    cursor: not-allowed;
}

.pagination button.active {
    background: var(--gradient-blue);
    color: white;
    border-color: transparent;
}

.page-info {
    color: var(--text-secondary);
    font-size: 13px;
    margin: 0 16px;
}

/* ========== Modal ========== */
.modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.75);
    backdrop-filter: blur(6px);
    z-index: 1000;
    display: flex;
    justify-content: center;
    align-items: center;
    opacity: 0;
    visibility: hidden;
    transition: all 0.3s ease;
}

.modal-overlay.active {
    opacity: 1;
    visibility: visible;
}

.modal {
    background: var(--bg-card);
    border: 1px solid var(--border-color);
    border-radius: 20px;
    width: 90%;
    max-width: 620px;
    max-height: 90vh;
    overflow-y: auto;
    transform: translateY(-20px) scale(0.95);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    box-shadow: 0 25px 80px rgba(0, 0, 0, 0.5);
}

.modal-overlay.active .modal {
    transform: translateY(0) scale(1);
}

.modal-header {
    padding: 22px 28px;
    border-bottom: 1px solid var(--border-color);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.modal-header h2 {
    font-size: 20px;
    font-weight: 700;
}

.modal-close {
    width: 36px;
    height: 36px;
    border: none;
    background: var(--bg-secondary);
    color: var(--text-secondary);
    cursor: pointer;
    border-radius: 10px;
    font-size: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
}

.modal-close:hover {
    background: var(--accent-red);
    color: white;
}

.modal-body {
    padding: 28px;
}

.form-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 20px;
}

.form-group {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.form-group.full-width {
    grid-column: span 2;
}

.form-group label {
    font-size: 13px;
    color: var(--text-secondary);
    font-weight: 600;
}

.form-group input {
    padding: 14px 16px;
    background: var(--bg-primary);
    border: 1px solid var(--border-color);
    border-radius: 10px;
    color: var(--text-primary);
    font-size: 15px;
    font-family: var(--font-mono);
    transition: all 0.2s;
}

.form-group input:focus {
    outline: none;
    border-color: var(--border-focus);
    box-shadow: 0 0 0 4px rgba(61, 158, 255, 0.15);
}

.modal-footer {
    padding: 20px 28px;
    border-top: 1px solid var(--border-color);
    display: flex;
    justify-content: flex-end;
    gap: 12px;
}

/* ========== Toast ========== */
.toast-container {
    position: fixed;
    top: 24px;
    right: 24px;
    z-index: 2000;
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.toast {
    padding: 16px 22px;
    background: var(--bg-card);
    border: 1px solid var(--border-color);
    border-radius: 12px;
    display: flex;
    align-items: center;
    gap: 14px;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.4);
    animation: toastIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    font-weight: 500;
}

@keyframes toastIn {
    from {
        opacity: 0;
        transform: translateX(100px);
    }
    to {
        opacity: 1;
        transform: translateX(0);
    }
}

.toast.success {
    border-left: 4px solid var(--accent-cyan);
}

.toast.error {
    border-left: 4px solid var(--accent-red);
}

.toast-icon {
    font-size: 20px;
}

.toast.success .toast-icon { color: var(--accent-cyan); }
.toast.error .toast-icon { color: var(--accent-red); }

/* ========== Charts Section ========== */
.charts-section {
    margin-bottom: 30px;
    animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
}

.section-header {
    margin-bottom: 20px;
}

.section-header h2 {
    font-size: 18px;
    font-weight: 600;
    color: var(--text-primary);
}

.charts-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 20px;
}

.chart-card {
    background: var(--bg-card);
    border: 1px solid var(--border-color);
    border-radius: 16px;
    padding: 20px;
    box-shadow: var(--shadow-card);
}

.chart-card h3 {
    font-size: 14px;
    font-weight: 600;
    color: var(--text-secondary);
    margin-bottom: 15px;
}

.chart-card canvas {
    max-height: 250px;
}

.chart-wide {
    grid-column: span 2;
}

.chart-wide canvas {
    max-height: 300px;
}

/* ========== Import/Export ========== */
.toolbar-spacer {
    flex: 1;
}

.import-export-group {
    display: flex;
    gap: 10px;
}

.import-btn {
    cursor: pointer;
}

.import-modal {
    max-width: 300px;
}

/* ========== Empty State ========== */
.empty-state {
    text-align: center;
    padding: 70px 30px;
    color: var(--text-secondary);
}

.empty-icon {
    font-size: 56px;
    margin-bottom: 18px;
    opacity: 0.5;
}

.empty-state h3 {
    font-size: 20px;
    margin-bottom: 10px;
    color: var(--text-primary);
}

.empty-state p {
    font-size: 14px;
}

/* ========== Loading ========== */
.loading {
    display: flex;
    justify-content: center;
    align-items: center;
    padding: 60px;
}

.spinner {
    width: 42px;
    height: 42px;
    border: 3px solid var(--border-color);
    border-top-color: var(--accent-blue);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

/* ========== Responsive ========== */
@media (max-width: 1024px) {
    .stats-grid {
        grid-template-columns: repeat(2, 1fr);
    }
}

@media (max-width: 768px) {
    #app {
        padding: 20px;
    }

    .header {
        flex-direction: column;
        gap: 20px;
        text-align: center;
    }

    .stats-grid {
        grid-template-columns: 1fr;
    }

    .form-grid {
        grid-template-columns: 1fr;
    }

    .form-group.full-width {
        grid-column: span 1;
    }

    .toolbar {
        flex-direction: column;
    }

    .filter-group {
        width: 100%;
        flex-wrap: wrap;
    }

    .data-table {
        font-size: 12px;
    }

    .data-table th,
    .data-table td {
        padding: 10px 8px;
    }
}
```

---

## å…«ã€API æ¥å£

### 8.1 æ¨¡å—ç®€ä»‹

ç³»ç»Ÿæä¾›å®Œæ•´çš„ RESTful API æ¥å£ï¼Œä½¿ç”¨ FastAPI æ¡†æ¶å¼€å‘ã€‚API æ”¯æŒ JSON æ ¼å¼çš„è¯·æ±‚å’Œå“åº”ï¼Œæä¾›äº¤äº’å¼æ–‡æ¡£ï¼ˆSwagger UIï¼‰æ–¹ä¾¿æµ‹è¯•ã€‚ä¸»è¦æ¥å£åŒ…æ‹¬ï¼šæ•°æ®è®°å½•çš„ CRUD æ“ä½œã€ç»„åˆ†æŸ¥è¯¢ã€ç”¨æˆ·è®¤è¯ã€æ•°æ®å¯¼å…¥å¯¼å‡ºã€å¤‡ä»½ç®¡ç†ã€å®‰å…¨è®¾ç½®ç­‰ã€‚API é‡‡ç”¨ JWT Token è®¤è¯ï¼Œå…³é”®æ“ä½œéœ€è¦ç™»å½•ã€‚

### 8.2 æ•°æ®æ¨¡å‹å®šä¹‰ (backend/models.py)

```python
"""
Pydantic æ•°æ®æ¨¡å‹
ç”¨äºè¯·æ±‚å’Œå“åº”çš„æ•°æ®éªŒè¯
"""

from pydantic import BaseModel
from typing import Optional, List
from datetime import datetime


class GasRecordBase(BaseModel):
    """æ°”ä½“è®°å½•åŸºç¡€æ¨¡å‹"""
    temperature: float
    pressure: float
    x_ch4: float = 0
    x_c2h6: float = 0
    x_c3h8: float = 0
    x_co2: float = 0
    x_n2: float = 0
    x_h2s: float = 0
    x_ic4h10: float = 0


class GasRecordCreate(GasRecordBase):
    """åˆ›å»ºæ°”ä½“è®°å½•çš„è¯·æ±‚æ¨¡å‹"""
    pass


class GasRecordUpdate(BaseModel):
    """æ›´æ–°æ°”ä½“è®°å½•çš„è¯·æ±‚æ¨¡å‹"""
    temperature: Optional[float] = None
    pressure: Optional[float] = None
    x_ch4: Optional[float] = None
    x_c2h6: Optional[float] = None
    x_c3h8: Optional[float] = None
    x_co2: Optional[float] = None
    x_n2: Optional[float] = None
    x_h2s: Optional[float] = None
    x_ic4h10: Optional[float] = None


class GasRecord(GasRecordBase):
    """æ°”ä½“è®°å½•å“åº”æ¨¡å‹"""
    id: int
    created_at: Optional[datetime] = None
    updated_at: Optional[datetime] = None

    class Config:
        from_attributes = True


class PaginatedResponse(BaseModel):
    """åˆ†é¡µå“åº”æ¨¡å‹"""
    records: List[GasRecord]
    total: int
    page: int
    per_page: int
    total_pages: int


class Statistics(BaseModel):
    """ç»Ÿè®¡ä¿¡æ¯æ¨¡å‹"""
    total_records: int
    min_temperature: Optional[float]
    max_temperature: Optional[float]
    avg_temperature: Optional[float]
    min_pressure: Optional[float]
    max_pressure: Optional[float]
    avg_pressure: Optional[float]


class ApiResponse(BaseModel):
    """é€šç”¨APIå“åº”æ¨¡å‹"""
    success: bool
    message: str
    data: Optional[dict] = None
```

### 8.3 æ•°æ®æ ¡éªŒæ¨¡å— (backend/data_validation.py)

```python
"""
æ•°æ®æ ¡éªŒæ¨¡å— - å¯¼å…¥æ—¶è‡ªåŠ¨æ ¡éªŒæ•°æ®æœ‰æ•ˆæ€§
"""

import re
from typing import List, Dict, Tuple, Any
from dataclasses import dataclass


PRESSURE_SOFT_MAX = 10.0
SUM_SOFT_TOLERANCE = 0.02
SUM_HARD_TOLERANCE = 0.05


@dataclass
class ValidationRule:
    """æ ¡éªŒè§„åˆ™"""
    field: str
    rule_type: str
    params: dict
    error_message: str


GAS_MIXTURE_RULES = [
    ValidationRule(
        field='temperature',
        rule_type='range',
        params={'min': 100, 'max': 1000},
        error_message='æ¸©åº¦å¿…é¡»åœ¨ 100-1000 K èŒƒå›´å†…'
    ),
    ValidationRule(
        field='temperature',
        rule_type='required',
        params={},
        error_message='æ¸©åº¦ä¸èƒ½ä¸ºç©º'
    ),
    ValidationRule(
        field='pressure',
        rule_type='range',
        params={'min': 0, 'max': 10000},
        error_message='å‹åŠ›å¿…é¡»åœ¨ 0-10000 MPa èŒƒå›´å†…'
    ),
    ValidationRule(
        field='pressure',
        rule_type='required',
        params={},
        error_message='å‹åŠ›ä¸èƒ½ä¸ºç©º'
    ),
    ValidationRule(
        field='x_ch4',
        rule_type='range',
        params={'min': 0, 'max': 1},
        error_message='CH4 æ‘©å°”åˆ†æ•°å¿…é¡»åœ¨ 0-1 èŒƒå›´å†…'
    ),
    ValidationRule(
        field='x_c2h6',
        rule_type='range',
        params={'min': 0, 'max': 1},
        error_message='C2H6 æ‘©å°”åˆ†æ•°å¿…é¡»åœ¨ 0-1 èŒƒå›´å†…'
    ),
]


def validate_required(value: Any) -> bool:
    """å¿…å¡«æ ¡éªŒ"""
    if value is None:
        return False
    if isinstance(value, str) and value.strip() == '':
        return False
    return True


def validate_range(value: float, min_val: float = None, max_val: float = None) -> bool:
    """èŒƒå›´æ ¡éªŒ"""
    try:
        num = float(value)
        if min_val is not None and num < min_val:
            return False
        if max_val is not None and num > max_val:
            return False
        return True
    except (ValueError, TypeError):
        return False


def validate_record(record: Dict[str, Any], rules: List[ValidationRule] = None) -> Tuple[bool, List[str]]:
    """æ ¡éªŒå•æ¡è®°å½•"""
    if rules is None:
        rules = GAS_MIXTURE_RULES
    
    errors = []
    
    for rule in rules:
        value = record.get(rule.field)
        
        if rule.rule_type == 'required':
            if not validate_required(value):
                errors.append(f"ç¬¬{rule.field}åˆ—: {rule.error_message}")
        
        elif rule.rule_type == 'range':
            if value is not None and str(value).strip() != '':
                if not validate_range(value, rule.params.get('min'), rule.params.get('max')):
                    errors.append(f"ç¬¬{rule.field}åˆ—: {rule.error_message}")
    
    # æ‘©å°”åˆ†æ•°ä¹‹å’Œæ ¡éªŒ
    mole_fractions = [
        record.get('x_ch4', 0),
        record.get('x_c2h6', 0),
        record.get('x_c3h8', 0),
        record.get('x_co2', 0),
        record.get('x_n2', 0),
        record.get('x_h2s', 0),
        record.get('x_ic4h10', 0)
    ]
    
    try:
        mole_fractions = [float(x) if x else 0 for x in mole_fractions]
        total = sum(mole_fractions)
        if total == 0:
            errors.append("æ‘©å°”åˆ†æ•°ä¸èƒ½å…¨éƒ¨ä¸º 0")
        elif abs(total - 1.0) > SUM_HARD_TOLERANCE:
            errors.append(f"æ‘©å°”åˆ†æ•°ä¹‹å’Œä¸º {total:.4f}ï¼Œåº”æ¥è¿‘ 1.0")
    except (ValueError, TypeError):
        pass
    
    return len(errors) == 0, errors


def clean_record(record: Dict[str, Any]) -> Dict[str, Any]:
    """æ¸…æ´—å•æ¡è®°å½•"""
    cleaned = {}
    
    float_fields = [
        'temperature', 'pressure',
        'x_ch4', 'x_c2h6', 'x_c3h8', 'x_co2', 'x_n2', 'x_h2s', 'x_ic4h10'
    ]
    
    for field in float_fields:
        value = record.get(field)
        if value is None or (isinstance(value, str) and value.strip() == ''):
            cleaned[field] = 0.0
        else:
            try:
                cleaned[field] = float(value)
            except (ValueError, TypeError):
                cleaned[field] = 0.0
    
    return cleaned


def get_field_constraints() -> Dict[str, Dict]:
    """è·å–å­—æ®µçº¦æŸ"""
    return {
        'temperature': {
            'type': 'number',
            'required': True,
            'min': 100,
            'max': 1000,
            'unit': 'K',
            'label': 'æ¸©åº¦'
        },
        'pressure': {
            'type': 'number',
            'required': True,
            'min': 0,
            'max': 10000,
            'unit': 'MPa',
            'label': 'å‹åŠ›'
        },
        'x_ch4': {
            'type': 'number',
            'required': False,
            'min': 0,
            'max': 1,
            'label': 'CHâ‚„ æ‘©å°”åˆ†æ•°'
        },
        'x_c2h6': {
            'type': 'number',
            'required': False,
            'min': 0,
            'max': 1,
            'label': 'Câ‚‚Hâ‚† æ‘©å°”åˆ†æ•°'
        }
    }
```

### 8.4 é…ç½®æ¨¡å— (backend/config.py)

```python
"""
Shared configuration helpers.
"""

import os
from pathlib import Path

BASE_DIR = Path(__file__).resolve().parent.parent


def _get_env_path(var_name: str, default_name: str) -> str:
    value = os.getenv(var_name)
    if value:
        return value
    return str(BASE_DIR / default_name)


def ensure_parent_dir(path: str) -> None:
    parent = os.path.dirname(path)
    if parent:
        os.makedirs(parent, exist_ok=True)


def get_database_path() -> str:
    path = _get_env_path("DATABASE_PATH", "gas_data.db")
    ensure_parent_dir(path)
    return path


def get_security_db_path() -> str:
    path = _get_env_path("SECURITY_DB_PATH", "security.db")
    ensure_parent_dir(path)
    return path


def get_database_url() -> str:
    return os.getenv("DATABASE_URL", "").strip()


def get_security_database_url() -> str:
    value = os.getenv("SECURITY_DATABASE_URL", "").strip()
    if value:
        return value
    return get_database_url()


def get_backup_dir() -> str:
    path = _get_env_path("BACKUP_DIR", "backups")
    return path


def get_cors_origins() -> list:
    raw = os.getenv("CORS_ORIGINS", "")
    if not raw:
        return []
    return [origin.strip() for origin in raw.split(",") if origin.strip()]
```

---

## åã€ç”¨æˆ·å‰ç«¯å®Œæ•´ä»£ç 

### 10.1 ç”¨æˆ·æŸ¥è¯¢é¡µé¢ (frontend/index.html)

```html
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ°”ä½“æ°´åˆç‰©ç›¸å¹³è¡¡æŸ¥è¯¢ç³»ç»Ÿ</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: linear-gradient(135deg, #0c1929 0%, #1a2940 50%, #0d2137 100%);
            min-height: 100vh;
            color: #e2e8f0;
        }
        .container { max-width: 800px; margin: 0 auto; padding: 40px 20px; }
        header { text-align: center; margin-bottom: 30px; }
        h1 {
            font-size: 28px;
            background: linear-gradient(135deg, #60a5fa, #34d399);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 8px;
        }
        .subtitle { color: #94a3b8; font-size: 14px; }
        .card {
            background: rgba(30, 41, 59, 0.8);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 20px;
            border: 1px solid rgba(71, 85, 105, 0.5);
            backdrop-filter: blur(10px);
        }
        .card-title {
            display: flex; align-items: center; gap: 10px;
            margin-bottom: 20px; font-size: 16px; color: #f1f5f9;
        }
        .card-title .step {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white; width: 28px; height: 28px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 14px; font-weight: 600;
        }
        .component-buttons { display: flex; flex-wrap: wrap; gap: 10px; }
        .comp-btn {
            padding: 10px 18px;
            background: rgba(15, 23, 42, 0.6);
            border: 2px solid #334155;
            border-radius: 10px;
            color: #94a3b8;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
        }
        .comp-btn:hover:not(.disabled) { border-color: #3b82f6; color: #f1f5f9; }
        .comp-btn.selected {
            background: rgba(59, 130, 246, 0.2);
            border-color: #3b82f6; color: #60a5fa;
        }
        .comp-btn.disabled { opacity: 0.3; cursor: not-allowed; }
        .selected-tags { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 15px; min-height: 40px; }
        .tag {
            display: flex; align-items: center; gap: 10px;
            padding: 8px 12px 8px 16px; border-radius: 25px;
            font-size: 14px; font-weight: 500;
        }
        .tag .remove-btn {
            width: 20px; height: 20px; border-radius: 50%;
            background: rgba(255,255,255,0.2); border: none;
            color: white; cursor: pointer;
        }
        .btn-confirm {
            width: 100%; padding: 14px;
            background: linear-gradient(135deg, #10b981, #059669);
            border: none; border-radius: 10px;
            color: white; font-size: 16px; font-weight: 600;
            cursor: pointer; transition: all 0.2s; margin-top: 20px;
        }
        .btn-confirm:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(16, 185, 129, 0.4);
        }
        .btn-confirm:disabled { background: #475569; cursor: not-allowed; }
        .range-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 12px 16px; background: rgba(15, 23, 42, 0.6);
            border-radius: 10px; margin-bottom: 10px;
        }
        .range-item .range-value { font-size: 16px; font-weight: 600; color: #34d399; }
        .temp-input-group { display: flex; align-items: center; gap: 12px; }
        .temp-input-group input {
            flex: 1; padding: 12px 16px;
            background: rgba(15, 23, 42, 0.8);
            border: 1px solid #334155; border-radius: 8px;
            color: #f1f5f9; font-size: 16px;
        }
        .btn-query {
            width: 100%; padding: 16px;
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            border: none; border-radius: 12px;
            color: white; font-size: 18px; font-weight: 600;
            cursor: pointer; margin-top: 20px;
        }
        .btn-query:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(59, 130, 246, 0.4);
        }
        .result-card { display: none; }
        .result-card.show { display: block; }
        .result-success { text-align: center; padding: 30px; }
        .result-value {
            font-size: 64px; font-weight: 700;
            background: linear-gradient(135deg, #34d399, #10b981);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }
        .result-unit { font-size: 24px; color: #94a3b8; margin-bottom: 20px; }
        .result-info {
            background: rgba(15, 23, 42, 0.6);
            border-radius: 12px; padding: 20px; text-align: left;
        }
        .result-row {
            display: flex; justify-content: space-between;
            padding: 10px 0; border-bottom: 1px solid rgba(71, 85, 105, 0.3);
        }
        .color-ch4 { background: linear-gradient(135deg, #ef4444, #dc2626); }
        .color-c2h6 { background: linear-gradient(135deg, #f97316, #ea580c); }
        .color-c3h8 { background: linear-gradient(135deg, #eab308, #ca8a04); }
        .color-co2 { background: linear-gradient(135deg, #22c55e, #16a34a); }
        .color-n2 { background: linear-gradient(135deg, #06b6d4, #0891b2); }
        .color-h2s { background: linear-gradient(135deg, #8b5cf6, #7c3aed); }
        .color-ic4h10 { background: linear-gradient(135deg, #ec4899, #db2777); }
        .dot-ch4 { background: #ef4444; }
        .dot-c2h6 { background: #f97316; }
        .dot-c3h8 { background: #eab308; }
        .dot-co2 { background: #22c55e; }
        .dot-n2 { background: #06b6d4; }
        .dot-h2s { background: #8b5cf6; }
        .dot-ic4h10 { background: #ec4899; }
        footer { text-align: center; margin-top: 40px; color: #475569; font-size: 12px; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>âš—ï¸ æ°”ä½“æ°´åˆç‰©ç›¸å¹³è¡¡æŸ¥è¯¢</h1>
            <p class="subtitle">Gas Hydrate Phase Equilibrium Query System</p>
        </header>

        <div class="card">
            <div class="card-title">
                <span class="step">1</span>
                <span>é€‰æ‹©æ°”ä½“ç»„åˆ†</span>
            </div>
            <div class="component-buttons" id="componentButtons"></div>
            <div class="selected-tags" id="selectedTags"></div>
            <button class="btn-confirm" id="confirmBtn" onclick="confirmComponents()" disabled>
                âœ“ ç¡®è®¤ç»„åˆ†ç»„åˆ
            </button>
        </div>

        <div class="card" id="rangeCard" style="display: none;">
            <div class="card-title">
                <span class="step">2</span>
                <span>æ•°æ®åº“ä¸­çš„ç»„åˆ†åŒºé—´</span>
            </div>
            <div class="range-display" id="rangeDisplay"></div>
            <div class="match-stats" id="matchStats"></div>
        </div>

        <div class="card" id="queryCard" style="display: none;">
            <div class="card-title">
                <span class="step">3</span>
                <span>è¾“å…¥æ¸©åº¦å¹¶æŸ¥è¯¢</span>
            </div>
            <div class="temp-input-group">
                <label>æ¸©åº¦</label>
                <input type="number" id="temperature" placeholder="ä¾‹å¦‚: 275" step="0.1">
                <span class="unit">K</span>
            </div>
            <button class="btn-query" onclick="doQuery()">ğŸ” æŸ¥è¯¢ç›¸å¹³è¡¡å‹åŠ›</button>
        </div>

        <div class="card result-card" id="resultCard">
            <div id="resultContent"></div>
        </div>

        <footer>Â© 2024 Gas Hydrate Database</footer>
    </div>

    <script>
        const COMPONENTS = {
            'x_ch4': { name: 'ç”²çƒ·', formula: 'CHâ‚„', color: 'color-ch4', dot: 'dot-ch4' },
            'x_c2h6': { name: 'ä¹™çƒ·', formula: 'Câ‚‚Hâ‚†', color: 'color-c2h6', dot: 'dot-c2h6' },
            'x_c3h8': { name: 'ä¸™çƒ·', formula: 'Câ‚ƒHâ‚ˆ', color: 'color-c3h8', dot: 'dot-c3h8' },
            'x_co2': { name: 'äºŒæ°§åŒ–ç¢³', formula: 'COâ‚‚', color: 'color-co2', dot: 'dot-co2' },
            'x_n2': { name: 'æ°®æ°”', formula: 'Nâ‚‚', color: 'color-n2', dot: 'dot-n2' },
            'x_h2s': { name: 'ç¡«åŒ–æ°¢', formula: 'Hâ‚‚S', color: 'color-h2s', dot: 'dot-h2s' },
            'x_ic4h10': { name: 'å¼‚ä¸çƒ·', formula: 'i-Câ‚„Hâ‚â‚€', color: 'color-ic4h10', dot: 'dot-ic4h10' }
        };

        const API_BASE = '/api';
        let selectedComponents = [];
        let availableComponents = Object.keys(COMPONENTS);
        let componentRanges = {};

        document.addEventListener('DOMContentLoaded', () => { renderComponentButtons(); });

        function renderComponentButtons() {
            const container = document.getElementById('componentButtons');
            container.innerHTML = '';
            Object.entries(COMPONENTS).forEach(([key, comp]) => {
                const btn = document.createElement('button');
                btn.className = 'comp-btn';
                btn.dataset.comp = key;
                const isSelected = selectedComponents.includes(key);
                const isAvailable = availableComponents.includes(key);
                if (isSelected) btn.classList.add('selected');
                if (!isAvailable && !isSelected) btn.classList.add('disabled');
                btn.innerHTML = `${comp.name} <span class="formula">${comp.formula}</span>`;
                btn.onclick = () => toggleComponent(key);
                container.appendChild(btn);
            });
            renderSelectedTags();
            updateConfirmButton();
        }

        function renderSelectedTags() {
            const container = document.getElementById('selectedTags');
            container.innerHTML = '';
            if (selectedComponents.length === 0) {
                container.innerHTML = '<span style="color: #64748b;">å°šæœªé€‰æ‹©ä»»ä½•ç»„åˆ†</span>';
                return;
            }
            selectedComponents.forEach(key => {
                const comp = COMPONENTS[key];
                const tag = document.createElement('div');
                tag.className = `tag ${comp.color}`;
                tag.innerHTML = `<span>${comp.name} (${comp.formula})</span>
                    <button class="remove-btn" onclick="removeComponent('${key}')">âœ•</button>`;
                container.appendChild(tag);
            });
        }

        function updateConfirmButton() {
            document.getElementById('confirmBtn').disabled = selectedComponents.length === 0;
        }

        async function toggleComponent(key) {
            if (selectedComponents.includes(key)) { removeComponent(key); return; }
            if (!availableComponents.includes(key)) return;
            selectedComponents.push(key);
            await updateAvailableComponents();
            renderComponentButtons();
            document.getElementById('rangeCard').style.display = 'none';
            document.getElementById('queryCard').style.display = 'none';
        }

        async function removeComponent(key) {
            selectedComponents = selectedComponents.filter(k => k !== key);
            await updateAvailableComponents();
            renderComponentButtons();
            document.getElementById('rangeCard').style.display = 'none';
            document.getElementById('queryCard').style.display = 'none';
        }

        async function updateAvailableComponents() {
            if (selectedComponents.length === 0) {
                availableComponents = Object.keys(COMPONENTS);
                return;
            }
            try {
                const res = await fetch(`${API_BASE}/components/available`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ selected: selectedComponents })
                });
                const data = await res.json();
                if (data.success) availableComponents = data.available;
            } catch (e) { console.error(e); }
        }

        async function confirmComponents() {
            if (selectedComponents.length === 0) return;
            try {
                const res = await fetch(`${API_BASE}/components/ranges`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ components: selectedComponents })
                });
                const data = await res.json();
                if (data.success) {
                    componentRanges = data.ranges;
                    displayRanges(data);
                    document.getElementById('rangeCard').style.display = 'block';
                    document.getElementById('queryCard').style.display = data.total_records > 0 ? 'block' : 'none';
                }
            } catch (e) { alert('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•'); }
        }

        function displayRanges(data) {
            const rangeContainer = document.getElementById('rangeDisplay');
            rangeContainer.innerHTML = '';
            selectedComponents.forEach(key => {
                const comp = COMPONENTS[key];
                const range = data.ranges[key];
                const item = document.createElement('div');
                item.className = 'range-item';
                item.innerHTML = range
                    ? `<div class="comp-name"><span class="dot ${comp.dot}" style="width:10px;height:10px;border-radius:50%;"></span>
                       <span>${comp.name}</span><span style="color:#64748b;font-size:12px;">${comp.formula}</span></div>
                       <div class="range-value">${(range.min * 100).toFixed(1)}% - ${(range.max * 100).toFixed(1)}%</div>`
                    : `<div class="comp-name"><span>${comp.name}</span></div><div class="range-value" style="color:#f87171;">æ— æ•°æ®</div>`;
                rangeContainer.appendChild(item);
            });
            document.getElementById('matchStats').innerHTML = `
                <div style="text-align:center;"><div style="font-size:24px;font-weight:700;color:#60a5fa;">${data.total_records}</div>
                <div style="font-size:12px;color:#94a3b8;">åŒ¹é…è®°å½•æ•°</div></div>`;
        }

        async function doQuery() {
            const temperature = parseFloat(document.getElementById('temperature').value);
            if (!temperature || temperature < 100 || temperature > 400) {
                showError('è¯·è¾“å…¥æœ‰æ•ˆçš„æ¸©åº¦ï¼ˆ100-400 Kï¼‰'); return;
            }
            try {
                const res = await fetch(`${API_BASE}/query/by-components`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ components: selectedComponents, temperature: temperature })
                });
                const data = await res.json();
                if (data.success && data.data) showResult(data.data, temperature);
                else showNoData(data.message);
            } catch (error) { showError('æŸ¥è¯¢å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•'); }
        }

        function showResult(result, queryTemp) {
            const compInfo = selectedComponents.map(k => COMPONENTS[k].formula).join(' + ');
            document.getElementById('resultContent').innerHTML = `
                <div class="result-success">
                    <div class="result-value">${result.pressure.toFixed(3)}</div>
                    <div class="result-unit">MPa</div>
                    <div class="result-info">
                        <div class="result-row"><span>æ°”ä½“ç»„åˆ†</span><span>${compInfo}</span></div>
                        <div class="result-row"><span>æŸ¥è¯¢æ¸©åº¦</span><span>${queryTemp} K</span></div>
                        <div class="result-row"><span>åŒ¹é…æ¸©åº¦</span><span>${result.temperature.toFixed(2)} K</span></div>
                    </div>
                </div>`;
            document.getElementById('resultCard').classList.add('show');
        }

        function showNoData(message) {
            document.getElementById('resultContent').innerHTML = `
                <div style="text-align:center;padding:40px;">
                    <div style="font-size:60px;">ğŸ”</div>
                    <div style="font-size:18px;">æœªæ‰¾åˆ°åŒ¹é…æ•°æ®</div>
                    <div style="color:#94a3b8;">${message || 'è¯·å°è¯•è°ƒæ•´æ¸©åº¦'}</div>
                </div>`;
            document.getElementById('resultCard').classList.add('show');
        }

        function showError(msg) {
            document.getElementById('resultContent').innerHTML = `
                <div style="text-align:center;padding:40px;">
                    <div style="font-size:60px;">âš ï¸</div><div style="font-size:18px;">${msg}</div>
                </div>`;
            document.getElementById('resultCard').classList.add('show');
        }
    </script>
</body>
</html>
```

---

## åä¸€ã€å‰ç«¯ Vue åº”ç”¨å®Œæ•´ä»£ç 

### 11.1 Vue 3 åº”ç”¨ (frontend/js/app.js)

```javascript
/**
 * æ°”ä½“æ··åˆç‰©æ•°æ®ç®¡ç†ç³»ç»Ÿ - Vue 3 å‰ç«¯åº”ç”¨
 * å‰åç«¯åˆ†ç¦»æ¶æ„ v2.0
 */

const { createApp, ref, reactive, computed, onMounted, watch, nextTick } = Vue;
const API_BASE = '/api';

Chart.defaults.color = '#8899a8';
Chart.defaults.borderColor = '#253041';

const app = createApp({
    setup() {
        const loading = ref(true);
        const importing = ref(false);
        const records = ref([]);
        const showCharts = ref(false);
        const statistics = ref({
            total_records: 0, min_temperature: 0, max_temperature: 0,
            avg_temperature: 0, min_pressure: 0, max_pressure: 0, avg_pressure: 0
        });
        
        let tempChart = null, pressureChart = null, scatterChart = null;
        
        const pagination = reactive({ page: 1, perPage: 15, total: 0, totalPages: 1 });
        const filters = reactive({ tempMin: '', tempMax: '', pressureMin: '', pressureMax: '' });
        const modal = reactive({ show: false, title: 'æ·»åŠ æ•°æ®', editId: null });
        const form = reactive({
            temperature: '', pressure: '',
            x_ch4: 0, x_c2h6: 0, x_c3h8: 0, x_co2: 0, x_n2: 0, x_h2s: 0, x_ic4h10: 0
        });
        const toasts = ref([]);

        async function fetchRecords() {
            loading.value = true;
            try {
                const params = new URLSearchParams({ page: pagination.page, per_page: pagination.perPage });
                if (filters.tempMin) params.append('temp_min', filters.tempMin);
                if (filters.tempMax) params.append('temp_max', filters.tempMax);
                if (filters.pressureMin) params.append('pressure_min', filters.pressureMin);
                if (filters.pressureMax) params.append('pressure_max', filters.pressureMax);
                
                const response = await fetch(`${API_BASE}/records?${params}`);
                const data = await response.json();
                records.value = data.records;
                pagination.total = data.total;
                pagination.totalPages = data.total_pages;
            } catch (error) {
                showToast('è·å–æ•°æ®å¤±è´¥: ' + error.message, 'error');
            } finally {
                loading.value = false;
            }
        }
        
        async function fetchStatistics() {
            try {
                const response = await fetch(`${API_BASE}/statistics`);
                const data = await response.json();
                Object.assign(statistics.value, data);
            } catch (error) {
                console.error('è·å–ç»Ÿè®¡ä¿¡æ¯å¤±è´¥:', error);
            }
        }
        
        async function createRecord() {
            try {
                const response = await fetch(`${API_BASE}/records`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        temperature: parseFloat(form.temperature),
                        pressure: parseFloat(form.pressure),
                        x_ch4: parseFloat(form.x_ch4) || 0,
                        x_c2h6: parseFloat(form.x_c2h6) || 0,
                        x_c3h8: parseFloat(form.x_c3h8) || 0,
                        x_co2: parseFloat(form.x_co2) || 0,
                        x_n2: parseFloat(form.x_n2) || 0,
                        x_h2s: parseFloat(form.x_h2s) || 0,
                        x_ic4h10: parseFloat(form.x_ic4h10) || 0
                    })
                });
                const result = await response.json();
                if (response.ok) {
                    showToast('æ·»åŠ æˆåŠŸ', 'success');
                    closeModal(); fetchRecords(); fetchStatistics();
                    if (showCharts.value) loadCharts();
                } else {
                    showToast(result.detail || 'æ·»åŠ å¤±è´¥', 'error');
                }
            } catch (error) {
                showToast('ç½‘ç»œé”™è¯¯: ' + error.message, 'error');
            }
        }
        
        async function updateRecord() {
            try {
                const response = await fetch(`${API_BASE}/records/${modal.editId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        temperature: parseFloat(form.temperature),
                        pressure: parseFloat(form.pressure),
                        x_ch4: parseFloat(form.x_ch4) || 0,
                        x_c2h6: parseFloat(form.x_c2h6) || 0,
                        x_c3h8: parseFloat(form.x_c3h8) || 0,
                        x_co2: parseFloat(form.x_co2) || 0,
                        x_n2: parseFloat(form.x_n2) || 0,
                        x_h2s: parseFloat(form.x_h2s) || 0,
                        x_ic4h10: parseFloat(form.x_ic4h10) || 0
                    })
                });
                const result = await response.json();
                if (response.ok) {
                    showToast('æ›´æ–°æˆåŠŸ', 'success');
                    closeModal(); fetchRecords(); fetchStatistics();
                    if (showCharts.value) loadCharts();
                } else {
                    showToast(result.detail || 'æ›´æ–°å¤±è´¥', 'error');
                }
            } catch (error) {
                showToast('ç½‘ç»œé”™è¯¯: ' + error.message, 'error');
            }
        }
        
        async function deleteRecord(id) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡è®°å½•å—ï¼Ÿ')) return;
            try {
                const response = await fetch(`${API_BASE}/records/${id}`, { method: 'DELETE' });
                if (response.ok) {
                    showToast('åˆ é™¤æˆåŠŸ', 'success');
                    fetchRecords(); fetchStatistics();
                    if (showCharts.value) loadCharts();
                } else {
                    const result = await response.json();
                    showToast(result.detail || 'åˆ é™¤å¤±è´¥', 'error');
                }
            } catch (error) {
                showToast('ç½‘ç»œé”™è¯¯: ' + error.message, 'error');
            }
        }

        function toggleCharts() {
            showCharts.value = !showCharts.value;
            if (showCharts.value) nextTick(() => loadCharts());
        }
        
        async function loadCharts() {
            try {
                const tempResponse = await fetch(`${API_BASE}/chart/temperature`);
                const tempData = await tempResponse.json();
                renderBarChart('tempChart', tempData, 'rgba(255, 153, 64, 0.8)', tempChart, (c) => { tempChart = c; });
                
                const pressureResponse = await fetch(`${API_BASE}/chart/pressure`);
                const pressureData = await pressureResponse.json();
                renderBarChart('pressureChart', pressureData, 'rgba(61, 158, 255, 0.8)', pressureChart, (c) => { pressureChart = c; });
                
                const scatterResponse = await fetch(`${API_BASE}/chart/scatter`);
                const scatterData = await scatterResponse.json();
                renderScatterChart('scatterChart', scatterData);
            } catch (error) {
                console.error('åŠ è½½å›¾è¡¨å¤±è´¥:', error);
            }
        }
        
        function renderBarChart(canvasId, data, color, existingChart, setChart) {
            const ctx = document.getElementById(canvasId);
            if (!ctx) return;
            if (existingChart) existingChart.destroy();
            
            const chart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.labels,
                    datasets: [{
                        label: data.title, data: data.data,
                        backgroundColor: color, borderColor: color.replace('0.8', '1'),
                        borderWidth: 1, borderRadius: 6
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.05)' } },
                        x: { grid: { display: false } }
                    }
                }
            });
            setChart(chart);
        }
        
        function renderScatterChart(canvasId, data) {
            const ctx = document.getElementById(canvasId);
            if (!ctx) return;
            if (scatterChart) scatterChart.destroy();
            
            scatterChart = new Chart(ctx, {
                type: 'scatter',
                data: {
                    datasets: [{
                        label: 'æ¸©åº¦-å‹åŠ›', data: data.data,
                        backgroundColor: 'rgba(0, 212, 170, 0.6)',
                        borderColor: 'rgba(0, 212, 170, 1)',
                        pointRadius: 5, pointHoverRadius: 8
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: (context) => `æ¸©åº¦: ${context.parsed.x.toFixed(1)}K, å‹åŠ›: ${context.parsed.y.toFixed(2)}MPa`
                            }
                        }
                    },
                    scales: {
                        x: { title: { display: true, text: 'æ¸©åº¦ (K)', color: '#8899a8' }, grid: { color: 'rgba(255,255,255,0.05)' } },
                        y: { title: { display: true, text: 'å‹åŠ› (MPa)', color: '#8899a8' }, grid: { color: 'rgba(255,255,255,0.05)' } }
                    }
                }
            });
        }

        function exportCSV() {
            window.location.href = `${API_BASE}/export/csv`;
            showToast('æ­£åœ¨ä¸‹è½½ CSV æ–‡ä»¶...', 'success');
        }
        
        function exportExcel() {
            window.location.href = `${API_BASE}/export/excel`;
            showToast('æ­£åœ¨ä¸‹è½½ Excel æ–‡ä»¶...', 'success');
        }
        
        async function handleImport(event) {
            const file = event.target.files[0];
            if (!file) return;
            const validTypes = ['.csv', '.xlsx', '.xls'];
            const ext = file.name.toLowerCase().slice(file.name.lastIndexOf('.'));
            if (!validTypes.includes(ext)) {
                showToast('è¯·ä¸Šä¼  CSV æˆ– Excel æ–‡ä»¶', 'error');
                event.target.value = ''; return;
            }
            importing.value = true;
            try {
                const formData = new FormData();
                formData.append('file', file);
                const response = await fetch(`${API_BASE}/import`, { method: 'POST', body: formData });
                const result = await response.json();
                if (response.ok && result.success) {
                    showToast(result.message, 'success');
                    fetchRecords(); fetchStatistics();
                    if (showCharts.value) loadCharts();
                } else {
                    showToast(result.detail || result.message || 'å¯¼å…¥å¤±è´¥', 'error');
                }
            } catch (error) {
                showToast('å¯¼å…¥å¤±è´¥: ' + error.message, 'error');
            } finally {
                importing.value = false;
                event.target.value = '';
            }
        }

        function openAddModal() {
            modal.title = 'æ·»åŠ æ•°æ®'; modal.editId = null;
            resetForm(); modal.show = true;
        }
        
        async function openEditModal(id) {
            try {
                const response = await fetch(`${API_BASE}/records/${id}`);
                const record = await response.json();
                modal.title = 'ç¼–è¾‘æ•°æ®'; modal.editId = id;
                Object.assign(form, {
                    temperature: record.temperature, pressure: record.pressure,
                    x_ch4: record.x_ch4, x_c2h6: record.x_c2h6, x_c3h8: record.x_c3h8,
                    x_co2: record.x_co2, x_n2: record.x_n2, x_h2s: record.x_h2s, x_ic4h10: record.x_ic4h10
                });
                modal.show = true;
            } catch (error) {
                showToast('è·å–è®°å½•å¤±è´¥', 'error');
            }
        }
        
        function closeModal() { modal.show = false; }
        function resetForm() {
            Object.assign(form, {
                temperature: '', pressure: '',
                x_ch4: 0, x_c2h6: 0, x_c3h8: 0, x_co2: 0, x_n2: 0, x_h2s: 0, x_ic4h10: 0
            });
        }
        
        function saveRecord() {
            if (!form.temperature || !form.pressure) {
                showToast('è¯·å¡«å†™æ¸©åº¦å’Œå‹åŠ›', 'error'); return;
            }
            modal.editId ? updateRecord() : createRecord();
        }
        
        function search() { pagination.page = 1; fetchRecords(); }
        function clearSearch() {
            Object.assign(filters, { tempMin: '', tempMax: '', pressureMin: '', pressureMax: '' });
            pagination.page = 1; fetchRecords();
        }
        function refresh() {
            fetchRecords(); fetchStatistics();
            if (showCharts.value) loadCharts();
        }
        function goToPage(page) {
            if (page < 1 || page > pagination.totalPages) return;
            pagination.page = page; fetchRecords();
        }
        
        function showToast(message, type = 'success') {
            const id = Date.now();
            toasts.value.push({ id, message, type });
            setTimeout(() => { toasts.value = toasts.value.filter(t => t.id !== id); }, 3000);
        }
        
        function formatNumber(num, decimals = 3) {
            if (num === null || num === undefined) return '0.000';
            return Number(num).toFixed(decimals);
        }
        
        const visiblePages = computed(() => {
            const pages = [];
            const current = pagination.page;
            const total = pagination.totalPages;
            let start = Math.max(1, current - 2);
            let end = Math.min(total, current + 2);
            if (end - start < 4) {
                if (start === 1) end = Math.min(total, 5);
                else start = Math.max(1, total - 4);
            }
            for (let i = start; i <= end; i++) pages.push(i);
            return pages;
        });

        onMounted(() => {
            fetchRecords(); fetchStatistics();
            document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeModal(); });
        });

        return {
            loading, importing, records, statistics, pagination, filters,
            modal, form, toasts, visiblePages, showCharts,
            fetchRecords, deleteRecord, openAddModal, openEditModal, closeModal,
            saveRecord, search, clearSearch, refresh, goToPage, formatNumber,
            toggleCharts, exportCSV, exportExcel, handleImport
        };
    }
});

app.mount('#app');
```

---

## åäºŒã€å‰ç«¯æ ·å¼ä»£ç 

### 12.1 ä¸»æ ·å¼æ–‡ä»¶ (frontend/css/style.css)

```css
/* æ°”ä½“æ··åˆç‰©æ•°æ®ç®¡ç†ç³»ç»Ÿ - å‰ç«¯æ ·å¼ - æ·±è‰²ç§‘æŠ€é£ä¸»é¢˜ */

:root {
    --bg-primary: #0a0e14;
    --bg-secondary: #12171e;
    --bg-card: #161d27;
    --bg-hover: #1a222d;
    --border-color: #253041;
    --border-focus: #3d9eff;
    --text-primary: #e8eef5;
    --text-secondary: #8899a8;
    --text-muted: #5c6b7a;
    --accent-blue: #3d9eff;
    --accent-cyan: #00d4aa;
    --accent-orange: #ff9940;
    --accent-red: #ff5555;
    --accent-purple: #b794f6;
    --gradient-blue: linear-gradient(135deg, #3d9eff 0%, #0066cc 100%);
    --gradient-cyan: linear-gradient(135deg, #00d4aa 0%, #00a885 100%);
    --shadow-glow: 0 0 30px rgba(61, 158, 255, 0.15);
    --shadow-card: 0 4px 20px rgba(0, 0, 0, 0.3);
    --font-mono: 'Fira Code', 'JetBrains Mono', 'Consolas', monospace;
    --font-sans: 'Inter', 'Noto Sans SC', -apple-system, sans-serif;
}

* { margin: 0; padding: 0; box-sizing: border-box; }

body {
    font-family: var(--font-sans);
    background: var(--bg-primary);
    color: var(--text-primary);
    min-height: 100vh;
    line-height: 1.6;
    background-image: 
        radial-gradient(ellipse at 20% 0%, rgba(61, 158, 255, 0.08) 0%, transparent 50%),
        radial-gradient(ellipse at 80% 100%, rgba(0, 212, 170, 0.06) 0%, transparent 50%);
}

#app { max-width: 1440px; margin: 0 auto; padding: 30px 40px; }

/* Header */
.header {
    display: flex; justify-content: space-between; align-items: center;
    margin-bottom: 35px; padding-bottom: 25px; border-bottom: 1px solid var(--border-color);
}

.logo { display: flex; align-items: center; gap: 16px; }

.logo-icon {
    width: 52px; height: 52px; background: var(--gradient-blue);
    border-radius: 14px; display: flex; align-items: center; justify-content: center;
    font-size: 26px; box-shadow: var(--shadow-glow);
}

.logo-text h1 {
    font-size: 24px; font-weight: 700; letter-spacing: -0.5px;
    background: linear-gradient(135deg, var(--text-primary) 0%, var(--accent-blue) 100%);
    -webkit-background-clip: text; -webkit-text-fill-color: transparent;
}

.logo-text p { font-size: 13px; color: var(--text-secondary); }
.header-actions { display: flex; gap: 12px; }

/* Buttons */
.btn {
    padding: 11px 22px; border: none; border-radius: 10px;
    font-size: 14px; font-weight: 600; cursor: pointer;
    transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
    display: inline-flex; align-items: center; gap: 8px;
}

.btn-primary {
    background: var(--gradient-blue); color: white;
    box-shadow: 0 4px 15px rgba(61, 158, 255, 0.3);
}

.btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 25px rgba(61, 158, 255, 0.4);
}

.btn-secondary {
    background: var(--bg-card); color: var(--text-primary);
    border: 1px solid var(--border-color);
}

.btn-secondary:hover { background: var(--bg-hover); border-color: var(--accent-blue); }

.btn-danger {
    background: transparent; color: var(--accent-red);
    border: 1px solid var(--accent-red); padding: 7px 12px;
}

.btn-danger:hover { background: var(--accent-red); color: white; }

.btn-success {
    background: var(--gradient-cyan); color: var(--bg-primary); font-weight: 700;
}

/* Stats Cards */
.stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 30px; }

.stat-card {
    background: var(--bg-card); border: 1px solid var(--border-color);
    border-radius: 16px; padding: 22px; position: relative; overflow: hidden;
    transition: all 0.3s ease;
}

.stat-card:hover { transform: translateY(-3px); box-shadow: var(--shadow-card); }

.stat-card::before {
    content: ''; position: absolute; top: 0; left: 0; right: 0; height: 3px;
}

.stat-card:nth-child(1)::before { background: var(--gradient-blue); }
.stat-card:nth-child(2)::before { background: var(--accent-orange); }
.stat-card:nth-child(3)::before { background: var(--gradient-cyan); }
.stat-card:nth-child(4)::before { background: var(--accent-purple); }

.stat-icon { font-size: 20px; margin-bottom: 12px; }
.stat-label { font-size: 13px; color: var(--text-secondary); margin-bottom: 8px; font-weight: 500; }
.stat-value { font-size: 28px; font-weight: 700; font-family: var(--font-mono); color: var(--text-primary); }
.stat-unit { font-size: 14px; color: var(--text-muted); margin-left: 4px; }

/* Table */
.table-container {
    background: var(--bg-card); border: 1px solid var(--border-color);
    border-radius: 16px; overflow: hidden; box-shadow: var(--shadow-card);
}

.data-table { width: 100%; border-collapse: collapse; }
.data-table thead { background: var(--bg-secondary); }

.data-table th {
    padding: 16px 18px; text-align: left; font-size: 12px; font-weight: 700;
    color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.8px;
    border-bottom: 1px solid var(--border-color);
}

.data-table td {
    padding: 14px 18px; font-size: 14px; border-bottom: 1px solid var(--border-color);
    font-family: var(--font-mono); color: var(--text-primary);
}

.data-table tbody tr { transition: background 0.2s; }
.data-table tbody tr:hover { background: rgba(61, 158, 255, 0.05); }

.cell-temp { color: var(--accent-orange); font-weight: 600; }
.cell-pressure { color: var(--accent-blue); font-weight: 600; }

/* Pagination */
.pagination {
    display: flex; justify-content: center; align-items: center;
    gap: 8px; margin-top: 28px;
}

.pagination button {
    min-width: 38px; height: 38px; border: 1px solid var(--border-color);
    background: var(--bg-card); color: var(--text-primary); border-radius: 10px;
    cursor: pointer; transition: all 0.2s; font-family: var(--font-mono);
}

.pagination button:hover:not(:disabled) {
    border-color: var(--accent-blue); color: var(--accent-blue);
    background: rgba(61, 158, 255, 0.1);
}

.pagination button:disabled { opacity: 0.35; cursor: not-allowed; }
.pagination button.active { background: var(--gradient-blue); color: white; border-color: transparent; }

/* Modal */
.modal-overlay {
    position: fixed; top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0, 0, 0, 0.75); backdrop-filter: blur(6px); z-index: 1000;
    display: flex; justify-content: center; align-items: center;
    opacity: 0; visibility: hidden; transition: all 0.3s ease;
}

.modal-overlay.active { opacity: 1; visibility: visible; }

.modal {
    background: var(--bg-card); border: 1px solid var(--border-color);
    border-radius: 20px; width: 90%; max-width: 620px; max-height: 90vh; overflow-y: auto;
    transform: translateY(-20px) scale(0.95);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    box-shadow: 0 25px 80px rgba(0, 0, 0, 0.5);
}

.modal-overlay.active .modal { transform: translateY(0) scale(1); }

.modal-header {
    padding: 22px 28px; border-bottom: 1px solid var(--border-color);
    display: flex; justify-content: space-between; align-items: center;
}

.modal-header h2 { font-size: 20px; font-weight: 700; }

.modal-close {
    width: 36px; height: 36px; border: none; background: var(--bg-secondary);
    color: var(--text-secondary); cursor: pointer; border-radius: 10px; font-size: 20px;
}

.modal-close:hover { background: var(--accent-red); color: white; }
.modal-body { padding: 28px; }
.form-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; }
.form-group { display: flex; flex-direction: column; gap: 8px; }
.form-group.full-width { grid-column: span 2; }
.form-group label { font-size: 13px; color: var(--text-secondary); font-weight: 600; }

.form-group input {
    padding: 14px 16px; background: var(--bg-primary); border: 1px solid var(--border-color);
    border-radius: 10px; color: var(--text-primary); font-size: 15px;
    font-family: var(--font-mono); transition: all 0.2s;
}

.form-group input:focus {
    outline: none; border-color: var(--border-focus);
    box-shadow: 0 0 0 4px rgba(61, 158, 255, 0.15);
}

.modal-footer {
    padding: 20px 28px; border-top: 1px solid var(--border-color);
    display: flex; justify-content: flex-end; gap: 12px;
}

/* Toast */
.toast-container {
    position: fixed; top: 24px; right: 24px; z-index: 2000;
    display: flex; flex-direction: column; gap: 12px;
}

.toast {
    padding: 16px 22px; background: var(--bg-card); border: 1px solid var(--border-color);
    border-radius: 12px; display: flex; align-items: center; gap: 14px;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.4);
    animation: toastIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
}

@keyframes toastIn {
    from { opacity: 0; transform: translateX(100px); }
    to { opacity: 1; transform: translateX(0); }
}

.toast.success { border-left: 4px solid var(--accent-cyan); }
.toast.error { border-left: 4px solid var(--accent-red); }

/* Charts */
.charts-section { margin-bottom: 30px; animation: fadeIn 0.3s ease; }
@keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

.charts-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; }

.chart-card {
    background: var(--bg-card); border: 1px solid var(--border-color);
    border-radius: 16px; padding: 20px; box-shadow: var(--shadow-card);
}

.chart-card h3 { font-size: 14px; font-weight: 600; color: var(--text-secondary); margin-bottom: 15px; }
.chart-card canvas { max-height: 250px; }
.chart-wide { grid-column: span 2; }
.chart-wide canvas { max-height: 300px; }

/* Loading */
.loading { display: flex; justify-content: center; align-items: center; padding: 60px; }

.spinner {
    width: 42px; height: 42px; border: 3px solid var(--border-color);
    border-top-color: var(--accent-blue); border-radius: 50%;
    animation: spin 0.8s linear infinite;
}

@keyframes spin { to { transform: rotate(360deg); } }

/* Responsive */
@media (max-width: 1024px) { .stats-grid { grid-template-columns: repeat(2, 1fr); } }

@media (max-width: 768px) {
    #app { padding: 20px; }
    .header { flex-direction: column; gap: 20px; text-align: center; }
    .stats-grid { grid-template-columns: 1fr; }
    .form-grid { grid-template-columns: 1fr; }
    .form-group.full-width { grid-column: span 1; }
}
```

---

## åä¸‰ã€æ•°æ®åº“è¿ç§»è„šæœ¬

### 13.1 è¿ç§»è„šæœ¬ (scripts/migrate_db.py)

```python
#!/usr/bin/env python3
"""Apply versioned SQL migrations for gas/security databases."""

from __future__ import annotations
import argparse
from pathlib import Path

from backend.db import (
    get_connection, get_security_connection, is_mysql, is_security_mysql
)

BASE_DIR = Path(__file__).resolve().parent.parent
MIGRATIONS_DIR = BASE_DIR / "migrations"


def split_sql(sql: str) -> list[str]:
    statements: list[str] = []
    current: list[str] = []
    for line in sql.splitlines():
        stripped = line.strip()
        if not stripped or stripped.startswith("--"):
            continue
        current.append(stripped)
        if stripped.endswith(";"):
            stmt = " ".join(current).rstrip(";").strip()
            if stmt:
                statements.append(stmt)
            current = []
    if current:
        stmt = " ".join(current).strip()
        if stmt:
            statements.append(stmt)
    return statements


def ensure_schema_table(cursor) -> None:
    cursor.execute("""
        CREATE TABLE IF NOT EXISTS schema_migrations (
            version VARCHAR(64) PRIMARY KEY,
            applied_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
        )
    """)


def get_applied_versions(cursor) -> set[str]:
    cursor.execute("SELECT version FROM schema_migrations")
    rows = cursor.fetchall()
    return {row["version"] for row in rows}


def apply_migrations(name: str, migration_path: Path, conn_factory) -> None:
    if not migration_path.exists():
        raise RuntimeError(f"Missing migrations directory: {migration_path}")

    with conn_factory(dict_cursor=True) as conn:
        cursor = conn.cursor()
        ensure_schema_table(cursor)
        conn.commit()

        applied = get_applied_versions(cursor)
        files = sorted(migration_path.glob("*.sql"))
        if not files:
            print(f"[migrate] {name}: no migration files found")
            return

        for file in files:
            version = file.stem
            if version in applied:
                continue
            sql = file.read_text()
            for statement in split_sql(sql):
                cursor.execute(statement)
            cursor.execute(
                "INSERT INTO schema_migrations (version) VALUES (?)",
                (version,),
            )
            conn.commit()
            print(f"[migrate] {name}: applied {version}")


def main() -> None:
    parser = argparse.ArgumentParser(description="Apply database migrations.")
    parser.add_argument(
        "--target", choices=("gas", "security", "all"), default="all",
        help="Which database to migrate"
    )
    args = parser.parse_args()

    if args.target in ("gas", "all"):
        if not is_mysql():
            print("[migrate] gas: DATABASE_URL is not MySQL, skipping")
        else:
            apply_migrations("gas", MIGRATIONS_DIR / "gas", get_connection)

    if args.target in ("security", "all"):
        if not is_security_mysql():
            print("[migrate] security: SECURITY_DATABASE_URL is not MySQL, skipping")
        else:
            apply_migrations("security", MIGRATIONS_DIR / "security", get_security_connection)


if __name__ == "__main__":
    main()
```

### 13.2 æ•°æ®åº“åˆå§‹åŒ–è„šæœ¬ (init_db.py)

```python
"""æ•°æ®åº“åˆå§‹åŒ–è„šæœ¬ - ä»åŸå§‹Excelæ–‡ä»¶å¯¼å…¥æ•°æ®åˆ°SQLiteæ•°æ®åº“"""

import os
import pandas as pd
from backend.database import init_database, batch_create_records, get_statistics


def import_data_from_excel(file_path: str = "date.csv"):
    """ä»Excelæ–‡ä»¶å¯¼å…¥æ•°æ®"""
    print("="*50)
    print("   æ°”ä½“æ··åˆç‰©æ•°æ®å¯¼å…¥å·¥å…·")
    print("="*50)
    
    print("\n[1/3] åˆå§‹åŒ–æ•°æ®åº“...")
    init_database()
    
    print(f"\n[2/3] è¯»å–æ•°æ®æ–‡ä»¶: {file_path}")
    try:
        ext = os.path.splitext(file_path)[1].lower()
        if ext in [".csv", ".tsv"]:
            df = pd.read_csv(file_path)
        elif ext in [".xls", ".xlsx"]:
            df = pd.read_excel(file_path)
        else:
            raise ValueError(f"ä¸æ”¯æŒçš„æ–‡ä»¶æ ¼å¼: {ext}")
        print(f"    [OK] æˆåŠŸè¯»å– {len(df)} æ¡è®°å½•")
        print(f"    [OK] åˆ—å: {df.columns.tolist()}")
    except Exception as e:
        print(f"    [ERROR] è¯»å–æ–‡ä»¶å¤±è´¥: {e}")
        return
    
    print("\n[3/3] å¯¼å…¥æ•°æ®åˆ°æ•°æ®åº“...")
    
    column_mapping = {
        'T (K)': 'temperature', 'xCH4': 'x_ch4', 'xC2H6': 'x_c2h6',
        'xC3H8': 'x_c3h8', 'xCO2': 'x_co2', 'xN2': 'x_n2',
        'xH2S': 'x_h2s', 'x i-C4H10': 'x_ic4h10', 'p (MPa)': 'pressure'
    }
    
    records = []
    for _, row in df.iterrows():
        record = {}
        for excel_col, db_col in column_mapping.items():
            if excel_col in df.columns:
                value = row[excel_col]
                record[db_col] = 0 if pd.isna(value) else float(value)
            else:
                record[db_col] = 0
        records.append(record)
    
    try:
        count = batch_create_records(records)
        print(f"    [OK] æˆåŠŸå¯¼å…¥ {count} æ¡è®°å½•")
    except Exception as e:
        print(f"    [ERROR] å¯¼å…¥å¤±è´¥: {e}")
        return
    
    print("\n" + "="*50)
    print("   å¯¼å…¥å®Œæˆï¼æ•°æ®ç»Ÿè®¡")
    print("="*50)
    
    stats = get_statistics()
    print(f"""
    * æ€»è®°å½•æ•°: {stats.get('total_records', 0)}
    * æ¸©åº¦èŒƒå›´: {stats.get('min_temperature', 0):.2f} ~ {stats.get('max_temperature', 0):.2f} K
    * å¹³å‡æ¸©åº¦: {stats.get('avg_temperature', 0):.2f} K
    * å‹åŠ›èŒƒå›´: {stats.get('min_pressure', 0):.3f} ~ {stats.get('max_pressure', 0):.3f} MPa
    * å¹³å‡å‹åŠ›: {stats.get('avg_pressure', 0):.3f} MPa
    """)
    
    print("\n[DONE] æ•°æ®å¯¼å…¥å®Œæˆï¼è¿è¡Œ 'python -m uvicorn backend.main:app --reload' å¯åŠ¨Webåº”ç”¨")


if __name__ == "__main__":
    import_data_from_excel()
```

---

## é™„å½•ï¼šé¡¹ç›®æ–‡ä»¶ç»“æ„

```
cursor_shujuku/
â”œâ”€â”€ backend/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ main.py          # FastAPI ä¸»åº”ç”¨
â”‚   â”œâ”€â”€ database.py      # æ•°æ®åº“æ“ä½œ
â”‚   â”œâ”€â”€ db.py           # æ•°æ®åº“è¿æ¥
â”‚   â”œâ”€â”€ config.py       # é…ç½®ç®¡ç†
â”‚   â”œâ”€â”€ models.py       # æ•°æ®æ¨¡å‹
â”‚   â”œâ”€â”€ auth.py         # ç”¨æˆ·è®¤è¯
â”‚   â”œâ”€â”€ security.py     # å®‰å…¨æ¨¡å—
â”‚   â”œâ”€â”€ backup.py       # å¤‡ä»½æ¨¡å—
â”‚   â”œâ”€â”€ data_review.py  # æ•°æ®å®¡æ ¸
â”‚   â”œâ”€â”€ data_validation.py # æ•°æ®æ ¡éªŒ
â”‚   â”œâ”€â”€ totp.py         # ä¸¤æ­¥éªŒè¯
â”‚   â””â”€â”€ requirements.txt
â”œâ”€â”€ frontend/
â”‚   â”œâ”€â”€ index.html      # ç”¨æˆ·å‰ç«¯
â”‚   â”œâ”€â”€ admin/
â”‚   â”‚   â””â”€â”€ index.html  # ç®¡ç†åå°
â”‚   â”œâ”€â”€ css/
â”‚   â”‚   â””â”€â”€ style.css
â”‚   â””â”€â”€ js/
â”‚       â””â”€â”€ app.js      # Vue åº”ç”¨
â”œâ”€â”€ docs/
â”‚   â”œâ”€â”€ ç”¨æˆ·æ‰‹å†Œ.md
â”‚   â””â”€â”€ ç³»ç»Ÿä»£ç æ–‡æ¡£.md
â”œâ”€â”€ backups/            # å¤‡ä»½æ–‡ä»¶ç›®å½•
â”œâ”€â”€ gas_data.db         # ä¸»æ•°æ®åº“
â”œâ”€â”€ security.db         # å®‰å…¨æ•°æ®åº“
â”œâ”€â”€ Dockerfile
â””â”€â”€ docker-compose.yml
```

---

## ä¹ã€FastAPI ä¸»åº”ç”¨å®Œæ•´ä»£ç 

### 9.1 æ¨¡å—ç®€ä»‹

`backend/main.py` æ˜¯ç³»ç»Ÿçš„æ ¸å¿ƒå…¥å£æ–‡ä»¶ï¼Œæ•´åˆäº†æ‰€æœ‰åŠŸèƒ½æ¨¡å—ï¼Œæä¾›å®Œæ•´çš„ RESTful API æ¥å£ã€‚åŒ…å«å®‰å…¨ä¸­é—´ä»¶ã€è®¤è¯ä¾èµ–ã€æ•°æ®è®°å½• CRUDã€å›¾è¡¨æ•°æ®ã€å¯¼å…¥å¯¼å‡ºã€ç”¨æˆ·è®¤è¯ã€TOTP ä¸¤æ­¥éªŒè¯ã€ä¼šè¯ç®¡ç†ã€æ•°æ®å®¡æ ¸ã€å¤‡ä»½ç®¡ç†ç­‰å…¨éƒ¨ API ç«¯ç‚¹ã€‚

### 9.2 ä¸»åº”ç”¨ä»£ç  (backend/main.py)

```python
"""
FastAPI åç«¯æœåŠ¡
æä¾› RESTful API æ¥å£
ç‰ˆæœ¬ 4.0 - å¢å¼ºå®‰å…¨æ€§ã€æ•°æ®ç®¡ç†åŠŸèƒ½
"""

from fastapi import FastAPI, HTTPException, Query, UploadFile, File, Header, Depends, Request
from fastapi.middleware.cors import CORSMiddleware
from fastapi.staticfiles import StaticFiles
from fastapi.responses import FileResponse, StreamingResponse, Response
from typing import Optional, List
from pydantic import BaseModel
import os
import io
import csv
import tempfile
import json

from backend.models import (
    GasRecordCreate, GasRecordUpdate, GasRecord,
    PaginatedResponse, Statistics, ApiResponse
)
from backend.database import (
    create_record, delete_record, update_record,
    get_record_by_id, get_all_records, get_statistics,
    get_chart_data, batch_create_records, get_all_records_no_pagination,
    batch_delete_records, batch_update_records
)
from backend.auth import (
    authenticate_user, create_access_token, get_current_user,
    hash_password, verify_password, create_user, change_password, list_users,
    get_admin_username, is_admin_configured, is_using_default_secret_key,
    ensure_admin_user, reset_user_password
)
from backend.backup import (
    create_backup, restore_backup, list_backups, delete_backup,
    get_backup_status, init_backup_system, is_backup_supported
)
from backend.security import (
    init_security, check_rate_limit, detect_crawler, add_crawler_block,
    record_login, check_login_attempts, record_login_attempt,
    get_login_logs, create_session, validate_session, revoke_session,
    get_user_sessions, revoke_all_user_sessions, validate_password,
    get_password_policy, record_audit_log, get_audit_logs,
    record_data_history, get_data_history, get_rate_limit_status
)
from backend.data_review import (
    find_duplicate_pressure_records, move_duplicates_to_review,
    get_pending_groups, get_pending_stats, update_pending_pressure,
    approve_group, reject_group, restore_group
)
from backend.totp import (
    setup_totp, enable_totp, disable_totp, is_totp_enabled,
    verify_user_totp, get_totp_status, regenerate_backup_codes
)
from backend.data_validation import (
    validate_record, validate_batch, clean_record, clean_batch,
    validate_partial_record,
    get_validation_rules, get_field_constraints, get_soft_warnings,
    count_soft_warnings, PRESSURE_SOFT_MAX
)
from backend.config import get_backup_dir, get_cors_origins
from backend.db import get_connection

# ==================== è®¤è¯ä¾èµ– ====================

def get_token_from_header(authorization: Optional[str] = Header(None)) -> Optional[str]:
    """ä»è¯·æ±‚å¤´è·å– Token"""
    if authorization and authorization.startswith("Bearer "):
        return authorization[7:]
    return None


def require_auth(authorization: Optional[str] = Header(None)):
    """è®¤è¯ä¾èµ–é¡¹"""
    token = get_token_from_header(authorization)
    if not token:
        raise HTTPException(status_code=401, detail="æœªæä¾›è®¤è¯ä»¤ç‰Œ")

    user = get_current_user(token)
    if not user:
        raise HTTPException(status_code=401, detail="ä»¤ç‰Œæ— æ•ˆæˆ–å·²è¿‡æœŸ")

    return user

# ==================== Pydantic æ¨¡å‹ ====================

class LoginRequest(BaseModel):
    username: str
    password: str
    totp_code: Optional[str] = None

class ChangePasswordRequest(BaseModel):
    old_password: str
    new_password: str

class CreateUserRequest(BaseModel):
    username: str
    password: str
    role: str = "user"

class ResetUserPasswordRequest(BaseModel):
    new_password: str

class BatchDeleteRequest(BaseModel):
    ids: List[int]

class BatchUpdateRequest(BaseModel):
    ids: List[int]
    updates: dict

class TOTPSetupRequest(BaseModel):
    code: str

# åˆ›å»º FastAPI åº”ç”¨
app = FastAPI(
    title="æ°”ä½“æ··åˆç‰©æ•°æ®ç®¡ç†ç³»ç»Ÿ API",
    description="æä¾›æ°”ä½“æ··åˆç‰©çƒ­åŠ›å­¦æ•°æ®çš„å¢åˆ æ”¹æŸ¥åŠŸèƒ½ï¼Œå«å®‰å…¨å¢å¼º",
    version="4.0.0"
)

# è½¯æç¤ºï¼ˆä¸é˜»æ­¢å†™å…¥ï¼‰
def format_soft_warning(warnings: List[str]) -> str:
    if not warnings:
        return ""
    return f"ï¼ˆæ³¨æ„ï¼š{'; '.join(warnings)}ï¼‰"


def format_soft_warning_count(count: int) -> str:
    if count <= 0:
        return ""
    return f"ï¼ˆæ³¨æ„ï¼š{count} æ¡è®°å½•å‹åŠ›é«˜äº {PRESSURE_SOFT_MAX:.0f} MPaï¼Œå¯èƒ½ä¸ºå¼‚å¸¸å€¼ï¼‰"

# é…ç½®è·¨åŸŸ (CORS) - å…è®¸å‰ç«¯è®¿é—®
cors_origins = get_cors_origins()
app.add_middleware(
    CORSMiddleware,
    allow_origins=cors_origins,
    allow_credentials=bool(cors_origins),
    allow_methods=["*"],
    allow_headers=["*"],
)


# ==================== å®‰å…¨ä¸­é—´ä»¶ ====================

@app.middleware("http")
async def security_middleware(request: Request, call_next):
    """å®‰å…¨ä¸­é—´ä»¶ - APIé™æµ + é˜²çˆ¬è™«"""
    client_ip = request.client.host if request.client else "unknown"
    user_agent = request.headers.get("user-agent", "")
    path = request.url.path
    
    whitelist_paths = ["/", "/admin", "/docs", "/openapi.json", "/css/", "/js/"]
    is_whitelisted = any(path.startswith(p) for p in whitelist_paths)
    
    if not is_whitelisted and path.startswith("/api/"):
        allowed, error_msg = check_rate_limit(client_ip)
        if not allowed:
            return Response(
                content=json.dumps({"detail": error_msg, "error_code": "RATE_LIMITED"}),
                status_code=429,
                media_type="application/json"
            )
        
        is_crawler, crawler_reason = detect_crawler(user_agent, path, client_ip)
        if is_crawler:
            add_crawler_block(client_ip, crawler_reason)
            return Response(
                content=json.dumps({"detail": "è®¿é—®è¢«æ‹’ç»", "error_code": "BLOCKED"}),
                status_code=403,
                media_type="application/json"
            )
    
    response = await call_next(request)
    
    response.headers["X-Content-Type-Options"] = "nosniff"
    response.headers["X-Frame-Options"] = "DENY"
    response.headers["X-XSS-Protection"] = "1; mode=block"
    response.headers["Cache-Control"] = "no-store"
    
    return response

# å‰ç«¯é™æ€æ–‡ä»¶ç›®å½•
CURRENT_DIR = os.path.dirname(os.path.abspath(__file__))
BASE_DIR = os.path.dirname(CURRENT_DIR)
FRONTEND_DIR = os.path.join(BASE_DIR, "frontend")
FRONTEND_CSS = os.path.join(FRONTEND_DIR, "css")
FRONTEND_JS = os.path.join(FRONTEND_DIR, "js")
FRONTEND_INDEX = os.path.join(FRONTEND_DIR, "index.html")


# ==================== API è·¯ç”± ====================

@app.get("/api/records", response_model=PaginatedResponse, tags=["Records"])
async def api_get_records(
    page: int = Query(1, ge=1, description="é¡µç "),
    per_page: int = Query(15, ge=1, le=100, description="æ¯é¡µæ•°é‡"),
    temp_min: Optional[float] = Query(None, description="æœ€ä½æ¸©åº¦"),
    temp_max: Optional[float] = Query(None, description="æœ€é«˜æ¸©åº¦"),
    pressure_min: Optional[float] = Query(None, description="æœ€ä½å‹åŠ›"),
    pressure_max: Optional[float] = Query(None, description="æœ€é«˜å‹åŠ›")
):
    """è·å–è®°å½•åˆ—è¡¨ï¼ˆæ”¯æŒåˆ†é¡µå’Œç­›é€‰ï¼‰"""
    result = get_all_records(
        page=page,
        per_page=per_page,
        temp_min=temp_min,
        temp_max=temp_max,
        pressure_min=pressure_min,
        pressure_max=pressure_max
    )
    return result


@app.get("/api/records/{record_id}", response_model=GasRecord, tags=["Records"])
async def api_get_record(record_id: int):
    """è·å–å•æ¡è®°å½•"""
    record = get_record_by_id(record_id)
    if not record:
        raise HTTPException(status_code=404, detail="è®°å½•ä¸å­˜åœ¨")
    return record


@app.post("/api/records", response_model=ApiResponse, tags=["Records"])
async def api_create_record(data: GasRecordCreate, user: dict = Depends(require_auth)):
    """åˆ›å»ºæ–°è®°å½•"""
    if user["role"] not in ("admin", "user"):
        raise HTTPException(status_code=403, detail="æƒé™ä¸è¶³")
    try:
        record_payload = clean_record(data.model_dump())
        is_valid, errors = validate_record(record_payload)
        if not is_valid:
            raise HTTPException(status_code=400, detail="; ".join(errors))
        warnings = get_soft_warnings(record_payload)
        record_id = create_record(record_payload)
        return ApiResponse(
            success=True,
            message="åˆ›å»ºæˆåŠŸ" + format_soft_warning(warnings),
            data={"id": record_id}
        )
    except Exception as e:
        raise HTTPException(status_code=500, detail=str(e))


@app.put("/api/records/{record_id}", response_model=ApiResponse, tags=["Records"])
async def api_update_record(record_id: int, data: GasRecordUpdate, user: dict = Depends(require_auth)):
    """æ›´æ–°è®°å½•"""
    if user["role"] not in ("admin", "user"):
        raise HTTPException(status_code=403, detail="æƒé™ä¸è¶³")
    update_data = {k: v for k, v in data.model_dump().items() if v is not None}
    
    if not update_data:
        raise HTTPException(status_code=400, detail="æ²¡æœ‰è¦æ›´æ–°çš„æ•°æ®")

    existing = get_record_by_id(record_id)
    if not existing:
        raise HTTPException(status_code=404, detail="è®°å½•ä¸å­˜åœ¨")
    merged = {**existing, **update_data}
    merged_payload = clean_record(merged)
    is_valid, errors = validate_record(merged_payload)
    if not is_valid:
        raise HTTPException(status_code=400, detail="; ".join(errors))
    
    success = update_record(record_id, update_data)
    if not success:
        raise HTTPException(status_code=404, detail="è®°å½•ä¸å­˜åœ¨")
    
    warnings = get_soft_warnings(update_data) if "pressure" in update_data else []
    return ApiResponse(success=True, message="æ›´æ–°æˆåŠŸ" + format_soft_warning(warnings))


@app.delete("/api/records/{record_id}", response_model=ApiResponse, tags=["Records"])
async def api_delete_record(record_id: int, user: dict = Depends(require_auth)):
    """åˆ é™¤è®°å½•"""
    if user["role"] not in ("admin", "user"):
        raise HTTPException(status_code=403, detail="æƒé™ä¸è¶³")
    success = delete_record(record_id)
    if not success:
        raise HTTPException(status_code=404, detail="è®°å½•ä¸å­˜åœ¨")
    
    return ApiResponse(success=True, message="åˆ é™¤æˆåŠŸ")


@app.get("/api/statistics", response_model=Statistics, tags=["Statistics"])
async def api_statistics():
    """è·å–ç»Ÿè®¡ä¿¡æ¯"""
    stats = get_statistics()
    return stats


@app.get("/api/query", tags=["Query"])
async def api_query_by_composition(
    x_ch4: Optional[float] = Query(None, description="CH4 æ‘©å°”åˆ†æ•°"),
    x_c2h6: Optional[float] = Query(None, description="C2H6 æ‘©å°”åˆ†æ•°"),
    x_c3h8: Optional[float] = Query(None, description="C3H8 æ‘©å°”åˆ†æ•°"),
    x_co2: Optional[float] = Query(None, description="CO2 æ‘©å°”åˆ†æ•°"),
    x_n2: Optional[float] = Query(None, description="N2 æ‘©å°”åˆ†æ•°"),
    x_h2s: Optional[float] = Query(None, description="H2S æ‘©å°”åˆ†æ•°"),
    x_ic4h10: Optional[float] = Query(None, description="i-C4H10 æ‘©å°”åˆ†æ•°"),
    tolerance: float = Query(0.02, description="å…è®¸çš„è¯¯å·®èŒƒå›´ï¼Œé»˜è®¤2%"),
    strict: bool = Query(True, description="ä¸¥æ ¼æ¨¡å¼ï¼šæœªè¾“å…¥çš„ç»„åˆ†è¦æ±‚æ¥è¿‘0")
):
    """æ ¹æ®æ°”ä½“ç»„åˆ†æŸ¥è¯¢æ¸©åº¦å’Œå‹åŠ›"""
    from backend.database import query_by_composition
    
    composition = {
        'x_ch4': x_ch4, 'x_c2h6': x_c2h6, 'x_c3h8': x_c3h8,
        'x_co2': x_co2, 'x_n2': x_n2, 'x_h2s': x_h2s, 'x_ic4h10': x_ic4h10
    }
    composition = {k: v for k, v in composition.items() if v is not None}
    
    if not composition:
        return {"success": False, "message": "è¯·è‡³å°‘è¾“å…¥ä¸€ä¸ªç»„åˆ†", "data": []}
    
    results = query_by_composition(composition, tolerance, strict_mode=strict)
    return {"success": True, "data": results, "count": len(results)}


# ==================== å›¾è¡¨æ•°æ® API ====================

@app.get("/api/chart/temperature", tags=["Chart"])
async def api_chart_temperature():
    """è·å–æ¸©åº¦åˆ†å¸ƒæ•°æ®"""
    data = get_chart_data('temperature')
    return data


@app.get("/api/chart/pressure", tags=["Chart"])
async def api_chart_pressure():
    """è·å–å‹åŠ›åˆ†å¸ƒæ•°æ®"""
    data = get_chart_data('pressure')
    return data


@app.get("/api/chart/scatter", tags=["Chart"])
async def api_chart_scatter():
    """è·å–æ¸©åº¦-å‹åŠ›æ•£ç‚¹å›¾æ•°æ®"""
    data = get_chart_data('scatter')
    return data


@app.get("/api/chart/heatmap", tags=["Chart"])
async def api_chart_heatmap(
    temp_bins: int = Query(18, ge=5, le=60),
    pressure_bins: int = Query(20, ge=5, le=60)
):
    """è·å–æ¸©åº¦-å‹åŠ›å¯†åº¦çƒ­åŠ›å›¾æ•°æ®"""
    with get_connection(dict_cursor=True) as conn:
        cursor = conn.cursor()
        cursor.execute("SELECT temperature, pressure FROM gas_mixture")
        rows = cursor.fetchall()

    if not rows:
        return {"x_labels": [], "y_labels": [], "data": [], "meta": {}}

    temps = [row['temperature'] for row in rows]
    pressures = [row['pressure'] for row in rows]

    min_temp, max_temp = min(temps), max(temps)
    min_pressure, max_pressure = min(pressures), max(pressures)
    temp_range = max_temp - min_temp
    pressure_range = max_pressure - min_pressure

    if temp_range == 0:
        temp_bins = 1
    if pressure_range == 0:
        pressure_bins = 1

    temp_size = temp_range / temp_bins if temp_bins > 0 else 1.0
    pressure_size = pressure_range / pressure_bins if pressure_bins > 0 else 1.0

    counts = {}
    for row in rows:
        temp, pressure = row['temperature'], row['pressure']
        t_bin = int((temp - min_temp) / temp_size) if temp_size else 0
        p_bin = int((pressure - min_pressure) / pressure_size) if pressure_size else 0
        if t_bin >= temp_bins:
            t_bin = temp_bins - 1
        if p_bin >= pressure_bins:
            p_bin = pressure_bins - 1
        counts[(t_bin, p_bin)] = counts.get((t_bin, p_bin), 0) + 1

    temp_precision = 0 if temp_size >= 1 else 2
    pressure_precision = 1 if pressure_size >= 1 else 3

    x_labels = [f"{min_temp + i * temp_size:.{temp_precision}f}-{min_temp + (i+1) * temp_size:.{temp_precision}f}K" 
                for i in range(temp_bins)]
    y_labels = [f"{min_pressure + i * pressure_size:.{pressure_precision}f}-{min_pressure + (i+1) * pressure_size:.{pressure_precision}f}MPa" 
                for i in range(pressure_bins)]

    data = [[t_bin, p_bin, count] for (t_bin, p_bin), count in counts.items()]

    return {
        "x_labels": x_labels, "y_labels": y_labels, "data": data,
        "meta": {"min_temp": min_temp, "max_temp": max_temp, 
                 "min_pressure": min_pressure, "max_pressure": max_pressure}
    }


@app.get("/api/chart/scatter-distribution", tags=["Chart"])
async def api_chart_scatter_distribution(limit: Optional[int] = Query(None, ge=1, le=200000)):
    """è·å–æ¸©åº¦-å‹åŠ›åˆ†å¸ƒæ•£ç‚¹æ•°æ®"""
    with get_connection(dict_cursor=True) as conn:
        cursor = conn.cursor()
        if limit is None:
            cursor.execute("SELECT id, temperature, pressure FROM gas_mixture ORDER BY id")
        else:
            cursor.execute("SELECT id, temperature, pressure FROM gas_mixture ORDER BY id LIMIT ?", (limit,))
        rows = cursor.fetchall()

    if not rows:
        return {"data": [], "pressure_min": 0, "pressure_max": 0, "count": 0}

    pressures = [row['pressure'] for row in rows]
    return {
        "data": [{"value": [row['temperature'], row['pressure'], row['pressure']], "id": row['id']} for row in rows],
        "pressure_min": min(pressures), "pressure_max": max(pressures), "count": len(rows)
    }


# ==================== å¯¼å…¥å¯¼å‡º API ====================

@app.get("/api/export/csv", tags=["Export"])
async def api_export_csv(user: dict = Depends(require_auth)):
    """å¯¼å‡ºæ‰€æœ‰æ•°æ®ä¸º CSV æ–‡ä»¶"""
    records = get_all_records_no_pagination()
    output = io.StringIO()
    writer = csv.writer(output)
    writer.writerow(['ID', 'T (K)', 'xCH4', 'xC2H6', 'xC3H8', 'xCO2', 'xN2', 'xH2S', 'x i-C4H10', 'p (MPa)'])
    for r in records:
        writer.writerow([r['id'], r['temperature'], r['x_ch4'], r['x_c2h6'], r['x_c3h8'],
                        r['x_co2'], r['x_n2'], r['x_h2s'], r['x_ic4h10'], r['pressure']])
    output.seek(0)
    return StreamingResponse(
        iter([output.getvalue()]),
        media_type="text/csv",
        headers={"Content-Disposition": "attachment; filename=gas_data_export.csv"}
    )


@app.get("/api/export/excel", tags=["Export"])
async def api_export_excel(user: dict = Depends(require_auth)):
    """å¯¼å‡ºæ‰€æœ‰æ•°æ®ä¸º Excel æ–‡ä»¶"""
    try:
        import pandas as pd
        records = get_all_records_no_pagination()
        df = pd.DataFrame(records)
        column_mapping = {
            'id': 'ID', 'temperature': 'T (K)', 'x_ch4': 'xCH4', 'x_c2h6': 'xC2H6',
            'x_c3h8': 'xC3H8', 'x_co2': 'xCO2', 'x_n2': 'xN2', 'x_h2s': 'xH2S',
            'x_ic4h10': 'x i-C4H10', 'pressure': 'p (MPa)'
        }
        export_columns = ['id', 'temperature', 'x_ch4', 'x_c2h6', 'x_c3h8', 
                         'x_co2', 'x_n2', 'x_h2s', 'x_ic4h10', 'pressure']
        df = df[export_columns].rename(columns=column_mapping)
        output = io.BytesIO()
        df.to_excel(output, index=False, engine='openpyxl')
        output.seek(0)
        return StreamingResponse(
            output,
            media_type="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
            headers={"Content-Disposition": "attachment; filename=gas_data_export.xlsx"}
        )
    except ImportError:
        raise HTTPException(status_code=500, detail="éœ€è¦å®‰è£… pandas å’Œ openpyxl")


@app.post("/api/import", tags=["Import"])
async def api_import_file(file: UploadFile = File(...), user: dict = Depends(require_auth)):
    """æ‰¹é‡å¯¼å…¥æ•°æ®ï¼ˆæ”¯æŒ CSV å’Œ Excel æ–‡ä»¶ï¼‰"""
    if user["role"] not in ("admin", "user"):
        raise HTTPException(status_code=403, detail="æƒé™ä¸è¶³")
    try:
        filename = file.filename.lower()
        content = await file.read()
        records, row_numbers, skipped = parse_import_content(filename, content)
        if not records:
            raise HTTPException(status_code=400, detail="æ–‡ä»¶ä¸­æ²¡æœ‰æœ‰æ•ˆæ•°æ®")

        validation_errors = []
        valid_records = []
        for idx, record in enumerate(records):
            is_valid, errors = validate_record(record)
            if is_valid:
                valid_records.append(record)
            else:
                row_number = row_numbers[idx] if idx < len(row_numbers) else (idx + 1)
                validation_errors.append({"row": row_number, "errors": errors})

        if validation_errors:
            raise HTTPException(status_code=400, detail={
                "message": "å¯¼å…¥æ ¡éªŒå¤±è´¥",
                "summary": {"total": len(records), "valid_count": len(valid_records),
                           "invalid_count": len(validation_errors), "skipped_count": skipped},
                "errors": validation_errors[:50]
            })

        count = batch_create_records(valid_records)
        warning_count = count_soft_warnings(valid_records)
        return ApiResponse(
            success=True,
            message=f"æˆåŠŸå¯¼å…¥ {count} æ¡è®°å½•" + format_soft_warning_count(warning_count),
            data={"imported_count": count, "warning_count": warning_count}
        )
    except HTTPException:
        raise
    except Exception as e:
        raise HTTPException(status_code=500, detail=f"å¯¼å…¥å¤±è´¥: {str(e)}")


def parse_import_content(filename: str, content: bytes):
    records, row_numbers, skipped = [], [], 0
    if filename.endswith('.csv'):
        text = content.decode('utf-8-sig')
        reader = csv.DictReader(io.StringIO(text))
        for idx, row in enumerate(reader, start=2):
            record = parse_import_row(row)
            if record:
                records.append(record)
                row_numbers.append(idx)
            else:
                skipped += 1
    elif filename.endswith(('.xlsx', '.xls')):
        import pandas as pd
        df = pd.read_excel(io.BytesIO(content))
        for idx, row in df.iterrows():
            record = parse_import_row(row.to_dict())
            if record:
                records.append(record)
                row_numbers.append(idx + 2)
            else:
                skipped += 1
    else:
        raise HTTPException(status_code=400, detail="ä¸æ”¯æŒçš„æ–‡ä»¶æ ¼å¼")
    return records, row_numbers, skipped


def parse_import_row(row: dict) -> Optional[dict]:
    """è§£æå¯¼å…¥è¡Œæ•°æ®"""
    column_mapping = {
        'temperature': ['T (K)', 'T(K)', 'temperature', 'Temperature', 'æ¸©åº¦'],
        'x_ch4': ['xCH4', 'CH4', 'x_ch4', 'ç”²çƒ·'],
        'x_c2h6': ['xC2H6', 'C2H6', 'x_c2h6', 'ä¹™çƒ·'],
        'x_c3h8': ['xC3H8', 'C3H8', 'x_c3h8', 'ä¸™çƒ·'],
        'x_co2': ['xCO2', 'CO2', 'x_co2', 'äºŒæ°§åŒ–ç¢³'],
        'x_n2': ['xN2', 'N2', 'x_n2', 'æ°®æ°”'],
        'x_h2s': ['xH2S', 'H2S', 'x_h2s', 'ç¡«åŒ–æ°¢'],
        'x_ic4h10': ['x i-C4H10', 'x_i-C4H10', 'iC4H10', 'x_ic4h10', 'å¼‚ä¸çƒ·'],
        'pressure': ['p (MPa)', 'p(MPa)', 'pressure', 'Pressure', 'å‹åŠ›']
    }
    
    record = {}
    for db_field, possible_names in column_mapping.items():
        value = None
        for name in possible_names:
            if name in row:
                value = row[name]
                break
        try:
            record[db_field] = float(value) if value is not None and str(value).strip() != '' else 0.0
        except (ValueError, TypeError):
            record[db_field] = 0.0
    
    if record.get('temperature', 0) == 0 and record.get('pressure', 0) == 0:
        return None
    return record


# ==================== é™æ€æ–‡ä»¶æœåŠ¡ ====================

@app.get("/", tags=["Frontend"])
async def serve_frontend():
    """æä¾›å‰ç«¯é¡µé¢"""
    if os.path.exists(FRONTEND_INDEX):
        return FileResponse(FRONTEND_INDEX)
    return {"message": f"å‰ç«¯æ–‡ä»¶ä¸å­˜åœ¨ï¼Œè¯·è®¿é—® /docs æŸ¥çœ‹ API æ–‡æ¡£"}


@app.get("/css/{filename}", tags=["Frontend"])
async def serve_css(filename: str):
    filepath = os.path.join(FRONTEND_CSS, filename)
    if os.path.exists(filepath):
        return FileResponse(filepath, media_type="text/css")
    raise HTTPException(status_code=404, detail="CSS file not found")


@app.get("/js/{filename}", tags=["Frontend"])
async def serve_js(filename: str):
    filepath = os.path.join(FRONTEND_JS, filename)
    if os.path.exists(filepath):
        return FileResponse(filepath, media_type="application/javascript")
    raise HTTPException(status_code=404, detail="JS file not found")


# ==================== è®¤è¯ç›¸å…³ API ====================

@app.post("/api/auth/login", tags=["Auth"])
async def api_login(request: LoginRequest, req: Request):
    """ç”¨æˆ·ç™»å½•ï¼ˆæ”¯æŒä¸¤æ­¥éªŒè¯ï¼‰"""
    client_ip = req.client.host if req.client else "unknown"
    user_agent = req.headers.get("user-agent", "")
    
    allowed, error_msg = check_login_attempts(client_ip)
    if not allowed:
        record_login(request.username, client_ip, user_agent, False, "ç™»å½•å°è¯•è¿‡å¤š")
        raise HTTPException(status_code=429, detail=error_msg)
    
    user = authenticate_user(request.username, request.password)
    if not user:
        record_login_attempt(client_ip, False)
        record_login(request.username, client_ip, user_agent, False, "å¯†ç é”™è¯¯")
        raise HTTPException(status_code=401, detail="ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯")
    
    if is_totp_enabled(request.username):
        if not request.totp_code:
            return {"success": False, "require_totp": True, "message": "éœ€è¦ä¸¤æ­¥éªŒè¯ç "}
        if not verify_user_totp(request.username, request.totp_code):
            record_login_attempt(client_ip, False)
            record_login(request.username, client_ip, user_agent, False, "ä¸¤æ­¥éªŒè¯å¤±è´¥")
            raise HTTPException(status_code=401, detail="ä¸¤æ­¥éªŒè¯ç é”™è¯¯")
    
    record_login_attempt(client_ip, True)
    token = create_access_token({"sub": user["username"], "role": user["role"]})
    create_session(token, user["username"], client_ip, user_agent)
    record_login(request.username, client_ip, user_agent, True)
    record_audit_log(request.username, "LOGIN", ip=client_ip)
    
    return {
        "success": True, "message": "ç™»å½•æˆåŠŸ",
        "data": {"access_token": token, "token_type": "bearer", "user": user,
                 "totp_enabled": is_totp_enabled(request.username)}
    }


@app.get("/api/auth/me", tags=["Auth"])
async def api_get_me(user: dict = Depends(require_auth)):
    """è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯"""
    return {"success": True, "data": user}


@app.post("/api/auth/change-password", tags=["Auth"])
async def api_change_password(request: ChangePasswordRequest, user: dict = Depends(require_auth)):
    """ä¿®æ”¹å¯†ç """
    is_valid, errors = validate_password(request.new_password)
    if not is_valid:
        raise HTTPException(status_code=400, detail=f"å¯†ç ä¸ç¬¦åˆè¦æ±‚: {', '.join(errors)}")
    
    success = change_password(user["username"], request.old_password, request.new_password)
    if not success:
        raise HTTPException(status_code=400, detail="åŸå¯†ç é”™è¯¯")
    
    record_audit_log(user["username"], "CHANGE_PASSWORD")
    return {"success": True, "message": "å¯†ç ä¿®æ”¹æˆåŠŸ"}


@app.get("/api/auth/password-policy", tags=["Auth"])
async def api_password_policy():
    """è·å–å¯†ç ç­–ç•¥"""
    return {"success": True, "data": get_password_policy()}


@app.post("/api/auth/users", tags=["Auth"])
async def api_create_user(request: CreateUserRequest, user: dict = Depends(require_auth)):
    """åˆ›å»ºæ–°ç”¨æˆ·ï¼ˆä»…ç®¡ç†å‘˜ï¼‰"""
    if user["role"] != "admin":
        raise HTTPException(status_code=403, detail="æƒé™ä¸è¶³")
    if request.role not in ("admin", "user"):
        raise HTTPException(status_code=400, detail="è§’è‰²æ— æ•ˆ")
    is_valid, errors = validate_password(request.password)
    if not is_valid:
        raise HTTPException(status_code=400, detail=f"å¯†ç ä¸ç¬¦åˆè¦æ±‚: {', '.join(errors)}")
    success = create_user(request.username, request.password, request.role)
    if not success:
        raise HTTPException(status_code=400, detail="ç”¨æˆ·å·²å­˜åœ¨")
    return {"success": True, "message": "ç”¨æˆ·åˆ›å»ºæˆåŠŸ"}


@app.get("/api/auth/users", tags=["Auth"])
async def api_list_users(user: dict = Depends(require_auth)):
    """è·å–ç”¨æˆ·åˆ—è¡¨ï¼ˆä»…ç®¡ç†å‘˜ï¼‰"""
    if user["role"] != "admin":
        raise HTTPException(status_code=403, detail="æƒé™ä¸è¶³")
    return {"success": True, "data": list_users()}


# ==================== TOTP ä¸¤æ­¥éªŒè¯ API ====================

@app.post("/api/auth/totp/setup", tags=["TOTP"])
async def api_totp_setup(user: dict = Depends(require_auth)):
    """è®¾ç½®ä¸¤æ­¥éªŒè¯"""
    secret, uri = setup_totp(user["username"])
    return {"success": True, "data": {"secret": secret, "uri": uri,
            "message": "è¯·ä½¿ç”¨éªŒè¯å™¨Appæ‰«æäºŒç»´ç æˆ–æ‰‹åŠ¨è¾“å…¥å¯†é’¥"}}


@app.post("/api/auth/totp/enable", tags=["TOTP"])
async def api_totp_enable(request: TOTPSetupRequest, user: dict = Depends(require_auth)):
    """å¯ç”¨ä¸¤æ­¥éªŒè¯"""
    success = enable_totp(user["username"], request.code)
    if not success:
        raise HTTPException(status_code=400, detail="éªŒè¯ç é”™è¯¯ï¼Œè¯·é‡è¯•")
    record_audit_log(user["username"], "ENABLE_TOTP")
    return {"success": True, "message": "ä¸¤æ­¥éªŒè¯å·²å¯ç”¨"}


@app.post("/api/auth/totp/disable", tags=["TOTP"])
async def api_totp_disable(user: dict = Depends(require_auth)):
    """ç¦ç”¨ä¸¤æ­¥éªŒè¯"""
    disable_totp(user["username"])
    record_audit_log(user["username"], "DISABLE_TOTP")
    return {"success": True, "message": "ä¸¤æ­¥éªŒè¯å·²ç¦ç”¨"}


@app.get("/api/auth/totp/status", tags=["TOTP"])
async def api_totp_status(user: dict = Depends(require_auth)):
    """è·å–ä¸¤æ­¥éªŒè¯çŠ¶æ€"""
    status = get_totp_status(user["username"])
    return {"success": True, "data": status}


# ==================== ä¼šè¯ç®¡ç† API ====================

@app.get("/api/auth/sessions", tags=["Sessions"])
async def api_get_sessions(user: dict = Depends(require_auth)):
    """è·å–å½“å‰ç”¨æˆ·çš„æ‰€æœ‰ä¼šè¯"""
    sessions = get_user_sessions(user["username"])
    return {"success": True, "data": sessions}


@app.post("/api/auth/sessions/revoke-all", tags=["Sessions"])
async def api_revoke_all_sessions(user: dict = Depends(require_auth), authorization: Optional[str] = Header(None)):
    """æ’¤é”€é™¤å½“å‰ä¼šè¯å¤–çš„æ‰€æœ‰ä¼šè¯"""
    token = get_token_from_header(authorization)
    count = revoke_all_user_sessions(user["username"], except_token=token)
    record_audit_log(user["username"], "REVOKE_ALL_SESSIONS")
    return {"success": True, "message": f"å·²æ’¤é”€ {count} ä¸ªä¼šè¯"}


@app.post("/api/auth/logout", tags=["Sessions"])
async def api_logout(user: dict = Depends(require_auth), authorization: Optional[str] = Header(None)):
    """é€€å‡ºç™»å½•"""
    token = get_token_from_header(authorization)
    if token:
        revoke_session(token)
    record_audit_log(user["username"], "LOGOUT")
    return {"success": True, "message": "å·²é€€å‡ºç™»å½•"}


# ==================== å®‰å…¨æ—¥å¿— API ====================

@app.get("/api/security/login-logs", tags=["Security"])
async def api_get_login_logs(user: dict = Depends(require_auth), username: Optional[str] = None,
                             limit: int = Query(100, ge=1, le=500)):
    """è·å–ç™»å½•æ—¥å¿—"""
    if user["role"] != "admin":
        username = user["username"]
    logs = get_login_logs(username, limit)
    return {"success": True, "data": logs}


@app.get("/api/security/audit-logs", tags=["Security"])
async def api_get_audit_logs(user: dict = Depends(require_auth), username: Optional[str] = None,
                             action: Optional[str] = None, limit: int = Query(100, ge=1, le=500)):
    """è·å–å®¡è®¡æ—¥å¿—ï¼ˆä»…ç®¡ç†å‘˜ï¼‰"""
    if user["role"] != "admin":
        raise HTTPException(status_code=403, detail="æƒé™ä¸è¶³")
    logs = get_audit_logs(username=username, action=action, limit=limit)
    return {"success": True, "data": logs}


@app.get("/api/security/rate-limit", tags=["Security"])
async def api_rate_limit_status(req: Request):
    """è·å–å½“å‰IPçš„é™æµçŠ¶æ€"""
    client_ip = req.client.host if req.client else "unknown"
    status = get_rate_limit_status(client_ip)
    return {"success": True, "data": status}


# ==================== æ‰¹é‡æ“ä½œ API ====================

@app.post("/api/records/batch-delete", tags=["Batch"])
async def api_batch_delete(request: BatchDeleteRequest, user: dict = Depends(require_auth)):
    """æ‰¹é‡åˆ é™¤è®°å½•"""
    if user["role"] != "admin":
        raise HTTPException(status_code=403, detail="æƒé™ä¸è¶³")
    count = batch_delete_records(request.ids)
    record_audit_log(user["username"], "BATCH_DELETE", "records", None, str(request.ids))
    return {"success": True, "message": f"æˆåŠŸåˆ é™¤ {count} æ¡è®°å½•", "data": {"deleted_count": count}}


@app.post("/api/records/batch-update", tags=["Batch"])
async def api_batch_update(request: BatchUpdateRequest, user: dict = Depends(require_auth)):
    """æ‰¹é‡æ›´æ–°è®°å½•"""
    if user["role"] != "admin":
        raise HTTPException(status_code=403, detail="æƒé™ä¸è¶³")
    if not request.updates:
        raise HTTPException(status_code=400, detail="æ²¡æœ‰è¦æ›´æ–°çš„æ•°æ®")
    is_valid, errors = validate_partial_record(request.updates)
    if not is_valid:
        raise HTTPException(status_code=400, detail="; ".join(errors))
    count = batch_update_records(request.ids, request.updates)
    record_audit_log(user["username"], "BATCH_UPDATE", "records", None, str(request.ids), str(request.updates))
    warning_note = format_soft_warning(get_soft_warnings(request.updates))
    return {"success": True, "message": f"æˆåŠŸæ›´æ–° {count} æ¡è®°å½•{warning_note}", "data": {"updated_count": count}}


# ==================== æ•°æ®å®¡æ ¸ API ====================

class ApproveRequest(BaseModel):
    selected_ids: List[int]

class ApproveBatchItem(BaseModel):
    group_id: str
    selected_ids: List[int]

class ApproveBatchRequest(BaseModel):
    items: List[ApproveBatchItem]

class GroupBatchRequest(BaseModel):
    group_ids: List[str]


@app.get("/api/review/duplicates", tags=["Review"])
async def api_find_duplicates(user: dict = Depends(require_auth)):
    """æŸ¥æ‰¾åŒç»„åˆ†åŒæ¸©åº¦ä¸‹æœ‰å¤šä¸ªå‹åŠ›å€¼çš„æ•°æ®"""
    if user["role"] != "admin":
        raise HTTPException(status_code=403, detail="æƒé™ä¸è¶³")
    duplicates = find_duplicate_pressure_records()
    return {"success": True, "data": duplicates, "count": len(duplicates)}


@app.post("/api/review/move-duplicates", tags=["Review"])
async def api_move_duplicates(user: dict = Depends(require_auth)):
    """å°†é‡å¤æ•°æ®ç§»åˆ°å¾…å®¡æ ¸åŒº"""
    if user["role"] != "admin":
        raise HTTPException(status_code=403, detail="æƒé™ä¸è¶³")
    result = move_duplicates_to_review()
    record_audit_log(user["username"], "MOVE_DUPLICATES", None, None, None, str(result))
    return {"success": True, "message": f"å·²ç§»åŠ¨ {result['moved']} æ¡è®°å½•åˆ°å¾…å®¡æ ¸åŒº", "data": result}


@app.get("/api/review/pending", tags=["Review"])
async def api_get_pending_groups(page: int = Query(1, ge=1), per_page: int = Query(50, ge=1, le=200),
                                  group_id: Optional[str] = None, temp_min: Optional[float] = None,
                                  temp_max: Optional[float] = None, user: dict = Depends(require_auth)):
    """è·å–å¾…å®¡æ ¸çš„æ•°æ®ç»„"""
    if user["role"] != "admin":
        raise HTTPException(status_code=403, detail="æƒé™ä¸è¶³")
    result = get_pending_groups(page=page, per_page=per_page, group_id=group_id, temp_min=temp_min, temp_max=temp_max)
    return {"success": True, "data": result, "count": result["total"]}


@app.get("/api/review/stats", tags=["Review"])
async def api_get_review_stats(user: dict = Depends(require_auth)):
    """è·å–å®¡æ ¸ç»Ÿè®¡ä¿¡æ¯"""
    if user["role"] != "admin":
        raise HTTPException(status_code=403, detail="æƒé™ä¸è¶³")
    stats = get_pending_stats()
    return {"success": True, "data": stats}


@app.post("/api/review/approve/{group_id}", tags=["Review"])
async def api_approve_group(group_id: str, request: ApproveRequest, user: dict = Depends(require_auth)):
    """å®¡æ ¸é€šè¿‡ä¸€ç»„æ•°æ®"""
    if user["role"] != "admin":
        raise HTTPException(status_code=403, detail="æƒé™ä¸è¶³")
    result = approve_group(group_id, request.selected_ids, user["username"])
    record_audit_log(user["username"], "APPROVE_GROUP", "review", None, group_id, str(result))
    return {"success": True, "message": f"å·²å®¡æ ¸é€šè¿‡ {result['approved']} æ¡è®°å½•", "data": result}


@app.post("/api/review/reject/{group_id}", tags=["Review"])
async def api_reject_group(group_id: str, user: dict = Depends(require_auth)):
    """æ‹’ç»æ•´ç»„æ•°æ®"""
    if user["role"] != "admin":
        raise HTTPException(status_code=403, detail="æƒé™ä¸è¶³")
    reject_group(group_id, user["username"])
    record_audit_log(user["username"], "REJECT_GROUP", "review", None, group_id)
    return {"success": True, "message": "å·²æ‹’ç»è¯¥ç»„æ•°æ®"}


@app.post("/api/review/restore/{group_id}", tags=["Review"])
async def api_restore_group(group_id: str, user: dict = Depends(require_auth)):
    """æ¢å¤ä¸€ç»„æ•°æ®åˆ°å¾…å®¡æ ¸çŠ¶æ€"""
    if user["role"] != "admin":
        raise HTTPException(status_code=403, detail="æƒé™ä¸è¶³")
    result = restore_group(group_id)
    return {"success": True, "message": f"å·²æ¢å¤ {result['restored']} æ¡è®°å½•", "data": result}


# ==================== å…¬å¼€æŸ¥è¯¢ API ====================

class AvailableComponentsRequest(BaseModel):
    selected: List[str]

class ComponentRangesRequest(BaseModel):
    components: List[str]

class QueryByComponentsRequest(BaseModel):
    components: List[str]
    temperature: float


@app.post("/api/components/available", tags=["Public Query"])
async def api_available_components(request: AvailableComponentsRequest):
    """æ ¹æ®å·²é€‰ç»„åˆ†ï¼ŒæŸ¥è¯¢æ•°æ®åº“ä¸­è¿˜æœ‰å“ªäº›å¯ç”¨çš„ç»„åˆ†ç»„åˆ"""
    selected = request.selected
    all_components = ['x_ch4', 'x_c2h6', 'x_c3h8', 'x_co2', 'x_n2', 'x_h2s', 'x_ic4h10']
    
    try:
        with get_connection(dict_cursor=True) as conn:
            cursor = conn.cursor()
            conditions = [f"{comp} > 0" for comp in selected]
            where_clause = " AND ".join(conditions) if conditions else "1=1"

            cursor.execute(f"SELECT COUNT(*) as count FROM gas_mixture WHERE {where_clause}")
            match_count = cursor.fetchone()['count']

            available = []
            for comp in all_components:
                if comp in selected:
                    continue
                test_conditions = conditions + [f"{comp} > 0"]
                test_where = " AND ".join(test_conditions)
                cursor.execute(f"SELECT COUNT(*) as count FROM gas_mixture WHERE {test_where}")
                count = cursor.fetchone()['count']
                if count > 0:
                    available.append(comp)

            return {"success": True, "available": available, "match_count": match_count}
    except Exception as e:
        return {"success": False, "message": str(e)}


@app.post("/api/components/ranges", tags=["Public Query"])
async def api_component_ranges(request: ComponentRangesRequest):
    """æ ¹æ®é€‰å®šçš„ç»„åˆ†ï¼Œè¿”å›æ•°æ®åº“ä¸­æ¯ä¸ªç»„åˆ†çš„å®é™…åŒºé—´èŒƒå›´"""
    components = request.components
    all_components = ['x_ch4', 'x_c2h6', 'x_c3h8', 'x_co2', 'x_n2', 'x_h2s', 'x_ic4h10']
    
    try:
        with get_connection(dict_cursor=True) as conn:
            cursor = conn.cursor()
            conditions = [f"{comp} > 0" for comp in components]
            for comp in all_components:
                if comp not in components:
                    conditions.append(f"{comp} <= 0.02")
            where_clause = " AND ".join(conditions) if conditions else "1=1"

            ranges = {}
            for comp in components:
                cursor.execute(f"SELECT MIN({comp}) as min_val, MAX({comp}) as max_val FROM gas_mixture WHERE {where_clause}")
                row = cursor.fetchone()
                if row and row['min_val'] is not None:
                    ranges[comp] = {'min': row['min_val'], 'max': row['max_val']}

            cursor.execute(f"SELECT COUNT(*) as count FROM gas_mixture WHERE {where_clause}")
            total_records = cursor.fetchone()['count']

            cursor.execute(f"SELECT MIN(temperature) as min_temp, MAX(temperature) as max_temp FROM gas_mixture WHERE {where_clause}")
            temp_row = cursor.fetchone()
            temp_range = {'min': temp_row['min_temp'], 'max': temp_row['max_temp']} if temp_row and temp_row['min_temp'] else None

            return {"success": True, "ranges": ranges, "total_records": total_records, "temp_range": temp_range}
    except Exception as e:
        return {"success": False, "message": str(e)}


@app.post("/api/query/by-components", tags=["Public Query"])
async def api_query_by_components(request: QueryByComponentsRequest):
    """æ ¹æ®ç»„åˆ†ç»„åˆå’Œæ¸©åº¦æŸ¥è¯¢ç›¸å¹³è¡¡å‹åŠ›"""
    components = request.components
    temperature = request.temperature
    all_components = ['x_ch4', 'x_c2h6', 'x_c3h8', 'x_co2', 'x_n2', 'x_h2s', 'x_ic4h10']
    
    try:
        with get_connection(dict_cursor=True) as conn:
            cursor = conn.cursor()
            conditions = [f"{comp} > 0" for comp in components]
            for comp in all_components:
                if comp not in components:
                    conditions.append(f"{comp} <= 0.02")
            conditions.append("ABS(temperature - ?) <= 5")
            where_clause = " AND ".join(conditions)

            query = f"""SELECT temperature, pressure, {', '.join(all_components)}
                        FROM gas_mixture WHERE {where_clause}
                        ORDER BY ABS(temperature - ?) LIMIT 1"""

            cursor.execute(query, [temperature, temperature])
            row = cursor.fetchone()

            if row:
                composition = {comp: row[comp] for comp in all_components}
                return {"success": True, "data": {"temperature": row['temperature'], 
                        "pressure": row['pressure'], "composition": composition}}
            return {"success": False, "message": "åœ¨æŒ‡å®šçš„æ¸©åº¦èŒƒå›´å†…æœªæ‰¾åˆ°æ•°æ®"}
    except Exception as e:
        return {"success": False, "message": str(e)}


# ==================== å¤‡ä»½ç›¸å…³ API ====================

@app.get("/api/backup/status", tags=["Backup"])
async def api_backup_status(user: dict = Depends(require_auth)):
    """è·å–å¤‡ä»½çŠ¶æ€"""
    return {"success": True, "data": get_backup_status()}


@app.get("/api/backup/list", tags=["Backup"])
async def api_backup_list(user: dict = Depends(require_auth)):
    """è·å–å¤‡ä»½åˆ—è¡¨"""
    return {"success": True, "data": list_backups()}


@app.post("/api/backup/create", tags=["Backup"])
async def api_create_backup(user: dict = Depends(require_auth)):
    """æ‰‹åŠ¨åˆ›å»ºå¤‡ä»½"""
    if user["role"] != "admin":
        raise HTTPException(status_code=403, detail="æƒé™ä¸è¶³")
    backup_path = create_backup(manual=True)
    if backup_path:
        return {"success": True, "message": "å¤‡ä»½åˆ›å»ºæˆåŠŸ", "data": {"path": backup_path}}
    if not is_backup_supported():
        return {"success": False, "message": "å½“å‰ä½¿ç”¨æ‰˜ç®¡æ•°æ®åº“ï¼Œè¯·åœ¨äº‘æ§åˆ¶å°åˆ›å»ºå¤‡ä»½"}
    raise HTTPException(status_code=500, detail="å¤‡ä»½åˆ›å»ºå¤±è´¥")


@app.post("/api/backup/restore/{filename}", tags=["Backup"])
async def api_restore_backup(filename: str, user: dict = Depends(require_auth)):
    """æ¢å¤å¤‡ä»½"""
    if user["role"] != "admin":
        raise HTTPException(status_code=403, detail="æƒé™ä¸è¶³")
    success = restore_backup(filename)
    if success:
        return {"success": True, "message": "å¤‡ä»½æ¢å¤æˆåŠŸ"}
    if not is_backup_supported():
        return {"success": False, "message": "å½“å‰ä½¿ç”¨æ‰˜ç®¡æ•°æ®åº“ï¼Œè¯·åœ¨äº‘æ§åˆ¶å°è¿›è¡Œæ¢å¤"}
    raise HTTPException(status_code=500, detail="å¤‡ä»½æ¢å¤å¤±è´¥")


@app.delete("/api/backup/{filename}", tags=["Backup"])
async def api_delete_backup(filename: str, user: dict = Depends(require_auth)):
    """åˆ é™¤å¤‡ä»½"""
    if user["role"] != "admin":
        raise HTTPException(status_code=403, detail="æƒé™ä¸è¶³")
    success = delete_backup(filename)
    if success:
        return {"success": True, "message": "å¤‡ä»½åˆ é™¤æˆåŠŸ"}
    raise HTTPException(status_code=404, detail="å¤‡ä»½ä¸å­˜åœ¨")


@app.get("/api/backup/download/{filename}", tags=["Backup"])
async def api_download_backup(filename: str, user: dict = Depends(require_auth)):
    """ä¸‹è½½å¤‡ä»½æ–‡ä»¶"""
    backup_dir = get_backup_dir()
    filepath = os.path.join(backup_dir, filename)
    if not os.path.exists(filepath):
        raise HTTPException(status_code=404, detail="å¤‡ä»½ä¸å­˜åœ¨")
    return FileResponse(filepath, media_type="application/octet-stream", filename=filename)


# ==================== æ•°æ®æ¨¡æ¿ API ====================

@app.get("/api/template/csv", tags=["Template"])
async def api_download_csv_template():
    """ä¸‹è½½ CSV å¯¼å…¥æ¨¡æ¿"""
    template = '''T (K),xCH4,xC2H6,xC3H8,xCO2,xN2,xH2S,x i-C4H10,p (MPa)
300,0.9,0.05,0.02,0.01,0.01,0.005,0.005,10.5
310,0.85,0.08,0.03,0.02,0.01,0.005,0.005,15.2
'''
    return StreamingResponse(iter([template]), media_type="text/csv",
                             headers={"Content-Disposition": "attachment; filename=import_template.csv"})


# ==================== åå°ç®¡ç†è·¯ç”± ====================

ADMIN_DIR = os.path.join(FRONTEND_DIR, "admin")

@app.get("/admin", tags=["Admin"])
async def serve_admin():
    """åå°ç®¡ç†é¡µé¢"""
    admin_index = os.path.join(ADMIN_DIR, "index.html")
    if os.path.exists(admin_index):
        return FileResponse(admin_index)
    return {"message": "åå°ç®¡ç†é¡µé¢ä¸å­˜åœ¨"}


# ==================== å¯åŠ¨äº‹ä»¶ ====================

@app.on_event("startup")
async def startup_event():
    """åº”ç”¨å¯åŠ¨æ—¶æ‰§è¡Œ"""
    print("[App] æ­£åœ¨åˆå§‹åŒ–å®‰å…¨æ¨¡å—...")
    init_security()
    ensure_admin_user()
    if is_using_default_secret_key():
        print("[Security] WARNING: SECRET_KEY ä½¿ç”¨é»˜è®¤å€¼ï¼Œè¯·åœ¨ç”Ÿäº§ç¯å¢ƒä¸­è®¾ç½®ç¯å¢ƒå˜é‡")
    if not is_admin_configured():
        print("[Auth] WARNING: æœªè®¾ç½® ADMIN_PASSWORDï¼Œç®¡ç†å‘˜ç™»å½•å·²ç¦ç”¨")
    print("[App] æ­£åœ¨åˆå§‹åŒ–å¤‡ä»½ç³»ç»Ÿ...")
    init_backup_system()
    print("[App] ç³»ç»Ÿå¯åŠ¨å®Œæˆ v4.0")


# ==================== å¯åŠ¨å…¥å£ ====================

if __name__ == "__main__":
    import uvicorn
    import sys
    
    if sys.platform == 'win32':
        import io
        sys.stdout = io.TextIOWrapper(sys.stdout.buffer, encoding='utf-8', errors='replace')
    
    print("\n" + "="*60)
    print("   Gas Mixture Data Management System - FastAPI v4.0")
    print("="*60)
    print("   API Docs: http://127.0.0.1:8000/docs")
    print("   Frontend: http://127.0.0.1:8000")
    print("   Admin:    http://127.0.0.1:8000/admin")
    print("-"*60)
    uvicorn.run(app, host="127.0.0.1", port=8000)
```

---

## åå››ã€ç®¡ç†åå°å®Œæ•´ä»£ç 

### 14.1 ç®¡ç†åå° HTML (frontend/admin/index.html) - ç¬¬ä¸€éƒ¨åˆ†

```html
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç®¡ç†åå° - æ°”ä½“æ··åˆç‰©æ•°æ®ç³»ç»Ÿ</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --bg-dark: #0a0e14; --bg-card: #161d27; --bg-input: #0d1117;
            --border: #253041; --text: #e8eef5; --text-secondary: #8899a8;
            --accent: #3d9eff; --success: #00d4aa; --danger: #ff5555;
            --warning: #ffcc00; --orange: #ff9940;
        }
        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: var(--bg-dark); color: var(--text);
            min-height: 100vh; display: flex;
        }
        .login-container {
            display: flex; justify-content: center; align-items: center;
            width: 100%; min-height: 100vh;
            background: linear-gradient(135deg, #0a0e14 0%, #161d27 50%, #0a0e14 100%);
        }
        .login-box {
            background: var(--bg-card); border: 1px solid var(--border);
            border-radius: 16px; padding: 40px; width: 100%; max-width: 400px;
        }
        .login-title { font-size: 24px; margin-bottom: 30px; text-align: center; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; color: var(--text-secondary); font-size: 13px; margin-bottom: 8px; }
        .form-group input {
            width: 100%; padding: 14px; background: var(--bg-input);
            border: 1px solid var(--border); border-radius: 8px;
            color: var(--text); font-size: 14px;
        }
        .form-group input:focus { outline: none; border-color: var(--accent); }
        .btn-login {
            width: 100%; padding: 14px; background: linear-gradient(135deg, #3d9eff 0%, #0066cc 100%);
            border: none; border-radius: 8px; color: white; font-size: 16px;
            font-weight: 600; cursor: pointer; margin-top: 10px;
        }
        .btn-login:hover { opacity: 0.9; }
        .btn-login:disabled { background: #475569; cursor: not-allowed; }
        .error-message { color: var(--danger); font-size: 13px; margin-top: 10px; text-align: center; }
        .totp-section { margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--border); display: none; }
        .totp-section.show { display: block; }
        .sidebar {
            width: 240px; background: var(--bg-card);
            border-right: 1px solid var(--border);
            padding: 24px 16px; display: flex; flex-direction: column; min-height: 100vh;
        }
        .logo { display: flex; align-items: center; gap: 12px; margin-bottom: 32px; padding: 0 8px; }
        .logo-icon {
            width: 40px; height: 40px; background: linear-gradient(135deg, #3d9eff, #0066cc);
            border-radius: 10px; display: flex; align-items: center;
            justify-content: center; font-size: 20px;
        }
        .logo-text { font-size: 16px; font-weight: 700; }
        .nav-menu { list-style: none; flex: 1; }
        .nav-item {
            padding: 12px 16px; border-radius: 8px; cursor: pointer;
            display: flex; align-items: center; gap: 12px;
            color: var(--text-secondary); font-size: 14px;
            margin-bottom: 4px; transition: all 0.2s;
        }
        .nav-item:hover { background: rgba(61, 158, 255, 0.1); color: var(--text); }
        .nav-item.active { background: rgba(61, 158, 255, 0.15); color: var(--accent); }
        .nav-item .icon { width: 20px; text-align: center; }
        .user-info {
            padding: 16px; border-top: 1px solid var(--border);
            margin-top: auto; font-size: 13px; color: var(--text-secondary);
        }
        .user-name { color: var(--text); font-weight: 600; margin-bottom: 4px; }
        .btn-logout {
            width: 100%; margin-top: 12px; padding: 8px;
            background: transparent; border: 1px solid var(--border);
            border-radius: 6px; color: var(--text-secondary); cursor: pointer;
        }
        .btn-logout:hover { background: var(--danger); color: white; border-color: var(--danger); }
        .main-content { flex: 1; padding: 24px 32px; overflow-y: auto; }
        .page { display: none; }
        .page.active { display: block; }
        .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
        .page-title { font-size: 22px; font-weight: 700; }
        .card {
            background: var(--bg-card); border: 1px solid var(--border);
            border-radius: 12px; padding: 20px; margin-bottom: 20px;
        }
        .card-title { font-size: 14px; color: var(--text-secondary); margin-bottom: 16px; font-weight: 600; }
        .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 24px; }
        .stat-card {
            background: var(--bg-card); border: 1px solid var(--border);
            border-radius: 12px; padding: 20px; text-align: center;
        }
        .stat-value { font-size: 28px; font-weight: 700; color: var(--accent); }
        .stat-label { font-size: 12px; color: var(--text-secondary); margin-top: 4px; }
        .data-table { width: 100%; border-collapse: collapse; }
        .data-table th {
            padding: 12px; text-align: left; font-size: 12px; font-weight: 600;
            color: var(--text-secondary); border-bottom: 1px solid var(--border);
            text-transform: uppercase; background: rgba(0,0,0,0.2);
        }
        .data-table td { padding: 12px; font-size: 13px; border-bottom: 1px solid var(--border); }
        .data-table tbody tr:hover { background: rgba(61, 158, 255, 0.05); }
        .badge {
            padding: 4px 10px; border-radius: 12px; font-size: 11px;
            font-weight: 600; display: inline-block;
        }
        .badge-success { background: rgba(0, 212, 170, 0.2); color: var(--success); }
        .badge-danger { background: rgba(255, 85, 85, 0.2); color: var(--danger); }
        .badge-warning { background: rgba(255, 204, 0, 0.2); color: var(--warning); }
        .badge-info { background: rgba(61, 158, 255, 0.2); color: var(--accent); }
        .btn {
            padding: 8px 16px; border: none; border-radius: 6px;
            font-size: 13px; font-weight: 600; cursor: pointer;
            display: inline-flex; align-items: center; gap: 6px;
        }
        .btn-primary { background: var(--accent); color: white; }
        .btn-secondary { background: var(--bg-input); border: 1px solid var(--border); color: var(--text); }
        .btn-danger { background: var(--danger); color: white; }
        .btn-success { background: var(--success); color: #0a0e14; }
        .btn-sm { padding: 6px 12px; font-size: 12px; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .filters { display: flex; gap: 12px; margin-bottom: 20px; flex-wrap: wrap; align-items: center; }
        .filters input, .filters select {
            padding: 10px 14px; background: var(--bg-input); border: 1px solid var(--border);
            border-radius: 6px; color: var(--text); font-size: 13px;
        }
        .filters input:focus, .filters select:focus { outline: none; border-color: var(--accent); }
        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.7); z-index: 1000;
            display: none; justify-content: center; align-items: center;
        }
        .modal-overlay.active { display: flex; }
        .modal {
            background: var(--bg-card); border: 1px solid var(--border);
            border-radius: 12px; width: 90%; max-width: 500px; max-height: 90vh; overflow-y: auto;
        }
        .modal-header {
            padding: 20px; border-bottom: 1px solid var(--border);
            display: flex; justify-content: space-between; align-items: center;
        }
        .modal-header h3 { font-size: 16px; }
        .modal-close { background: none; border: none; color: var(--text-secondary); font-size: 20px; cursor: pointer; }
        .modal-body { padding: 20px; }
        .modal-footer { padding: 20px; border-top: 1px solid var(--border); display: flex; justify-content: flex-end; gap: 10px; }
        .form-row { display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; }
        .form-group-modal { margin-bottom: 16px; }
        .form-group-modal label { display: block; font-size: 12px; color: var(--text-secondary); margin-bottom: 6px; }
        .form-group-modal input, .form-group-modal select {
            width: 100%; padding: 10px; background: var(--bg-input);
            border: 1px solid var(--border); border-radius: 6px; color: var(--text);
        }
        .pagination { display: flex; justify-content: center; gap: 6px; margin-top: 20px; }
        .pagination button {
            min-width: 36px; height: 36px; border: 1px solid var(--border);
            background: var(--bg-card); color: var(--text); border-radius: 6px; cursor: pointer;
        }
        .pagination button:hover:not(:disabled) { border-color: var(--accent); }
        .pagination button:disabled { opacity: 0.4; cursor: not-allowed; }
        .pagination button.active { background: var(--accent); border-color: var(--accent); }
        .toast-container { position: fixed; top: 20px; right: 20px; z-index: 2000; }
        .toast {
            background: var(--bg-card); border: 1px solid var(--border);
            border-radius: 8px; padding: 14px 20px; margin-bottom: 10px;
            display: flex; align-items: center; gap: 10px;
            animation: slideIn 0.3s ease;
        }
        @keyframes slideIn { from { transform: translateX(100px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        .toast.success { border-left: 3px solid var(--success); }
        .toast.error { border-left: 3px solid var(--danger); }
        .action-buttons { display: flex; gap: 6px; }
        .action-btn {
            width: 30px; height: 30px; border: none; border-radius: 6px;
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            font-size: 14px; background: var(--bg-input); color: var(--text-secondary);
        }
        .action-btn:hover { color: var(--text); }
        .action-btn.edit:hover { color: var(--accent); }
        .action-btn.delete:hover { color: var(--danger); }
        .empty-state { text-align: center; padding: 60px 20px; color: var(--text-secondary); }
        .empty-state .icon { font-size: 48px; margin-bottom: 16px; }
        .loading { text-align: center; padding: 40px; color: var(--text-secondary); }
        .spinner {
            width: 32px; height: 32px; border: 3px solid var(--border);
            border-top-color: var(--accent); border-radius: 50%;
            animation: spin 0.8s linear infinite; margin: 0 auto 16px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div id="app">
        <div class="login-container" id="loginPage">
            <div class="login-box">
                <h1 class="login-title">ğŸ” ç®¡ç†å‘˜ç™»å½•</h1>
                <form id="loginForm" onsubmit="handleLogin(event)">
                    <div class="form-group">
                        <label>ç”¨æˆ·å</label>
                        <input type="text" id="loginUsername" required placeholder="è¯·è¾“å…¥ç”¨æˆ·å">
                    </div>
                    <div class="form-group">
                        <label>å¯†ç </label>
                        <input type="password" id="loginPassword" required placeholder="è¯·è¾“å…¥å¯†ç ">
                    </div>
                    <div class="totp-section" id="totpSection">
                        <div class="form-group">
                            <label>ä¸¤æ­¥éªŒè¯ç </label>
                            <input type="text" id="loginTotpCode" placeholder="è¯·è¾“å…¥6ä½éªŒè¯ç " maxlength="6">
                        </div>
                    </div>
                    <button type="submit" class="btn-login" id="loginBtn">ç™» å½•</button>
                    <div class="error-message" id="loginError"></div>
                </form>
            </div>
        </div>

        <div class="dashboard" id="dashboard" style="display: none; width: 100%;">
            <aside class="sidebar">
                <div class="logo">
                    <div class="logo-icon">âš—ï¸</div>
                    <span class="logo-text">ç®¡ç†åå°</span>
                </div>
                <ul class="nav-menu">
                    <li class="nav-item active" data-page="overview"><span class="icon">ğŸ“Š</span> ç³»ç»Ÿæ¦‚è§ˆ</li>
                    <li class="nav-item" data-page="records"><span class="icon">ğŸ“‹</span> æ•°æ®ç®¡ç†</li>
                    <li class="nav-item" data-page="import-export"><span class="icon">ğŸ“¥</span> å¯¼å…¥å¯¼å‡º</li>
                    <li class="nav-item" data-page="review"><span class="icon">ğŸ”</span> æ•°æ®å®¡æ ¸</li>
                    <li class="nav-item" data-page="users"><span class="icon">ğŸ‘¥</span> ç”¨æˆ·ç®¡ç†</li>
                    <li class="nav-item" data-page="backup"><span class="icon">ğŸ’¾</span> å¤‡ä»½æ¢å¤</li>
                    <li class="nav-item" data-page="logs"><span class="icon">ğŸ“</span> æ“ä½œæ—¥å¿—</li>
                    <li class="nav-item" data-page="sessions"><span class="icon">ğŸ”‘</span> ä¼šè¯ç®¡ç†</li>
                </ul>
                <div class="user-info">
                    <div class="user-name" id="currentUsername">admin</div>
                    <div id="currentRole">ç®¡ç†å‘˜</div>
                    <button class="btn-logout" onclick="handleLogout()">é€€å‡ºç™»å½•</button>
                </div>
            </aside>
            <main class="main-content">
                <div class="page active" id="page-overview">
                    <div class="page-header">
                        <h1 class="page-title">ç³»ç»Ÿæ¦‚è§ˆ</h1>
                        <button class="btn btn-secondary" onclick="loadOverview()">ğŸ”„ åˆ·æ–°</button>
                    </div>
                    <div class="stats-grid" id="overviewStats"></div>
                </div>

                <!-- Records Page -->
                <div class="page" id="page-records">
                    <div class="page-header">
                        <h1 class="page-title">æ•°æ®ç®¡ç†</h1>
                        <button class="btn btn-primary" onclick="openRecordModal()">â• æ·»åŠ æ•°æ®</button>
                    </div>
                    <div class="card">
                        <div class="filters">
                            <input type="number" id="filterTempMin" placeholder="æœ€ä½æ¸©åº¦ (K)" step="0.1">
                            <input type="number" id="filterTempMax" placeholder="æœ€é«˜æ¸©åº¦ (K)" step="0.1">
                            <input type="number" id="filterPressureMin" placeholder="æœ€ä½å‹åŠ› (MPa)" step="0.001">
                            <input type="number" id="filterPressureMax" placeholder="æœ€é«˜å‹åŠ› (MPa)" step="0.001">
                            <button class="btn btn-primary" onclick="loadRecords()">ğŸ” æœç´¢</button>
                            <button class="btn btn-secondary" onclick="clearFilters()">æ¸…é™¤</button>
                        </div>
                        <div id="recordsTableContainer"></div>
                        <div class="pagination" id="recordsPagination"></div>
                    </div>
                </div>

                <!-- Import/Export Page -->
                <div class="page" id="page-import-export">
                    <div class="page-header">
                        <h1 class="page-title">å¯¼å…¥å¯¼å‡º</h1>
                    </div>
                    <div class="card">
                        <div class="card-title">ğŸ“¥ æ•°æ®å¯¼å…¥</div>
                        <p style="color: var(--text-secondary); margin-bottom: 16px;">æ”¯æŒ CSV å’Œ Excel æ ¼å¼æ–‡ä»¶</p>
                        <input type="file" id="importFile" accept=".csv,.xlsx,.xls" style="display:none" onchange="handleImport(event)">
                        <button class="btn btn-primary" onclick="document.getElementById('importFile').click()">é€‰æ‹©æ–‡ä»¶å¯¼å…¥</button>
                        <button class="btn btn-secondary" onclick="downloadTemplate()">ğŸ“„ ä¸‹è½½æ¨¡æ¿</button>
                    </div>
                    <div class="card">
                        <div class="card-title">ğŸ“¤ æ•°æ®å¯¼å‡º</div>
                        <p style="color: var(--text-secondary); margin-bottom: 16px;">å¯¼å‡ºå…¨éƒ¨æ•°æ®åˆ°æ–‡ä»¶</p>
                        <button class="btn btn-success" onclick="exportCSV()">å¯¼å‡º CSV</button>
                        <button class="btn btn-success" onclick="exportExcel()">å¯¼å‡º Excel</button>
                    </div>
                </div>

                <!-- Review Page -->
                <div class="page" id="page-review">
                    <div class="page-header">
                        <h1 class="page-title">æ•°æ®å®¡æ ¸</h1>
                        <button class="btn btn-primary" onclick="scanDuplicates()">ğŸ” æ‰«æé‡å¤æ•°æ®</button>
                    </div>
                    <div class="stats-grid" id="reviewStats"></div>
                    <div class="card" id="reviewGroups"></div>
                </div>

                <!-- Users Page -->
                <div class="page" id="page-users">
                    <div class="page-header">
                        <h1 class="page-title">ç”¨æˆ·ç®¡ç†</h1>
                        <button class="btn btn-primary" onclick="openCreateUserModal()">â• åˆ›å»ºç”¨æˆ·</button>
                    </div>
                    <div class="card" id="usersTableContainer"></div>
                </div>

                <!-- Backup Page -->
                <div class="page" id="page-backup">
                    <div class="page-header">
                        <h1 class="page-title">å¤‡ä»½æ¢å¤</h1>
                        <button class="btn btn-success" onclick="createBackup()">â• åˆ›å»ºå¤‡ä»½</button>
                    </div>
                    <div class="card" id="backupStatus"></div>
                    <div class="card" id="backupList"></div>
                </div>

                <!-- Logs Page -->
                <div class="page" id="page-logs">
                    <div class="page-header">
                        <h1 class="page-title">æ“ä½œæ—¥å¿—</h1>
                        <button class="btn btn-secondary" onclick="loadLogs()">ğŸ”„ åˆ·æ–°</button>
                    </div>
                    <div class="card" id="logsTableContainer"></div>
                </div>

                <!-- Sessions Page -->
                <div class="page" id="page-sessions">
                    <div class="page-header">
                        <h1 class="page-title">ä¼šè¯ç®¡ç†</h1>
                        <button class="btn btn-danger" onclick="revokeAllSessions()">ğŸš« æ’¤é”€å…¶ä»–ä¼šè¯</button>
                    </div>
                    <div class="card" id="sessionsTableContainer"></div>
                </div>
            </main>
        </div>
    </div>

    <div class="modal-overlay" id="recordModal">
        <div class="modal">
            <div class="modal-header">
                <h3 id="recordModalTitle">æ·»åŠ æ•°æ®</h3>
                <button class="modal-close" onclick="closeModal('recordModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-row">
                    <div class="form-group-modal">
                        <label>æ¸©åº¦ (K) *</label>
                        <input type="number" id="recordTemp" step="0.01" required>
                    </div>
                    <div class="form-group-modal">
                        <label>å‹åŠ› (MPa) *</label>
                        <input type="number" id="recordPressure" step="0.001" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group-modal"><label>CHâ‚„</label><input type="number" id="recordCH4" step="0.0001" value="0"></div>
                    <div class="form-group-modal"><label>Câ‚‚Hâ‚†</label><input type="number" id="recordC2H6" step="0.0001" value="0"></div>
                </div>
                <div class="form-row">
                    <div class="form-group-modal"><label>Câ‚ƒHâ‚ˆ</label><input type="number" id="recordC3H8" step="0.0001" value="0"></div>
                    <div class="form-group-modal"><label>COâ‚‚</label><input type="number" id="recordCO2" step="0.0001" value="0"></div>
                </div>
                <div class="form-row">
                    <div class="form-group-modal"><label>Nâ‚‚</label><input type="number" id="recordN2" step="0.0001" value="0"></div>
                    <div class="form-group-modal"><label>Hâ‚‚S</label><input type="number" id="recordH2S" step="0.0001" value="0"></div>
                </div>
                <div class="form-group-modal"><label>i-Câ‚„Hâ‚â‚€</label><input type="number" id="recordIC4H10" step="0.0001" value="0"></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('recordModal')">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="saveRecord()">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="userModal">
        <div class="modal">
            <div class="modal-header">
                <h3>åˆ›å»ºç”¨æˆ·</h3>
                <button class="modal-close" onclick="closeModal('userModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group-modal"><label>ç”¨æˆ·å *</label><input type="text" id="newUsername" required></div>
                <div class="form-group-modal"><label>å¯†ç  *</label><input type="password" id="newPassword" required></div>
                <div class="form-group-modal">
                    <label>è§’è‰²</label>
                    <select id="newRole"><option value="user">æ™®é€šç”¨æˆ·</option><option value="admin">ç®¡ç†å‘˜</option></select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('userModal')">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="createUser()">åˆ›å»º</button>
            </div>
        </div>
    </div>

    <div class="toast-container" id="toastContainer"></div>

    <script>
        const API_BASE = '/api';
        let token = localStorage.getItem('admin_token');
        let currentUser = null;
        let currentPage = { records: 1, review: 1 };
        let editingRecordId = null;

        document.addEventListener('DOMContentLoaded', () => {
            if (token) { checkAuth(); } else { showLogin(); }
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', () => switchPage(item.dataset.page));
            });
        });

        async function checkAuth() {
            try {
                const res = await fetch(`${API_BASE}/auth/me`, { headers: { 'Authorization': `Bearer ${token}` } });
                if (res.ok) {
                    const data = await res.json();
                    currentUser = data.data;
                    showDashboard();
                } else { showLogin(); }
            } catch { showLogin(); }
        }

        function showLogin() { document.getElementById('loginPage').style.display = 'flex'; document.getElementById('dashboard').style.display = 'none'; }
        function showDashboard() {
            document.getElementById('loginPage').style.display = 'none';
            document.getElementById('dashboard').style.display = 'flex';
            document.getElementById('currentUsername').textContent = currentUser.username;
            document.getElementById('currentRole').textContent = currentUser.role === 'admin' ? 'ç®¡ç†å‘˜' : 'ç”¨æˆ·';
            loadOverview();
        }

        async function handleLogin(e) {
            e.preventDefault();
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;
            const totpCode = document.getElementById('loginTotpCode').value;
            document.getElementById('loginBtn').disabled = true;
            document.getElementById('loginError').textContent = '';
            try {
                const res = await fetch(`${API_BASE}/auth/login`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password, totp_code: totpCode || undefined })
                });
                const data = await res.json();
                if (res.ok && data.success) {
                    if (data.require_totp) {
                        document.getElementById('totpSection').classList.add('show');
                        document.getElementById('loginTotpCode').focus();
                    } else {
                        token = data.data.access_token;
                        localStorage.setItem('admin_token', token);
                        currentUser = data.data.user;
                        showDashboard();
                    }
                } else { document.getElementById('loginError').textContent = data.detail || data.message || 'ç™»å½•å¤±è´¥'; }
            } catch (err) { document.getElementById('loginError').textContent = 'ç½‘ç»œé”™è¯¯'; }
            document.getElementById('loginBtn').disabled = false;
        }

        async function handleLogout() {
            try { await fetch(`${API_BASE}/auth/logout`, { method: 'POST', headers: { 'Authorization': `Bearer ${token}` } }); } catch {}
            localStorage.removeItem('admin_token'); token = null; currentUser = null; showLogin();
        }

        function switchPage(pageName) {
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            document.querySelector(`[data-page="${pageName}"]`)?.classList.add('active');
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(`page-${pageName}`)?.classList.add('active');
            if (pageName === 'overview') loadOverview();
            else if (pageName === 'records') loadRecords();
            else if (pageName === 'review') { loadReviewStats(); loadReviewGroups(); }
            else if (pageName === 'users') loadUsers();
            else if (pageName === 'backup') { loadBackupStatus(); loadBackupList(); }
            else if (pageName === 'logs') loadLogs();
            else if (pageName === 'sessions') loadSessions();
        }

        async function loadOverview() {
            const container = document.getElementById('overviewStats');
            container.innerHTML = '<div class="loading"><div class="spinner"></div>åŠ è½½ä¸­...</div>';
            try {
                const res = await fetch(`${API_BASE}/statistics`);
                const stats = await res.json();
                container.innerHTML = `
                    <div class="stat-card"><div class="stat-value">${stats.total_records}</div><div class="stat-label">æ€»è®°å½•æ•°</div></div>
                    <div class="stat-card"><div class="stat-value" style="color:var(--orange)">${stats.avg_temperature?.toFixed(1) || 0}</div><div class="stat-label">å¹³å‡æ¸©åº¦ (K)</div></div>
                    <div class="stat-card"><div class="stat-value" style="color:var(--success)">${stats.avg_pressure?.toFixed(2) || 0}</div><div class="stat-label">å¹³å‡å‹åŠ› (MPa)</div></div>
                    <div class="stat-card"><div class="stat-value" style="color:var(--warning)">${stats.max_pressure?.toFixed(2) || 0}</div><div class="stat-label">æœ€å¤§å‹åŠ› (MPa)</div></div>`;
            } catch { container.innerHTML = '<div class="empty-state"><div class="icon">âš ï¸</div><div>åŠ è½½å¤±è´¥</div></div>'; }
        }

        async function loadRecords() {
            const container = document.getElementById('recordsTableContainer');
            container.innerHTML = '<div class="loading"><div class="spinner"></div>åŠ è½½ä¸­...</div>';
            const params = new URLSearchParams({ page: currentPage.records, per_page: 20 });
            const filters = ['TempMin', 'TempMax', 'PressureMin', 'PressureMax'];
            filters.forEach(f => {
                const val = document.getElementById(`filter${f}`)?.value;
                if (val) params.append(f.replace('Temp', 'temp_').replace('Pressure', 'pressure_').toLowerCase(), val);
            });
            try {
                const res = await fetch(`${API_BASE}/records?${params}`, { headers: { 'Authorization': `Bearer ${token}` } });
                const data = await res.json();
                if (!data.records?.length) { container.innerHTML = '<div class="empty-state"><div class="icon">ğŸ“­</div><div>æš‚æ— æ•°æ®</div></div>'; return; }
                container.innerHTML = `<table class="data-table"><thead><tr>
                    <th>ID</th><th>æ¸©åº¦(K)</th><th>å‹åŠ›(MPa)</th><th>CHâ‚„</th><th>Câ‚‚Hâ‚†</th><th>Câ‚ƒHâ‚ˆ</th><th>COâ‚‚</th><th>Nâ‚‚</th><th>Hâ‚‚S</th><th>i-Câ‚„Hâ‚â‚€</th><th>æ“ä½œ</th>
                </tr></thead><tbody>${data.records.map(r => `<tr>
                    <td>${r.id}</td><td style="color:var(--orange)">${r.temperature}</td><td style="color:var(--accent)">${r.pressure}</td>
                    <td>${r.x_ch4}</td><td>${r.x_c2h6}</td><td>${r.x_c3h8}</td><td>${r.x_co2}</td><td>${r.x_n2}</td><td>${r.x_h2s}</td><td>${r.x_ic4h10}</td>
                    <td><div class="action-buttons">
                        <button class="action-btn edit" onclick="editRecord(${r.id})">âœï¸</button>
                        <button class="action-btn delete" onclick="deleteRecord(${r.id})">ğŸ—‘ï¸</button>
                    </div></td>
                </tr>`).join('')}</tbody></table>`;
                renderPagination('recordsPagination', data.total_pages, currentPage.records, p => { currentPage.records = p; loadRecords(); });
            } catch { container.innerHTML = '<div class="empty-state"><div class="icon">âš ï¸</div><div>åŠ è½½å¤±è´¥</div></div>'; }
        }

        function renderPagination(containerId, totalPages, current, onChange) {
            const container = document.getElementById(containerId);
            if (totalPages <= 1) { container.innerHTML = ''; return; }
            let html = `<button ${current === 1 ? 'disabled' : ''} onclick="arguments[0].stopPropagation()">â€¹</button>`;
            const start = Math.max(1, current - 2), end = Math.min(totalPages, current + 2);
            for (let i = start; i <= end; i++) html += `<button class="${i === current ? 'active' : ''}">${i}</button>`;
            html += `<button ${current === totalPages ? 'disabled' : ''}>â€º</button>`;
            container.innerHTML = html;
            container.querySelectorAll('button').forEach(btn => {
                btn.onclick = () => {
                    if (btn.disabled) return;
                    if (btn.textContent === 'â€¹') onChange(current - 1);
                    else if (btn.textContent === 'â€º') onChange(current + 1);
                    else onChange(parseInt(btn.textContent));
                };
            });
        }

        function openRecordModal(id = null) {
            editingRecordId = id;
            document.getElementById('recordModalTitle').textContent = id ? 'ç¼–è¾‘æ•°æ®' : 'æ·»åŠ æ•°æ®';
            if (!id) ['Temp', 'Pressure', 'CH4', 'C2H6', 'C3H8', 'CO2', 'N2', 'H2S', 'IC4H10'].forEach(f => document.getElementById(`record${f}`).value = f === 'Temp' || f === 'Pressure' ? '' : 0);
            document.getElementById('recordModal').classList.add('active');
        }

        async function editRecord(id) {
            try {
                const res = await fetch(`${API_BASE}/records/${id}`, { headers: { 'Authorization': `Bearer ${token}` } });
                const r = await res.json();
                editingRecordId = id;
                document.getElementById('recordModalTitle').textContent = 'ç¼–è¾‘æ•°æ®';
                document.getElementById('recordTemp').value = r.temperature;
                document.getElementById('recordPressure').value = r.pressure;
                document.getElementById('recordCH4').value = r.x_ch4;
                document.getElementById('recordC2H6').value = r.x_c2h6;
                document.getElementById('recordC3H8').value = r.x_c3h8;
                document.getElementById('recordCO2').value = r.x_co2;
                document.getElementById('recordN2').value = r.x_n2;
                document.getElementById('recordH2S').value = r.x_h2s;
                document.getElementById('recordIC4H10').value = r.x_ic4h10;
                document.getElementById('recordModal').classList.add('active');
            } catch { showToast('è·å–æ•°æ®å¤±è´¥', 'error'); }
        }

        async function saveRecord() {
            const data = {
                temperature: parseFloat(document.getElementById('recordTemp').value),
                pressure: parseFloat(document.getElementById('recordPressure').value),
                x_ch4: parseFloat(document.getElementById('recordCH4').value) || 0,
                x_c2h6: parseFloat(document.getElementById('recordC2H6').value) || 0,
                x_c3h8: parseFloat(document.getElementById('recordC3H8').value) || 0,
                x_co2: parseFloat(document.getElementById('recordCO2').value) || 0,
                x_n2: parseFloat(document.getElementById('recordN2').value) || 0,
                x_h2s: parseFloat(document.getElementById('recordH2S').value) || 0,
                x_ic4h10: parseFloat(document.getElementById('recordIC4H10').value) || 0
            };
            try {
                const url = editingRecordId ? `${API_BASE}/records/${editingRecordId}` : `${API_BASE}/records`;
                const method = editingRecordId ? 'PUT' : 'POST';
                const res = await fetch(url, { method, headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` }, body: JSON.stringify(data) });
                const result = await res.json();
                if (res.ok) { showToast(result.message || 'ä¿å­˜æˆåŠŸ', 'success'); closeModal('recordModal'); loadRecords(); loadOverview(); }
                else showToast(result.detail || 'ä¿å­˜å¤±è´¥', 'error');
            } catch { showToast('ç½‘ç»œé”™è¯¯', 'error'); }
        }

        async function deleteRecord(id) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡è®°å½•å—ï¼Ÿ')) return;
            try {
                const res = await fetch(`${API_BASE}/records/${id}`, { method: 'DELETE', headers: { 'Authorization': `Bearer ${token}` } });
                if (res.ok) { showToast('åˆ é™¤æˆåŠŸ', 'success'); loadRecords(); loadOverview(); }
                else showToast('åˆ é™¤å¤±è´¥', 'error');
            } catch { showToast('ç½‘ç»œé”™è¯¯', 'error'); }
        }

        function clearFilters() {
            ['TempMin', 'TempMax', 'PressureMin', 'PressureMax'].forEach(f => document.getElementById(`filter${f}`).value = '');
            currentPage.records = 1; loadRecords();
        }

        // ==================== Import/Export ====================
        async function handleImport(e) {
            const file = e.target.files[0];
            if (!file) return;
            const formData = new FormData();
            formData.append('file', file);
            try {
                const res = await fetch(`${API_BASE}/import`, { method: 'POST', headers: { 'Authorization': `Bearer ${token}` }, body: formData });
                const data = await res.json();
                if (res.ok && data.success) { showToast(data.message, 'success'); loadOverview(); loadRecords(); }
                else showToast(data.detail?.message || data.detail || 'å¯¼å…¥å¤±è´¥', 'error');
            } catch { showToast('å¯¼å…¥å¤±è´¥', 'error'); }
            e.target.value = '';
        }

        function exportCSV() { window.location.href = `${API_BASE}/export/csv?token=${token}`; showToast('æ­£åœ¨ä¸‹è½½ CSV', 'success'); }
        function exportExcel() { window.location.href = `${API_BASE}/export/excel?token=${token}`; showToast('æ­£åœ¨ä¸‹è½½ Excel', 'success'); }
        function downloadTemplate() { window.location.href = `${API_BASE}/template/csv`; }

        // ==================== Data Review ====================
        async function loadReviewStats() {
            const container = document.getElementById('reviewStats');
            try {
                const res = await fetch(`${API_BASE}/review/stats`, { headers: { 'Authorization': `Bearer ${token}` } });
                const data = await res.json();
                const stats = data.data || {};
                container.innerHTML = `
                    <div class="stat-card"><div class="stat-value">${stats.total_groups || 0}</div><div class="stat-label">å¾…å®¡æ ¸ç»„</div></div>
                    <div class="stat-card"><div class="stat-value" style="color:var(--warning)">${stats.total_records || 0}</div><div class="stat-label">å¾…å®¡æ ¸è®°å½•</div></div>
                    <div class="stat-card"><div class="stat-value" style="color:var(--success)">${stats.approved || 0}</div><div class="stat-label">å·²é€šè¿‡</div></div>
                    <div class="stat-card"><div class="stat-value" style="color:var(--danger)">${stats.rejected || 0}</div><div class="stat-label">å·²æ‹’ç»</div></div>`;
            } catch { container.innerHTML = '<div class="empty-state">åŠ è½½å¤±è´¥</div>'; }
        }

        async function loadReviewGroups() {
            const container = document.getElementById('reviewGroups');
            container.innerHTML = '<div class="loading"><div class="spinner"></div>åŠ è½½ä¸­...</div>';
            try {
                const res = await fetch(`${API_BASE}/review/pending?page=${currentPage.review}&per_page=20`, { headers: { 'Authorization': `Bearer ${token}` } });
                const data = await res.json();
                if (!data.data?.groups?.length) { container.innerHTML = '<div class="card-title">å¾…å®¡æ ¸æ•°æ®ç»„</div><div class="empty-state"><div class="icon">âœ…</div><div>æš‚æ— å¾…å®¡æ ¸æ•°æ®</div></div>'; return; }
                container.innerHTML = `<div class="card-title">å¾…å®¡æ ¸æ•°æ®ç»„ (${data.data.total} ç»„)</div>
                    ${data.data.groups.map(g => `<div style="border:1px solid var(--border);border-radius:8px;padding:16px;margin-bottom:12px;">
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
                            <div><strong>æ¸©åº¦: ${g.temperature} K</strong> | ç»„åˆ†: CHâ‚„=${g.x_ch4}, Câ‚‚Hâ‚†=${g.x_c2h6}</div>
                            <div><span class="badge badge-warning">${g.records?.length || 0} æ¡è®°å½•</span></div>
                        </div>
                        <table class="data-table"><thead><tr><th>é€‰æ‹©</th><th>å‹åŠ›(MPa)</th><th>çŠ¶æ€</th></tr></thead>
                        <tbody>${(g.records || []).map(r => `<tr>
                            <td><input type="checkbox" class="review-checkbox" data-group="${g.group_id}" data-id="${r.id}" ${r.status === 'approved' ? 'checked disabled' : ''}></td>
                            <td style="color:var(--accent)">${r.pressure}</td>
                            <td><span class="badge badge-${r.status === 'pending' ? 'warning' : r.status === 'approved' ? 'success' : 'danger'}">${r.status === 'pending' ? 'å¾…å®¡æ ¸' : r.status === 'approved' ? 'å·²é€šè¿‡' : 'å·²æ‹’ç»'}</span></td>
                        </tr>`).join('')}</tbody></table>
                        <div style="margin-top:12px;display:flex;gap:8px;">
                            <button class="btn btn-success btn-sm" onclick="approveGroup('${g.group_id}')">âœ… é€šè¿‡é€‰ä¸­</button>
                            <button class="btn btn-danger btn-sm" onclick="rejectGroup('${g.group_id}')">âŒ æ‹’ç»å…¨éƒ¨</button>
                        </div>
                    </div>`).join('')}`;
            } catch { container.innerHTML = '<div class="empty-state"><div class="icon">âš ï¸</div><div>åŠ è½½å¤±è´¥</div></div>'; }
        }

        async function scanDuplicates() {
            try {
                const res = await fetch(`${API_BASE}/review/move-duplicates`, { method: 'POST', headers: { 'Authorization': `Bearer ${token}` } });
                const data = await res.json();
                if (res.ok) { showToast(data.message, 'success'); loadReviewStats(); loadReviewGroups(); }
                else showToast(data.detail || 'æ‰«æå¤±è´¥', 'error');
            } catch { showToast('ç½‘ç»œé”™è¯¯', 'error'); }
        }

        async function approveGroup(groupId) {
            const checkboxes = document.querySelectorAll(`.review-checkbox[data-group="${groupId}"]:checked:not(:disabled)`);
            const selectedIds = Array.from(checkboxes).map(cb => parseInt(cb.dataset.id));
            if (!selectedIds.length) { showToast('è¯·è‡³å°‘é€‰æ‹©ä¸€æ¡è®°å½•', 'error'); return; }
            try {
                const res = await fetch(`${API_BASE}/review/approve/${groupId}`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify({ selected_ids: selectedIds })
                });
                if (res.ok) { showToast('å®¡æ ¸é€šè¿‡', 'success'); loadReviewStats(); loadReviewGroups(); }
                else showToast('æ“ä½œå¤±è´¥', 'error');
            } catch { showToast('ç½‘ç»œé”™è¯¯', 'error'); }
        }

        async function rejectGroup(groupId) {
            if (!confirm('ç¡®å®šè¦æ‹’ç»è¯¥ç»„æ‰€æœ‰æ•°æ®å—ï¼Ÿ')) return;
            try {
                const res = await fetch(`${API_BASE}/review/reject/${groupId}`, { method: 'POST', headers: { 'Authorization': `Bearer ${token}` } });
                if (res.ok) { showToast('å·²æ‹’ç»', 'success'); loadReviewStats(); loadReviewGroups(); }
                else showToast('æ“ä½œå¤±è´¥', 'error');
            } catch { showToast('ç½‘ç»œé”™è¯¯', 'error'); }
        }

        // ==================== User Management ====================
        async function loadUsers() {
            const container = document.getElementById('usersTableContainer');
            container.innerHTML = '<div class="loading"><div class="spinner"></div>åŠ è½½ä¸­...</div>';
            try {
                const res = await fetch(`${API_BASE}/auth/users`, { headers: { 'Authorization': `Bearer ${token}` } });
                const data = await res.json();
                if (!data.data?.length) { container.innerHTML = '<div class="empty-state"><div class="icon">ğŸ‘¤</div><div>æš‚æ— ç”¨æˆ·</div></div>'; return; }
                container.innerHTML = `<table class="data-table"><thead><tr><th>ç”¨æˆ·å</th><th>è§’è‰²</th><th>åˆ›å»ºæ—¶é—´</th><th>TOTP</th></tr></thead>
                    <tbody>${data.data.map(u => `<tr>
                        <td>${u.username}</td>
                        <td><span class="badge badge-${u.role === 'admin' ? 'danger' : 'info'}">${u.role === 'admin' ? 'ç®¡ç†å‘˜' : 'ç”¨æˆ·'}</span></td>
                        <td>${u.created_at || '-'}</td>
                        <td><span class="badge badge-${u.totp_enabled ? 'success' : 'secondary'}">${u.totp_enabled ? 'å·²å¯ç”¨' : 'æœªå¯ç”¨'}</span></td>
                    </tr>`).join('')}</tbody></table>`;
            } catch { container.innerHTML = '<div class="empty-state"><div class="icon">âš ï¸</div><div>åŠ è½½å¤±è´¥</div></div>'; }
        }

        function openCreateUserModal() { document.getElementById('newUsername').value = ''; document.getElementById('newPassword').value = ''; document.getElementById('userModal').classList.add('active'); }

        async function createUser() {
            const data = { username: document.getElementById('newUsername').value, password: document.getElementById('newPassword').value, role: document.getElementById('newRole').value };
            try {
                const res = await fetch(`${API_BASE}/auth/users`, { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` }, body: JSON.stringify(data) });
                const result = await res.json();
                if (res.ok && result.success) { showToast('ç”¨æˆ·åˆ›å»ºæˆåŠŸ', 'success'); closeModal('userModal'); loadUsers(); }
                else showToast(result.detail || 'åˆ›å»ºå¤±è´¥', 'error');
            } catch { showToast('ç½‘ç»œé”™è¯¯', 'error'); }
        }

        // ==================== Backup Management ====================
        async function loadBackupStatus() {
            const container = document.getElementById('backupStatus');
            try {
                const res = await fetch(`${API_BASE}/backup/status`, { headers: { 'Authorization': `Bearer ${token}` } });
                const data = await res.json();
                const s = data.data || {};
                container.innerHTML = `<div class="card-title">å¤‡ä»½çŠ¶æ€</div>
                    <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:16px;">
                        <div><div style="color:var(--text-secondary);font-size:12px;">ä¸Šæ¬¡å¤‡ä»½</div><div style="font-size:16px;font-weight:600;">${s.last_backup_time || 'ä»æœªå¤‡ä»½'}</div></div>
                        <div><div style="color:var(--text-secondary);font-size:12px;">å¤‡ä»½æ•°é‡</div><div style="font-size:16px;font-weight:600;">${s.backup_count || 0} ä¸ª</div></div>
                        <div><div style="color:var(--text-secondary);font-size:12px;">æ€»å¤§å°</div><div style="font-size:16px;font-weight:600;">${formatSize(s.total_size || 0)}</div></div>
                    </div>`;
            } catch { container.innerHTML = '<div class="empty-state">åŠ è½½å¤±è´¥</div>'; }
        }

        async function loadBackupList() {
            const container = document.getElementById('backupList');
            container.innerHTML = '<div class="loading"><div class="spinner"></div>åŠ è½½ä¸­...</div>';
            try {
                const res = await fetch(`${API_BASE}/backup/list`, { headers: { 'Authorization': `Bearer ${token}` } });
                const data = await res.json();
                if (!data.data?.length) { container.innerHTML = '<div class="card-title">å¤‡ä»½åˆ—è¡¨</div><div class="empty-state"><div class="icon">ğŸ’¾</div><div>æš‚æ— å¤‡ä»½</div></div>'; return; }
                container.innerHTML = `<div class="card-title">å¤‡ä»½åˆ—è¡¨</div><table class="data-table"><thead><tr><th>æ–‡ä»¶å</th><th>å¤§å°</th><th>åˆ›å»ºæ—¶é—´</th><th>æ“ä½œ</th></tr></thead>
                    <tbody>${data.data.map(b => `<tr>
                        <td>${b.filename}</td><td>${formatSize(b.size)}</td><td>${b.created_at || '-'}</td>
                        <td><div class="action-buttons">
                            <button class="btn btn-sm btn-secondary" onclick="downloadBackup('${b.filename}')">ğŸ“¥</button>
                            <button class="btn btn-sm btn-primary" onclick="restoreBackup('${b.filename}')">ğŸ”„</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteBackup('${b.filename}')">ğŸ—‘ï¸</button>
                        </div></td>
                    </tr>`).join('')}</tbody></table>`;
            } catch { container.innerHTML = '<div class="empty-state"><div class="icon">âš ï¸</div><div>åŠ è½½å¤±è´¥</div></div>'; }
        }

        async function createBackup() {
            try {
                const res = await fetch(`${API_BASE}/backup/create`, { method: 'POST', headers: { 'Authorization': `Bearer ${token}` } });
                const data = await res.json();
                if (res.ok && data.success) { showToast('å¤‡ä»½åˆ›å»ºæˆåŠŸ', 'success'); loadBackupStatus(); loadBackupList(); }
                else showToast(data.message || data.detail || 'åˆ›å»ºå¤±è´¥', 'error');
            } catch { showToast('ç½‘ç»œé”™è¯¯', 'error'); }
        }

        function downloadBackup(filename) { window.location.href = `${API_BASE}/backup/download/${filename}?token=${token}`; }

        async function restoreBackup(filename) {
            if (!confirm(`ç¡®å®šè¦æ¢å¤å¤‡ä»½ ${filename} å—ï¼Ÿå½“å‰æ•°æ®å°†è¢«è¦†ç›–ï¼`)) return;
            try {
                const res = await fetch(`${API_BASE}/backup/restore/${filename}`, { method: 'POST', headers: { 'Authorization': `Bearer ${token}` } });
                const data = await res.json();
                if (res.ok && data.success) { showToast('æ¢å¤æˆåŠŸ', 'success'); loadOverview(); }
                else showToast(data.message || data.detail || 'æ¢å¤å¤±è´¥', 'error');
            } catch { showToast('ç½‘ç»œé”™è¯¯', 'error'); }
        }

        async function deleteBackup(filename) {
            if (!confirm(`ç¡®å®šè¦åˆ é™¤å¤‡ä»½ ${filename} å—ï¼Ÿ`)) return;
            try {
                const res = await fetch(`${API_BASE}/backup/${filename}`, { method: 'DELETE', headers: { 'Authorization': `Bearer ${token}` } });
                if (res.ok) { showToast('åˆ é™¤æˆåŠŸ', 'success'); loadBackupStatus(); loadBackupList(); }
                else showToast('åˆ é™¤å¤±è´¥', 'error');
            } catch { showToast('ç½‘ç»œé”™è¯¯', 'error'); }
        }

        // ==================== Logs ====================
        async function loadLogs() {
            const container = document.getElementById('logsTableContainer');
            container.innerHTML = '<div class="loading"><div class="spinner"></div>åŠ è½½ä¸­...</div>';
            try {
                const res = await fetch(`${API_BASE}/security/audit-logs?limit=100`, { headers: { 'Authorization': `Bearer ${token}` } });
                const data = await res.json();
                if (!data.data?.length) { container.innerHTML = '<div class="empty-state"><div class="icon">ğŸ“</div><div>æš‚æ— æ—¥å¿—</div></div>'; return; }
                container.innerHTML = `<table class="data-table"><thead><tr><th>æ—¶é—´</th><th>ç”¨æˆ·</th><th>æ“ä½œ</th><th>IP</th><th>è¯¦æƒ…</th></tr></thead>
                    <tbody>${data.data.map(log => `<tr>
                        <td>${log.created_at || '-'}</td><td>${log.username}</td>
                        <td><span class="badge badge-info">${log.action}</span></td>
                        <td>${log.ip || '-'}</td><td style="max-width:200px;overflow:hidden;text-overflow:ellipsis;">${log.details || '-'}</td>
                    </tr>`).join('')}</tbody></table>`;
            } catch { container.innerHTML = '<div class="empty-state"><div class="icon">âš ï¸</div><div>åŠ è½½å¤±è´¥</div></div>'; }
        }

        // ==================== Sessions ====================
        async function loadSessions() {
            const container = document.getElementById('sessionsTableContainer');
            container.innerHTML = '<div class="loading"><div class="spinner"></div>åŠ è½½ä¸­...</div>';
            try {
                const res = await fetch(`${API_BASE}/auth/sessions`, { headers: { 'Authorization': `Bearer ${token}` } });
                const data = await res.json();
                if (!data.data?.length) { container.innerHTML = '<div class="empty-state"><div class="icon">ğŸ”‘</div><div>æš‚æ— ä¼šè¯</div></div>'; return; }
                container.innerHTML = `<table class="data-table"><thead><tr><th>è®¾å¤‡/IP</th><th>ç™»å½•æ—¶é—´</th><th>æœ€åæ´»åŠ¨</th><th>çŠ¶æ€</th></tr></thead>
                    <tbody>${data.data.map(s => `<tr>
                        <td><div>${s.user_agent?.substring(0, 50) || 'æœªçŸ¥è®¾å¤‡'}</div><div style="color:var(--text-secondary);font-size:12px;">${s.ip || '-'}</div></td>
                        <td>${s.created_at || '-'}</td><td>${s.last_active || '-'}</td>
                        <td><span class="badge badge-${s.is_current ? 'success' : 'info'}">${s.is_current ? 'å½“å‰ä¼šè¯' : 'å…¶ä»–ä¼šè¯'}</span></td>
                    </tr>`).join('')}</tbody></table>`;
            } catch { container.innerHTML = '<div class="empty-state"><div class="icon">âš ï¸</div><div>åŠ è½½å¤±è´¥</div></div>'; }
        }

        async function revokeAllSessions() {
            if (!confirm('ç¡®å®šè¦æ’¤é”€é™¤å½“å‰ä¼šè¯å¤–çš„æ‰€æœ‰ä¼šè¯å—ï¼Ÿ')) return;
            try {
                const res = await fetch(`${API_BASE}/auth/sessions/revoke-all`, { method: 'POST', headers: { 'Authorization': `Bearer ${token}` } });
                const data = await res.json();
                if (res.ok) { showToast(data.message || 'æ“ä½œæˆåŠŸ', 'success'); loadSessions(); }
                else showToast(data.detail || 'æ“ä½œå¤±è´¥', 'error');
            } catch { showToast('ç½‘ç»œé”™è¯¯', 'error'); }
        }

        // ==================== Utilities ====================
        function closeModal(id) { document.getElementById(id).classList.remove('active'); }

        function showToast(message, type = 'success') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `<span>${type === 'success' ? 'âœ…' : 'âŒ'}</span><span>${message}</span>`;
            container.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        function formatSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024, sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
    </script>
</body>
</html>
```

---

**æ–‡æ¡£ç‰ˆæœ¬**ï¼šV5.0  
**ç”Ÿæˆæ—¥æœŸ**ï¼š2026å¹´1æœˆ  
**ç³»ç»Ÿåç§°**ï¼šæ°”ä½“æ··åˆç‰©æ•°æ®ç®¡ç†ç³»ç»Ÿ

---

*Â© 2026 Gas Mixture Data Management System. All Rights Reserved.*
